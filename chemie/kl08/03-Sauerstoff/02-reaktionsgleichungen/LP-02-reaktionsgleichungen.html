<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lernpfad: Reaktionsgleichungen aufstellen und ausgleichen</title>
    <style>
/* ═══════════════════════════════════════════════════════════════
   MINT LERNPFAD - Chemie Klasse 8: Reaktionsgleichungen
   sciencesim Design System
═══════════════════════════════════════════════════════════════ */

* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --bg: #f5f5f5;
    --white: #ffffff;
    --border: #dddddd;
    --text-primary: #222222;
    --text-secondary: #555555;
    --text-muted: #888888;
    --accent: #2a7a4b;
    --accent-light: #e8f5e9;
    --accent-dark: #1e5a35;
    --success: #2a7a4b;
    --success-bg: #e8f5e9;
    --warning: #b35c00;
    --warning-bg: #fff3e0;
    --error: #c62828;
    --error-bg: #ffebee;
    --metal: #2c5aa0;
    --oxygen: #c62828;
    --info: #1565c0;
    --info-bg: #e3f2fd;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg);
    font-size: 16px;
    color: var(--text-primary);
    line-height: 1.5;
}

.container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

/* ═══════════════════════════════════════════════════════════════
   HEADER
═══════════════════════════════════════════════════════════════ */

header {
    background: var(--white);
    border: 1px solid var(--border);
    padding: 15px 20px;
    margin-bottom: 20px;
}

header h1 {
    color: var(--accent);
    font-size: 1.4em;
    font-weight: 600;
}

header .meta {
    color: var(--text-muted);
    font-size: 0.9em;
    margin-top: 5px;
}

.progress-bar {
    background: #e0e0e0;
    height: 8px;
    margin-top: 10px;
}

.progress-fill {
    background: var(--accent);
    height: 100%;
    width: 0%;
    transition: width 0.3s;
}

.step-indicators {
    display: flex;
    gap: 4px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.step-dot {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75em;
    font-weight: 600;
    border: 2px solid var(--border);
    background: var(--white);
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text-secondary);
}

.step-dot:hover { border-color: var(--accent); }
.step-dot.completed { background: var(--success); border-color: var(--success); color: var(--white); }
.step-dot.current {
    border-color: var(--accent);
    background: var(--accent);
    color: var(--white);
    font-weight: 700;
}

/* ═══════════════════════════════════════════════════════════════
   STEP CONTENT
═══════════════════════════════════════════════════════════════ */

.step {
    background: var(--white);
    border: 1px solid var(--border);
    margin-bottom: 15px;
    display: none;
}

.step.active { display: block; }

.step-header {
    background: var(--accent);
    color: var(--white);
    padding: 12px 15px;
    font-weight: 600;
}

.step-content {
    padding: 20px;
}

/* ═══════════════════════════════════════════════════════════════
   CONTENT BOXES
═══════════════════════════════════════════════════════════════ */

.info-box {
    background: var(--accent-light);
    border: 1px solid var(--accent);
    padding: 12px 15px;
    margin: 15px 0;
}

.info-box strong { color: var(--accent); }

.science-box {
    background: var(--info-bg);
    border: 1px solid var(--info);
    padding: 12px 15px;
    margin: 15px 0;
}

.science-box strong { color: var(--info); }

.merke-box {
    background: var(--bg);
    border: 2px solid var(--accent);
    padding: 15px;
    margin: 15px 0;
}

.merke-box::before {
    content: "Merke";
    display: inline-block;
    background: var(--accent);
    color: var(--white);
    font-size: 0.75em;
    font-weight: 600;
    padding: 2px 8px;
    margin-bottom: 8px;
}

.hefter-hinweis {
    background: var(--warning-bg);
    border: 2px solid var(--warning);
    padding: 12px 15px;
    margin: 20px 0;
}

.hefter-hinweis::before {
    content: "Arbeitsblatt";
    display: inline-block;
    background: var(--warning);
    color: var(--white);
    font-size: 0.75em;
    font-weight: 600;
    padding: 2px 8px;
    margin-bottom: 8px;
}

.algorithm-box {
    background: var(--accent-light);
    border: 2px solid var(--accent);
    padding: 15px;
    margin: 15px 0;
}

.algorithm-box h4 {
    color: var(--accent);
    margin-bottom: 10px;
}

.algorithm-step {
    display: flex;
    align-items: flex-start;
    margin: 8px 0;
    padding: 8px;
    background: var(--white);
    border-left: 3px solid var(--accent);
}

.algorithm-step .step-num {
    background: var(--accent);
    color: white;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.85em;
    margin-right: 10px;
    flex-shrink: 0;
}

/* ═══════════════════════════════════════════════════════════════
   ATOM COUNTER
═══════════════════════════════════════════════════════════════ */

.atom-counter {
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 15px;
    margin: 15px 0;
    font-family: monospace;
}

.atom-row {
    display: flex;
    align-items: center;
    margin: 5px 0;
}

.atom-row .label {
    width: 60px;
    font-weight: bold;
}

.atom-dots {
    display: flex;
    gap: 3px;
    margin-right: 15px;
}

.atom-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: inline-block;
}

.atom-dot.metal { background: var(--metal); }
.atom-dot.oxygen { background: var(--oxygen); }

.atom-count {
    font-weight: bold;
    margin-left: 10px;
}

.atom-count.match { color: var(--success); }
.atom-count.mismatch { color: var(--error); }

/* ═══════════════════════════════════════════════════════════════
   FORM ELEMENTS
═══════════════════════════════════════════════════════════════ */

select, input[type="text"], input[type="number"] {
    padding: 8px;
    font-size: 1em;
    border: 1px solid var(--border);
    margin: 5px 0;
}

select { min-width: 80px; }

.inline-input {
    border: none;
    border-bottom: 2px solid var(--accent);
    padding: 3px 8px;
    width: 50px;
    background: transparent;
    text-align: center;
    font-size: 1em;
    font-weight: bold;
}

.inline-input.wide { width: 80px; }

.equation-builder {
    background: var(--bg);
    padding: 15px;
    margin: 15px 0;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 5px;
}

.equation-builder .coef {
    color: var(--text-muted);
}

.equation-builder .metal { color: var(--metal); font-weight: bold; }
.equation-builder .oxygen { color: var(--oxygen); font-weight: bold; }

.equation-builder sub {
    font-size: 0.7em;
}

/* ═══════════════════════════════════════════════════════════════
   BUTTONS & FEEDBACK
═══════════════════════════════════════════════════════════════ */

.btn {
    display: inline-block;
    padding: 10px 20px;
    background: var(--accent);
    color: var(--white);
    border: none;
    cursor: pointer;
    font-size: 1em;
    margin: 5px 5px 5px 0;
}

.btn:hover { background: var(--accent-dark); }
.btn-success { background: var(--success); }
.btn-secondary { background: #666; }
.btn-secondary:hover { background: #444; }

.nav-buttons {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--border);
}

.feedback {
    padding: 10px 15px;
    margin: 10px 0;
    display: none;
}

.feedback.correct {
    background: var(--success-bg);
    border: 1px solid var(--success);
    color: #1b5e20;
    display: block;
}

.feedback.incorrect {
    background: var(--error-bg);
    border: 1px solid var(--error);
    color: #b71c1c;
    display: block;
}

.feedback.hint {
    background: var(--warning-bg);
    border: 1px solid var(--warning);
    color: #7a4a00;
    display: block;
}

/* ═══════════════════════════════════════════════════════════════
   EXERCISE
═══════════════════════════════════════════════════════════════ */

.exercise {
    background: var(--bg);
    border: 1px solid var(--border);
    padding: 15px;
    margin: 15px 0;
}

.exercise-title {
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 10px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
}

th, td {
    border: 1px solid var(--border);
    padding: 10px;
    text-align: left;
}

th { background: var(--bg); font-weight: 600; }

ul, ol { margin-left: 20px; margin-top: 10px; }
li { margin: 5px 0; }

.hidden { display: none !important; }

/* Hands visualization */
.hands-visual {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin: 20px 0;
    flex-wrap: wrap;
}

.hands-item {
    text-align: center;
    padding: 15px;
    background: var(--white);
    border: 1px solid var(--border);
}

.hands-item .symbol {
    font-size: 2em;
    font-weight: bold;
    margin-bottom: 5px;
}

.hands-item .hands {
    font-size: 1.5em;
}

.hands-item .label {
    font-size: 0.85em;
    color: var(--text-muted);
}

/* ═══════════════════════════════════════════════════════════════
   VORFAKTOR-ANIMATION
═══════════════════════════════════════════════════════════════ */

.balance-anim {
    background: var(--white);
    border: 2px solid var(--accent);
    padding: 20px;
    margin: 20px 0;
}

.balance-anim h4 {
    color: var(--accent);
    margin-bottom: 15px;
}

.equation-display {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 8px;
    font-size: 1.3em;
    margin: 20px 0;
    flex-wrap: wrap;
}

.eq-element {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 60px;
}

.eq-formula {
    font-weight: bold;
    padding: 5px 10px;
    border: 2px solid transparent;
    transition: all 0.3s;
}

.eq-formula.highlight-product { border-color: var(--accent); background: var(--accent-light); }
.eq-formula.highlight-oxygen { border-color: var(--oxygen); background: #ffebee; }
.eq-formula.highlight-metal { border-color: var(--metal); background: #e3f2fd; }

.eq-coef {
    font-weight: bold;
    margin-right: 2px;
}

.eq-coef.new { color: var(--accent); }

.eq-counts {
    display: flex;
    gap: 5px;
    margin-top: 8px;
    font-size: 0.7em;
    font-family: monospace;
}

.eq-count {
    padding: 2px 6px;
    border-radius: 2px;
}

.eq-count.metal { background: #e3f2fd; color: var(--metal); }
.eq-count.oxygen { background: #ffebee; color: var(--oxygen); }

.eq-count.crossed {
    text-decoration: line-through;
    opacity: 0.5;
}

.eq-count.updated {
    font-weight: bold;
    animation: pulse-update 0.5s;
}

@keyframes pulse-update {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.eq-arrow, .eq-plus {
    font-size: 1.2em;
    color: var(--text-muted);
    padding-top: 5px;
}

.balance-status {
    text-align: center;
    padding: 10px;
    margin-top: 15px;
    font-weight: bold;
}

.balance-status.checking { background: var(--warning-bg); color: var(--warning); }
.balance-status.balanced { background: var(--success-bg); color: var(--success); }

.balance-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
}

.balance-step-info {
    background: var(--bg);
    padding: 10px 15px;
    margin-top: 15px;
    font-size: 0.95em;
}

.balance-step-info strong {
    color: var(--accent);
}

.mg-input-step {
    margin-top: 15px;
    padding: 10px;
    background: var(--bg);
    border-left: 3px solid var(--accent);
}

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Lernpfad: Reaktionsgleichungen aufstellen und ausgleichen</h1>
            <div class="meta">Chemie Klasse 8 | Thema 2.5</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="step-indicators" id="stepIndicators"></div>
        </header>

        <!-- ========== SCHRITT 1: Einstieg ========== -->
        <div class="step active" id="step1">
            <div class="step-header">Schritt 1: Warum brauchen wir genaue Mengen?</div>
            <div class="step-content">
                <div class="info-box">
                    <strong>Frage:</strong> Warum explodiert ein Airbag in genau 30 Millisekunden – nicht langsamer, nicht schneller?
                </div>

                <p><strong>Antwort:</strong> Weil Ingenieure die <strong>EXAKTEN Mengen</strong> berechnet haben!</p>

                <ul>
                    <li>Zu wenig Gas -> Airbag ist schlaff -> kein Schutz</li>
                    <li>Zu viel Gas -> Airbag platzt -> gefährlich</li>
                    <li>Genau richtig -> 67 Liter Stickstoff in 30 ms -> perfekter Schutz</li>
                </ul>

                <div class="merke-box">
                    <p><strong>Reaktionsgleichungen sind die REZEPTE der Chemie.</strong></p>
                    <p>Sie zeigen uns die genauen Mengenverhältnisse – ohne sie geht es schief!</p>
                </div>

                <p>Heute lernst du <strong>zwei Algorithmen</strong>:</p>
                <ol>
                    <li><strong>Algorithmus 1:</strong> Die Verhältnisformel aufstellen (z.B. MgO, Al<sub>2</sub>O<sub>3</sub>)</li>
                    <li><strong>Algorithmus 2:</strong> Die Reaktionsgleichung aufstellen und ausgleichen</li>
                </ol>

                <div class="nav-buttons">
                    <button class="btn btn-success" onclick="nextStep(2)">Weiter -></button>
                </div>
            </div>
        </div>

        <!-- ========== SCHRITT 2: Wertigkeiten ========== -->
        <div class="step" id="step2">
            <div class="step-header">Schritt 2: Wertigkeiten – Die "Händezahl" der Atome</div>
            <div class="step-content">
                <p>Um eine Formel aufzustellen, musst du wissen, wie viele <strong>Bindungen</strong> ein Atom eingehen kann. Das nennt man <strong>Wertigkeit</strong>.</p>

                <div class="merke-box">
                    <p>Die <strong>Wertigkeit</strong> gibt an, wie viele Bindungen ein Atom eingehen kann.</p>
                    <p>Stell dir vor: Jedes Atom hat "Hände" zum Festhalten.</p>
                </div>

                <div class="hands-visual">
                    <div class="hands-item">
                        <div class="symbol" style="color: var(--metal);">Mg</div>
                        <div class="hands">++</div>
                        <div class="label">2 Hände = Wertigkeit II</div>
                    </div>
                    <div class="hands-item">
                        <div class="symbol" style="color: var(--metal);">Al</div>
                        <div class="hands">+++</div>
                        <div class="label">3 Hände = Wertigkeit III</div>
                    </div>
                    <div class="hands-item">
                        <div class="symbol" style="color: var(--oxygen);">O</div>
                        <div class="hands">--</div>
                        <div class="label">2 Hände = Wertigkeit II</div>
                    </div>
                </div>

                <div class="science-box">
                    <strong>Warum diese Zahlen?</strong> Bei Metalloxiden gibt das Metall Elektronen <strong>ab</strong>, Sauerstoff <strong>nimmt</strong> sie auf. So entstehen geladene Teilchen (<strong>Ionen</strong>), die sich anziehen. Die Wertigkeit zeigt, wie viele Elektronen abgegeben bzw. aufgenommen werden.
                </div>

                <h4>Wertigkeitstabelle</h4>
                <table>
                    <tr>
                        <th>Na</th><th>Mg</th><th>Al</th><th>Fe</th><th>Cu</th><th>Zn</th><th>Ca</th><th>O</th>
                    </tr>
                    <tr>
                        <td>I</td><td>II</td><td>III</td><td>II/III</td><td>I/II</td><td>II</td><td>II</td><td>II</td>
                    </tr>
                </table>

                <p><strong>Hinweis:</strong> Eisen (Fe) und Kupfer (Cu) haben zwei mögliche Wertigkeiten. Welche gilt, steht meist in der Aufgabe.</p>

                <div class="hefter-hinweis">
                    <strong>→ AB Merkkasten:</strong> Ergänze die Lücken zur Wertigkeit („Händezahl").
                </div>

                <div class="exercise">
                    <div class="exercise-title">Übung: Wertigkeiten ablesen → AB Aufgabe 1</div>
                    <p>Welche Wertigkeit hat...</p>
                    <p>Calcium (Ca):
                        <select id="ex2-1" onchange="saveAnswer('ex2-1')">
                            <option value="">--</option>
                            <option value="1">I</option>
                            <option value="2">II</option>
                            <option value="3">III</option>
                        </select>
                        -> Ca gibt <input type="text" class="inline-input" id="ex2-1b" style="width:30px" onchange="saveAnswer('ex2-1b')"> Elektron(en) ab.
                    </p>
                    <p>Aluminium (Al):
                        <select id="ex2-2" onchange="saveAnswer('ex2-2')">
                            <option value="">--</option>
                            <option value="1">I</option>
                            <option value="2">II</option>
                            <option value="3">III</option>
                        </select>
                        -> Al gibt <input type="text" class="inline-input" id="ex2-2b" style="width:30px" onchange="saveAnswer('ex2-2b')"> Elektron(en) ab.
                    </p>
                    <p>Sauerstoff (O):
                        <select id="ex2-3" onchange="saveAnswer('ex2-3')">
                            <option value="">--</option>
                            <option value="1">I</option>
                            <option value="2">II</option>
                            <option value="3">III</option>
                        </select>
                        -> O nimmt <input type="text" class="inline-input" id="ex2-3b" style="width:30px" onchange="saveAnswer('ex2-3b')"> Elektron(en) auf.
                    </p>
                    <button class="btn" onclick="checkEx2()">Prüfen</button>
                    <div class="feedback" id="feedback2"></div>
                </div>

                <div class="hefter-hinweis">
                    <strong>→ AB Aufgabe 1:</strong> Übertrage deine Antworten in die Tabelle.
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="prevStep(1)"><- Zurück</button>
                    <button class="btn btn-success" onclick="nextStep(3)">Weiter -></button>
                </div>
            </div>
        </div>

        <!-- ========== SCHRITT 3: Algorithmus 1 ========== -->
        <div class="step" id="step3">
            <div class="step-header">Schritt 3: Algorithmus 1 – Verhältnisformel aufstellen</div>
            <div class="step-content">
                <p>Jetzt lernst du, wie man die <strong>Formel des Oxids</strong> ermittelt.</p>

                <div class="algorithm-box">
                    <h4>Algorithmus 1: Verhältnisformel aufstellen</h4>

                    <div class="algorithm-step">
                        <div class="step-num">1</div>
                        <div><strong>Elementsymbole aufschreiben:</strong> Li &nbsp; O</div>
                    </div>

                    <div class="algorithm-step">
                        <div class="step-num">2</div>
                        <div><strong>Wertigkeiten ablesen:</strong> I &nbsp; II</div>
                    </div>

                    <div class="algorithm-step">
                        <div class="step-num">3</div>
                        <div>
                            <strong>Kreuzregel anwenden:</strong> Wertigkeit A -> Index B (und umgekehrt)<br>
                            -> Li<sub>2</sub>O
                        </div>
                    </div>
                </div>

                <h4>Die Kreuzregel erklärt:</h4>
                <div style="font-size: 1.3em; text-align: center; margin: 15px 0; font-family: monospace; background: var(--bg); padding: 15px;">
                    <span style="color: var(--metal);">Al</span><sup style="color: var(--text-muted);">(III)</sup> +
                    <span style="color: var(--oxygen);">O</span><sup style="color: var(--text-muted);">(II)</sup> ->
                    <span style="color: var(--metal);">Al</span><sub style="color: var(--oxygen);"><strong>2</strong></sub><span style="color: var(--oxygen);">O</span><sub style="color: var(--metal);"><strong>3</strong></sub>
                    <p style="font-size: 0.7em; margin-top: 10px;">Wertigkeit III -> Index 3 bei O &nbsp;&nbsp;|&nbsp;&nbsp; Wertigkeit II -> Index 2 bei Al</p>
                </div>

                <div class="science-box" style="margin: 15px 0;">
                    <strong>Warum funktioniert die Kreuzregel? – Elektronen-Bilanz</strong>
                    <p style="margin-top: 8px;">Bei Metalloxiden gilt: <strong>abgegebene e<sup>−</sup> = aufgenommene e<sup>−</sup></strong></p>
                    <p><strong>Beispiel Al<sub>2</sub>O<sub>3</sub>:</strong></p>
                    <ul style="margin: 5px 0;">
                        <li>Al gibt <strong>3 e<sup>−</sup></strong> ab (Wertigkeit III)</li>
                        <li>O nimmt <strong>2 e<sup>−</sup></strong> auf (Wertigkeit II)</li>
                    </ul>
                    <p>Wie viele von jedem, damit es aufgeht?</p>
                    <ul style="margin: 5px 0;">
                        <li>2 Al geben 2 × 3 = <strong>6 e<sup>−</sup></strong> ab</li>
                        <li>3 O nehmen 3 × 2 = <strong>6 e<sup>−</sup></strong> auf ✓</li>
                    </ul>
                    <p style="margin-top: 8px;"><em>→ Das ist genau das, was die Kreuzregel macht!</em></p>
                </div>

                <h4>Beispiele:</h4>
                <table>
                    <tr><th>Metall</th><th>Wertigkeiten</th><th>Formel</th><th>Erklärung</th></tr>
                    <tr>
                        <td>Mg</td>
                        <td>Mg(II), O(II)</td>
                        <td><strong>MgO</strong></td>
                        <td>Gleiche Wertigkeit -> 1:1</td>
                    </tr>
                    <tr>
                        <td>Al</td>
                        <td>Al(III), O(II)</td>
                        <td><strong>Al<sub>2</sub>O<sub>3</sub></strong></td>
                        <td>Kreuzregel: 2 Al, 3 O</td>
                    </tr>
                    <tr>
                        <td>Na</td>
                        <td>Na(I), O(II)</td>
                        <td><strong>Na<sub>2</sub>O</strong></td>
                        <td>Kreuzregel: 2 Na, 1 O</td>
                    </tr>
                </table>

                <div class="hefter-hinweis">
                    <strong>→ AB Aufgabe 2:</strong> Wende die Kreuzregel an – trage Wertigkeiten und Oxidformeln ein.
                </div>

                <div class="exercise">
                    <div class="exercise-title">Übung: Kreuzregel anwenden</div>
                    <p><strong>Calcium:</strong> Ca(II) + O(II)</p>
                    <p>Formel: Ca<sub><input type="text" class="inline-input" id="ex3-1" style="width: 30px;" onchange="saveAnswer('ex3-1')"></sub>O<sub><input type="text" class="inline-input" id="ex3-2" style="width: 30px;" onchange="saveAnswer('ex3-2')"></sub></p>
                    <p style="font-size: 0.85em; color: var(--text-muted);">Tipp: Bei gleicher Wertigkeit ist der Index 1 (wird nicht geschrieben).</p>

                    <p style="margin-top: 15px;"><strong>Eisen (III):</strong> Fe(III) + O(II)</p>
                    <p>Formel: Fe<sub><input type="text" class="inline-input" id="ex3-3" style="width: 30px;" onchange="saveAnswer('ex3-3')"></sub>O<sub><input type="text" class="inline-input" id="ex3-4" style="width: 30px;" onchange="saveAnswer('ex3-4')"></sub></p>

                    <button class="btn" onclick="checkEx3()">Prüfen</button>
                    <div class="feedback" id="feedback3"></div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="prevStep(2)"><- Zurück</button>
                    <button class="btn btn-success" onclick="nextStep(4)">Weiter -></button>
                </div>
            </div>
        </div>

        <!-- ========== SCHRITT 4: O₂-Problem ========== -->
        <div class="step" id="step4">
            <div class="step-header">Schritt 4: Achtung – Sauerstoff ist O<sub>2</sub>!</div>
            <div class="step-content">
                <div class="info-box">
                    <strong>Wichtig:</strong> In der Luft kommt Sauerstoff nicht als einzelnes O vor, sondern als <strong>O<sub>2</sub></strong> (zwei Atome zusammen).
                </div>

                <p>Wenn wir eine Reaktionsgleichung schreiben, müssen wir das berücksichtigen:</p>

                <div style="background: var(--bg); padding: 15px; margin: 15px 0; font-size: 1.1em;">
                    <p><strong>Falsch:</strong> Mg + O -> MgO</p>
                    <p><strong>Richtig:</strong> Mg + O<sub>2</sub> -> MgO</p>
                </div>

                <p>Das Problem: Links haben wir jetzt <strong>2 Sauerstoff-Atome</strong> (in O<sub>2</sub>), aber rechts nur <strong>1</strong> (in MgO).</p>
                <p>-> Die Gleichung ist <strong>nicht ausgeglichen</strong>!</p>

                <div class="merke-box">
                    <p><strong>Gesetz der Erhaltung der Masse:</strong></p>
                    <p>Die Anzahl der Atome auf beiden Seiten muss <strong>gleich</strong> sein!</p>
                    <p>Atome verschwinden nicht und entstehen nicht neu.</p>
                </div>

                <div class="exercise">
                    <div class="exercise-title">Übung: Atome zählen</div>
                    <p>Gleichung: Mg + O<sub>2</sub> -> MgO</p>
                    <p>Wie viele Atome sind auf jeder Seite?</p>
                    <table>
                        <tr><th></th><th>Links</th><th>Rechts</th></tr>
                        <tr>
                            <td>Mg-Atome</td>
                            <td><input type="text" class="inline-input" id="ex4-1" onchange="saveAnswer('ex4-1')"></td>
                            <td><input type="text" class="inline-input" id="ex4-2" onchange="saveAnswer('ex4-2')"></td>
                        </tr>
                        <tr>
                            <td>O-Atome</td>
                            <td><input type="text" class="inline-input" id="ex4-3" onchange="saveAnswer('ex4-3')"></td>
                            <td><input type="text" class="inline-input" id="ex4-4" onchange="saveAnswer('ex4-4')"></td>
                        </tr>
                    </table>
                    <button class="btn" onclick="checkEx4()">Prüfen</button>
                    <div class="feedback" id="feedback4"></div>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="prevStep(3)"><- Zurück</button>
                    <button class="btn btn-success" onclick="nextStep(5)">Weiter -></button>
                </div>
            </div>
        </div>

        <!-- ========== SCHRITT 5: Algorithmus 2 ========== -->
        <div class="step" id="step5">
            <div class="step-header">Schritt 5: Algorithmus 2 – Reaktionsgleichung aufstellen und ausgleichen</div>
            <div class="step-content">
                <p>Jetzt lernst du den zweiten Algorithmus. Wir machen es am Beispiel <strong>Lithium</strong>:</p>

                <div class="algorithm-box">
                    <h4>Algorithmus 2: Reaktionsgleichung aufstellen und ausgleichen</h4>

                    <div class="algorithm-step">
                        <div class="step-num">1</div>
                        <div><strong>Wortgleichung:</strong> Lithium + Sauerstoff -> Lithiumoxid</div>
                    </div>

                    <div class="algorithm-step">
                        <div class="step-num">2</div>
                        <div><strong>Formelgleichung:</strong> Li + O<sub>2</sub> -> Li<sub>2</sub>O <span style="color: var(--text-muted); font-size: 0.85em;">(Li<sub>2</sub>O aus Algorithmus 1, Sauerstoff ist O<sub>2</sub>!)</span></div>
                    </div>

                    <div class="algorithm-step">
                        <div class="step-num">3</div>
                        <div><strong>Atome zählen:</strong> Links: Li=1, O=2 | Rechts: Li=2, O=1</div>
                    </div>

                    <div class="algorithm-step">
                        <div class="step-num">4</div>
                        <div>
                            <strong>Vorfaktoren ausgleichen:</strong><br>
                            a) Produkt verdoppeln, bis O-Zahl gerade: Li<sub>2</sub>O hat 1 O → 2 Li<sub>2</sub>O hat 2 O<br>
                            b) O<sub>2</sub>-Anzahl = O rechts ÷ 2 = 1<br>
                            c) Metall-Anzahl = Metall-Atome rechts = 4<br>
                            ⇒ <strong>4</strong> Li + <strong>1</strong> O<sub>2</sub> → <strong>2</strong> Li<sub>2</sub>O<br>
                            d) <strong>Kontrolle:</strong> Li: 4=4 ✓, O: 2=2 ✓
                        </div>
                    </div>
                </div>

                <!-- Interaktive Animation: Vorfaktoren ausgleichen -->
                <div class="balance-anim" id="balance-anim-al">
                    <h4>Animation: Vorfaktoren schrittweise ausgleichen (Aluminium)</h4>

                    <div class="info-box" style="font-size: 0.9em; margin: 10px 0;">
                        <strong>Tipp:</strong> Klicke dich Schritt für Schritt durch die Animation, um das Ausgleichen zu verstehen!
                    </div>

                    <div class="equation-display" id="eq-display-al">
                        <!-- Wird durch JavaScript gefüllt -->
                    </div>

                    <div class="balance-step-info" id="balance-info-al">
                        Klicke "Weiter" um zu starten.
                    </div>

                    <div class="balance-status checking" id="balance-status-al">
                        Noch nicht ausgeglichen
                    </div>

                    <div class="balance-controls">
                        <button class="btn btn-secondary" onclick="balanceReset()">Neustart</button>
                        <button class="btn btn-secondary" id="balance-back-btn" onclick="balanceBack()" disabled>Zurück</button>
                        <button class="btn" id="balance-next-btn" onclick="balanceNext()">Weiter</button>
                    </div>
                </div>

                <div class="hefter-hinweis">
                    <strong>→ AB Algorithmus 1 + 2:</strong> Fülle die Lücken im Lithium-Beispiel aus (Atomzahlen + Vorfaktoren).
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="prevStep(4)"><- Zurück</button>
                    <button class="btn btn-success" onclick="nextStep(6)">Weiter -></button>
                </div>
            </div>
        </div>

        <!-- ========== SCHRITT 6: Übung Mg ========== -->
        <div class="step" id="step6">
            <div class="step-header">Schritt 6: Übung – Magnesium (beide Algorithmen)</div>
            <div class="step-content">
                <p>Jetzt bist du dran! Wende <strong>beide Algorithmen</strong> auf <strong>Magnesium</strong> an.</p>

                <div class="exercise">
                    <div class="exercise-title">Magnesium + Sauerstoff → Magnesiumoxid (einfacher Fall)</div>

                    <p><strong>Algorithmus 1: Verhältnisformel</strong></p>
                    <p>Wertigkeiten: Mg =
                        <select id="ex6-w1" onchange="saveAnswer('ex6-w1')">
                            <option value="">--</option>
                            <option value="1">I</option>
                            <option value="2">II</option>
                            <option value="3">III</option>
                        </select>, O =
                        <select id="ex6-w2" onchange="saveAnswer('ex6-w2')">
                            <option value="">--</option>
                            <option value="1">I</option>
                            <option value="2">II</option>
                            <option value="3">III</option>
                        </select>
                    </p>

                    <p>Kreuzregel: Mg<sub><input type="text" class="inline-input" id="ex6-f1" style="width: 25px;" onchange="saveAnswer('ex6-f1')"></sub>O<sub><input type="text" class="inline-input" id="ex6-f2" style="width: 25px;" onchange="saveAnswer('ex6-f2')"></sub>
                    <span style="font-size: 0.85em; color: var(--text-muted);">(Index 1 = leer lassen)</span></p>

                    <button class="btn" onclick="checkEx6Step1()">Schritt 1 prüfen</button>
                    <div class="feedback" id="feedback6-step1"></div>

                    <hr style="margin: 15px 0;">

                    <p><strong>Algorithmus 2: Reaktionsgleichung schrittweise</strong></p>

                    <!-- Interaktive Gleichungsanzeige -->
                    <div class="balance-anim" id="mg-exercise">
                        <h4>Gleichung ausgleichen – du gibst die Werte ein!</h4>

                        <!-- Visuelle Gleichung -->
                        <div class="equation-display" id="mg-eq-display">
                            <div class="eq-element">
                                <div class="eq-formula" id="mg-metal-box">
                                    <span class="eq-coef" id="mg-coef-metal"></span><span style="color: var(--metal);">Mg</span>
                                </div>
                                <div class="eq-counts">
                                    <span class="eq-count metal" id="mg-count-metal-l">?</span>
                                </div>
                            </div>
                            <div class="eq-plus">+</div>
                            <div class="eq-element">
                                <div class="eq-formula" id="mg-o2-box">
                                    <span class="eq-coef" id="mg-coef-o2"></span><span style="color: var(--oxygen);">O<sub>2</sub></span>
                                </div>
                                <div class="eq-counts">
                                    <span class="eq-count oxygen" id="mg-count-o-l">?</span>
                                </div>
                            </div>
                            <div class="eq-arrow">→</div>
                            <div class="eq-element">
                                <div class="eq-formula" id="mg-product-box">
                                    <span class="eq-coef" id="mg-coef-product"></span><span style="color: var(--metal);">Mg</span><span style="color: var(--oxygen);">O</span>
                                </div>
                                <div class="eq-counts">
                                    <span class="eq-count metal" id="mg-count-metal-r">?</span>
                                    <span class="eq-count oxygen" id="mg-count-o-r">?</span>
                                </div>
                            </div>
                        </div>

                        <div class="balance-status checking" id="mg-status">
                            Starte mit dem Zählen der Atome
                        </div>

                        <!-- Schritt-für-Schritt Eingaben -->
                        <div id="mg-step-0" class="mg-input-step">
                            <div class="balance-step-info">
                                <strong>Start:</strong> Zähle die Atome auf beiden Seiten.
                            </div>
                            <p style="margin: 10px 0;">
                                Mg links: <input type="text" class="inline-input" id="mg-in-metal-l" style="width: 40px;" onchange="saveAnswer('mg-in-metal-l')">
                                O links: <input type="text" class="inline-input" id="mg-in-o-l" style="width: 40px;" onchange="saveAnswer('mg-in-o-l')">
                                | Mg rechts: <input type="text" class="inline-input" id="mg-in-metal-r" style="width: 40px;" onchange="saveAnswer('mg-in-metal-r')">
                                O rechts: <input type="text" class="inline-input" id="mg-in-o-r" style="width: 40px;" onchange="saveAnswer('mg-in-o-r')">
                            </p>
                            <button class="btn" onclick="checkMgStep0()">Atomzahlen prüfen</button>
                            <div class="feedback" id="mg-feedback-0"></div>
                        </div>

                        <div id="mg-step-1" class="mg-input-step hidden">
                            <div class="balance-step-info">
                                <strong>a) Produkt anpassen:</strong> O rechts soll = O links (2) sein.
                            </div>
                            <p style="margin: 10px 0;">
                                Vorfaktor für MgO: <input type="text" class="inline-input" id="mg-in-coef-product" style="width: 40px;" onchange="saveAnswer('mg-in-coef-product')">
                                <span style="font-size: 0.85em; color: var(--text-muted);">(Wie viele MgO für 2 O rechts?)</span>
                            </p>
                            <button class="btn" onclick="checkMgStep1()">Prüfen</button>
                            <div class="feedback" id="mg-feedback-1"></div>
                        </div>

                        <div id="mg-step-2" class="mg-input-step hidden">
                            <div class="balance-step-info">
                                <strong>b) Metall anpassen:</strong> Mg links = Mg rechts (jetzt 2).
                            </div>
                            <p style="margin: 10px 0;">
                                Vorfaktor für Mg: <input type="text" class="inline-input" id="mg-in-coef-metal" style="width: 40px;" onchange="saveAnswer('mg-in-coef-metal')">
                                <span style="font-size: 0.85em; color: var(--text-muted);">(Wie viele Mg links?)</span>
                            </p>
                            <button class="btn" onclick="checkMgStep2()">Prüfen</button>
                            <div class="feedback" id="mg-feedback-2"></div>
                        </div>

                        <div id="mg-step-done" class="mg-input-step hidden">
                            <div class="balance-step-info" style="background: var(--success-bg); border-left: 3px solid var(--success);">
                                <strong style="color: var(--success);">Geschafft!</strong> Die Gleichung ist ausgeglichen: 2 Mg + 1 O₂ → 2 MgO
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hefter-hinweis">
                    <strong>→ AB Aufgabe 3a (Magnesium):</strong> Übertrage alle Schritte und das Ergebnis.
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="prevStep(5)"><- Zurück</button>
                    <button class="btn btn-success" onclick="nextStep(7)">Weiter -></button>
                </div>
            </div>
        </div>

        <!-- ========== SCHRITT 7: Übung Fe ========== -->
        <div class="step" id="step7">
            <div class="step-header">Schritt 7: Übung – Eisen (beide Algorithmen)</div>
            <div class="step-content">
                <p>Jetzt eine schwierigere: <strong>Eisen</strong> (Wertigkeit III).</p>

                <div class="exercise">
                    <div class="exercise-title">Eisen + Sauerstoff → Eisenoxid (komplexer Fall)</div>

                    <p><strong>Algorithmus 1: Verhältnisformel</strong></p>
                    <p>Wertigkeiten: Fe =
                        <select id="ex7-w1" onchange="saveAnswer('ex7-w1')">
                            <option value="">--</option>
                            <option value="1">I</option>
                            <option value="2">II</option>
                            <option value="3">III</option>
                        </select>, O =
                        <select id="ex7-w2" onchange="saveAnswer('ex7-w2')">
                            <option value="">--</option>
                            <option value="1">I</option>
                            <option value="2">II</option>
                            <option value="3">III</option>
                        </select>
                    </p>

                    <p>Kreuzregel: Fe<sub><input type="text" class="inline-input" id="ex7-f1" style="width: 25px;" onchange="saveAnswer('ex7-f1')"></sub>O<sub><input type="text" class="inline-input" id="ex7-f2" style="width: 25px;" onchange="saveAnswer('ex7-f2')"></sub>
                    <span style="font-size: 0.85em; color: var(--text-muted);">(Wertigkeit kreuzen!)</span></p>

                    <button class="btn" onclick="checkEx7Step1()">Schritt 1 prüfen</button>
                    <div class="feedback" id="feedback7-step1"></div>

                    <hr style="margin: 15px 0;">

                    <p><strong>Algorithmus 2: Reaktionsgleichung schrittweise</strong></p>

                    <!-- Interaktive Gleichungsanzeige -->
                    <div class="balance-anim" id="fe-exercise">
                        <h4>Gleichung ausgleichen – du gibst die Werte ein!</h4>

                        <!-- Visuelle Gleichung -->
                        <div class="equation-display" id="fe-eq-display">
                            <div class="eq-element">
                                <div class="eq-formula" id="fe-metal-box">
                                    <span class="eq-coef" id="fe-coef-metal"></span><span style="color: var(--metal);">Fe</span>
                                </div>
                                <div class="eq-counts">
                                    <span class="eq-count metal" id="fe-count-metal-l">?</span>
                                </div>
                            </div>
                            <div class="eq-plus">+</div>
                            <div class="eq-element">
                                <div class="eq-formula" id="fe-o2-box">
                                    <span class="eq-coef" id="fe-coef-o2"></span><span style="color: var(--oxygen);">O<sub>2</sub></span>
                                </div>
                                <div class="eq-counts">
                                    <span class="eq-count oxygen" id="fe-count-o-l">?</span>
                                </div>
                            </div>
                            <div class="eq-arrow">→</div>
                            <div class="eq-element">
                                <div class="eq-formula" id="fe-product-box">
                                    <span class="eq-coef" id="fe-coef-product"></span><span style="color: var(--metal);">Fe<sub>2</sub></span><span style="color: var(--oxygen);">O<sub>3</sub></span>
                                </div>
                                <div class="eq-counts">
                                    <span class="eq-count metal" id="fe-count-metal-r">?</span>
                                    <span class="eq-count oxygen" id="fe-count-o-r">?</span>
                                </div>
                            </div>
                        </div>

                        <div class="balance-status checking" id="fe-status">
                            Starte mit dem Zählen der Atome
                        </div>

                        <!-- Schritt-für-Schritt Eingaben -->
                        <div id="fe-step-0" class="mg-input-step">
                            <div class="balance-step-info">
                                <strong>Start:</strong> Zähle die Atome auf beiden Seiten.
                            </div>
                            <p style="margin: 10px 0;">
                                Fe links: <input type="text" class="inline-input" id="fe-in-metal-l" style="width: 40px;" onchange="saveAnswer('fe-in-metal-l')">
                                O links: <input type="text" class="inline-input" id="fe-in-o-l" style="width: 40px;" onchange="saveAnswer('fe-in-o-l')">
                                | Fe rechts: <input type="text" class="inline-input" id="fe-in-metal-r" style="width: 40px;" onchange="saveAnswer('fe-in-metal-r')">
                                O rechts: <input type="text" class="inline-input" id="fe-in-o-r" style="width: 40px;" onchange="saveAnswer('fe-in-o-r')">
                            </p>
                            <button class="btn" onclick="checkFeStep0()">Atomzahlen prüfen</button>
                            <div class="feedback" id="fe-feedback-0"></div>
                        </div>

                        <div id="fe-step-1" class="mg-input-step hidden">
                            <div class="balance-step-info">
                                <strong>a) Produkt anpassen:</strong> O rechts soll gerade sein (kgV von 2 und 3 = 6).
                            </div>
                            <p style="margin: 10px 0;">
                                Vorfaktor für Fe<sub>2</sub>O<sub>3</sub>: <input type="text" class="inline-input" id="fe-in-coef-product" style="width: 40px;" onchange="saveAnswer('fe-in-coef-product')">
                                <span style="font-size: 0.85em; color: var(--text-muted);">(Wie viele Fe₂O₃ für 6 O?)</span>
                            </p>
                            <button class="btn" onclick="checkFeStep1()">Prüfen</button>
                            <div class="feedback" id="fe-feedback-1"></div>
                        </div>

                        <div id="fe-step-2" class="mg-input-step hidden">
                            <div class="balance-step-info">
                                <strong>b) O<sub>2</sub> anpassen:</strong> O links = O rechts (6).
                            </div>
                            <p style="margin: 10px 0;">
                                Vorfaktor für O<sub>2</sub>: <input type="text" class="inline-input" id="fe-in-coef-o2" style="width: 40px;" onchange="saveAnswer('fe-in-coef-o2')">
                                <span style="font-size: 0.85em; color: var(--text-muted);">(Wie viele O₂ für 6 O links?)</span>
                            </p>
                            <button class="btn" onclick="checkFeStep2()">Prüfen</button>
                            <div class="feedback" id="fe-feedback-2"></div>
                        </div>

                        <div id="fe-step-3" class="mg-input-step hidden">
                            <div class="balance-step-info">
                                <strong>c) Metall anpassen:</strong> Fe links = Fe rechts (jetzt 4).
                            </div>
                            <p style="margin: 10px 0;">
                                Vorfaktor für Fe: <input type="text" class="inline-input" id="fe-in-coef-metal" style="width: 40px;" onchange="saveAnswer('fe-in-coef-metal')">
                                <span style="font-size: 0.85em; color: var(--text-muted);">(Wie viele Fe links?)</span>
                            </p>
                            <button class="btn" onclick="checkFeStep3()">Prüfen</button>
                            <div class="feedback" id="fe-feedback-3"></div>
                        </div>

                        <div id="fe-step-done" class="mg-input-step hidden">
                            <div class="balance-step-info" style="background: var(--success-bg); border-left: 3px solid var(--success);">
                                <strong style="color: var(--success);">Geschafft!</strong> Die Gleichung ist ausgeglichen: 4 Fe + 3 O₂ → 2 Fe₂O₃
                            </div>
                        </div>
                    </div>
                </div>

                <div class="hefter-hinweis">
                    <strong>→ AB Aufgabe 3b (Eisen):</strong> Übertrage alle Schritte und das Ergebnis.
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="prevStep(6)"><- Zurück</button>
                    <button class="btn btn-success" onclick="nextStep(8)">Weiter -></button>
                </div>
            </div>
        </div>

        <!-- ========== SCHRITT 8: Zusammenfassung ========== -->
        <div class="step" id="step8">
            <div class="step-header">Schritt 8: Zusammenfassung</div>
            <div class="step-content">
                <div class="merke-box">
                    <p><strong>Die zwei Algorithmen:</strong></p>
                    <p><strong>Algorithmus 1: Verhältnisformel</strong></p>
                    <ol>
                        <li>Elementsymbole aufschreiben</li>
                        <li>Wertigkeiten ablesen</li>
                        <li>Kreuzregel anwenden</li>
                    </ol>
                    <p style="margin-top: 10px;"><strong>Algorithmus 2: Reaktionsgleichung</strong></p>
                    <ol>
                        <li>Wortgleichung</li>
                        <li>Formelgleichung (mit O<sub>2</sub>!)</li>
                        <li>Atome zählen</li>
                        <li>Vorfaktoren ausgleichen:<br>
                            a) Produkt verdoppeln, bis O-Zahl gerade<br>
                            b) O<sub>2</sub>-Anzahl = O rechts ÷ 2<br>
                            c) Metall-Anzahl = Metall-Atome rechts<br>
                            d) Kontrolle</li>
                    </ol>
                </div>

                <h4>Wichtige Regeln:</h4>
                <ul>
                    <li><strong>Index</strong> (tiefgestellt) ändert den STOFF -> MgO ≠ MgO<sub>2</sub></li>
                    <li><strong>Vorfaktor</strong> (vor der Formel) ändert nur die MENGE -> 2 MgO = zwei Mal MgO</li>
                    <li>Sauerstoff ist immer <strong>O<sub>2</sub></strong> (zweiatomig)</li>
                    <li>Atome links = Atome rechts (Massenerhaltung)</li>
                </ul>

                <div class="science-box">
                    <strong>Warum funktioniert das?</strong> Bei Metalloxiden geben Metalle Elektronen ab und werden zu positiven Ionen. Sauerstoff nimmt diese Elektronen auf und wird zum negativen Ion. Die entgegengesetzten Ladungen ziehen sich an - das ist die Ionenbindung!
                </div>

                <div class="info-box" style="background: var(--success-bg); border-color: var(--success);">
                    <strong>Geschafft!</strong><br>
                    Du hast beide Algorithmen gelernt. Vervollständige jetzt dein Arbeitsblatt.
                </div>

                <div class="hefter-hinweis">
                    <strong>→ AB vervollständigen:</strong>
                    <ul style="margin: 5px 0 0 15px;">
                        <li><strong>Aufgabe 3c (Aluminium)</strong> – selbstständig lösen</li>
                        <li><strong>Aufgabe 3d (Kupfer)</strong> – selbstständig lösen</li>
                        <li>Aufgabe 4 + 5 – für Schnelle (★★★)</li>
                    </ul>
                </div>

                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="prevStep(7)"><- Zurück</button>
                    <button class="btn" onclick="resetProgress()">Fortschritt zurücksetzen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ════════════════════════════════════════════════════════════════
    // LERNPFAD LOGIK (ES5)
    // ════════════════════════════════════════════════════════════════

    var TOTAL_STEPS = 8;
    var STORAGE_KEY = 'lp-chemie-8-reaktionsgleichungen';

    var currentStep = 1;
    var visitedSteps = [];

    // ───────────────────────────────────────────────────────────────
    // PROGRESS & STEP-INDICATORS
    // ───────────────────────────────────────────────────────────────
    function updateProgress() {
        var percent = ((currentStep - 1) / (TOTAL_STEPS - 1)) * 100;
        document.getElementById('progressFill').style.width = percent + '%';
    }

    function generateStepIndicators() {
        var container = document.getElementById('stepIndicators');
        container.innerHTML = '';
        for (var i = 1; i <= TOTAL_STEPS; i++) {
            var dot = document.createElement('div');
            dot.className = 'step-dot';
            if (i === currentStep) dot.classList.add('current');
            if (visitedSteps.indexOf(i) !== -1) dot.classList.add('completed');
            dot.textContent = i;
            dot.setAttribute('data-step', i);
            dot.onclick = function() {
                var stepIndex = parseInt(this.getAttribute('data-step'));
                showStep(stepIndex);
            };
            container.appendChild(dot);
        }
    }

    function updateStepIndicators() {
        var dots = document.querySelectorAll('.step-dot');
        for (var i = 0; i < dots.length; i++) {
            var stepNum = i + 1;
            dots[i].classList.remove('current');
            if (stepNum === currentStep) {
                dots[i].classList.add('current');
            }
            if (visitedSteps.indexOf(stepNum) !== -1) {
                dots[i].classList.add('completed');
            }
        }
    }

    // ───────────────────────────────────────────────────────────────
    // NAVIGATION
    // ───────────────────────────────────────────────────────────────
    function showStep(n) {
        if (visitedSteps.indexOf(currentStep) === -1) {
            visitedSteps.push(currentStep);
        }

        for (var i = 1; i <= TOTAL_STEPS; i++) {
            var step = document.getElementById('step' + i);
            if (step) step.classList.remove('active');
        }
        var targetStep = document.getElementById('step' + n);
        if (targetStep) {
            targetStep.classList.add('active');
            currentStep = n;
            updateProgress();
            updateStepIndicators();
            saveProgress();
            window.scrollTo(0, 0);
        }
    }

    function nextStep(n) { showStep(n); }
    function prevStep(n) { showStep(n); }

    // ───────────────────────────────────────────────────────────────
    // ÜBUNGEN PRÜFEN
    // ───────────────────────────────────────────────────────────────

    function checkEx2() {
        var c1 = document.getElementById('ex2-1').value === '2';
        var c2 = document.getElementById('ex2-2').value === '3';
        var c3 = document.getElementById('ex2-3').value === '2';
        var b1 = document.getElementById('ex2-1b').value.trim() === '2';
        var b2 = document.getElementById('ex2-2b').value.trim() === '3';
        var b3 = document.getElementById('ex2-3b').value.trim() === '2';
        var fb = document.getElementById('feedback2');
        if (c1 && c2 && c3 && b1 && b2 && b3) {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! Ca(II) gibt 2 e⁻ ab, Al(III) gibt 3 e⁻ ab, O(II) nimmt 2 e⁻ auf.';
        } else if (c1 && c2 && c3) {
            fb.className = 'feedback hint';
            fb.textContent = 'Wertigkeiten stimmen! Jetzt ergänze die Elektronenzahlen: Wertigkeit = Anzahl der Elektronen.';
        } else {
            fb.className = 'feedback incorrect';
            fb.textContent = '✗ Schau nochmal in die Tabelle: Ca(II), Al(III), O(II)';
        }
    }

    function checkEx3() {
        var v1 = document.getElementById('ex3-1').value.trim();
        var v2 = document.getElementById('ex3-2').value.trim();
        var v3 = document.getElementById('ex3-3').value.trim();
        var v4 = document.getElementById('ex3-4').value.trim();
        var fb = document.getElementById('feedback3');
        // CaO: Index 1 wird nicht geschrieben
        var ca1 = (v1 === '' || v1 === '1');
        var ca2 = (v2 === '' || v2 === '1');
        // Fe2O3: Index 2 und 3
        var fe1 = (v3 === '2');
        var fe2 = (v4 === '3');

        if (ca1 && ca2 && fe1 && fe2) {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Perfekt! CaO (1:1 bei gleicher Wertigkeit) und Fe₂O₃ (Kreuzregel bei III und II).';
        } else if (ca1 && ca2) {
            fb.className = 'feedback hint';
            fb.textContent = 'CaO stimmt! Bei Fe(III) + O(II): Wertigkeit von Fe (3) wird Index von O, Wertigkeit von O (2) wird Index von Fe.';
        } else if (fe1 && fe2) {
            fb.className = 'feedback hint';
            fb.textContent = 'Fe₂O₃ stimmt! Bei Ca(II) + O(II): gleiche Wertigkeit = 1:1. Index 1 wird nicht geschrieben.';
        } else {
            fb.className = 'feedback hint';
            fb.textContent = 'Tipp: Bei gleicher Wertigkeit ist das Verhältnis 1:1. Bei unterschiedlicher Wertigkeit: Kreuzregel!';
        }
    }

    function checkEx4() {
        var v1 = document.getElementById('ex4-1').value.trim();
        var v2 = document.getElementById('ex4-2').value.trim();
        var v3 = document.getElementById('ex4-3').value.trim();
        var v4 = document.getElementById('ex4-4').value.trim();
        var fb = document.getElementById('feedback4');
        if (v1 === '1' && v2 === '1' && v3 === '2' && v4 === '1') {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! Links: 1 Mg, 2 O. Rechts: 1 Mg, 1 O. Die O-Atome sind nicht gleich - muss ausgeglichen werden!';
        } else {
            fb.className = 'feedback incorrect';
            fb.textContent = '✗ Zähle nochmal: Links steht Mg (1 Atom) und O₂ (2 Atome). Rechts steht MgO (1 Mg, 1 O).';
        }
    }

    // ─── ÜBUNG 6: MAGNESIUM (schrittweise) ───────────────────────
    function checkEx6Step1() {
        var w1 = document.getElementById('ex6-w1').value;
        var w2 = document.getElementById('ex6-w2').value;
        var f1 = document.getElementById('ex6-f1').value.trim();
        var f2 = document.getElementById('ex6-f2').value.trim();
        var fb = document.getElementById('feedback6-step1');

        var wertOk = (w1 === '2' && w2 === '2');
        var formelOk = ((f1 === '' || f1 === '1') && (f2 === '' || f2 === '1'));

        if (!wertOk) {
            fb.className = 'feedback hint';
            fb.textContent = 'Schau in die Tabelle: Mg(II), O(II).';
        } else if (!formelOk) {
            fb.className = 'feedback hint';
            fb.textContent = 'Bei gleicher Wertigkeit ist das Verhältnis 1:1. Index 1 wird nicht geschrieben (leer lassen).';
        } else {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! Mg(II) + O(II) → MgO (1:1 bei gleicher Wertigkeit)';
        }
    }

    // ─── ÜBUNG 6: MAGNESIUM INTERAKTIV ───────────────────────
    // Zustand der Mg-Übung: 0=Start, 1=Atomzahlen ok, 2=Produkt ok, 3=fertig
    var mgExStep = 0;

    function updateMgDisplay() {
        // Aktualisiert die visuelle Gleichungsanzeige basierend auf mgExStep
        var coefMetal = document.getElementById('mg-coef-metal');
        var coefO2 = document.getElementById('mg-coef-o2');
        var coefProduct = document.getElementById('mg-coef-product');
        var countMetalL = document.getElementById('mg-count-metal-l');
        var countOL = document.getElementById('mg-count-o-l');
        var countMetalR = document.getElementById('mg-count-metal-r');
        var countOR = document.getElementById('mg-count-o-r');
        var status = document.getElementById('mg-status');
        var metalBox = document.getElementById('mg-metal-box');
        var o2Box = document.getElementById('mg-o2-box');
        var productBox = document.getElementById('mg-product-box');

        // Reset highlights
        metalBox.classList.remove('highlight-metal', 'highlight-product', 'highlight-oxygen');
        o2Box.classList.remove('highlight-metal', 'highlight-product', 'highlight-oxygen');
        productBox.classList.remove('highlight-metal', 'highlight-product', 'highlight-oxygen');

        if (mgExStep === 0) {
            // Noch keine Eingaben
            coefMetal.textContent = '';
            coefO2.textContent = '';
            coefProduct.textContent = '';
            countMetalL.textContent = '?';
            countOL.textContent = '?';
            countMetalR.textContent = '?';
            countOR.textContent = '?';
            status.className = 'balance-status checking';
            status.textContent = 'Zähle die Atome!';
        } else if (mgExStep === 1) {
            // Atomzahlen eingegeben
            coefMetal.textContent = '';
            coefO2.textContent = '';
            coefProduct.textContent = '';
            countMetalL.textContent = '1';
            countOL.textContent = '2';
            countMetalR.textContent = '1';
            countOR.textContent = '1';
            status.className = 'balance-status checking';
            status.textContent = 'Mg: 1=1 ✓ | O: 2≠1 ✗ → Ausgleichen!';
            productBox.classList.add('highlight-product');
        } else if (mgExStep === 2) {
            // Produkt-Vorfaktor eingegeben
            coefMetal.textContent = '';
            coefO2.textContent = '';
            coefProduct.textContent = '2';
            coefProduct.classList.add('new');
            countMetalL.textContent = '1';
            countOL.textContent = '2';
            countMetalR.textContent = '2';
            countOR.textContent = '2';
            status.className = 'balance-status checking';
            status.textContent = 'Mg: 1≠2 ✗ | O: 2=2 ✓ → Metall anpassen!';
            metalBox.classList.add('highlight-metal');
        } else if (mgExStep === 3) {
            // Fertig!
            coefMetal.textContent = '2';
            coefMetal.classList.add('new');
            coefO2.textContent = '';
            coefProduct.textContent = '2';
            countMetalL.textContent = '2';
            countOL.textContent = '2';
            countMetalR.textContent = '2';
            countOR.textContent = '2';
            status.className = 'balance-status balanced';
            status.textContent = '✓ Ausgeglichen: Mg: 2=2 | O: 2=2';
        }
    }

    function checkMgStep0() {
        var ml = document.getElementById('mg-in-metal-l').value.trim();
        var ol = document.getElementById('mg-in-o-l').value.trim();
        var mr = document.getElementById('mg-in-metal-r').value.trim();
        var or = document.getElementById('mg-in-o-r').value.trim();
        var fb = document.getElementById('mg-feedback-0');

        if (ml === '1' && ol === '2' && mr === '1' && or === '1') {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! Mg: 1≠1, O: 2≠1 → Nicht ausgeglichen!';
            mgExStep = 1;
            updateMgDisplay();
            // Nächsten Schritt einblenden
            document.getElementById('mg-step-1').classList.remove('hidden');
        } else {
            fb.className = 'feedback hint';
            fb.textContent = 'Tipp: Links Mg=1, O₂ hat 2 O. Rechts MgO hat 1 Mg und 1 O.';
        }
    }

    function checkMgStep1() {
        var v = document.getElementById('mg-in-coef-product').value.trim();
        var fb = document.getElementById('mg-feedback-1');

        if (v === '2') {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! 2 × MgO = 2 Mg + 2 O. Jetzt stimmt O (2=2), aber Mg nicht mehr!';
            mgExStep = 2;
            updateMgDisplay();
            // Nächsten Schritt einblenden
            document.getElementById('mg-step-2').classList.remove('hidden');
        } else {
            fb.className = 'feedback hint';
            fb.textContent = 'MgO hat 1 O. Wie viele MgO brauchst du für 2 O (wie O₂ links)?';
        }
    }

    function checkMgStep2() {
        var v = document.getElementById('mg-in-coef-metal').value.trim();
        var fb = document.getElementById('mg-feedback-2');

        if (v === '2') {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Perfekt! 2 Mg + 1 O₂ → 2 MgO ist ausgeglichen!';
            mgExStep = 3;
            updateMgDisplay();
            // Fertig-Meldung einblenden
            document.getElementById('mg-step-done').classList.remove('hidden');
        } else {
            fb.className = 'feedback hint';
            fb.textContent = 'Mit 2 MgO hast du rechts 2 Mg. Wie viele Mg brauchst du links?';
        }
    }

    // ─── ÜBUNG 7: EISEN (schrittweise) ───────────────────────────
    function checkEx7Step1() {
        var w1 = document.getElementById('ex7-w1').value;
        var w2 = document.getElementById('ex7-w2').value;
        var f1 = document.getElementById('ex7-f1').value.trim();
        var f2 = document.getElementById('ex7-f2').value.trim();
        var fb = document.getElementById('feedback7-step1');

        var wertOk = (w1 === '3' && w2 === '2');
        var formelOk = (f1 === '2' && f2 === '3');

        if (!wertOk) {
            fb.className = 'feedback hint';
            fb.textContent = 'Eisen hat hier Wertigkeit III (angegeben), O hat Wertigkeit II (Tabelle).';
        } else if (!formelOk) {
            fb.className = 'feedback hint';
            fb.textContent = 'Kreuzregel: Fe(III) → Index 3 bei O, O(II) → Index 2 bei Fe. Also Fe₂O₃.';
        } else {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! Fe(III) + O(II) → Fe₂O₃ (Kreuzregel)';
        }
    }

    // ─── ÜBUNG 7: EISEN INTERAKTIV ───────────────────────────
    // Zustand der Fe-Übung: 0=Start, 1=Atomzahlen ok, 2=Produkt ok, 3=O₂ ok, 4=fertig
    var feExStep = 0;

    function updateFeDisplay() {
        var coefMetal = document.getElementById('fe-coef-metal');
        var coefO2 = document.getElementById('fe-coef-o2');
        var coefProduct = document.getElementById('fe-coef-product');
        var countMetalL = document.getElementById('fe-count-metal-l');
        var countOL = document.getElementById('fe-count-o-l');
        var countMetalR = document.getElementById('fe-count-metal-r');
        var countOR = document.getElementById('fe-count-o-r');
        var status = document.getElementById('fe-status');
        var metalBox = document.getElementById('fe-metal-box');
        var o2Box = document.getElementById('fe-o2-box');
        var productBox = document.getElementById('fe-product-box');

        // Reset highlights
        metalBox.classList.remove('highlight-metal', 'highlight-product', 'highlight-oxygen');
        o2Box.classList.remove('highlight-metal', 'highlight-product', 'highlight-oxygen');
        productBox.classList.remove('highlight-metal', 'highlight-product', 'highlight-oxygen');

        if (feExStep === 0) {
            coefMetal.textContent = '';
            coefO2.textContent = '';
            coefProduct.textContent = '';
            countMetalL.textContent = '?';
            countOL.textContent = '?';
            countMetalR.textContent = '?';
            countOR.textContent = '?';
            status.className = 'balance-status checking';
            status.textContent = 'Zähle die Atome!';
        } else if (feExStep === 1) {
            // Atomzahlen eingegeben
            coefMetal.textContent = '';
            coefO2.textContent = '';
            coefProduct.textContent = '';
            countMetalL.textContent = '1';
            countOL.textContent = '2';
            countMetalR.textContent = '2';
            countOR.textContent = '3';
            status.className = 'balance-status checking';
            status.textContent = 'Fe: 1≠2 ✗ | O: 2≠3 ✗ → Ausgleichen!';
            productBox.classList.add('highlight-product');
        } else if (feExStep === 2) {
            // Produkt-Vorfaktor eingegeben (2 × Fe₂O₃)
            coefMetal.textContent = '';
            coefO2.textContent = '';
            coefProduct.textContent = '2';
            coefProduct.classList.add('new');
            countMetalL.textContent = '1';
            countOL.textContent = '2';
            countMetalR.textContent = '4';
            countOR.textContent = '6';
            status.className = 'balance-status checking';
            status.textContent = 'Fe: 1≠4 ✗ | O: 2≠6 ✗ → O₂ anpassen!';
            o2Box.classList.add('highlight-oxygen');
        } else if (feExStep === 3) {
            // O₂-Vorfaktor eingegeben (3 × O₂)
            coefMetal.textContent = '';
            coefO2.textContent = '3';
            coefO2.classList.add('new');
            coefProduct.textContent = '2';
            countMetalL.textContent = '1';
            countOL.textContent = '6';
            countMetalR.textContent = '4';
            countOR.textContent = '6';
            status.className = 'balance-status checking';
            status.textContent = 'Fe: 1≠4 ✗ | O: 6=6 ✓ → Metall anpassen!';
            metalBox.classList.add('highlight-metal');
        } else if (feExStep === 4) {
            // Fertig!
            coefMetal.textContent = '4';
            coefMetal.classList.add('new');
            coefO2.textContent = '3';
            coefProduct.textContent = '2';
            countMetalL.textContent = '4';
            countOL.textContent = '6';
            countMetalR.textContent = '4';
            countOR.textContent = '6';
            status.className = 'balance-status balanced';
            status.textContent = '✓ Ausgeglichen: Fe: 4=4 | O: 6=6';
        }
    }

    function checkFeStep0() {
        var ml = document.getElementById('fe-in-metal-l').value.trim();
        var ol = document.getElementById('fe-in-o-l').value.trim();
        var mr = document.getElementById('fe-in-metal-r').value.trim();
        var or = document.getElementById('fe-in-o-r').value.trim();
        var fb = document.getElementById('fe-feedback-0');

        if (ml === '1' && ol === '2' && mr === '2' && or === '3') {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! Fe: 1≠2, O: 2≠3 → Nicht ausgeglichen!';
            feExStep = 1;
            updateFeDisplay();
            document.getElementById('fe-step-1').classList.remove('hidden');
        } else {
            fb.className = 'feedback hint';
            fb.textContent = 'Tipp: Links Fe=1, O₂ hat 2 O. Rechts Fe₂O₃ hat 2 Fe und 3 O.';
        }
    }

    function checkFeStep1() {
        var v = document.getElementById('fe-in-coef-product').value.trim();
        var fb = document.getElementById('fe-feedback-1');

        if (v === '2') {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! 2 × Fe₂O₃ = 4 Fe + 6 O. Jetzt O₂ anpassen!';
            feExStep = 2;
            updateFeDisplay();
            document.getElementById('fe-step-2').classList.remove('hidden');
        } else {
            fb.className = 'feedback hint';
            fb.textContent = 'Fe₂O₃ hat 3 O. kgV von 2 und 3 ist 6. Wie viele Fe₂O₃ für 6 O?';
        }
    }

    function checkFeStep2() {
        var v = document.getElementById('fe-in-coef-o2').value.trim();
        var fb = document.getElementById('fe-feedback-2');

        if (v === '3') {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Richtig! 3 × O₂ = 6 O. O ist ausgeglichen (6=6)! Jetzt Fe anpassen!';
            feExStep = 3;
            updateFeDisplay();
            document.getElementById('fe-step-3').classList.remove('hidden');
        } else {
            fb.className = 'feedback hint';
            fb.textContent = 'O₂ hat 2 O. Du brauchst 6 O links. Also: 6 ÷ 2 = ?';
        }
    }

    function checkFeStep3() {
        var v = document.getElementById('fe-in-coef-metal').value.trim();
        var fb = document.getElementById('fe-feedback-3');

        if (v === '4') {
            fb.className = 'feedback correct';
            fb.textContent = '✓ Perfekt! 4 Fe + 3 O₂ → 2 Fe₂O₃ ist ausgeglichen!';
            feExStep = 4;
            updateFeDisplay();
            document.getElementById('fe-step-done').classList.remove('hidden');
        } else {
            fb.className = 'feedback hint';
            fb.textContent = 'Mit 2 × Fe₂O₃ hast du rechts 4 Fe (2×2). Wie viele Fe brauchst du links?';
        }
    }

    // ───────────────────────────────────────────────────────────────
    // PERSISTENZ
    // ───────────────────────────────────────────────────────────────
    function saveProgress() {
        try {
            localStorage.setItem(STORAGE_KEY + '-step', currentStep);
            localStorage.setItem(STORAGE_KEY + '-visited', JSON.stringify(visitedSteps));
            var inputs = document.querySelectorAll('input, select');
            for (var i = 0; i < inputs.length; i++) {
                var el = inputs[i];
                if (el.id) {
                    localStorage.setItem(STORAGE_KEY + '-' + el.id, el.value);
                }
            }
        } catch (e) {}
    }

    function saveAnswer(id) {
        saveProgress();
    }

    function loadProgress() {
        try {
            var savedVisited = localStorage.getItem(STORAGE_KEY + '-visited');
            if (savedVisited) visitedSteps = JSON.parse(savedVisited);
            var savedStep = localStorage.getItem(STORAGE_KEY + '-step');
            if (savedStep) currentStep = parseInt(savedStep);
            var inputs = document.querySelectorAll('input, select');
            for (var i = 0; i < inputs.length; i++) {
                var el = inputs[i];
                if (el.id) {
                    var saved = localStorage.getItem(STORAGE_KEY + '-' + el.id);
                    if (saved) el.value = saved;
                }
            }
        } catch (e) {}
    }

    function resetProgress() {
        if (!confirm('Fortschritt wirklich zurücksetzen?')) return;
        try {
            var keys = [];
            for (var i = 0; i < localStorage.length; i++) {
                if (localStorage.key(i).indexOf(STORAGE_KEY) === 0) {
                    keys.push(localStorage.key(i));
                }
            }
            for (var j = 0; j < keys.length; j++) {
                localStorage.removeItem(keys[j]);
            }
        } catch (e) {}
        location.reload();
    }

    document.addEventListener('change', saveProgress);

    // ───────────────────────────────────────────────────────────────
    // VORFAKTOR-ANIMATION (Al + O₂ → Al₂O₃)
    // ───────────────────────────────────────────────────────────────

    var balanceStep = 0;

    // Animations-Schritte: [coefAl, coefO2, coefAl2O3, highlightClass, infoText]
    var balanceSteps = [
        // Schritt 0: Start
        {
            coefs: [1, 1, 1],
            counts: { alL: 1, oL: 2, alR: 2, oR: 3 },
            highlight: null,
            info: '<strong>Start:</strong> Al + O<sub>2</sub> → Al<sub>2</sub>O<sub>3</sub><br>Atombilanz: Al 1≠2, O 2≠3 → nicht ausgeglichen!'
        },
        // Schritt 1: Produkt verdoppeln (kgV von 2 und 3 ist 6, also 2×Al₂O₃)
        {
            coefs: [1, 1, 2],
            counts: { alL: 1, oL: 2, alR: 4, oR: 6 },
            crossed: { oR: 3 },
            highlight: 'product',
            info: '<strong style="color: var(--accent);">Produkt verdoppeln:</strong> 2 × Al<sub>2</sub>O<sub>3</sub> hat 6 O (kgV von 2 und 3)<br>Neu: Al 1≠4, O 2≠6'
        },
        // Schritt 2: O₂ anpassen (6÷2=3)
        {
            coefs: [1, 3, 2],
            counts: { alL: 1, oL: 6, alR: 4, oR: 6 },
            crossed: { oL: 2 },
            highlight: 'oxygen',
            info: '<strong style="color: var(--oxygen);">O<sub>2</sub> anpassen:</strong> 3 × O<sub>2</sub> = 6 O (wie rechts)<br>Neu: Al 1≠4, <span style="color: var(--success); font-weight: bold;">O 6=6 ✓</span>'
        },
        // Schritt 3: Al anpassen
        {
            coefs: [4, 3, 2],
            counts: { alL: 4, oL: 6, alR: 4, oR: 6 },
            crossed: { alL: 1 },
            highlight: 'metal',
            info: '<strong style="color: var(--metal);">Al anpassen:</strong> 4 Al (wie rechts)<br><span style="color: var(--success); font-weight: bold;">Al 4=4 ✓, O 6=6 ✓ → Ausgeglichen!</span>'
        }
    ];

    function renderBalanceEquation() {
        var s = balanceSteps[balanceStep];
        var container = document.getElementById('eq-display-al');
        var html = '';

        // Al (Metall)
        var alHL = balanceStep === 3 ? ' highlight-metal' : '';
        var alCoef = s.coefs[0] > 1 ? '<span class="eq-coef new">' + s.coefs[0] + '</span>' : '';
        html += '<div class="eq-element">';
        html += '<div class="eq-formula' + alHL + '">' + alCoef + '<span style="color: var(--metal);">Al</span></div>';
        html += '<div class="eq-counts">';
        if (s.crossed && s.crossed.alL) {
            html += '<span class="eq-count metal crossed">' + s.crossed.alL + '</span>';
        }
        html += '<span class="eq-count metal' + (s.crossed && s.crossed.alL ? ' updated' : '') + '">' + s.counts.alL + '</span>';
        html += '</div></div>';

        // +
        html += '<div class="eq-plus">+</div>';

        // O₂ (Sauerstoff)
        var o2HL = balanceStep === 2 ? ' highlight-oxygen' : '';
        var o2Coef = s.coefs[1] > 1 ? '<span class="eq-coef new">' + s.coefs[1] + '</span>' : '';
        html += '<div class="eq-element">';
        html += '<div class="eq-formula' + o2HL + '">' + o2Coef + '<span style="color: var(--oxygen);">O<sub>2</sub></span></div>';
        html += '<div class="eq-counts">';
        if (s.crossed && s.crossed.oL) {
            html += '<span class="eq-count oxygen crossed">' + s.crossed.oL + '</span>';
        }
        html += '<span class="eq-count oxygen' + (s.crossed && s.crossed.oL ? ' updated' : '') + '">' + s.counts.oL + '</span>';
        html += '</div></div>';

        // →
        html += '<div class="eq-arrow">→</div>';

        // Al₂O₃ (Produkt)
        var prodHL = balanceStep === 1 ? ' highlight-product' : '';
        var prodCoef = s.coefs[2] > 1 ? '<span class="eq-coef new">' + s.coefs[2] + '</span>' : '';
        html += '<div class="eq-element">';
        html += '<div class="eq-formula' + prodHL + '">' + prodCoef + '<span style="color: var(--metal);">Al<sub>2</sub></span><span style="color: var(--oxygen);">O<sub>3</sub></span></div>';
        html += '<div class="eq-counts">';
        if (s.crossed && s.crossed.alR) {
            html += '<span class="eq-count metal crossed">' + s.crossed.alR + '</span>';
        }
        html += '<span class="eq-count metal">' + s.counts.alR + '</span>';
        if (s.crossed && s.crossed.oR) {
            html += '<span class="eq-count oxygen crossed">' + s.crossed.oR + '</span>';
        }
        html += '<span class="eq-count oxygen' + (s.crossed && s.crossed.oR ? ' updated' : '') + '">' + s.counts.oR + '</span>';
        html += '</div></div>';

        container.innerHTML = html;

        // Info-Text
        document.getElementById('balance-info-al').innerHTML = s.info;

        // Status
        var status = document.getElementById('balance-status-al');
        if (balanceStep === balanceSteps.length - 1) {
            status.className = 'balance-status balanced';
            status.textContent = '✓ Ausgeglichen: 4 Al + 3 O₂ → 2 Al₂O₃';
        } else {
            status.className = 'balance-status checking';
            var alMatch = s.counts.alL === s.counts.alR;
            var oMatch = s.counts.oL === s.counts.oR;
            status.textContent = 'Al: ' + s.counts.alL + (alMatch ? '=' : '≠') + s.counts.alR +
                               ' | O: ' + s.counts.oL + (oMatch ? '=' : '≠') + s.counts.oR;
        }
    }

    function balanceNext() {
        if (balanceStep < balanceSteps.length - 1) {
            balanceStep++;
            renderBalanceEquation();
            updateBalanceButtons();
        }
    }

    function balanceBack() {
        if (balanceStep > 0) {
            balanceStep--;
            renderBalanceEquation();
            updateBalanceButtons();
        }
    }

    function balanceReset() {
        balanceStep = 0;
        renderBalanceEquation();
        updateBalanceButtons();
    }

    function updateBalanceButtons() {
        var backBtn = document.getElementById('balance-back-btn');
        var nextBtn = document.getElementById('balance-next-btn');

        // Zurück-Button: disabled wenn am Anfang
        backBtn.disabled = (balanceStep === 0);

        // Weiter-Button: disabled und Text ändern wenn am Ende
        if (balanceStep === balanceSteps.length - 1) {
            nextBtn.textContent = 'Fertig!';
            nextBtn.disabled = true;
        } else {
            nextBtn.textContent = 'Weiter';
            nextBtn.disabled = false;
        }
    }

    // ───────────────────────────────────────────────────────────────
    // INIT
    // ───────────────────────────────────────────────────────────────
    loadProgress();
    generateStepIndicators();
    updateProgress();
    renderBalanceEquation();
    updateBalanceButtons();
    updateMgDisplay();
    updateFeDisplay();

    if (currentStep > 1) {
        for (var i = 1; i <= TOTAL_STEPS; i++) {
            var step = document.getElementById('step' + i);
            if (step) step.classList.remove('active');
        }
        var targetStep = document.getElementById('step' + currentStep);
        if (targetStep) {
            targetStep.classList.add('active');
            updateStepIndicators();
        }
    }
    </script>
</body>
</html>
