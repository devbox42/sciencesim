<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stundenleistung: Elektromagnetismus & Lorentzkraft</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            color: #222;
            font-size: 16px;
            line-height: 1.5;
        }
        .container {
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #2c5aa0;
            color: white;
            padding: 15px 20px;
        }
        header h1 {
            font-size: 1.3em;
            font-weight: 600;
        }
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        .header-info .meta {
            font-size: 0.85em;
            opacity: 0.9;
        }
        .progress-container {
            background: white;
            padding: 10px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .progress-bar {
            flex: 1;
            background: #e0e0e0;
            height: 8px;
        }
        .progress-fill {
            background: #2c5aa0;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 0.85em;
            color: #666;
            min-width: 120px;
        }
        .question {
            background: white;
            border: 1px solid #ddd;
            margin: 15px 0;
            padding: 20px;
        }
        .niveau-hinweis {
            background: #fff3e0;
            border: 1px solid #b35c00;
            color: #b35c00;
            padding: 8px 12px;
            margin-bottom: 12px;
            font-size: 0.85em;
            font-style: italic;
        }
        .nicht-gewertet-box {
            background: #f5f5f5;
            border: 1px solid #888;
            color: #666;
            padding: 10px 15px;
            margin-top: 12px;
            text-align: center;
            font-weight: 600;
        }
        .question-result {
            display: inline-block;
            padding: 3px 10px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }
        .question-result.full { background: #e8f5e9; color: #2a7a4b; }
        .question-result.partial { background: #fff3e0; color: #b35c00; }
        .question-result.zero { background: #ffebee; color: #c62828; }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .question-title {
            color: #2c5aa0;
            font-weight: 600;
            font-size: 1em;
        }
        .question-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .question-niveau {
            padding: 2px 8px;
            font-size: 0.8em;
            font-weight: 600;
            border-radius: 3px;
        }
        .niveau-1 { background: #e8f5e9; color: #2a7a4b; }
        .niveau-2 { background: #e3f2fd; color: #2c5aa0; }
        .niveau-3 { background: #f3e5f5; color: #7b1fa2; }
        .question-points {
            background: #f0f0f0;
            padding: 3px 10px;
            font-size: 0.8em;
            color: #666;
        }
        .question-text {
            margin-bottom: 15px;
        }
        .options {
            margin: 10px 0;
        }
        .option {
            display: block;
            padding: 12px 15px;
            margin: 6px 0;
            background: #fafafa;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.15s;
        }
        .option:hover {
            background: #f0f4f8;
            border-color: #2c5aa0;
        }
        .option.selected {
            background: #e3f2fd;
            border-color: #2c5aa0;
        }
        .option input {
            display: none;
        }
        .option.correct {
            background: #e8f5e9;
            border-color: #2a7a4b;
        }
        .option.incorrect {
            background: #ffebee;
            border-color: #c62828;
        }
        .option.missed {
            background: #fff8e1;
            border-color: #b35c00;
        }
        .multi-select .option {
            position: relative;
            padding-left: 40px;
        }
        .multi-select .option:before {
            content: "";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border: 2px solid #888;
            background: white;
        }
        .multi-select .option.selected:before {
            background: #2c5aa0;
            border-color: #2c5aa0;
        }
        .multi-select .option.selected:after {
            content: "\2713";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            line-height: 1;
        }
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .scenario {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .scenario.niveau-disabled {
            opacity: 0.4;
        }
        .scenario-label {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 8px;
            color: #2c5aa0;
        }
        .scenario svg {
            display: block;
            margin: 0 auto 10px;
        }
        .scenario select {
            width: 100%;
            padding: 8px;
            font-size: 0.9em;
        }
        .diagram {
            text-align: center;
            padding: 15px;
            background: #fafafa;
            margin: 10px 0;
        }
        .submit-section {
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            margin: 20px 0;
            text-align: center;
        }
        button {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1e4080;
        }
        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }
        button.btn-secondary {
            background: #666;
        }
        button.btn-success {
            background: #2a7a4b;
        }
        .results {
            background: white;
            border: 2px solid #2c5aa0;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }
        .results h2 {
            color: #2c5aa0;
            margin-bottom: 15px;
        }
        .results .score {
            font-size: 3em;
            font-weight: bold;
            color: #2c5aa0;
        }
        .results .grade {
            font-size: 1.5em;
            margin: 10px 0;
        }
        .grade-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.8em;
        }
        .grade-table th, .grade-table td {
            border: 1px solid #ddd;
            padding: 5px 6px;
            text-align: center;
        }
        .grade-table th {
            background: #2c5aa0;
            color: white;
        }
        .grade-table .current {
            background: #e8f5e9;
            font-weight: bold;
        }
        .feedback-box {
            padding: 12px 15px;
            margin: 10px 0;
            font-size: 0.9em;
            display: none;
        }
        .feedback-box.show {
            display: block;
        }
        .feedback-box.correct {
            background: #e8f5e9;
            border-left: 3px solid #2a7a4b;
        }
        .feedback-box.incorrect {
            background: #ffebee;
            border-left: 3px solid #c62828;
        }
        .hidden {
            display: none;
        }
        .symbol {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border: 2px solid #333;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
            vertical-align: middle;
        }
        .symbol-out { background: #e3f2fd; }
        .symbol-in { background: #ffebee; font-size: 20px; }
        select.correct { border-color: #2a7a4b; background: #e8f5e9; }
        select.incorrect { border-color: #c62828; background: #ffebee; }
        select.unanswered { border-color: #b35c00; background: #fff3e0; }
        .question.unanswered .question-header::after {
            content: " – nicht beantwortet";
            color: #b35c00;
            font-weight: normal;
            font-size: 0.85em;
        }
        @media print {
            button, .progress-container, .niveau-selection, .selection-row { display: none; }
            .question { page-break-inside: avoid; }
            .niveau-hinweis { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Stundenleistung: Elektromagnetismus & Lorentzkraft</h1>
        <div class="header-info">
            <div class="meta">Physik Klasse 9 | Differenziert (*/★★/★★★)</div>
        </div>
    </header>

    <!-- PLATZ + NIVEAU nebeneinander (dezent) -->
    <div class="selection-row" style="display: flex; gap: 20px; flex-wrap: wrap; margin: 15px 0;">

        <!-- PLATZ-AUSWAHL -->
        <div class="seat-field" id="seatField" style="flex: 1; min-width: 280px; padding: 15px; background: #fff; border: 1px solid #ddd;">
            <label style="font-weight: 600; font-size: 0.9em; color: #2c5aa0; display: block; margin-bottom: 8px;">Platznummer:</label>
            <div class="seat-warning" id="seatWarning" style="background: #fff3e0; border: 1px solid #b35c00; padding: 8px 10px; margin-bottom: 10px; font-size: 0.8em; color: #b35c00;">
                ⚠️ Kann nach OK <strong>nicht mehr geändert</strong> werden!
            </div>
            <div class="seat-row" id="seatRow" style="display: flex; align-items: center; gap: 8px;">
                <select class="seat-select" id="seatSelect" style="padding: 8px 12px; font-size: 1em; border: 1px solid #2c5aa0; background: #fff; min-width: 100px;">
                    <option value="">-- wählen --</option>
                </select>
                <button class="btn-seat-ok" id="btnSeatOk" onclick="confirmSeat()" style="padding: 8px 15px; font-size: 0.9em; font-weight: 600; background: #2c5aa0; color: #fff; border: none; cursor: pointer;">OK</button>
            </div>
            <div class="seat-confirmed" id="seatConfirmed" style="display: none; font-size: 1em; color: #2a7a4b; font-weight: 600;"></div>
            <input type="hidden" id="seatNumber" value="">
        </div>

        <!-- NIVEAU-AUSWAHL -->
        <div class="niveau-field" id="niveauField" style="flex: 1; min-width: 280px; padding: 15px; background: #fff; border: 1px solid #ddd;">
            <label style="font-weight: 600; font-size: 0.9em; color: #2c5aa0; display: block; margin-bottom: 8px;">Niveau:</label>
            <div class="niveau-warning" id="niveauWarning" style="background: #fff3e0; border: 1px solid #b35c00; padding: 8px 10px; margin-bottom: 10px; font-size: 0.8em; color: #b35c00;">
                ⚠️ Kann nach OK <strong>nicht mehr geändert</strong> werden!
            </div>
            <div class="niveau-row" id="niveauRow" style="display: flex; align-items: center; gap: 8px;">
                <select class="niveau-select" id="niveauSelect" style="padding: 8px 12px; font-size: 1em; border: 1px solid #2c5aa0; background: #fff; min-width: 180px;">
                    <option value="">-- wählen --</option>
                    <option value="1">★ Basis (24,5 BE)</option>
                    <option value="2">★★ Standard (29,5 BE)</option>
                    <option value="3">★★★ Erweitert (33,5 BE)</option>
                </select>
                <button class="btn-niveau-ok" id="btnNiveauOk" onclick="confirmNiveau()" style="padding: 8px 15px; font-size: 0.9em; font-weight: 600; background: #2c5aa0; color: #fff; border: none; cursor: pointer;">OK</button>
            </div>
            <div class="niveau-confirmed" id="niveauConfirmed" style="display: none; font-size: 1em; color: #2a7a4b; font-weight: 600;"></div>
        </div>

    </div>

    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Niveau wählen...</div>
    </div>

    <div class="container">
        <!-- ==================== NIVEAU 1 (★) - 15,5 BE ==================== -->

        <!-- FRAGE 1: Oersted-Versuch (★) 1 BE -->
        <div class="question" id="q1" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 1: Oersted-Versuch</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Was ist die Kernaussage des Oersted-Versuchs?
            </div>
            <div class="options" id="q1-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q1" value="a">
                    Ein Magnetfeld erzeugt einen elektrischen Strom im Leiter
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q1" value="b">
                    Ein stromdurchflossener Leiter erzeugt ein Magnetfeld
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q1" value="c">
                    Ein stromdurchflossener Leiter wird von einem Magnetfeld angezogen
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q1" value="d">
                    Ein Magnetfeld erzeugt eine Spannung im stromlosen Leiter
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q1" value="e">
                    Ein stromdurchflossener Leiter verstärkt ein vorhandenes Magnetfeld
                </label>
                <label class="option" data-value="f">
                    <input type="radio" name="q1" value="f">
                    Ein Leiter wird magnetisch, wenn Strom hindurchfließt
                </label>
            </div>
            <div class="feedback-box correct" id="q1-fb-correct">Richtig! Oersted entdeckte 1820, dass Strom ein Magnetfeld erzeugt.</div>
            <div class="feedback-box incorrect" id="q1-fb-incorrect">Die richtige Antwort: Ein stromdurchflossener Leiter erzeugt ein Magnetfeld.</div>
        </div>

        <!-- FRAGE 2: Technische Stromrichtung (★) 1 BE -->
        <div class="question" id="q2" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 2: Technische Stromrichtung</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Die technische Stromrichtung verläuft im Stromkreis...
            </div>
            <div class="options" id="q2-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q2" value="a">
                    von Minus nach Plus
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q2" value="b">
                    von Plus nach Minus
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q2" value="c">
                    in Richtung der Elektronenbewegung
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q2" value="d">
                    vom Nordpol zum Südpol
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q2" value="e">
                    vom Südpol zum Nordpol
                </label>
            </div>
            <div class="feedback-box correct" id="q2-fb-correct">Richtig! Die technische Stromrichtung verläuft von Plus nach Minus.</div>
            <div class="feedback-box incorrect" id="q2-fb-incorrect">Die technische Stromrichtung verläuft von Plus (+) nach Minus (-).</div>
        </div>

        <!-- FRAGE 3: Elektromagnet Definition (★) 1 BE -->
        <div class="question" id="q3" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 3: Elektromagnet</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Was ist ein Elektromagnet?
            </div>
            <div class="options" id="q3-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q3" value="a">
                    Ein Magnet, der elektrischen Strom durch sein Magnetfeld erzeugt
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q3" value="b">
                    Ein Permanentmagnet mit besonders starkem Feld
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q3" value="c">
                    Ein Magnet, dessen Magnetfeld durch elektrischen Strom erzeugt wird
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q3" value="d">
                    Ein Magnet, dessen Magnetfeld durch Reibung erzeugt wird
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q3" value="e">
                    Ein Magnet, dessen Magnetfeld durch bewegte Elektronen im Vakuum erzeugt wird
                </label>
                <label class="option" data-value="f">
                    <input type="radio" name="q3" value="f">
                    Ein Magnet, der nur bei angelegter Spannung magnetisch ist
                </label>
            </div>
            <div class="feedback-box correct" id="q3-fb-correct">Richtig! Ein Elektromagnet erzeugt sein Magnetfeld durch elektrischen Strom.</div>
            <div class="feedback-box incorrect" id="q3-fb-incorrect">Ein Elektromagnet ist ein Magnet, dessen Magnetfeld durch elektrischen Strom erzeugt wird.</div>
        </div>

        <!-- FRAGE 4: Elektromagnet Bestandteile (★) 1 BE -->
        <div class="question" id="q4" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 4: Bestandteile Elektromagnet</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Welche zwei wesentlichen Bestandteile hat ein Elektromagnet? <strong>(Mehrfachauswahl, 0,5 BE pro richtige Antwort, -0,5 BE pro falsche)</strong>
            </div>
            <div class="options multi-select" id="q4-options">
                <label class="option" data-value="a">
                    <input type="checkbox" name="q4" value="a">
                    Permanentmagnet
                </label>
                <label class="option" data-value="b">
                    <input type="checkbox" name="q4" value="b">
                    Kupferkern
                </label>
                <label class="option" data-value="c">
                    <input type="checkbox" name="q4" value="c">
                    Spule (Drahtwicklung)
                </label>
                <label class="option" data-value="d">
                    <input type="checkbox" name="q4" value="d">
                    Kondensator
                </label>
                <label class="option" data-value="e">
                    <input type="checkbox" name="q4" value="e">
                    Eisenkern
                </label>
                <label class="option" data-value="f">
                    <input type="checkbox" name="q4" value="f">
                    Transformator
                </label>
            </div>
            <div class="feedback-box correct" id="q4-fb-correct">Richtig! Spule + Eisenkern sind die wesentlichen Bestandteile.</div>
            <div class="feedback-box incorrect" id="q4-fb-incorrect">Die wesentlichen Bestandteile: Spule (Drahtwicklung) und Eisenkern.</div>
        </div>

        <!-- FRAGE 5: Rechte-Faust-Regel (★) 1 BE -->
        <div class="question" id="q5" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 5: Rechte-Faust-Regel</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Bei der Rechte-Faust-Regel für einen geraden stromdurchflossenen Leiter gilt:
            </div>
            <div class="options" id="q5-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q5" value="a">
                    Daumen = Feldlinienrichtung, gekrümmte Finger = Stromrichtung
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q5" value="b">
                    Daumen = Kraftrichtung, gekrümmte Finger = Feldlinienrichtung
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q5" value="c">
                    Daumen = Elektronenbewegung, gekrümmte Finger = Feldlinienrichtung
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q5" value="d">
                    Daumen = Stromrichtung, gekrümmte Finger = Feldlinienrichtung
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q5" value="e">
                    Daumen = Stromrichtung, gekrümmte Finger = Kraftrichtung
                </label>
                <label class="option" data-value="f">
                    <input type="radio" name="q5" value="f">
                    Gekrümmte Finger = Stromrichtung um den Leiter, Daumen = Nordpol
                </label>
            </div>
            <div class="feedback-box correct" id="q5-fb-correct">Richtig! Daumen = technische Stromrichtung, Finger umgreifen den Leiter in Feldlinienrichtung.</div>
            <div class="feedback-box incorrect" id="q5-fb-incorrect">Rechte-Faust: Daumen = Strom, gekrümmte Finger = Feldlinien.</div>
        </div>

        <!-- FRAGE 6: Symbole (★) 2 BE -->
        <div class="question" id="q6" data-niveau="1" data-points="2">
            <div class="question-header">
                <div class="question-title">Frage 6: Symbole im Leiterquerschnitt</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">2 BE</span>
                </div>
            </div>
            <div class="question-text">
                Ordne die Symbole der korrekten Bedeutung zu:
            </div>
            <div style="margin: 15px 0;">
                <div style="display:flex;align-items:center;gap:10px;margin:10px 0;">
                    <span class="symbol symbol-out">&#8226;</span>
                    <span>Punkt im Kreis:</span>
                    <select id="q6-punkt" style="padding:8px;flex:1;max-width:300px;" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Auswählen --</option>
                        <option value="heraus">Strom fließt heraus (auf dich zu)</option>
                        <option value="hinein">Strom fließt hinein (von dir weg)</option>
                        <option value="parallel">Strom fließt parallel zur Ebene</option>
                        <option value="keiner">Kein Strom fließt</option>
                    </select>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin:10px 0;">
                    <span class="symbol symbol-in">&#215;</span>
                    <span>Kreuz im Kreis:</span>
                    <select id="q6-kreuz" style="padding:8px;flex:1;max-width:300px;" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Auswählen --</option>
                        <option value="heraus">Strom fließt heraus (auf dich zu)</option>
                        <option value="hinein">Strom fließt hinein (von dir weg)</option>
                        <option value="parallel">Strom fließt parallel zur Ebene</option>
                        <option value="keiner">Kein Strom fließt</option>
                    </select>
                </div>
            </div>
            <div class="feedback-box correct" id="q6-fb-correct">Richtig! Punkt = heraus (Pfeilspitze), Kreuz = hinein (Pfeilende).</div>
            <div class="feedback-box incorrect" id="q6-fb-incorrect">Merke: Punkt = Pfeilspitze kommt auf dich zu. Kreuz = Pfeilende geht weg.</div>
        </div>

        <!-- FRAGE 7: Kompassnadel (★) 1 BE -->
        <div class="question" id="q7" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 7: Kompassnadel am Leiter</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Eine Kompassnadel wird neben einen stromdurchflossenen Leiter gehalten. Was passiert?
            </div>
            <div class="options" id="q7-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q7" value="a">
                    Die Kompassnadel zeigt in Stromrichtung
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q7" value="b">
                    Die Kompassnadel wird vom Magnetfeld des Leiters abgelenkt
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q7" value="c">
                    Die Kompassnadel wird vom elektrischen Feld des Leiters abgelenkt
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q7" value="d">
                    Die Kompassnadel wird vom Leiter angezogen
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q7" value="e">
                    Die Kompassnadel zeigt weiterhin nur nach Norden
                </label>
                <label class="option" data-value="f">
                    <input type="radio" name="q7" value="f">
                    Die Kompassnadel richtet sich senkrecht zum Leiter aus
                </label>
            </div>
            <div class="feedback-box correct" id="q7-fb-correct">Richtig! Das Magnetfeld des Leiters lenkt die Kompassnadel ab (Oersted-Versuch).</div>
            <div class="feedback-box incorrect" id="q7-fb-incorrect">Die Kompassnadel wird vom Magnetfeld des stromdurchflossenen Leiters abgelenkt.</div>
        </div>

        <!-- FRAGE 8: Elektromagnet verstärken (★) 1,5 BE -->
        <div class="question" id="q8" data-niveau="1" data-points="1.5">
            <div class="question-header">
                <div class="question-title">Frage 8: Elektromagnet verstärken</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1,5 BE</span>
                </div>
            </div>
            <div class="question-text">
                Welche Maßnahmen verstärken einen Elektromagneten? <strong>(Mehrfachauswahl, 0,5 BE pro richtige, -0,5 BE pro falsche)</strong>
            </div>
            <div class="options multi-select" id="q8-options">
                <label class="option" data-value="a">
                    <input type="checkbox" name="q8" value="a">
                    Kupferkern einführen
                </label>
                <label class="option" data-value="b">
                    <input type="checkbox" name="q8" value="b">
                    Stromstärke erhöhen
                </label>
                <label class="option" data-value="c">
                    <input type="checkbox" name="q8" value="c">
                    Spannung verringern
                </label>
                <label class="option" data-value="d">
                    <input type="checkbox" name="q8" value="d">
                    Windungszahl erhöhen
                </label>
                <label class="option" data-value="e">
                    <input type="checkbox" name="q8" value="e">
                    Eisenkern einführen
                </label>
                <label class="option" data-value="f">
                    <input type="checkbox" name="q8" value="f">
                    Drahtlänge verkürzen
                </label>
            </div>
            <div class="feedback-box correct" id="q8-fb-correct">Richtig! Stromstärke, Windungszahl und Eisenkern verstärken das Magnetfeld.</div>
            <div class="feedback-box incorrect" id="q8-fb-incorrect">Die 3 Verstärkungsmethoden: Stromstärke erhöhen, Windungszahl erhöhen, Eisenkern einführen.</div>
        </div>

        <!-- FRAGE 9: Anwendung Elektromagnet (★) 1 BE -->
        <div class="question" id="q9" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 9: Anwendung Elektromagnet</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Welche Geräte enthalten einen Elektromagneten? <strong>(Mehrfachauswahl, 0,5 BE pro richtige, -0,5 BE pro falsche)</strong>
            </div>
            <div class="options multi-select" id="q9-options">
                <label class="option" data-value="a">
                    <input type="checkbox" name="q9" value="a">
                    Kühlschrankmagnet
                </label>
                <label class="option" data-value="b">
                    <input type="checkbox" name="q9" value="b">
                    Elektrische Türklingel
                </label>
                <label class="option" data-value="c">
                    <input type="checkbox" name="q9" value="c">
                    Kompass
                </label>
                <label class="option" data-value="d">
                    <input type="checkbox" name="q9" value="d">
                    Lautsprecher
                </label>
                <label class="option" data-value="e">
                    <input type="checkbox" name="q9" value="e">
                    Magnetverschluss einer Tasche
                </label>
                <label class="option" data-value="f">
                    <input type="checkbox" name="q9" value="f">
                    Taschenlampe
                </label>
            </div>
            <div class="feedback-box correct" id="q9-fb-correct">Richtig! Türklingel und Lautsprecher nutzen Elektromagnete.</div>
            <div class="feedback-box incorrect" id="q9-fb-incorrect">Türklingel und Lautsprecher enthalten Elektromagnete. Kühlschrankmagnet und Kompass nutzen Permanentmagnete.</div>
        </div>

        <!-- FRAGE 10: Elektromotorisches Prinzip (★) 1 BE -->
        <div class="question" id="q10" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 10: Elektromotorisches Prinzip</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Was beschreibt das elektromotorische Prinzip?
            </div>
            <div class="options" id="q10-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q10" value="a">
                    Ein stromdurchflossener Leiter erzeugt ein Magnetfeld
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q10" value="b">
                    Auf einen stromdurchflossenen Leiter im Magnetfeld wirkt eine Kraft
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q10" value="c">
                    Ein Magnetfeld erzeugt einen Strom im Leiter
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q10" value="d">
                    Ein bewegter Magnet erzeugt eine Spannung im Leiter
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q10" value="e">
                    Auf einen Leiter im Magnetfeld wirkt immer eine Kraft
                </label>
                <label class="option" data-value="f">
                    <input type="radio" name="q10" value="f">
                    Auf bewegte Elektronen im Magnetfeld wirkt keine Kraft
                </label>
            </div>
            <div class="feedback-box correct" id="q10-fb-correct">Richtig! Auf einen stromdurchflossenen Leiter im Magnetfeld wirkt eine Kraft (Lorentzkraft).</div>
            <div class="feedback-box incorrect" id="q10-fb-incorrect">Das elektromotorische Prinzip: Auf einen stromdurchflossenen Leiter im Magnetfeld wirkt eine Kraft.</div>
        </div>

        <!-- FRAGE 11: Rechte-Hand-Regel Zuordnung (★) 3 BE -->
        <div class="question" id="q11" data-niveau="1" data-points="3">
            <div class="question-header">
                <div class="question-title">Frage 11: Rechte-Hand-Regel</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">3 BE</span>
                </div>
            </div>
            <div class="question-text">
                Ordne die Finger der Rechte-Hand-Regel der korrekten Bedeutung zu:
            </div>
            <div style="margin: 15px 0;">
                <div style="display:flex;align-items:center;gap:10px;margin:10px 0;flex-wrap:wrap;">
                    <span style="min-width:100px;font-weight:600;">Daumen:</span>
                    <select id="q11-daumen" style="padding:8px;flex:1;max-width:350px;" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Auswählen --</option>
                        <option value="kraft">Lorentzkraft / Kraftrichtung</option>
                        <option value="strom">Stromrichtung / Bewegung positiver Ladung</option>
                        <option value="feld">Magnetfeldrichtung (von N nach S)</option>
                        <option value="spannung">Spannungsrichtung</option>
                        <option value="widerstand">Widerstand</option>
                    </select>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin:10px 0;flex-wrap:wrap;">
                    <span style="min-width:100px;font-weight:600;">Zeigefinger:</span>
                    <select id="q11-zeige" style="padding:8px;flex:1;max-width:350px;" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Auswählen --</option>
                        <option value="strom">Stromrichtung / Bewegung positiver Ladung</option>
                        <option value="kraft">Lorentzkraft / Kraftrichtung</option>
                        <option value="feld">Magnetfeldrichtung (von N nach S)</option>
                        <option value="spannung">Spannungsrichtung</option>
                        <option value="widerstand">Widerstand</option>
                    </select>
                </div>
                <div style="display:flex;align-items:center;gap:10px;margin:10px 0;flex-wrap:wrap;">
                    <span style="min-width:100px;font-weight:600;">Mittelfinger:</span>
                    <select id="q11-mittel" style="padding:8px;flex:1;max-width:350px;" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Auswählen --</option>
                        <option value="feld">Magnetfeldrichtung (von N nach S)</option>
                        <option value="strom">Stromrichtung / Bewegung positiver Ladung</option>
                        <option value="kraft">Lorentzkraft / Kraftrichtung</option>
                        <option value="spannung">Spannungsrichtung</option>
                        <option value="widerstand">Widerstand</option>
                    </select>
                </div>
            </div>
            <div class="feedback-box correct" id="q11-fb-correct">Richtig! Daumen = Strom, Zeigefinger = Magnetfeld, Mittelfinger = Kraft.</div>
            <div class="feedback-box incorrect" id="q11-fb-incorrect">UVW-Regel: Daumen = Ursache (Strom), Zeigefinger = Vermittler (Magnetfeld), Mittelfinger = Wirkung (Kraft).</div>
        </div>

        <!-- FRAGE 12: Feldlinien Leiter (★) 1 BE -->
        <div class="question" id="q12" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 12: Feldlinien um einen Leiter</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Wie verlaufen die magnetischen Feldlinien um einen geraden stromdurchflossenen Leiter?
            </div>
            <div class="options" id="q12-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q12" value="a">
                    In geraden Linien parallel zum Leiter
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q12" value="b">
                    In geraden Linien senkrecht zum Leiter
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q12" value="c">
                    In spiralförmigen Linien entlang des Leiters
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q12" value="d">
                    In konzentrischen Kreisen um den Leiter
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q12" value="e">
                    In konzentrischen Kreisen durch den Leiter
                </label>
                <label class="option" data-value="f">
                    <input type="radio" name="q12" value="f">
                    Radial vom Leiter weg in alle Richtungen
                </label>
            </div>
            <div class="feedback-box correct" id="q12-fb-correct">Richtig! Die Feldlinien bilden konzentrische Kreise um den Leiter.</div>
            <div class="feedback-box incorrect" id="q12-fb-incorrect">Die Feldlinien verlaufen in konzentrischen Kreisen um den Leiter.</div>
        </div>

        <!-- FRAGE 13: Elektromagnet vs Permanentmagnet (★) 1 BE -->
        <div class="question" id="q13" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 13: Elektromagnet vs Permanentmagnet</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Was ist der Hauptvorteil eines Elektromagneten gegenüber einem Permanentmagneten?
            </div>
            <div class="options" id="q13-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q13" value="a">
                    Er ist billiger herzustellen
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q13" value="b">
                    Er kann ein- und ausgeschaltet werden
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q13" value="c">
                    Er braucht keinen Strom
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q13" value="d">
                    Er ist immer stärker
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q13" value="e">
                    Er verliert nie seine Magnetkraft
                </label>
            </div>
            <div class="feedback-box correct" id="q13-fb-correct">Richtig! Elektromagnete können ein-/ausgeschaltet und in der Stärke reguliert werden.</div>
            <div class="feedback-box incorrect" id="q13-fb-incorrect">Der Hauptvorteil: Ein Elektromagnet kann ein- und ausgeschaltet werden.</div>
        </div>

        <!-- FRAGE 14: Magnetfeld bei Stromunterbrechung (★) 1 BE -->
        <div class="question" id="q14" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 14: Strom unterbrochen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Was passiert mit dem Magnetfeld eines Elektromagneten, wenn der Strom unterbrochen wird?
            </div>
            <div class="options" id="q14-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q14" value="a">
                    Das Magnetfeld bleibt gleich stark
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q14" value="b">
                    Das Magnetfeld wird stärker
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q14" value="c">
                    Das Magnetfeld verschwindet vollständig
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q14" value="d">
                    Das Magnetfeld kehrt sich um
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q14" value="e">
                    Das Magnetfeld bleibt für 10 Sekunden erhalten
                </label>
            </div>
            <div class="feedback-box correct" id="q14-fb-correct">Richtig! Ohne Strom gibt es kein Magnetfeld mehr.</div>
            <div class="feedback-box incorrect" id="q14-fb-incorrect">Das Magnetfeld verschwindet, wenn kein Strom mehr fließt.</div>
        </div>

        <!-- FRAGE 15: Anziehung/Abstoßung (★) 1 BE -->
        <div class="question" id="q15" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 15: Anziehung und Abstoßung</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Zwei Elektromagnete werden mit ihren Nordpolen zueinander gehalten. Was passiert?
            </div>
            <div class="options" id="q15-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q15" value="a">
                    Sie ziehen sich an
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q15" value="b">
                    Beide Magnetfelder verschwinden
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q15" value="c">
                    Die Pole tauschen sich aus
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q15" value="d">
                    Sie stoßen sich ab
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q15" value="e">
                    Es passiert nichts
                </label>
            </div>
            <div class="feedback-box correct" id="q15-fb-correct">Richtig! Gleiche Pole stoßen sich ab (N-N oder S-S).</div>
            <div class="feedback-box incorrect" id="q15-fb-incorrect">Gleiche Pole (N-N oder S-S) stoßen sich ab, ungleiche ziehen sich an.</div>
        </div>

        <!-- FRAGE 16: Feldstärke und Abstand (★) 1 BE -->
        <div class="question" id="q16" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 16: Feldstärke und Abstand</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Wie verändert sich die magnetische Feldstärke, wenn man sich vom Leiter entfernt?
            </div>
            <div class="options" id="q16-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q16" value="a">
                    Sie nimmt zu
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q16" value="b">
                    Sie kehrt sich um
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q16" value="c">
                    Sie nimmt ab
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q16" value="d">
                    Sie bleibt gleich
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q16" value="e">
                    Sie verdoppelt sich bei doppeltem Abstand
                </label>
            </div>
            <div class="feedback-box correct" id="q16-fb-correct">Richtig! Die Feldstärke nimmt mit zunehmendem Abstand ab.</div>
            <div class="feedback-box incorrect" id="q16-fb-incorrect">Die magnetische Feldstärke nimmt mit größerem Abstand ab.</div>
        </div>

        <!-- FRAGE 17: Leiterschaukel (★) 1 BE -->
        <div class="question" id="q17" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 17: Leiterschaukel</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Eine stromdurchflossene Leiterschaukel hängt zwischen den Polen eines Hufeisenmagneten. Was passiert?
            </div>
            <div class="options" id="q17-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q17" value="a">
                    Die Schaukel bleibt ruhig hängen
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q17" value="b">
                    Die Schaukel wird magnetisiert
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q17" value="c">
                    Die Schaukel wird zur Seite ausgelenkt
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q17" value="d">
                    Die Schaukel wird heiß
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q17" value="e">
                    Der Magnet verliert seine Kraft
                </label>
            </div>
            <div class="feedback-box correct" id="q17-fb-correct">Richtig! Die Lorentzkraft lenkt den stromdurchflossenen Leiter im Magnetfeld aus.</div>
            <div class="feedback-box incorrect" id="q17-fb-incorrect">Die Lorentzkraft bewirkt eine Auslenkung des Leiters.</div>
        </div>

        <!-- FRAGE 18: Motor-Prinzip (★) 1 BE -->
        <div class="question" id="q18" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 18: Motor-Prinzip</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Das elektromotorische Prinzip ist die Grundlage für...
            </div>
            <div class="options" id="q18-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q18" value="a">
                    den Generator
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q18" value="b">
                    den Elektromotor
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q18" value="c">
                    den Transformator
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q18" value="d">
                    die Batterie
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q18" value="e">
                    den Kompass
                </label>
            </div>
            <div class="feedback-box correct" id="q18-fb-correct">Richtig! Das elektromotorische Prinzip (Kraft auf stromführenden Leiter) ist die Grundlage des Motors.</div>
            <div class="feedback-box incorrect" id="q18-fb-incorrect">Das elektromotorische Prinzip ist die Grundlage für den Elektromotor.</div>
        </div>

        <!-- FRAGE 19: Spulenkern Material (★) 1 BE -->
        <div class="question" id="q19" data-niveau="1" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 19: Spulenkern</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Warum verwendet man einen Eisenkern im Elektromagneten?
            </div>
            <div class="options" id="q19-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q19" value="a">
                    Er isoliert die Spule
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q19" value="b">
                    Er leitet den Strom besser
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q19" value="c">
                    Er verstärkt das Magnetfeld erheblich
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q19" value="d">
                    Er kühlt die Spule
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q19" value="e">
                    Er macht den Magneten leichter
                </label>
            </div>
            <div class="feedback-box correct" id="q19-fb-correct">Richtig! Eisen ist ferromagnetisch und verstärkt das Magnetfeld stark.</div>
            <div class="feedback-box incorrect" id="q19-fb-incorrect">Der Eisenkern verstärkt das Magnetfeld erheblich (ferromagnetisches Material).</div>
        </div>

        <!-- ==================== NIVEAU 2 (★★) ==================== -->

        <!-- FRAGE 20: Polung Elektromagnet (★★) 1 BE -->
        <div class="question" id="q20" data-niveau="2" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 20: Polung ändern</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-2">★★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Wenn man die <strong>elektrischen Pole</strong> an der Spannungsquelle vertauscht, dann...
            </div>
            <div class="options" id="q20-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q20" value="a">
                    bleibt die magnetische Polung gleich
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q20" value="b">
                    kehrt sich die magnetische Polung um
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q20" value="c">
                    verdoppelt sich die magnetische Feldstärke
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q20" value="d">
                    verschwindet das Magnetfeld kurzzeitig
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q20" value="e">
                    kehrt sich die Stromrichtung um, aber die Polung bleibt gleich
                </label>
            </div>
            <div class="feedback-box correct" id="q20-fb-correct">Richtig! Poltausch kehrt die Stromrichtung und damit die magnetische Polung um.</div>
            <div class="feedback-box incorrect" id="q20-fb-incorrect">Wenn die elektrischen Pole getauscht werden, kehrt sich auch die magnetische Polung um.</div>
        </div>

        <!-- FRAGE 21: Polung komplex (★★) 1 BE -->
        <div class="question" id="q21" data-niveau="2" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 21: Doppelte Änderung</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-2">★★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Wenn man <strong>sowohl</strong> die elektrischen Pole <strong>als auch</strong> die Wickelrichtung umkehrt, dann...
            </div>
            <div class="options" id="q21-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q21" value="a">
                    kehrt sich die magnetische Polung um (doppelte Umkehrung)
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q21" value="b">
                    verdoppelt sich die Umkehrwirkung
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q21" value="c">
                    bleibt die magnetische Polung gleich (beide Änderungen heben sich auf)
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q21" value="d">
                    bleibt die Polung gleich, weil sich die Änderungen gegenseitig verstärken
                </label>
                <label class="option" data-value="e">
                    <input type="radio" name="q21" value="e">
                    kehrt sich nur die Nordpol-Seite um
                </label>
            </div>
            <div class="feedback-box correct" id="q21-fb-correct">Richtig! Doppelte Umkehrung hebt sich auf – die Polung bleibt gleich.</div>
            <div class="feedback-box incorrect" id="q21-fb-incorrect">Jede einzelne Änderung kehrt die Polung um. Beide zusammen heben sich auf!</div>
        </div>

        <!-- FRAGE 22: Lorentzkraft Richtung (★) 2 BE - Gleich nach RH-Regel -->
        <div class="question" id="q22" data-niveau="1" data-points="2">
            <div class="question-header">
                <div class="question-title">Frage 22: Lorentzkraft bestimmen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">★</span>
                    <span class="question-points">2 BE</span>
                </div>
            </div>
            <div class="question-text">
                Bestimme die Richtung der Lorentzkraft.
            </div>
            <div class="scenario-grid">
                <div class="scenario" id="scenario-a">
                    <div class="scenario-label">a) Strom nach rechts (→)</div>
                    <svg viewBox="0 0 120 100" width="120">
                        <rect x="10" y="80" width="100" height="15" fill="#c62828"/>
                        <text x="60" y="92" text-anchor="middle" fill="white" font-size="10" font-weight="bold">N</text>
                        <rect x="10" y="5" width="100" height="15" fill="#1565c0"/>
                        <text x="60" y="17" text-anchor="middle" fill="white" font-size="10" font-weight="bold">S</text>
                        <rect x="40" y="45" width="40" height="10" fill="#666"/>
                        <line x1="30" y1="50" x2="55" y2="50" stroke="#c62828" stroke-width="2"/>
                        <polygon points="55,50 48,46 48,54" fill="#c62828"/>
                        <text x="35" y="42" font-size="9" fill="#c62828">I</text>
                    </svg>
                    <select id="q22-a" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Richtung --</option>
                        <option value="oben">Nach oben ↑</option>
                        <option value="unten">Nach unten ↓</option>
                        <option value="links">Nach links ←</option>
                        <option value="rechts">Nach rechts →</option>
                        <option value="heraus">Heraus ⊙</option>
                        <option value="hinein">Hinein ⊗</option>
                    </select>
                </div>
                <div class="scenario" id="scenario-b">
                    <div class="scenario-label">b) Strom nach links (←)</div>
                    <svg viewBox="0 0 120 100" width="120">
                        <rect x="10" y="80" width="100" height="15" fill="#c62828"/>
                        <text x="60" y="92" text-anchor="middle" fill="white" font-size="10" font-weight="bold">N</text>
                        <rect x="10" y="5" width="100" height="15" fill="#1565c0"/>
                        <text x="60" y="17" text-anchor="middle" fill="white" font-size="10" font-weight="bold">S</text>
                        <rect x="40" y="45" width="40" height="10" fill="#666"/>
                        <line x1="90" y1="50" x2="65" y2="50" stroke="#c62828" stroke-width="2"/>
                        <polygon points="65,50 72,46 72,54" fill="#c62828"/>
                        <text x="82" y="42" font-size="9" fill="#c62828">I</text>
                    </svg>
                    <select id="q22-b" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Richtung --</option>
                        <option value="oben">Nach oben ↑</option>
                        <option value="unten">Nach unten ↓</option>
                        <option value="links">Nach links ←</option>
                        <option value="rechts">Nach rechts →</option>
                        <option value="heraus">Heraus ⊙</option>
                        <option value="hinein">Hinein ⊗</option>
                    </select>
                </div>
            </div>
            <div class="feedback-box correct" id="q22-fb-correct">Richtig! a) heraus, b) hinein.</div>
            <div class="feedback-box incorrect" id="q22-fb-incorrect">Rechte-Hand-Regel: Daumen = I, Zeigefinger = B (↑), Mittelfinger = F.</div>
        </div>

        <!-- ==================== NIVEAU 2 (★★) ==================== -->

        <!-- FRAGE 23: Lorentzkraft (Punkt/Kreuz) (★★) 2 BE - ohne Feldrichtung -->
        <div class="question" id="q23" data-niveau="2" data-points="2">
            <div class="question-header">
                <div class="question-title">Frage 23: Lorentzkraft (Punkt/Kreuz)</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-2">★★</span>
                    <span class="question-points">2 BE</span>
                </div>
            </div>
            <div class="question-text">
                Bestimme die Lorentzkraft-Richtung.
            </div>
            <div class="scenario-grid">
                <div class="scenario" id="scenario-c">
                    <div class="scenario-label">a) Strom heraus (⊙)</div>
                    <svg viewBox="0 0 120 100" width="120">
                        <!-- Nordpol unten (rot) -->
                        <rect x="10" y="80" width="100" height="15" fill="#c62828"/>
                        <text x="60" y="92" text-anchor="middle" fill="white" font-size="10" font-weight="bold">N</text>
                        <!-- Südpol oben (blau) -->
                        <rect x="10" y="5" width="100" height="15" fill="#1565c0"/>
                        <text x="60" y="17" text-anchor="middle" fill="white" font-size="10" font-weight="bold">S</text>
                        <!-- Leiter mit Strom heraus -->
                        <circle cx="60" cy="50" r="12" fill="#666" stroke="#333"/>
                        <circle cx="60" cy="50" r="4" fill="#c62828"/>
                    </svg>
                    <select id="q23-a" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Richtung --</option>
                        <option value="links">Nach links ←</option>
                        <option value="rechts">Nach rechts →</option>
                        <option value="oben">Nach oben ↑</option>
                        <option value="unten">Nach unten ↓</option>
                        <option value="heraus">Heraus ⊙</option>
                        <option value="hinein">Hinein ⊗</option>
                    </select>
                </div>
                <div class="scenario" id="scenario-d">
                    <div class="scenario-label">b) Strom hinein (⊗)</div>
                    <svg viewBox="0 0 120 100" width="120">
                        <!-- Nordpol unten (rot) -->
                        <rect x="10" y="80" width="100" height="15" fill="#c62828"/>
                        <text x="60" y="92" text-anchor="middle" fill="white" font-size="10" font-weight="bold">N</text>
                        <!-- Südpol oben (blau) -->
                        <rect x="10" y="5" width="100" height="15" fill="#1565c0"/>
                        <text x="60" y="17" text-anchor="middle" fill="white" font-size="10" font-weight="bold">S</text>
                        <!-- Leiter mit Strom hinein -->
                        <circle cx="60" cy="50" r="12" fill="#666" stroke="#333"/>
                        <line x1="51" y1="41" x2="69" y2="59" stroke="#c62828" stroke-width="2"/>
                        <line x1="69" y1="41" x2="51" y2="59" stroke="#c62828" stroke-width="2"/>
                    </svg>
                    <select id="q23-b" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Richtung --</option>
                        <option value="links">Nach links ←</option>
                        <option value="rechts">Nach rechts →</option>
                        <option value="oben">Nach oben ↑</option>
                        <option value="unten">Nach unten ↓</option>
                        <option value="heraus">Heraus ⊙</option>
                        <option value="hinein">Hinein ⊗</option>
                    </select>
                </div>
            </div>
            <div class="feedback-box correct" id="q23-fb-correct">Richtig! a) links, b) rechts.</div>
            <div class="feedback-box incorrect" id="q23-fb-incorrect">Bei ⊙ zeigt Daumen auf dich zu, bei ⊗ von dir weg. Dann Rechte-Hand-Regel anwenden.</div>
        </div>

        <!-- FRAGE 24: Spulen-Polung bestimmen (★★) 1 BE -->
        <div class="question" id="q24" data-niveau="2" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 24: Magnetische Polung einer Spule</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-2">★★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Die Spule ist an eine Spannungsquelle angeschlossen. Welche magnetische Polung entsteht?
            </div>
            <div class="diagram" style="text-align:center; margin: 15px 0;">
                <!-- Spule mit Wickelrichtung und elektrischer Polung -->
                <svg viewBox="0 0 300 100" width="340" style="max-width:100%;">
                    <!-- Spulenkörper (graues Rechteck) -->
                    <rect x="60" y="25" width="180" height="50" fill="#e0e0e0" stroke="#888" stroke-width="1.5"/>

                    <!-- Plus-Anschluss links (Kabel in Spulenfarbe) -->
                    <line x1="25" y1="50" x2="60" y2="50" stroke="#b35c00" stroke-width="2.5"/>
                    <!-- Plus-Symbol mit rotem Kreis -->
                    <circle cx="15" cy="50" r="10" fill="white" stroke="#c62828" stroke-width="2"/>
                    <text x="15" y="55" text-anchor="middle" font-size="14" fill="#c62828" font-weight="bold">+</text>
                    <!-- Gestrichelte Verbindung zum ersten Wicklungsanfang -->
                    <line x1="60" y1="50" x2="75" y2="25" stroke="#b35c00" stroke-width="1.5" stroke-dasharray="4,3"/>

                    <!-- Minus-Anschluss rechts (Kabel in Spulenfarbe) -->
                    <line x1="240" y1="50" x2="275" y2="50" stroke="#b35c00" stroke-width="2.5"/>
                    <!-- Minus-Symbol mit blauem Kreis -->
                    <circle cx="285" cy="50" r="10" fill="white" stroke="#1565c0" stroke-width="2"/>
                    <text x="285" y="55" text-anchor="middle" font-size="14" fill="#1565c0" font-weight="bold">−</text>
                    <!-- Gestrichelte Verbindung vom letzten Wicklungsende -->
                    <line x1="215" y1="75" x2="240" y2="50" stroke="#b35c00" stroke-width="1.5" stroke-dasharray="4,3"/>

                    <!-- Wicklungen (schräge Linien, sichtbare Vorderseite) -->
                    <line x1="75" y1="25" x2="90" y2="75" stroke="#b35c00" stroke-width="2.5"/>
                    <line x1="100" y1="25" x2="115" y2="75" stroke="#b35c00" stroke-width="2.5"/>
                    <line x1="125" y1="25" x2="140" y2="75" stroke="#b35c00" stroke-width="2.5"/>
                    <line x1="150" y1="25" x2="165" y2="75" stroke="#b35c00" stroke-width="2.5"/>
                    <line x1="175" y1="25" x2="190" y2="75" stroke="#b35c00" stroke-width="2.5"/>
                    <line x1="200" y1="25" x2="215" y2="75" stroke="#b35c00" stroke-width="2.5"/>

                    <!-- Rücklaufende Wicklungen (gestrichelt) -->
                    <line x1="90" y1="75" x2="100" y2="25" stroke="#b35c00" stroke-width="1.5" stroke-dasharray="4,3"/>
                    <line x1="115" y1="75" x2="125" y2="25" stroke="#b35c00" stroke-width="1.5" stroke-dasharray="4,3"/>
                    <line x1="140" y1="75" x2="150" y2="25" stroke="#b35c00" stroke-width="1.5" stroke-dasharray="4,3"/>
                    <line x1="165" y1="75" x2="175" y2="25" stroke="#b35c00" stroke-width="1.5" stroke-dasharray="4,3"/>
                    <line x1="190" y1="75" x2="200" y2="25" stroke="#b35c00" stroke-width="1.5" stroke-dasharray="4,3"/>

                    <!-- Strom-Pfeil oben -->
                    <line x1="100" y1="15" x2="180" y2="15" stroke="#c62828" stroke-width="2"/>
                    <polygon points="180,15 170,11 170,19" fill="#c62828"/>
                    <text x="140" y="12" text-anchor="middle" font-size="10" fill="#c62828">I</text>
                </svg>
            </div>
            <div class="options-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <label class="option" data-value="a" style="padding:10px; text-align:center;">
                    <input type="radio" name="q24" value="a">
                    <svg viewBox="0 0 160 50" width="140" style="display:block; margin:5px auto;">
                        <rect x="10" y="15" width="60" height="20" fill="#c62828"/>
                        <text x="40" y="29" text-anchor="middle" fill="white" font-size="11" font-weight="bold">N</text>
                        <rect x="70" y="15" width="60" height="20" fill="#1565c0"/>
                        <text x="100" y="29" text-anchor="middle" fill="white" font-size="11" font-weight="bold">S</text>
                        <text x="80" y="45" text-anchor="middle" font-size="9">links N, rechts S</text>
                    </svg>
                </label>
                <label class="option" data-value="b" style="padding:10px; text-align:center;">
                    <input type="radio" name="q24" value="b">
                    <svg viewBox="0 0 160 50" width="140" style="display:block; margin:5px auto;">
                        <rect x="10" y="15" width="60" height="20" fill="#1565c0"/>
                        <text x="40" y="29" text-anchor="middle" fill="white" font-size="11" font-weight="bold">S</text>
                        <rect x="70" y="15" width="60" height="20" fill="#c62828"/>
                        <text x="100" y="29" text-anchor="middle" fill="white" font-size="11" font-weight="bold">N</text>
                        <text x="80" y="45" text-anchor="middle" font-size="9">links S, rechts N</text>
                    </svg>
                </label>
                <label class="option" data-value="c" style="padding:10px; text-align:center;">
                    <input type="radio" name="q24" value="c">
                    <svg viewBox="0 0 160 50" width="140" style="display:block; margin:5px auto;">
                        <rect x="10" y="15" width="60" height="20" fill="#c62828"/>
                        <text x="40" y="29" text-anchor="middle" fill="white" font-size="11" font-weight="bold">N</text>
                        <rect x="70" y="15" width="60" height="20" fill="#c62828"/>
                        <text x="100" y="29" text-anchor="middle" fill="white" font-size="11" font-weight="bold">N</text>
                        <text x="80" y="45" text-anchor="middle" font-size="9">beidseitig N</text>
                    </svg>
                </label>
                <label class="option" data-value="d" style="padding:10px; text-align:center;">
                    <input type="radio" name="q24" value="d">
                    <svg viewBox="0 0 160 50" width="140" style="display:block; margin:5px auto;">
                        <rect x="40" y="15" width="80" height="20" fill="#888"/>
                        <text x="80" y="29" text-anchor="middle" fill="white" font-size="10">kein Magnetfeld</text>
                        <text x="80" y="45" text-anchor="middle" font-size="9">unmagnetisch</text>
                    </svg>
                </label>
            </div>
            <div class="feedback-box correct" id="q24-fb-correct">Richtig! Oben ⊙ (ccw), unten ⊗ (cw) → B innen nach rechts → Nordpol rechts.</div>
            <div class="feedback-box incorrect" id="q24-fb-incorrect">Querschnitt: Oben ⊙ (counterclockwise), unten ⊗ (clockwise) → B zeigt nach rechts.</div>
        </div>

        <!-- ==================== NIVEAU 3 (★★★) ==================== -->

        <!-- FRAGE 25: Elektronen-Ablenkung (★★★) 1 BE - ohne N/S Beschriftung -->
        <div class="question" id="q25" data-niveau="3" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 25: Ablenkung von Elektronen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-3">★★★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Ein <strong>Elektron (e⁻)</strong> bewegt sich nach rechts (→). Das Magnetfeld zeigt nach oben (↑). Wohin wird es abgelenkt?
            </div>
            <div class="diagram">
                <svg viewBox="0 0 200 120" width="250">
                    <!-- Nordpol unten (rot) -->
                    <rect x="20" y="95" width="160" height="20" fill="#c62828"/>
                    <text x="100" y="109" text-anchor="middle" fill="white" font-size="11" font-weight="bold">N</text>
                    <!-- Südpol oben (blau) -->
                    <rect x="20" y="5" width="160" height="20" fill="#1565c0"/>
                    <text x="100" y="19" text-anchor="middle" fill="white" font-size="11" font-weight="bold">S</text>
                    <!-- Elektron -->
                    <circle cx="70" cy="60" r="8" fill="#1565c0"/>
                    <text x="70" y="64" text-anchor="middle" fill="white" font-size="9" font-weight="bold">−</text>
                    <!-- Geschwindigkeit -->
                    <line x1="82" y1="60" x2="120" y2="60" stroke="#333" stroke-width="2"/>
                    <polygon points="120,60 110,55 110,65" fill="#333"/>
                    <text x="100" y="52" font-size="9">v</text>
                </svg>
            </div>
            <div class="options" id="q25-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q25" value="a">
                    Nach oben (↑)
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q25" value="b">
                    Nach unten (↓)
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q25" value="c">
                    Aus der Ebene heraus (auf dich zu)
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q25" value="d">
                    In die Ebene hinein (von dir weg)
                </label>
            </div>
            <div class="feedback-box correct" id="q25-fb-correct">Richtig! Bei Elektronen: Daumen ENTGEGEN der Bewegung (←), dann Kraft hinein.</div>
            <div class="feedback-box incorrect" id="q25-fb-incorrect">Bei Elektronen: Daumen entgegen v! Also ← statt →. Dann: Mittelfinger → hinein.</div>
        </div>

        <!-- FRAGE 26: Protonen-Ablenkung (★★★) 1 BE -->
        <div class="question" id="q26" data-niveau="3" data-points="1">
            <div class="question-header">
                <div class="question-title">Frage 26: Ablenkung von Protonen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-3">★★★</span>
                    <span class="question-points">1 BE</span>
                </div>
            </div>
            <div class="question-text">
                Ein <strong>Proton (p⁺)</strong> bewegt sich nach rechts (→). Das Magnetfeld zeigt nach oben (↑). Wohin wird es abgelenkt?
            </div>
            <div class="diagram">
                <svg viewBox="0 0 200 120" width="250">
                    <!-- Nordpol unten (rot) -->
                    <rect x="20" y="95" width="160" height="20" fill="#c62828"/>
                    <text x="100" y="109" text-anchor="middle" fill="white" font-size="11" font-weight="bold">N</text>
                    <!-- Südpol oben (blau) -->
                    <rect x="20" y="5" width="160" height="20" fill="#1565c0"/>
                    <text x="100" y="19" text-anchor="middle" fill="white" font-size="11" font-weight="bold">S</text>
                    <!-- Proton -->
                    <circle cx="70" cy="60" r="8" fill="#c62828"/>
                    <text x="70" y="64" text-anchor="middle" fill="white" font-size="9" font-weight="bold">+</text>
                    <!-- Geschwindigkeit -->
                    <line x1="82" y1="60" x2="120" y2="60" stroke="#333" stroke-width="2"/>
                    <polygon points="120,60 110,55 110,65" fill="#333"/>
                    <text x="100" y="52" font-size="9">v</text>
                </svg>
            </div>
            <div class="options" id="q26-options">
                <label class="option" data-value="a">
                    <input type="radio" name="q26" value="a">
                    Nach oben (↑)
                </label>
                <label class="option" data-value="b">
                    <input type="radio" name="q26" value="b">
                    Nach unten (↓)
                </label>
                <label class="option" data-value="c">
                    <input type="radio" name="q26" value="c">
                    Aus der Ebene heraus (auf dich zu)
                </label>
                <label class="option" data-value="d">
                    <input type="radio" name="q26" value="d">
                    In die Ebene hinein (von dir weg)
                </label>
            </div>
            <div class="feedback-box correct" id="q26-fb-correct">Richtig! Bei Protonen: Daumen IN Bewegungsrichtung (→), dann Kraft heraus.</div>
            <div class="feedback-box incorrect" id="q26-fb-incorrect">Bei positiven Ladungen: Daumen in Bewegungsrichtung. Kraft → heraus (⊙).</div>
        </div>

        <!-- FRAGE 27: Lorentzkraft → Pole ableiten (★★★) 2 BE -->
        <div class="question" id="q27" data-niveau="3" data-points="2">
            <div class="question-header">
                <div class="question-title">Frage 27: Magnetpole aus Lorentzkraft ableiten</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-3">★★★</span>
                    <span class="question-points">2 BE</span>
                </div>
            </div>
            <div class="question-text">
                <strong>Bestimme die Lage des Nordpols.</strong>
            </div>
            <div class="scenario-grid">
                <div class="scenario" id="scenario-27a">
                    <div class="scenario-label">a)</div>
                    <svg viewBox="0 0 140 100" width="140">
                        <!-- Oberer Pol (grau, ?) -->
                        <rect x="15" y="5" width="110" height="15" fill="#888" stroke="#555"/>
                        <text x="70" y="17" text-anchor="middle" fill="white" font-size="12" font-weight="bold">?</text>
                        <!-- Unterer Pol (grau, ?) -->
                        <rect x="15" y="80" width="110" height="15" fill="#888" stroke="#555"/>
                        <text x="70" y="92" text-anchor="middle" fill="white" font-size="12" font-weight="bold">?</text>
                        <!-- Leiter mit Strom heraus -->
                        <circle cx="70" cy="50" r="10" fill="#666" stroke="#333"/>
                        <circle cx="70" cy="50" r="3" fill="#c62828"/>
                        <!-- Kraft-Pfeil nach rechts -->
                        <line x1="85" y1="50" x2="120" y2="50" stroke="#2a7a4b" stroke-width="2.5"/>
                        <polygon points="120,50 112,45 112,55" fill="#2a7a4b"/>
                        <text x="105" y="42" font-size="9" fill="#2a7a4b" font-weight="bold">F</text>
                    </svg>
                    <select id="q27-a" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Nordpol ist... --</option>
                        <option value="oben">...oben</option>
                        <option value="unten">...unten</option>
                        <option value="links">...links</option>
                        <option value="rechts">...rechts</option>
                    </select>
                </div>
                <div class="scenario" id="scenario-27b">
                    <div class="scenario-label">b)</div>
                    <svg viewBox="0 0 140 100" width="140">
                        <!-- Oberer Pol (grau, ?) -->
                        <rect x="15" y="5" width="110" height="15" fill="#888" stroke="#555"/>
                        <text x="70" y="17" text-anchor="middle" fill="white" font-size="12" font-weight="bold">?</text>
                        <!-- Unterer Pol (grau, ?) -->
                        <rect x="15" y="80" width="110" height="15" fill="#888" stroke="#555"/>
                        <text x="70" y="92" text-anchor="middle" fill="white" font-size="12" font-weight="bold">?</text>
                        <!-- Leiter mit Strom hinein -->
                        <circle cx="70" cy="50" r="10" fill="#666" stroke="#333"/>
                        <line x1="63" y1="43" x2="77" y2="57" stroke="#c62828" stroke-width="2"/>
                        <line x1="77" y1="43" x2="63" y2="57" stroke="#c62828" stroke-width="2"/>
                        <!-- Kraft-Pfeil nach rechts -->
                        <line x1="85" y1="50" x2="120" y2="50" stroke="#2a7a4b" stroke-width="2.5"/>
                        <polygon points="120,50 112,45 112,55" fill="#2a7a4b"/>
                        <text x="105" y="42" font-size="9" fill="#2a7a4b" font-weight="bold">F</text>
                    </svg>
                    <select id="q27-b" onchange="updateProgress(); saveProgress();">
                        <option value="">-- Nordpol ist... --</option>
                        <option value="oben">...oben</option>
                        <option value="unten">...unten</option>
                        <option value="links">...links</option>
                        <option value="rechts">...rechts</option>
                    </select>
                </div>
            </div>
            <div class="feedback-box correct" id="q27-fb-correct">Richtig! a) B↓ → N oben, b) B↑ → N unten.</div>
            <div class="feedback-box incorrect" id="q27-fb-incorrect">UVW rückwärts: Daumen=I, Mittelfinger=F → Zeigefinger zeigt Richtung B. N ist dort, wo B herkommt.</div>
        </div>

        <!-- SUBMIT SECTION -->
        <div class="submit-section" id="submitSection">
            <p style="margin-bottom:15px;">Überprüfe deine Antworten, bevor du abgibst.</p>
            <button onclick="submitTest()" id="submitBtn">Test abgeben</button>
        </div>

        <!-- RESULTS -->
        <div class="results hidden" id="resultsSection">
            <h2>Ergebnis</h2>
            <div id="studentNameDisplay"></div>
            <div style="margin:10px 0;font-size:0.9em;" id="niveauDisplay"></div>
            <div style="margin-top:20px;">
                <div style="font-size:1.1em; font-weight:600; color:#555; margin-bottom:5px;">Erreichte Punkte:</div>
                <div class="score" id="scoreDisplay">0 / 0</div>
            </div>
            <div class="grade" id="gradeDisplay"></div>

            <table class="grade-table" id="gradeTable">
                <tr>
                    <th>NP</th>
                    <th>14</th><th>13</th><th>12</th><th>11</th><th>10</th><th>9</th><th>8</th><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th>
                </tr>
                <tr>
                    <td>%</td>
                    <td>100</td><td>96</td><td>90,7</td><td>86</td><td>80</td><td>73,3</td><td>66,7</td><td>60</td><td>53,3</td><td>46,7</td><td>40</td><td>33,3</td><td>26,7</td><td>20</td>
                </tr>
                <tr id="gradeRow">
                    <td>BE</td>
                    <td id="be14">-</td><td id="be13">-</td><td id="be12">-</td><td id="be11">-</td><td id="be10">-</td>
                    <td id="be9">-</td><td id="be8">-</td><td id="be7">-</td><td id="be6">-</td><td id="be5">-</td>
                    <td id="be4">-</td><td id="be3">-</td><td id="be2">-</td><td id="be1">-</td>
                </tr>
            </table>

            <!-- Hinweis: Drucken und Abgeben -->
            <div style="background: #fff3e0; border: 2px solid #b35c00; padding: 15px; margin: 20px 0; text-align: left;">
                <strong style="color: #b35c00; font-size: 1.1em;">⚠️ Ergebnis sichern:</strong>
                <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li>Klicke auf <strong>"Drucken / PDF"</strong> (oder Strg+P / Cmd+P)</li>
                    <li>Wähle <strong>"Als PDF speichern"</strong></li>
                    <li>Lade das PDF in der <strong>Bildungscloud</strong> hoch</li>
                </ol>
            </div>

            <div style="margin-top:20px;">
                <button class="btn-secondary" onclick="window.print()">Drucken / PDF</button>
            </div>
        </div>
    </div>

    <!-- Lehrer-Reset Button (dezent am Seitenende) -->
    <div style="text-align:center; margin: 40px 0 20px; opacity: 0.3;">
        <button onclick="lehrerReset()" style="background:#666; font-size:0.85em; padding:8px 15px;">Lehrkraft: Reset</button>
    </div>

    <script>
        // ES5 JavaScript
        var STORAGE_KEY = 'mt-9e-elektromagnetismus-25be';
        var KLASSENSTUFE = 9;  // Für 24h-Reset: nur Kl. 6-7, ab Kl. 8 permanent
        var LEHRER_PIN = '2024';
        var AUTO_RESET_MS = 86400000;  // 24 Stunden in Millisekunden

        var selectedNiveau = 0;
        var testSubmitted = false;
        var finalScore = 0;
        var finalMaxPoints = 0;

        // BE pro Niveau nach Umstrukturierung:
        // ★:   Q1-Q19 + Q22 (20 Fragen = 24.5 BE)
        // ★★:  + Q20, Q21, Q23, Q24 (24 Fragen = 29.5 BE)
        // ★★★: + Q25, Q26, Q27 (27 Fragen = 33.5 BE)
        var niveauPoints = {
            1: 24.5,  // ★ (Q1-Q19, Q22)
            2: 29.5,  // ★★ (+ Q20, Q21, Q23, Q24)
            3: 33.5   // ★★★ (+ Q25, Q26, Q27)
        };

        // ===== PLATZ-DROPDOWN (analog Spanisch-MT) =====
        function generateSeatDropdown() {
            var select = document.getElementById('seatSelect');

            // Optionen P1-P24 hinzufügen
            for (var i = 1; i <= 24; i++) {
                var option = document.createElement('option');
                option.value = i;
                option.textContent = 'P' + i;
                select.appendChild(option);
            }

            // Gespeicherte Auswahl wiederherstellen
            var saved = localStorage.getItem(STORAGE_KEY + '-seat');
            var seatLocked = localStorage.getItem(STORAGE_KEY + '-seat-locked');

            if (saved && seatLocked === 'true') {
                showLockedSeat(saved);
            } else if (saved) {
                select.value = saved;
            }
        }

        function confirmSeat() {
            var select = document.getElementById('seatSelect');
            var num = select.value;

            if (!num) {
                alert('Bitte wähle zuerst eine Platznummer!');
                return;
            }

            var ok = confirm('Platznummer P' + num + ' bestätigen?\n\nDiese Auswahl kann NICHT mehr geändert werden!');
            if (!ok) return;

            localStorage.setItem(STORAGE_KEY + '-seat', num);
            localStorage.setItem(STORAGE_KEY + '-seat-locked', 'true');
            document.getElementById('seatNumber').value = num;

            showLockedSeat(num);
        }

        function showLockedSeat(num) {
            document.getElementById('seatNumber').value = num;
            document.getElementById('seatWarning').style.display = 'none';
            document.getElementById('seatRow').style.display = 'none';
            document.getElementById('seatConfirmed').style.display = 'block';
            document.getElementById('seatConfirmed').innerHTML =
                '✓ Deine Platznummer: <strong style="color:#2c5aa0; font-size:1.2em;">P' + num + '</strong> (gesperrt)';
        }

        // ===== NIVEAU-DROPDOWN (analog Platz) =====
        function restoreNiveauDropdown() {
            var saved = localStorage.getItem(STORAGE_KEY + '-niveau');
            var niveauLocked = localStorage.getItem(STORAGE_KEY + '-niveau-locked');

            if (saved && niveauLocked === 'true') {
                selectedNiveau = parseInt(saved);
                showLockedNiveau(saved);
                selectNiveau(selectedNiveau);
            } else if (saved) {
                document.getElementById('niveauSelect').value = saved;
            }
        }

        function confirmNiveau() {
            var select = document.getElementById('niveauSelect');
            var val = select.value;

            if (!val) {
                alert('Bitte wähle zuerst ein Niveau!');
                return;
            }

            var niveauStars = ['', '★ Basis', '★★ Standard', '★★★ Erweitert'][parseInt(val)];
            var ok = confirm('Niveau "' + niveauStars + '" bestätigen?\n\nDiese Auswahl kann NICHT mehr geändert werden!');
            if (!ok) return;

            localStorage.setItem(STORAGE_KEY + '-niveau', val);
            localStorage.setItem(STORAGE_KEY + '-niveau-locked', 'true');
            selectedNiveau = parseInt(val);

            showLockedNiveau(val);
            selectNiveau(selectedNiveau);
        }

        function showLockedNiveau(val) {
            var niveauStars = ['', '★ Basis (24,5 BE)', '★★ Standard (29,5 BE)', '★★★ Erweitert (33,5 BE)'][parseInt(val)];
            document.getElementById('niveauWarning').style.display = 'none';
            document.getElementById('niveauRow').style.display = 'none';
            document.getElementById('niveauConfirmed').style.display = 'block';
            document.getElementById('niveauConfirmed').innerHTML =
                '✓ Dein Niveau: <strong style="color:#2c5aa0; font-size:1.2em;">' + niveauStars + '</strong> (gesperrt)';
        }

        // Korrekte Antworten (aktualisiert nach Umstrukturierung)
        var answers = {
            // ★ Niveau (Q1-Q19, Q22)
            q1: 'b',
            q2: 'b',   // Technische Stromrichtung: Plus nach Minus
            q3: 'c',   // Gemischt: Elektromagnet Definition
            q4: ['c', 'e'],  // Gemischt: früher a,b
            q5: 'd',   // Gemischt: früher a
            q6punkt: 'heraus',
            q6kreuz: 'hinein',
            q7: 'b',   // Gemischt: Kompassnadel
            q8: ['b', 'd', 'e'],  // Gemischt: früher a,b,c
            q9: ['b', 'd'],  // Gemischt: früher a,b
            q10: 'b',
            q11daumen: 'strom',
            q11zeige: 'feld',
            q11mittel: 'kraft',
            q12: 'd',  // Gemischt: Feldlinien um Leiter
            q13: 'b',  // Elektromagnet vs Permanentmagnet (gemischt)
            q14: 'c',  // Strom unterbrochen (gemischt, "fast" entfernt)
            q15: 'd',  // Anziehung/Abstoßung (gemischt)
            q16: 'c',  // Feldstärke und Abstand (gemischt)
            q17: 'c',  // Leiterschaukel (gemischt)
            q18: 'b',  // Motor-Prinzip (gemischt)
            q19: 'c',  // Spulenkern (gemischt)
            q22a: 'heraus',  // Lorentzkraft ★ (a: Strom rechts)
            q22b: 'hinein',  // Lorentzkraft ★ (b: Strom links)
            // ★★ Niveau (Q20, Q21, Q23, Q24)
            q20: 'b',  // Polung ändern (gemischt)
            q21: 'c',  // Doppelte Änderung (gemischt)
            q23a: 'links',   // Lorentzkraft Punkt/Kreuz (a: I⊙ + B↑ → F←)
            q23b: 'rechts',  // Lorentzkraft Punkt/Kreuz (b: I⊗ + B↑ → F→)
            q24: 'b',  // Spulen-Polung: Oben ⊙, unten ⊗ → B nach rechts → Nordpol rechts
            // ★★★ Niveau (Q25-Q27)
            q25: 'd',  // Elektronen-Ablenkung (hinein)
            q26: 'c',  // Protonen-Ablenkung (heraus)
            q27a: 'oben',   // Lorentzkraft→Pole: I⊙ + F→ → B↓ → N oben
            q27b: 'unten'   // Lorentzkraft→Pole: I⊗ + F→ → B↑ → N unten
        };

        // Flag um zu verhindern, dass saveProgress während des Restore-Vorgangs aufgerufen wird
        var isRestoring = false;

        function selectNiveau(niveau) {
            selectedNiveau = niveau;

            // Hinweise bei Fragen über dem gewählten Niveau anzeigen
            var questions = document.querySelectorAll('.question');
            for (var j = 0; j < questions.length; j++) {
                var qNiveau = parseInt(questions[j].dataset.niveau);
                var qId = questions[j].id;
                var existingHint = document.getElementById(qId + '-niveau-hinweis');

                if (qNiveau > niveau) {
                    // Frage ist über dem Niveau - Hinweis hinzufügen (falls nicht vorhanden)
                    if (!existingHint) {
                        var hint = document.createElement('div');
                        hint.className = 'niveau-hinweis';
                        hint.id = qId + '-niveau-hinweis';
                        hint.innerHTML = '⚠️ Diese Aufgabe wird bei deinem Niveau <strong>nicht gewertet</strong>.';
                        // Nach dem question-header einfügen
                        var header = questions[j].querySelector('.question-header');
                        if (header && header.nextSibling) {
                            header.parentNode.insertBefore(hint, header.nextSibling);
                        }
                    }
                } else {
                    // Frage ist im Niveau - Hinweis entfernen (falls vorhanden)
                    if (existingHint) {
                        existingHint.remove();
                    }
                }
            }

            updateProgress();
            // Nur speichern wenn NICHT im Restore-Modus
            if (!isRestoring) {
                saveProgress();
            }
        }

        function setupOptions() {
            // Alle .option Elemente finden
            var allOptions = document.querySelectorAll('.option');

            for (var i = 0; i < allOptions.length; i++) {
                var opt = allOptions[i];
                var input = opt.querySelector('input[type="radio"], input[type="checkbox"]');
                if (!input) continue;

                var isRadio = input.type === 'radio';

                // Click-Handler für das Label
                opt.addEventListener('click', (function(optEl, inputEl, radio) {
                    return function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        if (radio) {
                            // Radio: Alle Siblings deselektieren
                            var siblings = optEl.parentNode.querySelectorAll('.option');
                            for (var k = 0; k < siblings.length; k++) {
                                siblings[k].classList.remove('selected');
                                var sib = siblings[k].querySelector('input');
                                if (sib) sib.checked = false;
                            }
                            optEl.classList.add('selected');
                            inputEl.checked = true;
                        } else {
                            // Checkbox: Toggeln
                            optEl.classList.toggle('selected');
                            inputEl.checked = optEl.classList.contains('selected');
                        }
                        updateProgress();
                        saveProgress();
                    };
                })(opt, input, isRadio));

                // Click-Handler für das Input selbst
                input.addEventListener('click', (function(optEl, inputEl, radio) {
                    return function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        if (radio) {
                            var siblings = optEl.parentNode.querySelectorAll('.option');
                            for (var k = 0; k < siblings.length; k++) {
                                siblings[k].classList.remove('selected');
                                var sib = siblings[k].querySelector('input');
                                if (sib) sib.checked = false;
                            }
                            optEl.classList.add('selected');
                            inputEl.checked = true;
                        } else {
                            optEl.classList.toggle('selected');
                            inputEl.checked = optEl.classList.contains('selected');
                        }
                        updateProgress();
                        saveProgress();
                    };
                })(opt, input, isRadio));
            }
        }

        function countAnsweredQuestions() {
            if (selectedNiveau === 0) return { answered: 0, total: 0 };

            var answered = 0;
            var total = 0;

            var questions = document.querySelectorAll('.question');
            for (var i = 0; i < questions.length; i++) {
                var qNiveau = parseInt(questions[i].dataset.niveau);
                if (qNiveau <= selectedNiveau) {
                    total++;
                    var qId = questions[i].id;
                    if (isQuestionAnswered(qId)) {
                        answered++;
                    }
                }
            }

            return { answered: answered, total: total };
        }

        function isQuestionAnswered(qId) {
            switch(qId) {
                // ★ Niveau (Q1-Q19, Q22)
                case 'q1': return !!document.querySelector('input[name="q1"]:checked');
                case 'q2': return !!document.querySelector('input[name="q2"]:checked');
                case 'q3': return !!document.querySelector('input[name="q3"]:checked');
                case 'q4': return !!document.querySelector('input[name="q4"]:checked');
                case 'q5': return !!document.querySelector('input[name="q5"]:checked');
                case 'q6': return document.getElementById('q6-punkt').value && document.getElementById('q6-kreuz').value;
                case 'q7': return !!document.querySelector('input[name="q7"]:checked');
                case 'q8': return !!document.querySelector('input[name="q8"]:checked');
                case 'q9': return !!document.querySelector('input[name="q9"]:checked');
                case 'q10': return !!document.querySelector('input[name="q10"]:checked');
                case 'q11': return document.getElementById('q11-daumen').value && document.getElementById('q11-zeige').value && document.getElementById('q11-mittel').value;
                case 'q12': return !!document.querySelector('input[name="q12"]:checked');
                case 'q13': return !!document.querySelector('input[name="q13"]:checked');
                case 'q14': return !!document.querySelector('input[name="q14"]:checked');
                case 'q15': return !!document.querySelector('input[name="q15"]:checked');
                case 'q16': return !!document.querySelector('input[name="q16"]:checked');
                case 'q17': return !!document.querySelector('input[name="q17"]:checked');
                case 'q18': return !!document.querySelector('input[name="q18"]:checked');
                case 'q19': return !!document.querySelector('input[name="q19"]:checked');
                case 'q22': return document.getElementById('q22-a').value && document.getElementById('q22-b').value;
                // ★★ Niveau (Q20, Q21, Q23)
                case 'q20': return !!document.querySelector('input[name="q20"]:checked');
                case 'q21': return !!document.querySelector('input[name="q21"]:checked');
                case 'q23': return document.getElementById('q23-a').value && document.getElementById('q23-b').value;
                case 'q24': return !!document.querySelector('input[name="q24"]:checked');
                // ★★★ Niveau (Q25-Q27)
                case 'q25': return !!document.querySelector('input[name="q25"]:checked');
                case 'q26': return !!document.querySelector('input[name="q26"]:checked');
                case 'q27': return document.getElementById('q27-a').value && document.getElementById('q27-b').value;
                default: return false;
            }
        }

        function updateProgress() {
            if (selectedNiveau === 0) {
                document.getElementById('progressText').textContent = 'Niveau wählen...';
                document.getElementById('progressFill').style.width = '0%';
                return;
            }

            var status = countAnsweredQuestions();
            var percent = status.total > 0 ? (status.answered / status.total) * 100 : 0;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = status.answered + ' / ' + status.total + ' beantwortet (' + niveauPoints[selectedNiveau] + ' BE)';
        }

        function saveProgress() {
            var answers = collectAllAnswers();
            var data = {
                answers: answers,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            // DEBUG: Checkbox-Werte bei Save
            console.log('[SAVE] q4:', answers.q4, 'q8:', answers.q8, 'q9:', answers.q9);
        }

        function loadProgress() {
            var saved = localStorage.getItem(STORAGE_KEY);
            console.log('[LOAD] Raw localStorage:', saved ? 'exists' : 'empty');
            if (saved) {
                var data = JSON.parse(saved);
                if (data.answers) {
                    // DEBUG: Checkbox-Werte bei Load
                    console.log('[LOAD] q4:', data.answers.q4, 'q8:', data.answers.q8, 'q9:', data.answers.q9);
                    restoreAnswers(data.answers);
                }
            }
        }

        function collectAllAnswers() {
            return {
                // ★ Niveau (Q1-Q19, Q22)
                q1: getRadioValue('q1'),
                q2: getRadioValue('q2'),
                q3: getRadioValue('q3'),
                q4: getCheckboxValues('q4'),
                q5: getRadioValue('q5'),
                q6punkt: document.getElementById('q6-punkt').value,
                q6kreuz: document.getElementById('q6-kreuz').value,
                q7: getRadioValue('q7'),
                q8: getCheckboxValues('q8'),
                q9: getCheckboxValues('q9'),
                q10: getRadioValue('q10'),
                q11daumen: document.getElementById('q11-daumen').value,
                q11zeige: document.getElementById('q11-zeige').value,
                q11mittel: document.getElementById('q11-mittel').value,
                q12: getRadioValue('q12'),
                q13: getRadioValue('q13'),
                q14: getRadioValue('q14'),
                q15: getRadioValue('q15'),
                q16: getRadioValue('q16'),
                q17: getRadioValue('q17'),
                q18: getRadioValue('q18'),
                q19: getRadioValue('q19'),
                q22a: document.getElementById('q22-a').value,
                q22b: document.getElementById('q22-b').value,
                // ★★ Niveau (Q20, Q21, Q23)
                q20: getRadioValue('q20'),
                q21: getRadioValue('q21'),
                q23a: document.getElementById('q23-a').value,
                q23b: document.getElementById('q23-b').value,
                q24: getRadioValue('q24'),
                // ★★★ Niveau (Q25-Q27)
                q25: getRadioValue('q25'),
                q26: getRadioValue('q26'),
                q27a: document.getElementById('q27-a').value,
                q27b: document.getElementById('q27-b').value
            };
        }

        function restoreAnswers(saved) {
            // Single-choice questions (★/★★/★★★)
            var singleQuestions = [
                'q1', 'q2', 'q3', 'q5', 'q7', 'q10', 'q12',
                'q13', 'q14', 'q15', 'q16', 'q17', 'q18', 'q19',
                'q20', 'q21', 'q24', 'q25', 'q26'
            ];
            singleQuestions.forEach(function(q) {
                if (saved[q]) {
                    var radio = document.querySelector('input[name="' + q + '"][value="' + saved[q] + '"]');
                    if (radio) {
                        radio.checked = true;
                        radio.parentNode.classList.add('selected');
                    }
                }
            });

            // Multi-select questions
            ['q4', 'q8', 'q9'].forEach(function(q) {
                console.log('[RESTORE] ' + q + ':', saved[q], 'length:', saved[q] ? saved[q].length : 'N/A');
                if (saved[q] && saved[q].length) {
                    saved[q].forEach(function(val) {
                        var cb = document.querySelector('input[name="' + q + '"][value="' + val + '"]');
                        console.log('[RESTORE] ' + q + ' val=' + val + ' found:', !!cb);
                        if (cb) {
                            cb.checked = true;
                            cb.parentNode.classList.add('selected');
                            console.log('[RESTORE] ' + q + ' val=' + val + ' checked:', cb.checked, 'selected:', cb.parentNode.classList.contains('selected'));
                        }
                    });
                }
            });

            // Select dropdowns
            if (saved.q6punkt) document.getElementById('q6-punkt').value = saved.q6punkt;
            if (saved.q6kreuz) document.getElementById('q6-kreuz').value = saved.q6kreuz;
            if (saved.q11daumen) document.getElementById('q11-daumen').value = saved.q11daumen;
            if (saved.q11zeige) document.getElementById('q11-zeige').value = saved.q11zeige;
            if (saved.q11mittel) document.getElementById('q11-mittel').value = saved.q11mittel;
            if (saved.q22a) document.getElementById('q22-a').value = saved.q22a;
            if (saved.q22b) document.getElementById('q22-b').value = saved.q22b;
            if (saved.q23a) document.getElementById('q23-a').value = saved.q23a;
            if (saved.q23b) document.getElementById('q23-b').value = saved.q23b;
            if (saved.q27a) document.getElementById('q27-a').value = saved.q27a;
            if (saved.q27b) document.getElementById('q27-b').value = saved.q27b;

            updateProgress();
        }

        function getRadioValue(name) {
            var checked = document.querySelector('input[name="' + name + '"]:checked');
            return checked ? checked.value : '';
        }

        function getCheckboxValues(name) {
            var checked = document.querySelectorAll('input[name="' + name + '"]:checked');
            var values = [];
            for (var i = 0; i < checked.length; i++) {
                values.push(checked[i].value);
            }
            return values;
        }

        function submitTest() {
            if (testSubmitted) return;

            // Prüfen ob Platz gesperrt
            var seatLocked = localStorage.getItem(STORAGE_KEY + '-seat-locked');
            var seatNum = document.getElementById('seatNumber').value;
            if (seatLocked !== 'true' || !seatNum) {
                alert('Bitte bestätige zuerst deine Platznummer (mit OK-Button)!');
                return;
            }

            // Prüfen ob Niveau gesperrt
            var niveauLocked = localStorage.getItem(STORAGE_KEY + '-niveau-locked');
            if (niveauLocked !== 'true' || selectedNiveau === 0) {
                alert('Bitte bestätige zuerst dein Niveau (mit OK-Button)!');
                return;
            }

            testSubmitted = true;

            var userAnswers = collectAllAnswers();
            var score = 0;
            var maxPoints = niveauPoints[selectedNiveau];

            // ===== NIVEAU 1 (★) - Q1-Q19, Q22 = 25.5 BE =====

            // Q1: 1 BE (single-choice)
            if (selectedNiveau >= 1) {
                var q1Correct = userAnswers.q1 === answers.q1;
                var q1Pts = q1Correct ? 1 : 0;
                score += q1Pts;
                markRadioQuestion('q1', answers.q1, userAnswers.q1);
                showFeedback('q1', q1Correct);
                showQuestionResult('q1', q1Pts, 1);
            }

            // Q2: 1 BE (single-choice)
            if (selectedNiveau >= 1) {
                var q2Correct = userAnswers.q2 === answers.q2;
                var q2Pts = q2Correct ? 1 : 0;
                score += q2Pts;
                markRadioQuestion('q2', answers.q2, userAnswers.q2);
                showFeedback('q2', q2Correct);
                showQuestionResult('q2', q2Pts, 1);
            }

            // Q3: 1 BE (single-choice)
            if (selectedNiveau >= 1) {
                var q3Correct = userAnswers.q3 === answers.q3;
                var q3Pts = q3Correct ? 1 : 0;
                score += q3Pts;
                markRadioQuestion('q3', answers.q3, userAnswers.q3);
                showFeedback('q3', q3Correct);
                showQuestionResult('q3', q3Pts, 1);
            }

            // Q4: 1 BE (Multi-Select, 2 richtige = 2×0.5)
            if (selectedNiveau >= 1) {
                var q4Score = scoreMultiSelect('q4', answers.q4, userAnswers.q4, 1);
                score += q4Score;
                showFeedback('q4', q4Score === 1);
                showQuestionResult('q4', q4Score, 1);
            }

            // Q5: 1 BE (single-choice)
            if (selectedNiveau >= 1) {
                var q5Correct = userAnswers.q5 === answers.q5;
                var q5Pts = q5Correct ? 1 : 0;
                score += q5Pts;
                markRadioQuestion('q5', answers.q5, userAnswers.q5);
                showFeedback('q5', q5Correct);
                showQuestionResult('q5', q5Pts, 1);
            }

            // Q6: 2 BE (2 Dropdowns)
            if (selectedNiveau >= 1) {
                var q6Score = 0;
                var q6pEl = document.getElementById('q6-punkt');
                var q6kEl = document.getElementById('q6-kreuz');
                if (userAnswers.q6punkt === answers.q6punkt) { q6Score++; }
                if (userAnswers.q6kreuz === answers.q6kreuz) { q6Score++; }
                markDropdown(q6pEl, answers.q6punkt, userAnswers.q6punkt);
                markDropdown(q6kEl, answers.q6kreuz, userAnswers.q6kreuz);
                score += q6Score;
                showFeedback('q6', q6Score === 2);
                showQuestionResult('q6', q6Score, 2);
                if (!userAnswers.q6punkt || !userAnswers.q6kreuz) { document.getElementById('q6').classList.add('unanswered'); }
            }

            // Q7: 1 BE (single-choice)
            if (selectedNiveau >= 1) {
                var q7Correct = userAnswers.q7 === answers.q7;
                var q7Pts = q7Correct ? 1 : 0;
                score += q7Pts;
                markRadioQuestion('q7', answers.q7, userAnswers.q7);
                showFeedback('q7', q7Correct);
                showQuestionResult('q7', q7Pts, 1);
            }

            // Q8: 1.5 BE (Multi-Select, 3 richtige = 3×0.5)
            if (selectedNiveau >= 1) {
                var q8Score = scoreMultiSelect('q8', answers.q8, userAnswers.q8, 1.5);
                score += q8Score;
                showFeedback('q8', q8Score === 1.5);
                showQuestionResult('q8', q8Score, 1.5);
            }

            // Q9: 1 BE (Multi-Select, 2 richtige = 2×0.5)
            if (selectedNiveau >= 1) {
                var q9Score = scoreMultiSelect('q9', answers.q9, userAnswers.q9, 1);
                score += q9Score;
                showFeedback('q9', q9Score === 1);
                showQuestionResult('q9', q9Score, 1);
            }

            // Q10: 1 BE (single-choice)
            if (selectedNiveau >= 1) {
                var q10Correct = userAnswers.q10 === answers.q10;
                var q10Pts = q10Correct ? 1 : 0;
                score += q10Pts;
                markRadioQuestion('q10', answers.q10, userAnswers.q10);
                showFeedback('q10', q10Correct);
                showQuestionResult('q10', q10Pts, 1);
            }

            // Q11: 3 BE (3 Dropdowns)
            if (selectedNiveau >= 1) {
                var q11Score = 0;
                var q11dEl = document.getElementById('q11-daumen');
                var q11zEl = document.getElementById('q11-zeige');
                var q11mEl = document.getElementById('q11-mittel');
                if (userAnswers.q11daumen === answers.q11daumen) { q11Score++; }
                if (userAnswers.q11zeige === answers.q11zeige) { q11Score++; }
                if (userAnswers.q11mittel === answers.q11mittel) { q11Score++; }
                markDropdown(q11dEl, answers.q11daumen, userAnswers.q11daumen);
                markDropdown(q11zEl, answers.q11zeige, userAnswers.q11zeige);
                markDropdown(q11mEl, answers.q11mittel, userAnswers.q11mittel);
                score += q11Score;
                showFeedback('q11', q11Score === 3);
                showQuestionResult('q11', q11Score, 3);
                if (!userAnswers.q11daumen || !userAnswers.q11zeige || !userAnswers.q11mittel) { document.getElementById('q11').classList.add('unanswered'); }
            }

            // Q12: 1 BE (single-choice)
            if (selectedNiveau >= 1) {
                var q12Correct = userAnswers.q12 === answers.q12;
                var q12Pts = q12Correct ? 1 : 0;
                score += q12Pts;
                markRadioQuestion('q12', answers.q12, userAnswers.q12);
                showFeedback('q12', q12Correct);
                showQuestionResult('q12', q12Pts, 1);
            }

            // Q13-Q19: jeweils 1 BE (single-choice, ★ Niveau)
            var starOneQuestions = ['q13', 'q14', 'q15', 'q16', 'q17', 'q18', 'q19'];
            for (var i = 0; i < starOneQuestions.length; i++) {
                var qId = starOneQuestions[i];
                if (selectedNiveau >= 1) {
                    var qCorrect = userAnswers[qId] === answers[qId];
                    var qPts = qCorrect ? 1 : 0;
                    score += qPts;
                    markRadioQuestion(qId, answers[qId], userAnswers[qId]);
                    showFeedback(qId, qCorrect);
                    showQuestionResult(qId, qPts, 1);
                }
            }

            // Q22: 2 BE (2 Dropdowns - Lorentzkraft ★ Niveau)
            if (selectedNiveau >= 1) {
                var q22Score = 0;
                var q22aEl = document.getElementById('q22-a');
                var q22bEl = document.getElementById('q22-b');
                if (userAnswers.q22a === answers.q22a) { q22Score++; }
                if (userAnswers.q22b === answers.q22b) { q22Score++; }
                markDropdown(q22aEl, answers.q22a, userAnswers.q22a);
                markDropdown(q22bEl, answers.q22b, userAnswers.q22b);
                score += q22Score;
                showFeedback('q22', q22Score === 2);
                showQuestionResult('q22', q22Score, 2);
                if (!userAnswers.q22a || !userAnswers.q22b) { document.getElementById('q22').classList.add('unanswered'); }
            }

            // ===== NIVEAU 2 (★★) - Q20, Q21, Q23, Q24 = +5 BE =====

            // Q20: 1 BE (single-choice - Polung ändern)
            var q20NotGraded = selectedNiveau < 2;
            var q20Correct = userAnswers.q20 === answers.q20;
            var q20Pts = q20Correct ? 1 : 0;
            if (!q20NotGraded) score += q20Pts;
            markRadioQuestion('q20', answers.q20, userAnswers.q20);
            showFeedback('q20', q20Correct);
            showQuestionResult('q20', q20Pts, 1, q20NotGraded);

            // Q21: 1 BE (single-choice - Doppelte Änderung)
            var q21NotGraded = selectedNiveau < 2;
            var q21Correct = userAnswers.q21 === answers.q21;
            var q21Pts = q21Correct ? 1 : 0;
            if (!q21NotGraded) score += q21Pts;
            markRadioQuestion('q21', answers.q21, userAnswers.q21);
            showFeedback('q21', q21Correct);
            showQuestionResult('q21', q21Pts, 1, q21NotGraded);

            // Q23: 2 BE (2 Dropdowns - Lorentzkraft Punkt/Kreuz)
            var q23NotGraded = selectedNiveau < 2;
            var q23Score = 0;
            var q23aEl = document.getElementById('q23-a');
            var q23bEl = document.getElementById('q23-b');
            if (userAnswers.q23a === answers.q23a) { q23Score++; }
            if (userAnswers.q23b === answers.q23b) { q23Score++; }
            markDropdown(q23aEl, answers.q23a, userAnswers.q23a);
            markDropdown(q23bEl, answers.q23b, userAnswers.q23b);
            if (!q23NotGraded) score += q23Score;
            showFeedback('q23', q23Score === 2);
            showQuestionResult('q23', q23Score, 2, q23NotGraded);
            if (!userAnswers.q23a || !userAnswers.q23b) { document.getElementById('q23').classList.add('unanswered'); }

            // Q24: 1 BE (single-choice - Spulen-Polung, ★★)
            var q24NotGraded = selectedNiveau < 2;
            var q24Correct = userAnswers.q24 === answers.q24;
            var q24Pts = q24Correct ? 1 : 0;
            if (!q24NotGraded) score += q24Pts;
            markRadioQuestion('q24', answers.q24, userAnswers.q24);
            showFeedback('q24', q24Correct);
            showQuestionResult('q24', q24Pts, 1, q24NotGraded);

            // ===== NIVEAU 3 (★★★) - Q25, Q26 = +2 BE =====

            // Q25: 1 BE (single-choice - Elektronen-Ablenkung)
            var q25NotGraded = selectedNiveau < 3;
            var q25Correct = userAnswers.q25 === answers.q25;
            var q25Pts = q25Correct ? 1 : 0;
            if (!q25NotGraded) score += q25Pts;
            markRadioQuestion('q25', answers.q25, userAnswers.q25);
            showFeedback('q25', q25Correct);
            showQuestionResult('q25', q25Pts, 1, q25NotGraded);

            // Q26: 1 BE (single-choice - Protonen-Ablenkung)
            var q26NotGraded = selectedNiveau < 3;
            var q26Correct = userAnswers.q26 === answers.q26;
            var q26Pts = q26Correct ? 1 : 0;
            if (!q26NotGraded) score += q26Pts;
            markRadioQuestion('q26', answers.q26, userAnswers.q26);
            showFeedback('q26', q26Correct);
            showQuestionResult('q26', q26Pts, 1, q26NotGraded);

            // Q27: 2 BE (2 Dropdowns - Lorentzkraft → Pole ableiten)
            var q27NotGraded = selectedNiveau < 3;
            var q27Score = 0;
            var q27aEl = document.getElementById('q27-a');
            var q27bEl = document.getElementById('q27-b');
            if (userAnswers.q27a === answers.q27a) { q27Score++; }
            if (userAnswers.q27b === answers.q27b) { q27Score++; }
            markDropdown(q27aEl, answers.q27a, userAnswers.q27a);
            markDropdown(q27bEl, answers.q27b, userAnswers.q27b);
            if (!q27NotGraded) score += q27Score;
            showFeedback('q27', q27Score === 2);
            showQuestionResult('q27', q27Score, 2, q27NotGraded);
            if (!userAnswers.q27a || !userAnswers.q27b) { document.getElementById('q27').classList.add('unanswered'); }

            // Nicht gewertete Fragen markieren
            markNichtGewertet();

            displayResults(score, maxPoints);
        }

        function markNichtGewertet() {
            // Alle Fragen über dem gewählten Niveau als "Nicht gewertet" markieren
            var questions = document.querySelectorAll('.question');
            for (var i = 0; i < questions.length; i++) {
                var qNiveau = parseInt(questions[i].dataset.niveau);
                var qId = questions[i].id;

                if (qNiveau > selectedNiveau) {
                    // Entferne den Hinweis (wird durch "Nicht gewertet" Box ersetzt)
                    var hint = document.getElementById(qId + '-niveau-hinweis');
                    if (hint) {
                        hint.remove();
                    }

                    // Füge "Nicht gewertet" Box am Ende der Frage hinzu
                    var existingBox = document.getElementById(qId + '-nicht-gewertet');
                    if (!existingBox) {
                        var box = document.createElement('div');
                        box.className = 'nicht-gewertet-box';
                        box.id = qId + '-nicht-gewertet';
                        box.textContent = 'Nicht gewertet, nur informativ';
                        questions[i].appendChild(box);
                    }
                }
            }
        }

        function scoreMultiSelect(qId, correctAnswers, userAnswers, maxPoints) {
            var qOptions = document.querySelectorAll('#' + qId + '-options .option');
            var score = 0;

            for (var i = 0; i < qOptions.length; i++) {
                var val = qOptions[i].dataset.value;
                var isCorrectAnswer = correctAnswers.indexOf(val) !== -1;
                var wasSelected = userAnswers.indexOf(val) !== -1;

                if (isCorrectAnswer && wasSelected) {
                    score += 0.5;  // +0,5 BE pro richtige Antwort
                    qOptions[i].classList.add('correct');
                } else if (isCorrectAnswer && !wasSelected) {
                    qOptions[i].classList.add('missed');
                } else if (!isCorrectAnswer && wasSelected) {
                    score -= 0.5;  // -0,5 BE pro falsche Antwort
                    qOptions[i].classList.add('incorrect');
                }
            }

            // Minimum 0, Maximum maxPoints
            return Math.max(0, Math.min(score, maxPoints));
        }

        function markRadioQuestion(name, correct, selected) {
            var options = document.querySelectorAll('#' + name + '-options .option, .options-grid .option input[name="' + name + '"]');
            // Fallback für options-grid (F24)
            if (options.length === 0) {
                options = document.querySelectorAll('.option input[name="' + name + '"]');
                for (var j = 0; j < options.length; j++) {
                    var opt = options[j].closest('.option');
                    var val = opt.dataset.value;
                    if (val === correct) { opt.classList.add('correct'); }
                    else if (val === selected && val !== correct) { opt.classList.add('incorrect'); }
                }
                // Keine Antwort gegeben?
                if (!selected) {
                    var question = document.getElementById(name);
                    if (question) { question.classList.add('unanswered'); }
                }
                return;
            }
            for (var i = 0; i < options.length; i++) {
                var val = options[i].dataset.value;
                if (val === correct) { options[i].classList.add('correct'); }
                else if (val === selected && val !== correct) { options[i].classList.add('incorrect'); }
            }
            // Keine Antwort gegeben?
            if (!selected) {
                var question = document.getElementById(name);
                if (question) { question.classList.add('unanswered'); }
            }
        }

        function markDropdown(selectEl, correctVal, userVal) {
            if (!selectEl) return;
            if (userVal === correctVal) {
                selectEl.classList.add('correct');
            } else if (userVal && userVal !== correctVal) {
                selectEl.classList.add('incorrect');
                // Richtige Option grün markieren
                var opts = selectEl.options;
                for (var i = 0; i < opts.length; i++) {
                    if (opts[i].value === correctVal) {
                        opts[i].style.background = '#e8f5e9';
                        opts[i].style.fontWeight = 'bold';
                    }
                }
            } else if (!userVal) {
                selectEl.classList.add('unanswered');
            }
        }

        function showFeedback(qId, isCorrect) {
            var fbCorrect = document.getElementById(qId + '-fb-correct');
            var fbIncorrect = document.getElementById(qId + '-fb-incorrect');
            if (isCorrect && fbCorrect) { fbCorrect.classList.add('show'); }
            else if (!isCorrect && fbIncorrect) { fbIncorrect.classList.add('show'); }
        }

        function showQuestionResult(qId, achieved, maxPts, notGraded) {
            var question = document.getElementById(qId);
            if (!question) return;

            var meta = question.querySelector('.question-meta');
            if (!meta) return;

            // Bestehende Ergebnis-Anzeige entfernen (falls vorhanden)
            var existing = meta.querySelector('.question-result');
            if (existing) existing.remove();

            // Neue Ergebnis-Anzeige erstellen
            var result = document.createElement('span');
            result.className = 'question-result';

            if (notGraded) {
                // Nicht gewertet: grau, Punkte in Klammern
                result.style.background = '#f0f0f0';
                result.style.color = '#888';
                result.textContent = '(' + achieved + ')/' + maxPts + ' BE';
            } else {
                // Normal bewertet
                if (achieved === maxPts) {
                    result.classList.add('full');
                } else if (achieved > 0) {
                    result.classList.add('partial');
                } else {
                    result.classList.add('zero');
                }
                result.textContent = achieved + '/' + maxPts + ' BE';
            }
            meta.appendChild(result);

            // Speichern für Reload
            var scoreData = JSON.parse(localStorage.getItem(STORAGE_KEY + '-qscores') || '{}');
            scoreData[qId] = { achieved: achieved, max: maxPts, notGraded: !!notGraded };
            localStorage.setItem(STORAGE_KEY + '-qscores', JSON.stringify(scoreData));
        }

        function displayResults(score, maxPoints) {
            document.getElementById('submitSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            var seatEl = document.getElementById('seatNumber');
            var platzText = (seatEl && seatEl.value) ? 'P' + seatEl.value : '—';
            var niveauStars = ['', '\u2605', '\u2605\u2605', '\u2605\u2605\u2605'][selectedNiveau];

            document.getElementById('studentNameDisplay').textContent = 'Platznummer: ' + platzText;
            document.getElementById('niveauDisplay').textContent = 'Niveau: ' + niveauStars + ' (' + maxPoints + ' BE)';
            document.getElementById('scoreDisplay').textContent = score + ' / ' + maxPoints;

            // BE-Schwellen für Notenspiegel berechnen (auf nächste 0.5 aufrunden)
            var thresholds = [100, 96, 90.67, 86, 80, 73.33, 66.67, 60, 53.33, 46.67, 40, 33.33, 26.67, 20];
            var npIds = ['be14', 'be13', 'be12', 'be11', 'be10', 'be9', 'be8', 'be7', 'be6', 'be5', 'be4', 'be3', 'be2', 'be1'];
            for (var i = 0; i < thresholds.length; i++) {
                var beExact = maxPoints * thresholds[i] / 100;
                var be = Math.ceil(beExact * 2) / 2;  // Auf nächste 0.5 aufrunden
                document.getElementById(npIds[i]).textContent = be;
            }

            // Note berechnen
            var percent = (score / maxPoints) * 100;
            var np = 0;
            if (percent >= 100) np = 14;
            else if (percent >= 96) np = 13;
            else if (percent >= 90.67) np = 12;
            else if (percent >= 86) np = 11;
            else if (percent >= 80) np = 10;
            else if (percent >= 73.33) np = 9;
            else if (percent >= 66.67) np = 8;
            else if (percent >= 60) np = 7;
            else if (percent >= 53.33) np = 6;
            else if (percent >= 46.67) np = 5;
            else if (percent >= 40) np = 4;
            else if (percent >= 33.33) np = 3;
            else if (percent >= 26.67) np = 2;
            else if (percent >= 20) np = 1;
            else np = 0;

            document.getElementById('gradeDisplay').textContent = np + ' Notenpunkte';

            // Markiere aktuelle Note in Tabelle
            if (np > 0) {
                var cellId = 'be' + np;
                var cell = document.getElementById(cellId);
                if (cell) cell.classList.add('current');
            }

            // Abgabe-Status und Ergebnis speichern (NICHT löschen!)
            localStorage.setItem(STORAGE_KEY + '-submitted', 'true');
            localStorage.setItem(STORAGE_KEY + '-score', score);
            localStorage.setItem(STORAGE_KEY + '-maxPoints', maxPoints);

            // Alle Felder deaktivieren
            disableAllInputs();
        }

        // ===== NEUE FUNKTIONEN: Submission-Logik =====

        // Alle Eingabefelder deaktivieren nach Abgabe
        function disableAllInputs() {
            var radios = document.querySelectorAll('input[type="radio"]');
            for (var i = 0; i < radios.length; i++) {
                radios[i].disabled = true;
            }
            var checkboxes = document.querySelectorAll('input[type="checkbox"]');
            for (var j = 0; j < checkboxes.length; j++) {
                checkboxes[j].disabled = true;
            }
            var selects = document.querySelectorAll('select');
            for (var k = 0; k < selects.length; k++) {
                selects[k].disabled = true;
            }

            // Seat/Niveau OK-Buttons deaktivieren
            var btnSeatOk = document.getElementById('btnSeatOk');
            if (btnSeatOk) btnSeatOk.disabled = true;
            var btnNiveauOk = document.getElementById('btnNiveauOk');
            if (btnNiveauOk) btnNiveauOk.disabled = true;

            var submitBtn = document.getElementById('submitBtn');
            if (submitBtn) submitBtn.disabled = true;
        }

        // Alle Test-Daten aus localStorage löschen
        function clearTestData() {
            var keysToRemove = [];
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                if (key && key.indexOf(STORAGE_KEY) === 0) {
                    keysToRemove.push(key);
                }
            }
            for (var j = 0; j < keysToRemove.length; j++) {
                localStorage.removeItem(keysToRemove[j]);
            }
        }

        // Reset blockieren (für Schüler)
        function reset() {
            alert('Reset nicht möglich. Wende dich an die Lehrkraft.');
            return;
        }

        // Lehrer-Reset mit PIN
        function lehrerReset() {
            var pin = prompt('Lehrer-PIN eingeben:');
            if (pin === LEHRER_PIN) {
                clearTestData();
                alert('Test wurde zurückgesetzt. Die Seite wird neu geladen.');
                location.reload();
            } else if (pin !== null) {
                alert('Falscher PIN.');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            generateSeatDropdown();
            setupOptions();

            // Startzeit speichern (beim ersten Öffnen)
            var startTime = localStorage.getItem(STORAGE_KEY + '-start');
            if (!startTime) {
                localStorage.setItem(STORAGE_KEY + '-start', Date.now());
            } else {
                // 24h-Check nur für Klasse 6-7
                if (KLASSENSTUFE <= 7) {
                    var elapsed = Date.now() - parseInt(startTime);
                    if (elapsed > AUTO_RESET_MS) {
                        clearTestData();
                        localStorage.setItem(STORAGE_KEY + '-start', Date.now());
                    }
                }
                // Für Klasse 8+ bleibt alles permanent
            }

            // WICHTIG: Restore-Modus aktivieren um zu verhindern, dass saveProgress() aufgerufen wird
            isRestoring = true;

            // Antworten ZUERST laden, BEVOR Niveau wiederhergestellt wird
            var wasSubmitted = localStorage.getItem(STORAGE_KEY + '-submitted');
            if (wasSubmitted === 'true') {
                testSubmitted = true;
                loadProgress();
                // Gespeicherten Score anzeigen
                var savedScore = localStorage.getItem(STORAGE_KEY + '-score');
                var savedMax = localStorage.getItem(STORAGE_KEY + '-maxPoints');
                if (savedScore && savedMax) {
                    finalScore = parseInt(savedScore);
                    finalMaxPoints = parseInt(savedMax);
                    showSavedResults(finalScore, finalMaxPoints);
                }
                disableAllInputs();
            } else {
                loadProgress();
            }

            // Niveau NACH dem Laden der Antworten wiederherstellen
            restoreNiveauDropdown();

            // Restore-Modus beenden
            isRestoring = false;

            // Event-Listener für alle Antwort-Selects (außer seatSelect und niveauSelect)
            var selects = document.querySelectorAll('select:not(#niveauSelect):not(#seatSelect)');
            for (var i = 0; i < selects.length; i++) {
                selects[i].addEventListener('change', function() {
                    updateProgress();
                    saveProgress();
                });
            }
        });

        // Gespeicherte Ergebnisse anzeigen (nach Reload)
        function showSavedResults(score, maxPoints) {
            document.getElementById('submitSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');

            var seatEl = document.getElementById('seatNumber');
            var platzText = (seatEl && seatEl.value) ? 'P' + seatEl.value : '—';
            var niveauStars = ['', '\u2605', '\u2605\u2605', '\u2605\u2605\u2605'][selectedNiveau];

            document.getElementById('studentNameDisplay').textContent = 'Platznummer: ' + platzText;
            document.getElementById('niveauDisplay').textContent = 'Niveau: ' + niveauStars + ' (' + maxPoints + ' BE)';
            document.getElementById('scoreDisplay').textContent = score + ' / ' + maxPoints;

            // BE-Schwellen berechnen (auf nächste 0.5 aufrunden)
            var thresholds = [100, 96, 90.67, 86, 80, 73.33, 66.67, 60, 53.33, 46.67, 40, 33.33, 26.67, 20];
            var npIds = ['be14', 'be13', 'be12', 'be11', 'be10', 'be9', 'be8', 'be7', 'be6', 'be5', 'be4', 'be3', 'be2', 'be1'];
            for (var i = 0; i < thresholds.length; i++) {
                var beExact = maxPoints * thresholds[i] / 100;
                var be = Math.ceil(beExact * 2) / 2;  // Auf nächste 0.5 aufrunden
                document.getElementById(npIds[i]).textContent = be;
            }

            // Note berechnen
            var percent = (score / maxPoints) * 100;
            var np = 0;
            if (percent >= 100) np = 14;
            else if (percent >= 96) np = 13;
            else if (percent >= 90.67) np = 12;
            else if (percent >= 86) np = 11;
            else if (percent >= 80) np = 10;
            else if (percent >= 73.33) np = 9;
            else if (percent >= 66.67) np = 8;
            else if (percent >= 60) np = 7;
            else if (percent >= 53.33) np = 6;
            else if (percent >= 46.67) np = 5;
            else if (percent >= 40) np = 4;
            else if (percent >= 33.33) np = 3;
            else if (percent >= 26.67) np = 2;
            else if (percent >= 20) np = 1;
            else np = 0;

            document.getElementById('gradeDisplay').textContent = np + ' Notenpunkte';

            if (np > 0) {
                var cellId = 'be' + np;
                var cell = document.getElementById(cellId);
                if (cell) cell.classList.add('current');
            }

            // Nicht gewertete Fragen markieren (bei Reload)
            markNichtGewertet();

            // Fragen-Ergebnisse wiederherstellen
            restoreQuestionResults();
        }

        function restoreQuestionResults() {
            var scoreData = JSON.parse(localStorage.getItem(STORAGE_KEY + '-qscores') || '{}');
            for (var qId in scoreData) {
                if (scoreData.hasOwnProperty(qId)) {
                    var data = scoreData[qId];
                    var question = document.getElementById(qId);
                    if (question) {
                        var meta = question.querySelector('.question-meta');
                        if (meta && !meta.querySelector('.question-result')) {
                            var result = document.createElement('span');
                            result.className = 'question-result';
                            if (data.notGraded) {
                                // Nicht gewertete Aufgaben: Punkte in Klammern, grau
                                result.style.background = '#f0f0f0';
                                result.style.color = '#888';
                                result.textContent = '(' + data.achieved + ')/' + data.max + ' BE';
                            } else {
                                // Normal gewertete Aufgaben
                                if (data.achieved === data.max) {
                                    result.classList.add('full');
                                } else if (data.achieved > 0) {
                                    result.classList.add('partial');
                                } else {
                                    result.classList.add('zero');
                                }
                                result.textContent = data.achieved + '/' + data.max + ' BE';
                            }
                            meta.appendChild(result);
                        }
                    }
                }
            }

            // Visuelle Markierungen wiederherstellen
            restoreVisualState();
        }

        // Visuelle Zustände nach Reload wiederherstellen (Korrekt/Falsch + Feedback)
        function restoreVisualState() {
            var saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            var data = JSON.parse(saved);
            var userAnswers = data.answers || {};

            // Single-Choice Fragen markieren
            var singleQuestions = [
                'q1', 'q2', 'q3', 'q5', 'q7', 'q10', 'q12',
                'q13', 'q14', 'q15', 'q16', 'q17', 'q18', 'q19',
                'q20', 'q21', 'q24', 'q25', 'q26'
            ];
            singleQuestions.forEach(function(q) {
                markRadioQuestion(q, answers[q], userAnswers[q] || '');
                var isCorrect = userAnswers[q] === answers[q];
                showFeedback(q, isCorrect);
            });

            // Multi-Select Fragen markieren
            ['q4', 'q8', 'q9'].forEach(function(q) {
                var userVals = userAnswers[q] || [];
                var correctVals = answers[q];
                var qOptions = document.querySelectorAll('#' + q + '-options .option');
                for (var i = 0; i < qOptions.length; i++) {
                    var val = qOptions[i].dataset.value;
                    var isCorrectAnswer = correctVals.indexOf(val) !== -1;
                    var wasSelected = userVals.indexOf(val) !== -1;
                    if (isCorrectAnswer && wasSelected) {
                        qOptions[i].classList.add('correct');
                    } else if (isCorrectAnswer && !wasSelected) {
                        qOptions[i].classList.add('missed');
                    } else if (!isCorrectAnswer && wasSelected) {
                        qOptions[i].classList.add('incorrect');
                    }
                }
                // Feedback
                var score = 0;
                for (var j = 0; j < correctVals.length; j++) {
                    if (userVals.indexOf(correctVals[j]) !== -1) score += 0.5;
                }
                for (var k = 0; k < userVals.length; k++) {
                    if (correctVals.indexOf(userVals[k]) === -1) score -= 0.5;
                }
                score = Math.max(0, score);
                var maxScore = correctVals.length * 0.5;
                showFeedback(q, score === maxScore);
            });

            // Dropdown Fragen markieren
            var dropdownMappings = [
                { id: 'q6-punkt', key: 'q6punkt', correct: answers.q6punkt },
                { id: 'q6-kreuz', key: 'q6kreuz', correct: answers.q6kreuz },
                { id: 'q11-daumen', key: 'q11daumen', correct: answers.q11daumen },
                { id: 'q11-zeige', key: 'q11zeige', correct: answers.q11zeige },
                { id: 'q11-mittel', key: 'q11mittel', correct: answers.q11mittel },
                { id: 'q22-a', key: 'q22a', correct: answers.q22a },
                { id: 'q22-b', key: 'q22b', correct: answers.q22b },
                { id: 'q23-a', key: 'q23a', correct: answers.q23a },
                { id: 'q23-b', key: 'q23b', correct: answers.q23b },
                { id: 'q27-a', key: 'q27a', correct: answers.q27a },
                { id: 'q27-b', key: 'q27b', correct: answers.q27b }
            ];

            dropdownMappings.forEach(function(m) {
                var el = document.getElementById(m.id);
                if (el) {
                    markDropdown(el, m.correct, userAnswers[m.key] || '');
                }
            });

            // Feedback für Dropdown-Fragen
            var q6Correct = (userAnswers.q6punkt === answers.q6punkt) && (userAnswers.q6kreuz === answers.q6kreuz);
            showFeedback('q6', q6Correct);

            var q11Correct = (userAnswers.q11daumen === answers.q11daumen) &&
                             (userAnswers.q11zeige === answers.q11zeige) &&
                             (userAnswers.q11mittel === answers.q11mittel);
            showFeedback('q11', q11Correct);

            var q22Correct = (userAnswers.q22a === answers.q22a) && (userAnswers.q22b === answers.q22b);
            showFeedback('q22', q22Correct);

            var q23Correct = (userAnswers.q23a === answers.q23a) && (userAnswers.q23b === answers.q23b);
            showFeedback('q23', q23Correct);

            var q27Correct = (userAnswers.q27a === answers.q27a) && (userAnswers.q27b === answers.q27b);
            showFeedback('q27', q27Correct);
        }
    </script>
</body>
</html>
