<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minitest: Energieumwandlung & Wirkungsgrad</title>
    <style>
        :root {
            --fach: #2c5aa0;
            --fach-light: #e3f0ff;
            --bg: #f5f5f5;
            --white: #ffffff;
            --border: #dddddd;
            --text: #222222;
            --text-muted: #555555;
            --success: #2a7a4b;
            --success-bg: #e8f5e9;
            --warning: #b35c00;
            --warning-bg: #fff3e0;
            --error: #c62828;
            --error-bg: #ffebee;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
            line-height: 1.5;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        header {
            background: var(--fach);
            color: var(--white);
            padding: 15px 20px;
            margin: -20px -20px 20px;
        }
        header h1 { font-size: 1.3em; font-weight: 600; }
        header p { font-size: 0.85em; opacity: 0.9; }
        .info-bar {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            background: var(--white);
            border: 1px solid var(--border);
            padding: 12px 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .platz-field select, .platz-field button {
            padding: 5px 10px;
            font-size: 1em;
            border: 1px solid var(--border);
        }
        .aufgabe {
            background: var(--white);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 15px;
        }
        .aufgabe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--fach);
        }
        .aufgabe-title { font-weight: 600; color: var(--fach); }
        .aufgabe-punkte {
            font-size: 0.85em;
            background: var(--fach-light);
            color: var(--fach);
            padding: 3px 10px;
        }
        .operator { font-weight: 600; color: var(--fach); }
        .fz { font-family: "Times New Roman", Times, serif; font-style: italic; }
        p { margin-bottom: 10px; }
        .mc-options { margin: 15px 0; }
        .mc-option {
            display: block;
            padding: 10px 15px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
        }
        .mc-option:hover { border-color: var(--fach); }
        .mc-option.selected { border-color: var(--fach); background: var(--fach-light); }
        .mc-option.correct-answer { border-color: var(--success); background: var(--success-bg); }
        .mc-option.wrong-answer { border-color: var(--error); background: var(--error-bg); }
        .mc-option input { margin-right: 10px; }
        .calc-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .calc-input {
            border: 1px solid var(--border);
            padding: 8px 12px;
            font-size: 1em;
            width: 80px;
            text-align: center;
        }
        .calc-input:focus { outline: 2px solid var(--fach); border-color: var(--fach); }
        .calc-input.correct { border-color: var(--success); background: var(--success-bg); }
        .calc-input.incorrect { border-color: var(--error); background: var(--error-bg); }
        .unit-select {
            padding: 8px 12px;
            font-size: 1em;
            border: 1px solid var(--border);
        }
        .unit-select.correct { border-color: var(--success); background: var(--success-bg); }
        .unit-select.incorrect { border-color: var(--error); background: var(--error-bg); }
        .feedback {
            padding: 12px;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }
        .feedback.correct { background: var(--success-bg); border: 1px solid var(--success); color: var(--success); display: block; }
        .feedback.partial { background: var(--warning-bg); border: 1px solid var(--warning); color: var(--warning); display: block; }
        .feedback.incorrect { background: var(--error-bg); border: 1px solid var(--error); color: var(--error); display: block; }
        .solution-box {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-left: 3px solid var(--fach);
            font-size: 0.9em;
            display: none;
        }
        .solution-box.visible { display: block; }
        .solution-box strong { color: var(--fach); }
        .results {
            background: var(--white);
            border: 2px solid var(--fach);
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        .results h2 { color: var(--fach); margin-bottom: 15px; }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        .result-box { text-align: center; padding: 15px; background: var(--fach-light); }
        .result-box .value { font-size: 1.8em; font-weight: 600; color: var(--fach); }
        .result-box .label { font-size: 0.85em; color: var(--text-muted); }
        .grade-display {
            text-align: center;
            padding: 20px;
            background: var(--fach);
            color: var(--white);
        }
        .grade-display .grade { font-size: 3em; font-weight: 700; }
        .grade-display .label { font-size: 0.9em; opacity: 0.9; }
        .grading-table {
            margin-top: 15px;
            font-size: 0.8em;
            width: 100%;
            border-collapse: collapse;
        }
        .grading-table th, .grading-table td {
            border: 1px solid var(--border);
            padding: 5px 8px;
            text-align: center;
        }
        .grading-table th { background: var(--bg); }
        .btn {
            background: var(--fach);
            color: var(--white);
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 15px;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: var(--border); cursor: not-allowed; }
        .btn-secondary { background: var(--white); color: var(--fach); border: 1px solid var(--fach); }
        .btn-print { background: var(--text-muted); }
        .button-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .hinweis {
            background: var(--fach-light);
            border-left: 3px solid var(--fach);
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .teil { margin-top: 12px; }
        .teil-label { font-weight: 600; margin-bottom: 5px; }
        .locked-notice {
            background: var(--warning-bg);
            border: 1px solid var(--warning);
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        .locked-notice.visible { display: block; }
        #questionsContainer { display: none; }
        #questionsContainer.unlocked { display: block; }
        .unlock-hint {
            background: #fff3e0;
            border: 2px solid #b35c00;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #b35c00;
        }
        @media print {
            body { background: white; font-size: 11pt; }
            .container { max-width: 100%; padding: 10px; }
            .btn, .button-row { display: none !important; }
            .aufgabe { break-inside: avoid; page-break-inside: avoid; border: 1px solid #ccc; }
            .results { border: 2px solid #333; }
            .grade-display { background: #333 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .locked-notice { display: none !important; }
            header { background: #2c5aa0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Minitest: Energieumwandlung & Wirkungsgrad</h1>
            <p>Physik Klasse 10 MR | MT-04 | 20 Minuten | 23 BE</p>
        </header>

        <div class="locked-notice" id="lockedNotice">
            <strong>Test bereits abgegeben!</strong> Ergebnisse werden unten angezeigt.
        </div>

        <div class="info-bar">
            <div class="platz-field" id="seatField">
                <span id="seatSelectRow">
                    Platz: <select id="platzNummer">
                        <option value="">-- wählen --</option>
                        <option value="P1">P1</option><option value="P2">P2</option><option value="P3">P3</option>
                        <option value="P4">P4</option><option value="P5">P5</option><option value="P6">P6</option>
                        <option value="P7">P7</option><option value="P8">P8</option><option value="P9">P9</option>
                        <option value="P10">P10</option><option value="P11">P11</option><option value="P12">P12</option>
                        <option value="P13">P13</option><option value="P14">P14</option><option value="P15">P15</option>
                        <option value="P16">P16</option><option value="P17">P17</option><option value="P18">P18</option>
                        <option value="P19">P19</option><option value="P20">P20</option><option value="P21">P21</option>
                        <option value="P22">P22</option><option value="P23">P23</option><option value="P24">P24</option>
                    </select>
                    <button type="button" class="btn" style="padding:5px 15px; margin-left:5px;" onclick="confirmSeat()">OK</button>
                </span>
                <span id="seatConfirmed" style="display:none; color:#2a7a4b; font-weight:600;"></span>
            </div>
            <div>Datum: <span id="currentDate"></span></div>
        </div>

        <div class="hinweis">
            <strong>Hinweise:</strong> g = 10 m/s². Kein Taschenrechner. Formeln auf Arbeitsblatt nutzbar.
        </div>

        <div class="unlock-hint" id="unlockHint">
            <strong>Bitte bestätige zuerst:</strong><br>
            Deine Platznummer (mit OK)<br><br>
            Danach werden die Aufgaben angezeigt.
        </div>

        <div id="questionsContainer">

        <!-- AUFGABE 1: MC Energieerhaltung (1 BE) -->
        <div class="aufgabe" id="aufgabe1">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 1</span>
                <span class="aufgabe-punkte" id="punkte1">__/1 BE</span>
            </div>
            <p><span class="operator">Kreuze an</span>: Welche Aussage zum Energieerhaltungssatz ist richtig?</p>
            <div class="mc-options" id="mc1-options">
                <label class="mc-option" data-value="0"><input type="radio" name="mc1" value="0">Energie kann aus dem Nichts erzeugt werden.</label>
                <label class="mc-option" data-value="1"><input type="radio" name="mc1" value="1">Die Gesamtenergie in einem geschlossenen System bleibt konstant.</label>
                <label class="mc-option" data-value="2"><input type="radio" name="mc1" value="2">Beim Bremsen verschwindet die Bewegungsenergie.</label>
            </div>
            <div class="feedback" id="fb1"></div>
            <div class="solution-box" id="sol1"><strong>Lösung:</strong> Die Gesamtenergie bleibt konstant.</div>
        </div>

        <!-- AUFGABE 2: Energieumwandlung Pendel (3 BE) -->
        <div class="aufgabe" id="aufgabe2">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 2</span>
                <span class="aufgabe-punkte" id="punkte2">__/3 BE</span>
            </div>
            <p><span class="operator">Ergänze</span> die Energieformen beim Fadenpendel (je 1 BE):</p>
            <div class="teil">
                <p>a) Am höchsten Punkt (Ruhe): E<sub>pot</sub> = <select class="unit-select" id="sel2a"><option value="">wählen</option><option value="max">maximal</option><option value="0">0</option></select>, E<sub>kin</sub> = <select class="unit-select" id="sel2a2"><option value="">wählen</option><option value="max">maximal</option><option value="0">0</option></select></p>
            </div>
            <div class="teil">
                <p>b) Im tiefsten Punkt: E<sub>pot</sub> = <select class="unit-select" id="sel2b"><option value="">wählen</option><option value="max">maximal</option><option value="0">0</option></select></p>
            </div>
            <div class="feedback" id="fb2"></div>
            <div class="solution-box" id="sol2"><strong>Lösung:</strong> a) E<sub>pot</sub> = max, E<sub>kin</sub> = 0 | b) E<sub>pot</sub> = 0</div>
        </div>

        <!-- AUFGABE 3: E_pot berechnen (2 BE) -->
        <div class="aufgabe" id="aufgabe3">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 3</span>
                <span class="aufgabe-punkte" id="punkte3">__/2 BE</span>
            </div>
            <p>Ein Stein (<span class="fz">m</span> = 2 kg) liegt auf <span class="fz">h</span> = 5 m Höhe.</p>
            <p><span class="operator">Berechne</span> die Lageenergie E<sub>pot</sub>.</p>
            <div class="calc-row">
                <span>E<sub>pot</sub> = </span>
                <input type="text" class="calc-input" id="calc3" inputmode="decimal">
                <select class="unit-select" id="unit3"><option value="">Einheit</option><option value="J">J</option><option value="N">N</option><option value="W">W</option></select>
            </div>
            <div class="feedback" id="fb3"></div>
            <div class="solution-box" id="sol3"><strong>Lösung:</strong> E<sub>pot</sub> = 2·10·5 = <strong>100 J</strong></div>
        </div>

        <!-- AUFGABE 4: E_kin = E_pot (2 BE) -->
        <div class="aufgabe" id="aufgabe4">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 4</span>
                <span class="aufgabe-punkte" id="punkte4">__/2 BE</span>
            </div>
            <p>Der Stein aus Aufgabe 3 fällt herunter (idealer Fall, keine Reibung).</p>
            <p><span class="operator">Gib an</span>: Wie groß ist E<sub>kin</sub> kurz vor dem Aufprall?</p>
            <div class="calc-row">
                <span>E<sub>kin</sub> = </span>
                <input type="text" class="calc-input" id="calc4" inputmode="decimal">
                <select class="unit-select" id="unit4"><option value="">Einheit</option><option value="J">J</option><option value="N">N</option><option value="W">W</option></select>
            </div>
            <div class="feedback" id="fb4"></div>
            <div class="solution-box" id="sol4"><strong>Lösung:</strong> E<sub>kin</sub> = E<sub>pot</sub> = <strong>100 J</strong> (Energieerhaltung)</div>
        </div>

        <!-- AUFGABE 5: v berechnen (2 BE) -->
        <div class="aufgabe" id="aufgabe5">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 5</span>
                <span class="aufgabe-punkte" id="punkte5">__/2 BE</span>
            </div>
            <p><span class="operator">Berechne</span> die Geschwindigkeit v des Steins kurz vor dem Aufprall.</p>
            <p class="hinweis" style="margin:8px 0;font-size:0.85em;">Tipp: v = √(2·E<sub>kin</sub>/m)</p>
            <div class="calc-row">
                <span>v = </span>
                <input type="text" class="calc-input" id="calc5" inputmode="decimal">
                <select class="unit-select" id="unit5"><option value="">Einheit</option><option value="m/s">m/s</option><option value="J">J</option><option value="m">m</option></select>
            </div>
            <div class="feedback" id="fb5"></div>
            <div class="solution-box" id="sol5"><strong>Lösung:</strong> v = √(2·100/2) = √100 = <strong>10 m/s</strong></div>
        </div>

        <!-- AUFGABE 6: Wirkungsgrad berechnen (3 BE) -->
        <div class="aufgabe" id="aufgabe6">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 6</span>
                <span class="aufgabe-punkte" id="punkte6">__/3 BE</span>
            </div>
            <p>Eine Lampe wird mit P<sub>zu</sub> = 100 W betrieben und gibt P<sub>Licht</sub> = 20 W als Licht ab.</p>
            <div class="teil">
                <p class="teil-label">a) <span class="operator">Berechne</span> den Wirkungsgrad η als Dezimalzahl:</p>
                <div class="calc-row"><span>η = </span><input type="text" class="calc-input" id="calc6a" inputmode="decimal" style="width:70px;"></div>
            </div>
            <div class="teil">
                <p class="teil-label">b) <span class="operator">Gib</span> η in Prozent an:</p>
                <div class="calc-row"><span>η = </span><input type="text" class="calc-input" id="calc6b" inputmode="decimal" style="width:70px;"><span> %</span></div>
            </div>
            <div class="teil">
                <p class="teil-label">c) <span class="operator">Berechne</span> die Verlustleistung P<sub>Wärme</sub>:</p>
                <div class="calc-row"><span>P<sub>Wärme</sub> = </span><input type="text" class="calc-input" id="calc6c" inputmode="decimal"><span> W</span></div>
            </div>
            <div class="feedback" id="fb6"></div>
            <div class="solution-box" id="sol6"><strong>Lösung:</strong> a) η = 20/100 = <strong>0,2</strong> | b) <strong>20 %</strong> | c) 100−20 = <strong>80 W</strong></div>
        </div>

        <!-- AUFGABE 7: MC LED vs Glühbirne (1 BE) -->
        <div class="aufgabe" id="aufgabe7">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 7</span>
                <span class="aufgabe-punkte" id="punkte7">__/1 BE</span>
            </div>
            <p>Eine LED hat η = 40%, eine Glühbirne η = 5%.</p>
            <p><span class="operator">Kreuze an</span>: Wie viel mehr Licht gibt die LED bei gleicher Leistung?</p>
            <div class="mc-options" id="mc7-options">
                <label class="mc-option" data-value="0"><input type="radio" name="mc7" value="0">Doppelt so viel</label>
                <label class="mc-option" data-value="1"><input type="radio" name="mc7" value="1">4-mal so viel</label>
                <label class="mc-option" data-value="2"><input type="radio" name="mc7" value="2">8-mal so viel</label>
            </div>
            <div class="feedback" id="fb7"></div>
            <div class="solution-box" id="sol7"><strong>Lösung:</strong> 40%/5% = <strong>8-mal so viel</strong></div>
        </div>

        <!-- AUFGABE 8: Kettenrechnung (3 BE) -->
        <div class="aufgabe" id="aufgabe8">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 8</span>
                <span class="aufgabe-punkte" id="punkte8">__/3 BE</span>
            </div>
            <p>Eine Windkraftanlage: Rotor η<sub>1</sub> = 0,50, Generator η<sub>2</sub> = 0,80.</p>
            <p>Zugeführte Energie: E<sub>Wind</sub> = 1000 J</p>
            <div class="teil">
                <p class="teil-label">a) <span class="operator">Berechne</span> den Gesamtwirkungsgrad:</p>
                <div class="calc-row"><span>η<sub>ges</sub> = η<sub>1</sub>·η<sub>2</sub> = </span><input type="text" class="calc-input" id="calc8a" inputmode="decimal" style="width:70px;"></div>
            </div>
            <div class="teil">
                <p class="teil-label">b) <span class="operator">Berechne</span> die elektrische Energie:</p>
                <div class="calc-row">
                    <span>E<sub>el</sub> = </span>
                    <input type="text" class="calc-input" id="calc8b" inputmode="decimal">
                    <select class="unit-select" id="unit8b"><option value="">Einheit</option><option value="J">J</option><option value="W">W</option><option value="%">%</option></select>
                </div>
            </div>
            <div class="feedback" id="fb8"></div>
            <div class="solution-box" id="sol8"><strong>Lösung:</strong> a) 0,50·0,80 = <strong>0,40</strong> | b) 1000·0,40 = <strong>400 J</strong></div>
        </div>

        <!-- AUFGABE 9: Energieverlust (4 BE) -->
        <div class="aufgabe" id="aufgabe9">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 9</span>
                <span class="aufgabe-punkte" id="punkte9">__/4 BE</span>
            </div>
            <p>Ein Ball (<span class="fz">m</span> = 0,5 kg) fällt aus <span class="fz">h</span> = 8 m. Durch Luftreibung erreicht er nur v = 10 m/s.</p>
            <div class="teil">
                <p class="teil-label">a) E<sub>pot</sub> oben:</p>
                <div class="calc-row"><span>E<sub>pot</sub> = </span><input type="text" class="calc-input" id="calc9a" inputmode="decimal"><span> J</span></div>
            </div>
            <div class="teil">
                <p class="teil-label">b) E<sub>kin</sub> unten (mit v = 10 m/s):</p>
                <div class="calc-row"><span>E<sub>kin</sub> = </span><input type="text" class="calc-input" id="calc9b" inputmode="decimal"><span> J</span></div>
            </div>
            <div class="teil">
                <p class="teil-label">c) Energieverlust durch Reibung:</p>
                <div class="calc-row"><span>E<sub>Verlust</sub> = </span><input type="text" class="calc-input" id="calc9c" inputmode="decimal"><span> J</span></div>
            </div>
            <div class="teil">
                <p class="teil-label">d) Wohin geht die „verlorene" Energie?</p>
                <div class="calc-row"><span>→ in </span><select class="unit-select" id="sel9d"><option value="">wählen</option><option value="Waerme">Wärme</option><option value="Licht">Licht</option><option value="Nichts">Nichts</option></select></div>
            </div>
            <div class="feedback" id="fb9"></div>
            <div class="solution-box" id="sol9"><strong>Lösung:</strong> a) 0,5·10·8 = <strong>40 J</strong> | b) ½·0,5·100 = <strong>25 J</strong> | c) 40−25 = <strong>15 J</strong> | d) <strong>Wärme</strong></div>
        </div>

        <!-- AUFGABE 10: MC Wirkungsgrad (2 BE) -->
        <div class="aufgabe" id="aufgabe10">
            <div class="aufgabe-header">
                <span class="aufgabe-title">Aufgabe 10</span>
                <span class="aufgabe-punkte" id="punkte10">__/2 BE</span>
            </div>
            <p><span class="operator">Kreuze</span> die zwei richtigen Aussagen an:</p>
            <div class="mc-options" id="mc10-options">
                <label class="mc-option" data-value="a"><input type="checkbox" name="mc10" value="a">Der Wirkungsgrad kann größer als 100% sein.</label>
                <label class="mc-option" data-value="b"><input type="checkbox" name="mc10" value="b">η = 1 bedeutet: Alle zugeführte Energie wird genutzt.</label>
                <label class="mc-option" data-value="c"><input type="checkbox" name="mc10" value="c">Bei η = 0,3 gehen 70% der Energie verloren.</label>
                <label class="mc-option" data-value="d"><input type="checkbox" name="mc10" value="d">Glühbirnen haben einen höheren Wirkungsgrad als LEDs.</label>
            </div>
            <div class="feedback" id="fb10"></div>
            <div class="solution-box" id="sol10"><strong>Lösung:</strong> b) und c) sind richtig.</div>
        </div>

        <!-- AUSWERTUNG -->
        <div class="button-row" id="submitButtons">
            <button class="btn" id="btnSubmit" onclick="submitTest()">Abgeben</button>
            <button class="btn btn-secondary" onclick="resetTest()">Zurücksetzen</button>
        </div>

        </div>

        <div class="results" id="results">
            <h2>Ergebnis</h2>
            <div class="results-grid">
                <div class="result-box">
                    <div class="value" id="resPunkte">0</div>
                    <div class="label">von 23 BE</div>
                </div>
                <div class="result-box">
                    <div class="value" id="resProzent">0%</div>
                    <div class="label">erreicht</div>
                </div>
                <div class="result-box">
                    <div class="value" id="resRichtig">0</div>
                    <div class="label">von 10 Aufgaben</div>
                </div>
            </div>
            <div class="grade-display">
                <div class="grade" id="resNote">–</div>
                <div class="label">Note (MR Klasse 10)</div>
            </div>
            <div class="button-row">
                <button class="btn btn-print" onclick="window.print()">Drucken / PDF</button>
            </div>
            <table class="grading-table">
                <tr><th>Note</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td></tr>
                <tr><th>ab %</th><td>≥96</td><td>≥80</td><td>≥60</td><td>≥40</td><td>≥20</td><td>&lt;20</td></tr>
                <tr><th>ab BE</th><td>≥24</td><td>≥20</td><td>≥15</td><td>≥10</td><td>≥5</td><td>&lt;5</td></tr>
            </table>
        </div>
    </div>

    <script>
    // MT-04 Energieumwandlung v2 | ES5 | 23 BE | max 1 BE pro Feld
    var TOTAL_POINTS = 23;
    var QUIZ_ID = 'mt04-energieumwandlung-v2';
    var testSubmitted = false;
    var tabSwitchCount = 0;
    var tabSwitchStart = 0;
    var tabSwitchSeconds = 0;

    function getNote(percent) {
        if (percent >= 96) return '1';
        if (percent >= 80) return '2';
        if (percent >= 60) return '3';
        if (percent >= 40) return '4';
        if (percent >= 20) return '5';
        return '6';
    }

    function parseNumber(val) {
        if (val === '' || val === null || val === undefined) return NaN;
        return parseFloat(String(val).replace(',', '.'));
    }

    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('de-DE');

    document.querySelectorAll('.mc-option').forEach(function(opt) {
        opt.addEventListener('click', function() {
            if (testSubmitted) return;
            var input = this.querySelector('input');
            if (input.type === 'checkbox') {
                input.checked = !input.checked;
                this.classList.toggle('selected', input.checked);
            } else {
                var name = input.name;
                document.querySelectorAll('input[name="' + name + '"]').forEach(function(inp) {
                    inp.closest('.mc-option').classList.remove('selected');
                });
                this.classList.add('selected');
                input.checked = true;
            }
            saveProgress();
        });
    });

    document.querySelectorAll('input, select').forEach(function(el) {
        el.addEventListener('change', function() { if (!testSubmitted) saveProgress(); });
        el.addEventListener('input', function() { if (!testSubmitted) saveProgress(); });
    });

    function saveProgress() {
        if (testSubmitted) return;
        var data = {};
        document.querySelectorAll('input[type="text"], select').forEach(function(el) {
            if (el.id) data[el.id] = el.value;
        });
        document.querySelectorAll('input[type="radio"]:checked').forEach(function(el) {
            data[el.name] = el.value;
        });
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(function(el) {
            data['cb_' + el.value] = 'checked';
        });
        localStorage.setItem(QUIZ_ID, JSON.stringify(data));
    }

    function loadProgress() {
        var saved = localStorage.getItem(QUIZ_ID);
        if (!saved) return;
        try {
            var data = JSON.parse(saved);
            for (var key in data) {
                if (key.indexOf('cb_') === 0) {
                    var val = key.replace('cb_', '');
                    var cb = document.querySelector('input[type="checkbox"][value="' + val + '"]');
                    if (cb) { cb.checked = true; cb.closest('.mc-option').classList.add('selected'); }
                } else {
                    var el = document.getElementById(key);
                    if (el) el.value = data[key];
                    var radio = document.querySelector('input[name="' + key + '"][value="' + data[key] + '"]');
                    if (radio) { radio.checked = true; radio.closest('.mc-option').classList.add('selected'); }
                }
            }
        } catch (e) { console.error('Fehler:', e); }
    }

    function getRadio(name) {
        var sel = document.querySelector('input[name="' + name + '"]:checked');
        return sel ? sel.value : null;
    }

    function markMcCorrect(containerId, correctValue) {
        var container = document.getElementById(containerId);
        if (!container) return;
        container.querySelectorAll('.mc-option').forEach(function(opt) {
            var val = opt.getAttribute('data-value');
            if (val === correctValue) opt.classList.add('correct-answer');
            var input = opt.querySelector('input');
            if (input && input.checked && val !== correctValue) opt.classList.add('wrong-answer');
        });
    }

    function markCheckboxCorrect(containerId, correctValues) {
        var container = document.getElementById(containerId);
        if (!container) return;
        container.querySelectorAll('.mc-option').forEach(function(opt) {
            var val = opt.getAttribute('data-value');
            var isCorrect = correctValues.indexOf(val) !== -1;
            if (isCorrect) opt.classList.add('correct-answer');
            var input = opt.querySelector('input');
            if (input && input.checked && !isCorrect) opt.classList.add('wrong-answer');
        });
    }

    function markInputCorrect(inputId, isCorrect) {
        var el = document.getElementById(inputId);
        if (el) el.classList.add(isCorrect ? 'correct' : 'incorrect');
    }

    function showSolutionBox(id) {
        var box = document.getElementById(id);
        if (box) box.classList.add('visible');
    }

    function initTabSwitchTracking() {
        var savedCount = localStorage.getItem(QUIZ_ID + '-tabswitches');
        var savedSeconds = localStorage.getItem(QUIZ_ID + '-tabseconds');
        if (savedCount) tabSwitchCount = parseInt(savedCount);
        if (savedSeconds) tabSwitchSeconds = parseInt(savedSeconds);
        document.addEventListener('visibilitychange', function() {
            if (testSubmitted) return;
            if (document.hidden) {
                tabSwitchStart = Date.now();
                tabSwitchCount++;
                localStorage.setItem(QUIZ_ID + '-tabswitches', tabSwitchCount);
            } else {
                if (tabSwitchStart > 0) {
                    var duration = Math.round((Date.now() - tabSwitchStart) / 1000);
                    tabSwitchSeconds += duration;
                    localStorage.setItem(QUIZ_ID + '-tabseconds', tabSwitchSeconds);
                    tabSwitchStart = 0;
                }
            }
        });
    }

    function formatTimestamp(ts) {
        if (!ts) return '—';
        var d = new Date(parseInt(ts));
        return d.toLocaleDateString('de-DE') + ' ' + d.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}) + ' Uhr';
    }

    function formatDuration(sec) {
        if (sec < 60) return sec + ' Sek.';
        return Math.floor(sec/60) + ':' + (sec%60 < 10 ? '0' : '') + (sec%60) + ' Min.';
    }

    function disableAllInputs() {
        document.querySelectorAll('input, select').forEach(function(el) {
            if (el.id !== 'platzNummer') el.disabled = true;
        });
    }

    function confirmSeat() {
        var select = document.getElementById('platzNummer');
        var num = select.value;
        if (!num) { alert('Bitte wähle zuerst eine Platznummer!'); return; }
        var ok = confirm('Platznummer ' + num + ' bestätigen?');
        if (!ok) return;
        localStorage.setItem(QUIZ_ID + '-seat', num);
        localStorage.setItem(QUIZ_ID + '-seat-locked', 'true');
        showLockedSeat(num);
        checkUnlocked();
    }

    function showLockedSeat(num) {
        document.getElementById('seatSelectRow').style.display = 'none';
        document.getElementById('seatConfirmed').style.display = 'inline';
        document.getElementById('seatConfirmed').innerHTML = 'Platz: <strong>' + num + '</strong>';
    }

    function checkUnlocked() {
        var seatLocked = localStorage.getItem(QUIZ_ID + '-seat-locked') === 'true';
        var container = document.getElementById('questionsContainer');
        var hint = document.getElementById('unlockHint');
        if (seatLocked) { container.classList.add('unlocked'); hint.style.display = 'none'; }
        else { container.classList.remove('unlocked'); hint.style.display = 'block'; }
    }

    function submitTest() {
        if (testSubmitted) return;
        var platz = document.getElementById('platzNummer').value;
        if (!platz) { alert('Bitte wähle zuerst deinen Platz!'); return; }
        localStorage.setItem(QUIZ_ID + '-submit-time', Date.now());

        var total = 0;
        var richtig = 0;

        // A1: MC (1 BE)
        var mc1 = getRadio('mc1');
        var p1 = mc1 === '1' ? 1 : 0;
        if (p1 === 1) richtig++;
        markMcCorrect('mc1-options', '1');
        showSolutionBox('sol1');
        document.getElementById('fb1').className = 'feedback ' + (p1 ? 'correct' : 'incorrect');
        document.getElementById('fb1').textContent = p1 ? 'Richtig! (1/1 BE)' : 'Falsch. (0/1 BE)';
        document.getElementById('punkte1').textContent = p1 + '/1 BE';
        total += p1;

        // A2: Pendel Dropdown (3 BE: 1+1+1)
        var s2a = document.getElementById('sel2a').value;
        var s2a2 = document.getElementById('sel2a2').value;
        var s2b = document.getElementById('sel2b').value;
        var p2 = 0;
        var s2aCorr = s2a === 'max'; if (s2aCorr) p2++;
        var s2a2Corr = s2a2 === '0'; if (s2a2Corr) p2++;
        var s2bCorr = s2b === '0'; if (s2bCorr) p2++;
        markInputCorrect('sel2a', s2aCorr);
        markInputCorrect('sel2a2', s2a2Corr);
        markInputCorrect('sel2b', s2bCorr);
        if (p2 === 3) richtig++;
        showSolutionBox('sol2');
        document.getElementById('fb2').className = 'feedback ' + (p2 === 3 ? 'correct' : p2 > 0 ? 'partial' : 'incorrect');
        document.getElementById('fb2').textContent = '(' + p2 + '/3 BE)';
        document.getElementById('punkte2').textContent = p2 + '/3 BE';
        total += p2;

        // A3: E_pot = 100 J (2 BE: 1 Wert + 1 Einheit)
        var v3 = parseNumber(document.getElementById('calc3').value);
        var u3 = document.getElementById('unit3').value;
        var p3 = 0;
        var v3Corr = Math.abs(v3 - 100) < 1; if (v3Corr) p3++;
        var u3Corr = u3 === 'J'; if (u3Corr) p3++;
        markInputCorrect('calc3', v3Corr);
        markInputCorrect('unit3', u3Corr);
        if (p3 === 2) richtig++;
        showSolutionBox('sol3');
        document.getElementById('fb3').className = 'feedback ' + (p3 === 2 ? 'correct' : p3 > 0 ? 'partial' : 'incorrect');
        document.getElementById('fb3').textContent = '(' + p3 + '/2 BE)';
        document.getElementById('punkte3').textContent = p3 + '/2 BE';
        total += p3;

        // A4: E_kin = 100 J (2 BE)
        var v4 = parseNumber(document.getElementById('calc4').value);
        var u4 = document.getElementById('unit4').value;
        var p4 = 0;
        var v4Corr = Math.abs(v4 - 100) < 1; if (v4Corr) p4++;
        var u4Corr = u4 === 'J'; if (u4Corr) p4++;
        markInputCorrect('calc4', v4Corr);
        markInputCorrect('unit4', u4Corr);
        if (p4 === 2) richtig++;
        showSolutionBox('sol4');
        document.getElementById('fb4').className = 'feedback ' + (p4 === 2 ? 'correct' : p4 > 0 ? 'partial' : 'incorrect');
        document.getElementById('fb4').textContent = '(' + p4 + '/2 BE)';
        document.getElementById('punkte4').textContent = p4 + '/2 BE';
        total += p4;

        // A5: v = 10 m/s (2 BE)
        var v5 = parseNumber(document.getElementById('calc5').value);
        var u5 = document.getElementById('unit5').value;
        var p5 = 0;
        var v5Corr = Math.abs(v5 - 10) < 0.5; if (v5Corr) p5++;
        var u5Corr = u5 === 'm/s'; if (u5Corr) p5++;
        markInputCorrect('calc5', v5Corr);
        markInputCorrect('unit5', u5Corr);
        if (p5 === 2) richtig++;
        showSolutionBox('sol5');
        document.getElementById('fb5').className = 'feedback ' + (p5 === 2 ? 'correct' : p5 > 0 ? 'partial' : 'incorrect');
        document.getElementById('fb5').textContent = '(' + p5 + '/2 BE)';
        document.getElementById('punkte5').textContent = p5 + '/2 BE';
        total += p5;

        // A6: Wirkungsgrad (3 BE: 1+1+1)
        var v6a = parseNumber(document.getElementById('calc6a').value);
        var v6b = parseNumber(document.getElementById('calc6b').value);
        var v6c = parseNumber(document.getElementById('calc6c').value);
        var p6 = 0;
        var v6aCorr = Math.abs(v6a - 0.2) < 0.01; if (v6aCorr) p6++;
        var v6bCorr = Math.abs(v6b - 20) < 1; if (v6bCorr) p6++;
        var v6cCorr = Math.abs(v6c - 80) < 1; if (v6cCorr) p6++;
        markInputCorrect('calc6a', v6aCorr);
        markInputCorrect('calc6b', v6bCorr);
        markInputCorrect('calc6c', v6cCorr);
        if (p6 === 3) richtig++;
        showSolutionBox('sol6');
        document.getElementById('fb6').className = 'feedback ' + (p6 === 3 ? 'correct' : p6 > 0 ? 'partial' : 'incorrect');
        document.getElementById('fb6').textContent = '(' + p6 + '/3 BE)';
        document.getElementById('punkte6').textContent = p6 + '/3 BE';
        total += p6;

        // A7: MC LED (1 BE)
        var mc7 = getRadio('mc7');
        var p7 = mc7 === '2' ? 1 : 0;
        if (p7 === 1) richtig++;
        markMcCorrect('mc7-options', '2');
        showSolutionBox('sol7');
        document.getElementById('fb7').className = 'feedback ' + (p7 ? 'correct' : 'incorrect');
        document.getElementById('fb7').textContent = p7 ? 'Richtig! (1/1 BE)' : 'Falsch. (0/1 BE)';
        document.getElementById('punkte7').textContent = p7 + '/1 BE';
        total += p7;

        // A8: Kette (3 BE: 1+1+1)
        var v8a = parseNumber(document.getElementById('calc8a').value);
        var v8b = parseNumber(document.getElementById('calc8b').value);
        var u8b = document.getElementById('unit8b').value;
        var p8 = 0;
        var v8aCorr = Math.abs(v8a - 0.4) < 0.02; if (v8aCorr) p8++;
        var v8bCorr = Math.abs(v8b - 400) < 5; if (v8bCorr) p8++;
        var u8bCorr = u8b === 'J'; if (u8bCorr) p8++;
        markInputCorrect('calc8a', v8aCorr);
        markInputCorrect('calc8b', v8bCorr);
        markInputCorrect('unit8b', u8bCorr);
        if (p8 === 3) richtig++;
        showSolutionBox('sol8');
        document.getElementById('fb8').className = 'feedback ' + (p8 === 3 ? 'correct' : p8 > 0 ? 'partial' : 'incorrect');
        document.getElementById('fb8').textContent = '(' + p8 + '/3 BE)';
        document.getElementById('punkte8').textContent = p8 + '/3 BE';
        total += p8;

        // A9: Verlust (4 BE: 1+1+1+1)
        var v9a = parseNumber(document.getElementById('calc9a').value);
        var v9b = parseNumber(document.getElementById('calc9b').value);
        var v9c = parseNumber(document.getElementById('calc9c').value);
        var s9d = document.getElementById('sel9d').value;
        var p9 = 0;
        var v9aCorr = Math.abs(v9a - 40) < 1; if (v9aCorr) p9++;
        var v9bCorr = Math.abs(v9b - 25) < 1; if (v9bCorr) p9++;
        var v9cCorr = Math.abs(v9c - 15) < 1; if (v9cCorr) p9++;
        var s9dCorr = s9d === 'Waerme'; if (s9dCorr) p9++;
        markInputCorrect('calc9a', v9aCorr);
        markInputCorrect('calc9b', v9bCorr);
        markInputCorrect('calc9c', v9cCorr);
        markInputCorrect('sel9d', s9dCorr);
        if (p9 === 4) richtig++;
        showSolutionBox('sol9');
        document.getElementById('fb9').className = 'feedback ' + (p9 === 4 ? 'correct' : p9 > 0 ? 'partial' : 'incorrect');
        document.getElementById('fb9').textContent = '(' + p9 + '/4 BE)';
        document.getElementById('punkte9').textContent = p9 + '/4 BE';
        total += p9;

        // A10: MC Checkbox (2 BE: je 1 für b, c)
        var cbB = document.querySelector('input[value="b"]').checked;
        var cbC = document.querySelector('input[value="c"]').checked;
        var cbA = document.querySelector('input[value="a"]').checked;
        var cbD = document.querySelector('input[value="d"]').checked;
        var p10 = 0;
        if (cbB && !cbA && !cbD) p10++;
        if (cbC && !cbA && !cbD) p10++;
        if (cbA || cbD) p10 = Math.max(0, p10 - 1);
        p10 = Math.max(0, Math.min(2, p10));
        if (p10 === 2) richtig++;
        markCheckboxCorrect('mc10-options', ['b', 'c']);
        showSolutionBox('sol10');
        document.getElementById('fb10').className = 'feedback ' + (p10 === 2 ? 'correct' : p10 > 0 ? 'partial' : 'incorrect');
        document.getElementById('fb10').textContent = '(' + p10 + '/2 BE)';
        document.getElementById('punkte10').textContent = p10 + '/2 BE';
        total += p10;

        // Ergebnis
        var prozent = Math.round((total / TOTAL_POINTS) * 100);
        document.getElementById('resPunkte').textContent = total;
        document.getElementById('resProzent').textContent = prozent + '%';
        document.getElementById('resRichtig').textContent = richtig;
        document.getElementById('resNote').textContent = getNote(prozent);
        document.getElementById('results').style.display = 'block';
        document.getElementById('btnSubmit').disabled = true;
        document.getElementById('lockedNotice').classList.add('visible');
        testSubmitted = true;
        disableAllInputs();

        var startTS = localStorage.getItem(QUIZ_ID + '-start');
        var submitTS = localStorage.getItem(QUIZ_ID + '-submit-time');
        var switches = localStorage.getItem(QUIZ_ID + '-tabswitches') || '0';
        var switchSec = localStorage.getItem(QUIZ_ID + '-tabseconds') || '0';
        var tsHtml = '<div style="margin-top:20px;padding:12px;background:#f5f5f5;border:1px solid #ddd;font-size:0.85em;">' +
            '<div><strong>Aufruf:</strong> ' + formatTimestamp(startTS) + '</div>' +
            '<div><strong>Abgabe:</strong> ' + formatTimestamp(submitTS) + '</div>' +
            '<div><strong>Tab-Wechsel:</strong> ' + switches + '× (' + formatDuration(parseInt(switchSec)) + ')</div></div>';
        document.getElementById('results').insertAdjacentHTML('beforeend', tsHtml);

        localStorage.setItem(QUIZ_ID + '-result', JSON.stringify({platz:platz, total:total, percent:prozent, note:getNote(prozent), richtig:richtig, submitted:true}));
        document.getElementById('results').scrollIntoView({behavior:'smooth'});
    }

    function resetTest() {
        if (!confirm('Alle Eingaben löschen?')) return;
        ['', '-result', '-start', '-submit-time', '-seat', '-seat-locked', '-tabswitches', '-tabseconds'].forEach(function(s) {
            localStorage.removeItem(QUIZ_ID + s);
        });
        location.reload();
    }

    function restoreSubmittedState() {
        var r = localStorage.getItem(QUIZ_ID + '-result');
        if (!r) return false;
        try {
            var res = JSON.parse(r);
            if (res.submitted) { loadProgress(); testSubmitted = false; submitTest(); return true; }
        } catch(e) {}
        return false;
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (!localStorage.getItem(QUIZ_ID + '-start')) localStorage.setItem(QUIZ_ID + '-start', Date.now());
        initTabSwitchTracking();
        var seat = localStorage.getItem(QUIZ_ID + '-seat');
        if (seat && localStorage.getItem(QUIZ_ID + '-seat-locked') === 'true') showLockedSeat(seat);
        if (!restoreSubmittedState()) loadProgress();
        checkUnlocked();
    });
    </script>
</body>
</html>
