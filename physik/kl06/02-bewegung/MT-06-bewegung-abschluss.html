<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abschlusstest: Bewegung | Physik Klasse 6</title>
    <style>
        /* ═══════════════════════════════════════════════════════════════
           MT-06 ABSCHLUSSTEST: Bewegung | Physik Klasse 6
           BE-Struktur: * = 25 BE | ** = 31 BE | *** = 37 BE
           ═══════════════════════════════════════════════════════════════ */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            color: #222;
            font-size: 16px;
            line-height: 1.5;
        }
        .container { max-width: 850px; margin: 0 auto; padding: 20px; }

        header {
            background: #2c5aa0;
            color: white;
            padding: 15px 20px;
        }
        header h1 { font-size: 1.3em; font-weight: 600; }
        .header-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
        .header-info .meta { font-size: 0.85em; opacity: 0.9; }

        .selection-row { display: flex; gap: 20px; flex-wrap: wrap; margin: 15px 20px; }
        .selection-field { flex: 1; min-width: 280px; padding: 15px; background: #fff; border: 1px solid #ddd; }
        .selection-field label { font-weight: 600; font-size: 0.9em; color: #2c5aa0; display: block; margin-bottom: 8px; }
        .warning-box { background: #fff3e0; border: 1px solid #b35c00; padding: 8px 10px; margin-bottom: 10px; font-size: 0.8em; color: #b35c00; }
        .confirm-row { display: flex; align-items: center; gap: 8px; }
        .confirm-row select { padding: 8px 12px; font-size: 1em; border: 1px solid #2c5aa0; min-width: 100px; }
        .confirmed-text { font-size: 1em; color: #2a7a4b; font-weight: 600; }

        .progress-container { background: white; padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 15px; }
        .progress-bar { flex: 1; background: #e0e0e0; height: 8px; }
        .progress-fill { background: #2c5aa0; height: 100%; width: 0%; transition: width 0.3s; }
        .progress-text { font-size: 0.85em; color: #666; min-width: 120px; }

        .question { background: white; border: 1px solid #ddd; margin: 15px 0; padding: 20px; }
        .question-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
        .question-title { color: #2c5aa0; font-weight: 600; font-size: 1em; }
        .question-meta { display: flex; gap: 8px; align-items: center; }
        .question-niveau { padding: 2px 8px; font-size: 0.8em; font-weight: 600; border-radius: 3px; }
        .niveau-1 { background: #e8f5e9; color: #2a7a4b; }
        .niveau-2 { background: #e3f2fd; color: #2c5aa0; }
        .niveau-3 { background: #f3e5f5; color: #7b1fa2; }
        .question-points { background: #f0f0f0; padding: 3px 10px; font-size: 0.8em; color: #666; }
        .question-text { margin-bottom: 15px; }
        .question-result { display: inline-block; padding: 3px 10px; font-size: 0.8em; font-weight: 600; margin-left: 8px; }
        .question-result.full { background: #e8f5e9; color: #2a7a4b; }
        .question-result.partial { background: #fff3e0; color: #b35c00; }
        .question-result.zero { background: #ffebee; color: #c62828; }

        .feedback-box { padding: 12px 15px; margin: 10px 0; font-size: 0.9em; display: none; }
        .feedback-box.show { display: block; }
        .feedback-box.correct { background: #e8f5e9; border-left: 3px solid #2a7a4b; }
        .feedback-box.incorrect { background: #ffebee; border-left: 3px solid #c62828; }

        .lueckentext { line-height: 2.2; font-size: 1em; }
        .lueckentext select {
            padding: 4px 8px;
            font-size: 0.95em;
            border: 1px solid #2c5aa0;
            border-radius: 2px;
            background: #fafafa;
            min-width: 130px;
        }
        .lueckentext select.correct { border-color: #2a7a4b; background: #e8f5e9; }
        .lueckentext select.incorrect { border-color: #c62828; background: #ffebee; }

        .zuordnung-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .zuordnung-table th { background: #2c5aa0; color: white; padding: 8px 6px; text-align: center; font-size: 0.85em; }
        .zuordnung-table td { border: 1px solid #ddd; padding: 8px 6px; }
        .zuordnung-table td:first-child { font-weight: 500; }
        .zuordnung-table td:not(:first-child) { text-align: center; }
        .zuordnung-table tr:nth-child(even) { background: #fafafa; }
        .zuordnung-table input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
        .zuordnung-table input.correct-check { accent-color: #2a7a4b; }
        .zuordnung-table input.incorrect-check { accent-color: #c62828; outline: 2px solid #c62828; }
        .zuordnung-table input.missed-check { outline: 2px dashed #b35c00; }

        .calc-box { background: #fafafa; border: 1px solid #ddd; padding: 15px; margin: 10px 0; }
        .calc-box h4 { color: #2c5aa0; margin-bottom: 10px; font-size: 0.95em; }
        .calc-row { display: flex; align-items: center; gap: 10px; margin: 8px 0; flex-wrap: wrap; }
        .calc-row label { min-width: 80px; font-weight: 500; }
        .calc-row input[type="text"], .calc-row input[type="number"] {
            padding: 8px 12px;
            font-size: 1em;
            border: 1px solid #2c5aa0;
            width: 100px;
            min-height: 44px;
        }
        .calc-row input.correct { border-color: #2a7a4b; background: #e8f5e9; }
        .calc-row input.incorrect { border-color: #c62828; background: #ffebee; }
        .calc-row .unit { color: #666; font-size: 0.9em; }

        .options { display: flex; flex-direction: column; gap: 8px; }
        .option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: #fafafa;
            border: 1px solid #ddd;
            cursor: pointer;
            min-height: 44px;
        }
        .option:hover { background: #f0f0f0; }
        .option input[type="radio"] { width: 20px; height: 20px; cursor: pointer; }
        .option.selected { background: #e3f2fd; border-color: #2c5aa0; }
        .option.correct-option { background: #e8f5e9; border-color: #2a7a4b; }
        .option.incorrect-option { background: #ffebee; border-color: #c62828; }

        .hinweis { background: #fff3e0; border: 1px solid #b35c00; padding: 8px 12px; margin-bottom: 15px; font-size: 0.85em; color: #b35c00; }
        .tipp { background: #e3f2fd; border: 1px solid #2c5aa0; padding: 8px 12px; margin: 10px 0; font-size: 0.85em; color: #2c5aa0; }

        /* ISO 80000: Bruchdarstellung */
        .frac {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 4px;
            line-height: 1;
        }
        .frac .z {
            border-bottom: 1.5px solid currentColor;
            padding: 0 5px 2px;
            text-align: center;
        }
        .frac .n {
            padding: 2px 5px 0;
            text-align: center;
        }
        /* ISO 80000: Formelzeichen kursiv, Einheiten aufrecht */
        .fz { font-style: italic; }
        .eh { font-style: normal; }

        .svg-container {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            overflow-x: auto;
        }
        .svg-container svg { max-width: 100%; height: auto; }

        .submit-section { background: white; padding: 20px; border: 1px solid #ddd; margin: 20px 0; text-align: center; }
        button { background: #2c5aa0; color: white; border: none; padding: 12px 30px; font-size: 1em; cursor: pointer; margin: 5px; min-height: 44px; }
        button:hover { background: #1e4080; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        button.btn-secondary { background: #666; }
        button.btn-small { padding: 8px 15px; font-size: 0.9em; min-height: 44px; }

        .results { background: white; border: 2px solid #2c5aa0; padding: 25px; margin: 20px 0; text-align: center; }
        .results h2 { color: #2c5aa0; margin-bottom: 15px; }
        .results .score { font-size: 3em; font-weight: bold; color: #2c5aa0; }
        .results .grade { font-size: 1.5em; margin: 10px 0; }
        .grade-table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.8em; }
        .grade-table th, .grade-table td { border: 1px solid #ddd; padding: 5px 6px; text-align: center; }
        .grade-table th { background: #2c5aa0; color: white; }
        .grade-table .current { background: #e8f5e9; font-weight: bold; }

        .hidden { display: none; }

        .teacher-section { background: #fff3e0; border: 2px dashed #b35c00; padding: 15px; margin: 20px; }
        .teacher-section h3 { color: #b35c00; margin-bottom: 10px; }

        @media print {
            button, .progress-container, .selection-row, .teacher-section { display: none; }
            .question { page-break-inside: avoid; }
        }

        @media (max-width: 600px) {
            .zuordnung-table { font-size: 0.8em; }
            .zuordnung-table th, .zuordnung-table td { padding: 6px 4px; }
            .calc-row { flex-direction: column; align-items: flex-start; gap: 5px; }
            .calc-row label { min-width: auto; }
            .calc-row input { width: 100% !important; max-width: 150px; }
            .svg-container { padding: 10px 5px; }
            .svg-container svg { width: 100%; height: auto; }
            .options .option { padding: 15px; }
            .selection-row { flex-direction: column; margin: 10px; }
            .selection-field { min-width: 100%; }
        }

        /* Touch-Optimierung für iOS */
        select, input[type="number"] {
            -webkit-tap-highlight-color: transparent;
        }

        input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        input[type="radio"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>Abschlusstest: Bewegung</h1>
        <div class="header-info">
            <div class="meta">Physik Klasse 6 | Offene Unterlagen erlaubt</div>
        </div>
    </header>

    <div class="selection-row">
        <div class="selection-field">
            <label>Platznummer:</label>
            <div id="seatWarning" class="warning-box">
                Kann nach OK <strong>nicht mehr geändert</strong> werden!
            </div>
            <div id="seatRow" class="confirm-row">
                <select id="seatSelect">
                    <option value="">-- wählen --</option>
                </select>
                <button class="btn-small" onclick="confirmSeat()">OK</button>
            </div>
            <div id="seatConfirmed" class="confirmed-text" style="display:none;"></div>
        </div>

        <div class="selection-field">
            <label>Dein Niveau:</label>
            <div id="niveauWarning" class="warning-box">
                Kann nach OK <strong>nicht mehr geändert</strong> werden!
            </div>
            <div id="niveauRow" class="confirm-row">
                <select id="niveauSelect">
                    <option value="">-- wählen --</option>
                    <option value="1">* Basis (25 BE)</option>
                    <option value="2">** Standard (31 BE)</option>
                    <option value="3">*** Erweitert (37 BE)</option>
                </select>
                <button class="btn-small" onclick="confirmNiveau()">OK</button>
            </div>
            <div id="niveauConfirmed" class="confirmed-text" style="display:none;"></div>
        </div>
    </div>

    <div class="progress-container">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-text" id="progressText">Niveau wählen...</div>
    </div>

    <div class="container">

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 1: Lückentext - Bewegung beschreiben (5 BE) - ALLE NIVEAUS
             Themenbereich 1: Bewegungsarten
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q1" data-niveau="1" data-points="5">
            <div class="question-header">
                <div class="question-title">Aufgabe 1: Bewegung beschreiben</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">*</span>
                    <span class="question-points">5 BE</span>
                </div>
            </div>
            <div class="question-text">Ergänze den Lückentext mit den richtigen Begriffen.</div>
            <div class="lueckentext">
                Ein Körper ist in Bewegung, wenn er seinen
                <select id="q1-a"><option value="">---</option><option value="ort">Ort</option><option value="namen">Namen</option><option value="zustand">Zustand</option></select>
                verändert. Die
                <select id="q1-b"><option value="">---</option><option value="bahnform">Bahnform</option><option value="farbe">Farbe</option><option value="geschwindigkeit">Geschwindigkeit</option></select>
                beschreibt, wie der Weg aussieht (gerade oder krummlinig). Bleibt die Geschwindigkeit gleich, ist die Bewegung
                <select id="q1-c"><option value="">---</option><option value="gleichfoermig">gleichförmig</option><option value="ungleichfoermig">ungleichförmig</option><option value="geradlinig">geradlinig</option></select>.
                Eine Bewegung auf einer geraden Linie heißt
                <select id="q1-d"><option value="">---</option><option value="geradlinig">geradlinig</option><option value="krummlinig">krummlinig</option><option value="gleichfoermig">gleichförmig</option></select>.
                Ein Karussell bewegt sich auf einer
                <select id="q1-e"><option value="">---</option><option value="krummlinigen">krummlinigen</option><option value="geradlinigen">geradlinigen</option><option value="ungleichfoermigen">ungleichförmigen</option></select>
                Bahn.
            </div>
            <div class="feedback-box correct" id="q1-fb-correct">Super! Du kennst die Grundbegriffe der Bewegungslehre.</div>
            <div class="feedback-box incorrect" id="q1-fb-incorrect">Einige Begriffe sind vertauscht. Schau nochmal in dein Lernblatt!</div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 2: Zuordnungstabelle - Bewegungen klassifizieren (6 BE) - ALLE NIVEAUS
             Themenbereich 1: Bewegungsarten
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q2" data-niveau="1" data-points="6">
            <div class="question-header">
                <div class="question-title">Aufgabe 2: Bewegungen zuordnen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">*</span>
                    <span class="question-points">6 BE</span>
                </div>
            </div>
            <div class="question-text">Kreuze für jedes Beispiel <strong>genau 2 Kästchen</strong> an: eine Bahnform und eine Bewegungsart.</div>
            <table class="zuordnung-table">
                <thead>
                    <tr>
                        <th style="width:40%;">Beispiel</th>
                        <th>gerad-<br>linig</th>
                        <th>krumm-<br>linig</th>
                        <th>gleich-<br>förmig</th>
                        <th>ungleich-<br>förmig</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-correct="geradlinig,gleichfoermig">
                        <td>a) Rolltreppe (konstant)</td>
                        <td><input type="checkbox" name="q2a-bahn" value="geradlinig"></td>
                        <td><input type="checkbox" name="q2a-bahn" value="krummlinig"></td>
                        <td><input type="checkbox" name="q2a-art" value="gleichfoermig"></td>
                        <td><input type="checkbox" name="q2a-art" value="ungleichfoermig"></td>
                    </tr>
                    <tr data-correct="krummlinig,gleichfoermig">
                        <td>b) Karussell (dreht gleichmäßig)</td>
                        <td><input type="checkbox" name="q2b-bahn" value="geradlinig"></td>
                        <td><input type="checkbox" name="q2b-bahn" value="krummlinig"></td>
                        <td><input type="checkbox" name="q2b-art" value="gleichfoermig"></td>
                        <td><input type="checkbox" name="q2b-art" value="ungleichfoermig"></td>
                    </tr>
                    <tr data-correct="geradlinig,ungleichfoermig">
                        <td>c) Auto bremst vor Ampel</td>
                        <td><input type="checkbox" name="q2c-bahn" value="geradlinig"></td>
                        <td><input type="checkbox" name="q2c-bahn" value="krummlinig"></td>
                        <td><input type="checkbox" name="q2c-art" value="gleichfoermig"></td>
                        <td><input type="checkbox" name="q2c-art" value="ungleichfoermig"></td>
                    </tr>
                    <tr data-correct="krummlinig,ungleichfoermig">
                        <td>d) Ball wird geworfen</td>
                        <td><input type="checkbox" name="q2d-bahn" value="geradlinig"></td>
                        <td><input type="checkbox" name="q2d-bahn" value="krummlinig"></td>
                        <td><input type="checkbox" name="q2d-art" value="gleichfoermig"></td>
                        <td><input type="checkbox" name="q2d-art" value="ungleichfoermig"></td>
                    </tr>
                    <tr data-correct="geradlinig,gleichfoermig">
                        <td>e) ICE auf gerader Strecke</td>
                        <td><input type="checkbox" name="q2e-bahn" value="geradlinig"></td>
                        <td><input type="checkbox" name="q2e-bahn" value="krummlinig"></td>
                        <td><input type="checkbox" name="q2e-art" value="gleichfoermig"></td>
                        <td><input type="checkbox" name="q2e-art" value="ungleichfoermig"></td>
                    </tr>
                    <tr data-correct="geradlinig,ungleichfoermig">
                        <td>f) Sprinter beim 100m-Lauf</td>
                        <td><input type="checkbox" name="q2f-bahn" value="geradlinig"></td>
                        <td><input type="checkbox" name="q2f-bahn" value="krummlinig"></td>
                        <td><input type="checkbox" name="q2f-art" value="gleichfoermig"></td>
                        <td><input type="checkbox" name="q2f-art" value="ungleichfoermig"></td>
                    </tr>
                </tbody>
            </table>
            <div class="feedback-box correct" id="q2-fb-correct">Alle Bewegungen richtig zugeordnet!</div>
            <div class="feedback-box incorrect" id="q2-fb-incorrect">Einige Zuordnungen stimmen nicht. Denke daran: Kreisförmig = krummlinig!</div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 3: Geschwindigkeit berechnen (4 BE) - ALLE NIVEAUS
             Themenbereich 2: v = s/t
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q3" data-niveau="1" data-points="4">
            <div class="question-header">
                <div class="question-title">Aufgabe 3: Geschwindigkeit berechnen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">*</span>
                    <span class="question-points">4 BE</span>
                </div>
            </div>
            <div class="question-text">Lisa fährt mit dem Fahrrad <strong>200 m</strong> in <strong>40 s</strong>. Berechne ihre Geschwindigkeit.</div>
            <div class="calc-box">
                <h4>Rechnung:</h4>
                <div class="calc-row">
                    <label><span class="fz">v</span> = <span class="frac"><span class="z"><span class="fz">s</span></span><span class="n"><span class="fz">t</span></span></span> =</label>
                    <span class="frac" style="font-size:1.1em;">
                        <span class="z"><input type="number" id="q3-s" placeholder="?" style="width:70px; min-height:44px; padding:4px 8px;"> <span class="unit">m</span></span>
                        <span class="n"><input type="number" id="q3-t" placeholder="?" style="width:70px; min-height:44px; padding:4px 8px;"> <span class="unit">s</span></span>
                    </span>
                    <span class="unit">=</span>
                    <input type="number" id="q3-v" step="0.1" placeholder="?">
                    <span class="unit"><span class="frac"><span class="z">m</span><span class="n">s</span></span></span>
                </div>
            </div>
            <div class="feedback-box correct" id="q3-fb-correct">Richtig! <span class="fz">v</span> = <span class="frac"><span class="z">200 m</span><span class="n">40 s</span></span> = 5 <span class="frac"><span class="z">m</span><span class="n">s</span></span></div>
            <div class="feedback-box incorrect" id="q3-fb-incorrect">Schau nochmal: <span class="fz">v</span> = <span class="frac"><span class="z"><span class="fz">s</span></span><span class="n"><span class="fz">t</span></span></span>. Setze die Werte ein und teile!</div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 4: s-t-Diagramm ablesen (5 BE) - ALLE NIVEAUS
             Themenbereich 3: Weg-Zeit-Diagramme
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q4" data-niveau="1" data-points="5">
            <div class="question-header">
                <div class="question-title">Aufgabe 4: Weg-Zeit-Diagramm ablesen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">*</span>
                    <span class="question-points">5 BE</span>
                </div>
            </div>
            <div class="question-text">Das Diagramm zeigt die Bewegung eines Joggers. Lies die Werte ab und beantworte die Fragen.</div>

            <div class="svg-container">
                <svg viewBox="0 0 420 280" width="420" height="280">
                    <!-- Hintergrund -->
                    <rect x="50" y="10" width="360" height="240" fill="#fafafa" stroke="#ddd"/>

                    <!-- Gitternetz -->
                    <g stroke="#e0e0e0" stroke-width="1">
                        <!-- Horizontale Linien (alle 50m) -->
                        <line x1="50" y1="58" x2="410" y2="58"/>
                        <line x1="50" y1="106" x2="410" y2="106"/>
                        <line x1="50" y1="154" x2="410" y2="154"/>
                        <line x1="50" y1="202" x2="410" y2="202"/>
                        <!-- Vertikale Linien (alle 20s) -->
                        <line x1="122" y1="10" x2="122" y2="250"/>
                        <line x1="194" y1="10" x2="194" y2="250"/>
                        <line x1="266" y1="10" x2="266" y2="250"/>
                        <line x1="338" y1="10" x2="338" y2="250"/>
                    </g>

                    <!-- Achsen -->
                    <line x1="50" y1="250" x2="410" y2="250" stroke="#333" stroke-width="2"/>
                    <line x1="50" y1="10" x2="50" y2="250" stroke="#333" stroke-width="2"/>

                    <!-- Achsenbeschriftung -->
                    <text x="230" y="275" text-anchor="middle" font-size="14" fill="#333">Zeit <tspan font-style="italic">t</tspan> in s</text>
                    <text x="15" y="130" text-anchor="middle" font-size="14" fill="#333" transform="rotate(-90, 15, 130)">Weg <tspan font-style="italic">s</tspan> in m</text>

                    <!-- Y-Achse Werte -->
                    <text x="45" y="254" text-anchor="end" font-size="12" fill="#666">0</text>
                    <text x="45" y="206" text-anchor="end" font-size="12" fill="#666">50</text>
                    <text x="45" y="158" text-anchor="end" font-size="12" fill="#666">100</text>
                    <text x="45" y="110" text-anchor="end" font-size="12" fill="#666">150</text>
                    <text x="45" y="62" text-anchor="end" font-size="12" fill="#666">200</text>

                    <!-- X-Achse Werte -->
                    <text x="50" y="268" text-anchor="middle" font-size="12" fill="#666">0</text>
                    <text x="122" y="268" text-anchor="middle" font-size="12" fill="#666">20</text>
                    <text x="194" y="268" text-anchor="middle" font-size="12" fill="#666">40</text>
                    <text x="266" y="268" text-anchor="middle" font-size="12" fill="#666">60</text>
                    <text x="338" y="268" text-anchor="middle" font-size="12" fill="#666">80</text>
                    <text x="410" y="268" text-anchor="middle" font-size="12" fill="#666">100</text>

                    <!-- Bewegungslinie: Abschnitt A (0-20s: 0-100m, schnell) -->
                    <line x1="50" y1="250" x2="122" y2="154" stroke="#2c5aa0" stroke-width="3"/>
                    <!-- Abschnitt B (20-40s: 100m, Pause) -->
                    <line x1="122" y1="154" x2="194" y2="154" stroke="#2c5aa0" stroke-width="3"/>
                    <!-- Abschnitt C (40-60s: 100-150m, langsamer) -->
                    <line x1="194" y1="154" x2="266" y2="106" stroke="#2c5aa0" stroke-width="3"/>

                    <!-- Abschnitts-Beschriftungen -->
                    <text x="86" y="195" text-anchor="middle" font-size="13" fill="#2c5aa0" font-weight="bold">A</text>
                    <text x="158" y="145" text-anchor="middle" font-size="13" fill="#2c5aa0" font-weight="bold">B</text>
                    <text x="230" y="123" text-anchor="middle" font-size="13" fill="#2c5aa0" font-weight="bold">C</text>

                    <!-- Endpunkt markieren -->
                    <circle cx="266" cy="106" r="5" fill="#2c5aa0"/>
                </svg>
            </div>

            <div class="calc-box">
                <div class="calc-row">
                    <label>a) Nach 20 s ist der Jogger</label>
                    <input type="number" id="q4-a" placeholder="?" style="width:80px;"> <span class="unit">m weit gelaufen. (1 BE)</span>
                </div>
                <div class="calc-row">
                    <label>b) In Abschnitt B passiert:</label>
                    <select id="q4-b" style="padding:8px; min-width:180px; min-height:44px; font-size:1em; border:1px solid #2c5aa0;">
                        <option value="">-- wählen --</option>
                        <option value="pause">Der Jogger macht Pause</option>
                        <option value="schneller">Der Jogger wird schneller</option>
                        <option value="langsamer">Der Jogger wird langsamer</option>
                    </select>
                    <span class="unit">(1 BE)</span>
                </div>
                <div class="calc-row">
                    <label>c) Am schnellsten ist der Jogger in Abschnitt</label>
                    <select id="q4-c" style="padding:8px; min-width:80px; min-height:44px; font-size:1em; border:1px solid #2c5aa0;">
                        <option value="">--</option>
                        <option value="a">A</option>
                        <option value="b">B</option>
                        <option value="c">C</option>
                    </select>
                    <span class="unit">(1 BE)</span>
                </div>
                <div class="calc-row">
                    <label>d) Die Gesamtstrecke beträgt</label>
                    <input type="number" id="q4-d" placeholder="?" style="width:80px;"> <span class="unit">m. (1 BE)</span>
                </div>
                <div class="calc-row">
                    <label>e) Die Bewegung dauert insgesamt</label>
                    <input type="number" id="q4-e" placeholder="?" style="width:80px;"> <span class="unit">s. (1 BE)</span>
                </div>
            </div>
            <div class="feedback-box correct" id="q4-fb-correct">Sehr gut! Du kannst s-t-Diagramme richtig ablesen.</div>
            <div class="feedback-box incorrect" id="q4-fb-incorrect">Lies die Werte nochmal genau ab. Eine waagerechte Linie bedeutet Stillstand!</div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 5: Verkehrssicherheit Begriffe (5 BE) - ALLE NIVEAUS
             Themenbereich 4: Verkehrssicherheit
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q5" data-niveau="1" data-points="5">
            <div class="question-header">
                <div class="question-title">Aufgabe 5: Verkehrssicherheit</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-1">*</span>
                    <span class="question-points">5 BE</span>
                </div>
            </div>
            <div class="question-text">Ergänze die Begriffe zur Verkehrssicherheit.</div>
            <div class="lueckentext">
                Wenn ein Autofahrer eine Gefahr sieht, braucht er Zeit zum Reagieren. Der Weg, den das Auto während dieser Zeit fährt, heißt
                <select id="q5-a"><option value="">---</option><option value="reaktionsweg">Reaktionsweg</option><option value="bremsweg">Bremsweg</option><option value="anhalteweg">Anhalteweg</option></select>.
                Dann tritt der Fahrer auf die Bremse. Der Weg zum Abbremsen heißt
                <select id="q5-b"><option value="">---</option><option value="reaktionsweg">Reaktionsweg</option><option value="bremsweg">Bremsweg</option><option value="anhalteweg">Anhalteweg</option></select>.
                Beide zusammen ergeben den
                <select id="q5-c"><option value="">---</option><option value="reaktionsweg">Reaktionsweg</option><option value="bremsweg">Bremsweg</option><option value="anhalteweg">Anhalteweg</option></select>.
                <br><br>
                Bei höherer Geschwindigkeit ist der Anhalteweg
                <select id="q5-d"><option value="">---</option><option value="laenger">länger</option><option value="kuerzer">kürzer</option><option value="gleich">gleich</option></select>.
                Bei nasser Straße ist der Bremsweg
                <select id="q5-e"><option value="">---</option><option value="laenger">länger</option><option value="kuerzer">kürzer</option><option value="gleich">gleich</option></select>
                als bei trockener Straße.
            </div>
            <div class="feedback-box correct" id="q5-fb-correct">Richtig! Du verstehst die Begriffe der Verkehrssicherheit.</div>
            <div class="feedback-box incorrect" id="q5-fb-incorrect">Merke: Reaktionsweg + Bremsweg = Anhalteweg</div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 6: Formelumstellung (3 BE) - NUR ** und ***
             Themenbereich 2: v = s/t (Umstellung)
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q6" data-niveau="2" data-points="3">
            <div class="question-header">
                <div class="question-title">Aufgabe 6: Zeit berechnen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-2">**</span>
                    <span class="question-points">3 BE</span>
                </div>
            </div>
            <div class="question-text">Ein Auto fährt mit <strong>20 <span class="frac"><span class="z">m</span><span class="n">s</span></span></strong>. Wie lange braucht es für <strong>400 m</strong>?</div>
            <div class="calc-box">
                <h4>Rechnung:</h4>
                <div class="calc-row">
                    <label><span class="fz">t</span> =</label>
                    <span class="frac" style="font-size:1.1em;">
                        <span class="z"><input type="number" id="q6-s" placeholder="?" style="width:70px; min-height:44px; padding:4px 8px;"> <span class="unit">m</span></span>
                        <span class="n"><input type="number" id="q6-v" placeholder="?" style="width:80px; min-height:44px; padding:4px 8px;"> <span class="unit"><span class="frac" style="font-size:0.95em;"><span class="z">m</span><span class="n">s</span></span></span></span>
                    </span>
                    <span class="unit">=</span>
                    <input type="number" id="q6-t" placeholder="?"> <span class="unit">s</span>
                </div>
            </div>
            <div class="feedback-box correct" id="q6-fb-correct">Richtig! <span class="fz">t</span> = <span class="frac"><span class="z">400 m</span><span class="n">20 m/s</span></span> = 20 s</div>
            <div class="feedback-box incorrect" id="q6-fb-incorrect">Stelle die Formel um: <span class="fz">t</span> = <span class="frac"><span class="z"><span class="fz">s</span></span><span class="n"><span class="fz">v</span></span></span> = <span class="frac"><span class="z">400 m</span><span class="n">20 m/s</span></span> = ?</div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 7: Geschwindigkeit aus Diagramm berechnen (3 BE) - NUR ** und ***
             Themenbereich 3: Diagramme + Berechnung
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q7" data-niveau="2" data-points="3">
            <div class="question-header">
                <div class="question-title">Aufgabe 7: Geschwindigkeit aus Diagramm</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-2">**</span>
                    <span class="question-points">3 BE</span>
                </div>
            </div>
            <div class="question-text">Berechne die Geschwindigkeit des Joggers in <strong>Abschnitt A</strong>.</div>

            <div class="svg-container">
                <svg viewBox="0 0 420 280" width="420" height="280">
                    <rect x="50" y="10" width="360" height="240" fill="#fafafa" stroke="#ddd"/>
                    <g stroke="#e0e0e0" stroke-width="1">
                        <line x1="50" y1="58" x2="410" y2="58"/>
                        <line x1="50" y1="106" x2="410" y2="106"/>
                        <line x1="50" y1="154" x2="410" y2="154"/>
                        <line x1="50" y1="202" x2="410" y2="202"/>
                        <line x1="122" y1="10" x2="122" y2="250"/>
                        <line x1="194" y1="10" x2="194" y2="250"/>
                        <line x1="266" y1="10" x2="266" y2="250"/>
                        <line x1="338" y1="10" x2="338" y2="250"/>
                    </g>
                    <line x1="50" y1="250" x2="410" y2="250" stroke="#333" stroke-width="2"/>
                    <line x1="50" y1="10" x2="50" y2="250" stroke="#333" stroke-width="2"/>
                    <text x="230" y="275" text-anchor="middle" font-size="14" fill="#333">Zeit <tspan font-style="italic">t</tspan> in s</text>
                    <text x="15" y="130" text-anchor="middle" font-size="14" fill="#333" transform="rotate(-90, 15, 130)">Weg <tspan font-style="italic">s</tspan> in m</text>
                    <text x="45" y="254" text-anchor="end" font-size="12" fill="#666">0</text>
                    <text x="45" y="206" text-anchor="end" font-size="12" fill="#666">50</text>
                    <text x="45" y="158" text-anchor="end" font-size="12" fill="#666">100</text>
                    <text x="45" y="110" text-anchor="end" font-size="12" fill="#666">150</text>
                    <text x="45" y="62" text-anchor="end" font-size="12" fill="#666">200</text>
                    <text x="50" y="268" text-anchor="middle" font-size="12" fill="#666">0</text>
                    <text x="122" y="268" text-anchor="middle" font-size="12" fill="#666">20</text>
                    <text x="194" y="268" text-anchor="middle" font-size="12" fill="#666">40</text>
                    <text x="266" y="268" text-anchor="middle" font-size="12" fill="#666">60</text>
                    <text x="338" y="268" text-anchor="middle" font-size="12" fill="#666">80</text>
                    <text x="410" y="268" text-anchor="middle" font-size="12" fill="#666">100</text>
                    <line x1="50" y1="250" x2="122" y2="154" stroke="#2c5aa0" stroke-width="3"/>
                    <line x1="122" y1="154" x2="194" y2="154" stroke="#2c5aa0" stroke-width="3"/>
                    <line x1="194" y1="154" x2="266" y2="106" stroke="#2c5aa0" stroke-width="3"/>
                    <text x="86" y="195" text-anchor="middle" font-size="13" fill="#2c5aa0" font-weight="bold">A</text>
                    <text x="158" y="145" text-anchor="middle" font-size="13" fill="#2c5aa0" font-weight="bold">B</text>
                    <text x="230" y="123" text-anchor="middle" font-size="13" fill="#2c5aa0" font-weight="bold">C</text>
                    <circle cx="266" cy="106" r="5" fill="#2c5aa0"/>
                </svg>
            </div>
            <div class="calc-box">
                <h4>Werte aus dem Diagramm:</h4>
                <div class="calc-row">
                    <label>Weg in A:</label>
                    <input type="number" id="q7-s" placeholder="?" style="width:80px;"> <span class="unit">m (1 BE)</span>
                </div>
                <div class="calc-row">
                    <label>Zeit in A:</label>
                    <input type="number" id="q7-t" placeholder="?" style="width:80px;"> <span class="unit">s (1 BE)</span>
                </div>
                <div class="calc-row">
                    <label><span class="fz">v</span> = <span class="frac"><span class="z"><span class="fz">s</span></span><span class="n"><span class="fz">t</span></span></span> =</label>
                    <input type="number" id="q7-v" step="0.1" placeholder="?"> <span class="unit"><span class="frac"><span class="z">m</span><span class="n">s</span></span> (1 BE)</span>
                </div>
            </div>
            <div class="feedback-box correct" id="q7-fb-correct">Richtig! In Abschnitt A: <span class="fz">s</span> = 100 m, <span class="fz">t</span> = 20 s → <span class="fz">v</span> = 5 <span class="frac"><span class="z">m</span><span class="n">s</span></span></div>
            <div class="feedback-box incorrect" id="q7-fb-incorrect">Abschnitt A geht von 0 bis 20 s und von 0 bis 100 m.</div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 8: Anhalteweg berechnen (3 BE) - NUR ***
             Themenbereich 4: Verkehrssicherheit (Berechnung)
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q8" data-niveau="3" data-points="3">
            <div class="question-header">
                <div class="question-title">Aufgabe 8: Anhalteweg berechnen</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-3">***</span>
                    <span class="question-points">3 BE</span>
                </div>
            </div>
            <div class="question-text">Ein Auto fährt mit <strong>15 <span class="frac"><span class="z">m</span><span class="n">s</span></span></strong>. Die Reaktionszeit des Fahrers beträgt <strong>1 s</strong>. Der Bremsweg bei dieser Geschwindigkeit ist <strong>22 m</strong>.</div>
            <div class="calc-box">
                <h4>a) Reaktionsweg berechnen (1 BE):</h4>
                <div class="calc-row">
                    <label>Reaktionsweg =</label>
                    <input type="number" id="q8-rw" placeholder="?"> <span class="unit">m</span>
                </div>
                <h4 style="margin-top:15px;">b) Anhalteweg berechnen (2 BE):</h4>
                <div class="calc-row">
                    <label>Anhalteweg =</label>
                    <input type="number" id="q8-rw2" placeholder="?" style="width:60px;"> <span class="unit">m +</span>
                    <input type="number" id="q8-bw" placeholder="?" style="width:60px;"> <span class="unit">m =</span>
                    <input type="number" id="q8-aw" placeholder="?"> <span class="unit">m</span>
                </div>
            </div>
            <div class="feedback-box correct" id="q8-fb-correct">Richtig! Reaktionsweg = 15 m, Anhalteweg = 15 m + 22 m = 37 m</div>
            <div class="feedback-box incorrect" id="q8-fb-incorrect">Reaktionsweg = 15 <span class="frac"><span class="z">m</span><span class="n">s</span></span> · 1 s = 15 m. Dann: 15 m + 22 m = 37 m</div>
        </div>

        <!-- ═══════════════════════════════════════════════════════════════════════
             AUFGABE 9: Sicherheitsbeurteilung (3 BE) - NUR ***
             Themenbereich 4: Verkehrssicherheit (Transfer)
             ═══════════════════════════════════════════════════════════════════════ -->
        <div class="question" id="q9" data-niveau="3" data-points="3">
            <div class="question-header">
                <div class="question-title">Aufgabe 9: Gefährliche Situation?</div>
                <div class="question-meta">
                    <span class="question-niveau niveau-3">***</span>
                    <span class="question-points">3 BE</span>
                </div>
            </div>
            <div class="question-text">
                Ein Ball rollt auf die Straße. Er liegt <strong>30 m</strong> vor dem Auto.<br>
                Verwende <strong>deinen Anhalteweg aus Aufgabe 8</strong>.
            </div>
            <div class="calc-box">
                <h4>a) Kann das Auto rechtzeitig anhalten? (1 BE)</h4>
                <div class="options" style="margin: 10px 0;">
                    <label class="option">
                        <input type="radio" name="q9-a" value="ja"> Ja, das Auto kann rechtzeitig anhalten.
                    </label>
                    <label class="option">
                        <input type="radio" name="q9-a" value="nein"> Nein, das Auto kann NICHT rechtzeitig anhalten.
                    </label>
                </div>

                <h4 style="margin-top:15px;">b) Um wie viele Meter ist der Anhalteweg zu lang? (1 BE)</h4>
                <div class="calc-row">
                    <label>Anhalteweg &minus; Abstand =</label>
                    <input type="number" id="q9-b" placeholder="?" style="width:80px; min-height:44px;"> <span class="unit">m</span>
                </div>

                <h4 style="margin-top:15px;">c) Bei nasser Straße verdoppelt sich der Bremsweg auf 44 m. Berechne den neuen Anhalteweg. (1 BE)</h4>
                <div class="calc-row">
                    <label>Neuer Anhalteweg =</label>
                    <input type="number" id="q9-c" placeholder="?" style="width:80px; min-height:44px;"> <span class="unit">m</span>
                </div>
            </div>
            <div class="feedback-box correct" id="q9-fb-correct">Richtig! 37 m &gt; 30 m → Das Auto kann nicht anhalten (7 m zu lang). Bei nasser Straße: 15 m + 44 m = 59 m &ndash; noch viel gefährlicher!</div>
            <div class="feedback-box incorrect" id="q9-fb-incorrect">Dein Anhalteweg aus Aufgabe 8 ist 37 m. Vergleiche mit 30 m: 37 &minus; 30 = 7 m zu lang. Nasser Bremsweg: 15 m + 44 m = ?</div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section" id="submitSection">
            <p style="margin-bottom:15px;">Überprüfe deine Antworten, bevor du abgibst.</p>
            <button onclick="submitTest()" id="submitBtn">Test abgeben</button>
        </div>

        <!-- Results Section -->
        <div class="results hidden" id="resultsSection">
            <h2>Ergebnis</h2>
            <div id="studentNameDisplay"></div>
            <div style="margin:10px 0;font-size:0.9em;" id="niveauDisplay"></div>
            <div style="margin-top:20px;">
                <div style="font-size:1.1em; font-weight:600; color:#555; margin-bottom:5px;">Erreichte Punkte:</div>
                <div class="score" id="scoreDisplay">0 / 0</div>
            </div>
            <div class="grade" id="gradeDisplay"></div>
            <table class="grade-table">
                <tr>
                    <th>NP</th><th>14</th><th>13</th><th>12</th><th>11</th><th>10</th><th>9</th><th>8</th><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th>
                </tr>
                <tr>
                    <td>%</td><td>100</td><td>96</td><td>90,7</td><td>86</td><td>80</td><td>73,3</td><td>66,7</td><td>60</td><td>53,3</td><td>46,7</td><td>40</td><td>33,3</td><td>26,7</td><td>20</td>
                </tr>
                <tr id="gradeRow">
                    <td>BE</td><td id="be14">-</td><td id="be13">-</td><td id="be12">-</td><td id="be11">-</td><td id="be10">-</td><td id="be9">-</td><td id="be8">-</td><td id="be7">-</td><td id="be6">-</td><td id="be5">-</td><td id="be4">-</td><td id="be3">-</td><td id="be2">-</td><td id="be1">-</td>
                </tr>
            </table>
            <div id="tabInfo" style="background: #f0f0f0; padding: 10px; margin: 15px 0; font-size: 0.85em; color: #666; text-align: left;">
                <strong>Testprotokoll:</strong>
                <span id="tabProtocol"></span>
            </div>
            <div style="background: #fff3e0; border: 2px solid #b35c00; padding: 15px; margin: 20px 0; text-align: left;">
                <strong style="color: #b35c00;">Ergebnis sichern:</strong>
                <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li>Klicke auf <strong>"Drucken / PDF"</strong></li>
                    <li>Wähle <strong>"Als PDF speichern"</strong></li>
                    <li>Lade das PDF in der <strong>Bildungscloud</strong> hoch</li>
                </ol>
            </div>
            <button class="btn-secondary" onclick="window.print()">Drucken / PDF</button>
        </div>

        <!-- Teacher Reset Section -->
        <div class="teacher-section" id="teacherSection">
            <h3>Lehrer-Bereich</h3>
            <p style="font-size:0.85em; margin-bottom:10px;">Reset für diesen Platz (löscht alle Eingaben):</p>
            <button class="btn-secondary btn-small" onclick="teacherReset()">Platz zurücksetzen</button>
        </div>
    </div>

    <script>
    // ═══════════════════════════════════════════════════════════════
    // KONFIGURATION
    // ═══════════════════════════════════════════════════════════════
    var STORAGE_KEY = 'mt-physik-6-bewegung-abschluss-v1';
    var STORAGE_HOURS = 22;
    var selectedNiveau = 0;
    var testSubmitted = false;
    var seatConfirmed = false;

    // BE-Struktur pro Niveau
    var BE_STRUKTUR = {
        1: 25,  // * Basis
        2: 31,  // ** Standard
        3: 37   // *** Erweitert
    };

    // Richtige Antworten
    var answers = {
        // Q1: Lückentext Bewegung (5 BE)
        'q1-a': 'ort',
        'q1-b': 'bahnform',
        'q1-c': 'gleichfoermig',
        'q1-d': 'geradlinig',
        'q1-e': 'krummlinigen',
        // Q3: Geschwindigkeit (4 BE) - 200m/40s = 5 m/s
        'q3-s': 200,
        'q3-t': 40,
        'q3-v': 5,
        // Q4: Diagramm ablesen (5 BE)
        'q4-a': 100,
        'q4-b': 'pause',
        'q4-c': 'a',
        'q4-d': 150,
        'q4-e': 60,
        // Q5: Verkehrssicherheit Begriffe (5 BE)
        'q5-a': 'reaktionsweg',
        'q5-b': 'bremsweg',
        'q5-c': 'anhalteweg',
        'q5-d': 'laenger',
        'q5-e': 'laenger',
        // Q6: Formelumstellung (3 BE) - 400m/20m/s = 20s
        'q6-s': 400,
        'q6-v': 20,
        'q6-t': 20,
        // Q7: Geschwindigkeit aus Diagramm (3 BE) - 100m/20s = 5 m/s
        'q7-s': 100,
        'q7-t': 20,
        'q7-v': 5,
        // Q8: Anhalteweg (3 BE) - 15m + 22m = 37m
        'q8-rw': 15,
        'q8-rw2': 15,
        'q8-bw': 22,
        'q8-aw': 37,
        // Q9: Sicherheitsbeurteilung (3 BE)
        'q9-a': 'nein',
        'q9-b': 7,
        'q9-c': 59
    };

    // Toleranzen für numerische Eingaben
    var tolerances = {
        'q3-s': 0, 'q3-t': 0, 'q3-v': 0.1,
        'q4-a': 0, 'q4-d': 0, 'q4-e': 0,
        'q6-s': 0, 'q6-v': 0, 'q6-t': 0,
        'q7-s': 0, 'q7-t': 0, 'q7-v': 0.1,
        'q8-rw': 0, 'q8-rw2': 0, 'q8-bw': 0, 'q8-aw': 0,
        'q9-b': 0, 'q9-c': 0
    };

    // ═══════════════════════════════════════════════════════════════
    // INITIALISIERUNG
    // ═══════════════════════════════════════════════════════════════
    (function() {
        // Platznummern generieren
        var seatSel = document.getElementById('seatSelect');
        for (var i = 1; i <= 30; i++) {
            var opt = document.createElement('option');
            opt.value = i;
            opt.textContent = 'Platz ' + i;
            seatSel.appendChild(opt);
        }

        // Fragen initial verstecken
        var questions = document.querySelectorAll('.question');
        for (var i = 0; i < questions.length; i++) {
            questions[i].style.display = 'none';
        }
        document.getElementById('submitSection').style.display = 'none';

        // Event-Listener für alle Eingaben
        var allInputs = document.querySelectorAll('input, select');
        for (var i = 0; i < allInputs.length; i++) {
            allInputs[i].addEventListener('change', function() {
                saveAnswers();
                updateProgress();
            });
        }

        // Radio-Button Click-Handler für Options
        var options = document.querySelectorAll('.option');
        for (var i = 0; i < options.length; i++) {
            options[i].addEventListener('click', function(e) {
                var radio = this.querySelector('input[type="radio"]');
                if (radio && e.target !== radio) {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));
                }
                // Highlight selected option
                var name = radio.name;
                var allOptions = document.querySelectorAll('.option input[name="' + name + '"]');
                for (var j = 0; j < allOptions.length; j++) {
                    allOptions[j].parentElement.classList.remove('selected');
                }
                this.classList.add('selected');
            });
        }

        // Gespeicherte Antworten wiederherstellen
        restoreAnswers();
    })();

    // ═══════════════════════════════════════════════════════════════
    // PLATZ & NIVEAU
    // ═══════════════════════════════════════════════════════════════
    function confirmSeat() {
        var sel = document.getElementById('seatSelect');
        var val = sel.value;
        if (!val) { alert('Bitte Platznummer wählen!'); return; }
        seatConfirmed = true;
        document.getElementById('seatRow').style.display = 'none';
        document.getElementById('seatWarning').style.display = 'none';
        document.getElementById('seatConfirmed').textContent = 'Platz ' + val;
        document.getElementById('seatConfirmed').style.display = 'block';
        saveAnswers();
    }

    function confirmNiveau() {
        if (!seatConfirmed) { alert('Bitte zuerst Platznummer wählen und bestätigen!'); return; }
        var sel = document.getElementById('niveauSelect');
        var val = parseInt(sel.value);
        if (!val) { alert('Bitte Niveau wählen!'); return; }
        selectedNiveau = val;
        document.getElementById('niveauRow').style.display = 'none';
        document.getElementById('niveauWarning').style.display = 'none';
        var labels = { 1: '* Basis (25 BE)', 2: '** Standard (31 BE)', 3: '*** Erweitert (37 BE)' };
        document.getElementById('niveauConfirmed').textContent = labels[val];
        document.getElementById('niveauConfirmed').style.display = 'block';
        showQuestionsForNiveau(val);
        saveAnswers();
        updateProgress();
    }

    function showQuestionsForNiveau(niveau) {
        var questions = document.querySelectorAll('.question');
        for (var i = 0; i < questions.length; i++) {
            var qNiveau = parseInt(questions[i].getAttribute('data-niveau'));
            questions[i].style.display = (qNiveau <= niveau) ? 'block' : 'none';
        }
        document.getElementById('submitSection').style.display = 'block';
    }

    // ═══════════════════════════════════════════════════════════════
    // FORTSCHRITT
    // ═══════════════════════════════════════════════════════════════
    function updateProgress() {
        if (selectedNiveau === 0) return;
        var answered = countAnsweredFields();
        var total = countTotalFields();
        var pct = total > 0 ? Math.round((answered / total) * 100) : 0;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = answered + ' / ' + total + ' beantwortet';
    }

    function countTotalFields() {
        var count = 0;
        // Q1: 5 Selects, Q2: 12 Checkboxen, Q3: 3 Inputs, Q4: 5 Fields, Q5: 5 Selects
        count = 5 + 12 + 3 + 5 + 5; // = 30 für Niveau 1
        if (selectedNiveau >= 2) count += 6; // Q6: 3 Inputs, Q7: 3 Inputs
        if (selectedNiveau >= 3) count += 7; // Q8: 4 Inputs, Q9: 3 Fields
        return count;
    }

    function countAnsweredFields() {
        var count = 0;

        // Q1 Selects
        var q1Fields = ['q1-a','q1-b','q1-c','q1-d','q1-e'];
        for (var i = 0; i < q1Fields.length; i++) {
            var el = document.getElementById(q1Fields[i]);
            if (el && el.value !== '') count++;
        }

        // Q2 Checkboxen
        var rows = document.querySelectorAll('#q2 tbody tr');
        for (var r = 0; r < rows.length; r++) {
            var checks = rows[r].querySelectorAll('input[type="checkbox"]');
            var bahnChecked = false, artChecked = false;
            for (var c = 0; c < checks.length; c++) {
                if (checks[c].checked) {
                    if (checks[c].name.indexOf('-bahn') > -1) bahnChecked = true;
                    if (checks[c].name.indexOf('-art') > -1) artChecked = true;
                }
            }
            if (bahnChecked) count++;
            if (artChecked) count++;
        }

        // Q3 Inputs
        var q3Fields = ['q3-s','q3-t','q3-v'];
        for (var i = 0; i < q3Fields.length; i++) {
            var el = document.getElementById(q3Fields[i]);
            if (el && el.value !== '') count++;
        }

        // Q4 Fields
        var q4Fields = ['q4-a','q4-b','q4-c','q4-d','q4-e'];
        for (var i = 0; i < q4Fields.length; i++) {
            var el = document.getElementById(q4Fields[i]);
            if (el && el.value !== '') count++;
        }

        // Q5 Selects
        var q5Fields = ['q5-a','q5-b','q5-c','q5-d','q5-e'];
        for (var i = 0; i < q5Fields.length; i++) {
            var el = document.getElementById(q5Fields[i]);
            if (el && el.value !== '') count++;
        }

        // Q6 (nur ** und ***)
        if (selectedNiveau >= 2) {
            var q6Fields = ['q6-s','q6-v','q6-t'];
            for (var i = 0; i < q6Fields.length; i++) {
                var el = document.getElementById(q6Fields[i]);
                if (el && el.value !== '') count++;
            }
            var q7Fields = ['q7-s','q7-t','q7-v'];
            for (var i = 0; i < q7Fields.length; i++) {
                var el = document.getElementById(q7Fields[i]);
                if (el && el.value !== '') count++;
            }
        }

        // Q8-Q9 (nur ***)
        if (selectedNiveau >= 3) {
            var q8Fields = ['q8-rw','q8-rw2','q8-bw','q8-aw'];
            for (var i = 0; i < q8Fields.length; i++) {
                var el = document.getElementById(q8Fields[i]);
                if (el && el.value !== '') count++;
            }
            // Q9: 1 Radio + 2 Inputs
            var q9a = document.querySelector('input[name="q9-a"]:checked');
            if (q9a) count++;
            var q9b = document.getElementById('q9-b');
            if (q9b && q9b.value !== '') count++;
            var q9c = document.getElementById('q9-c');
            if (q9c && q9c.value !== '') count++;
        }

        return count;
    }

    // ═══════════════════════════════════════════════════════════════
    // SPEICHERN & WIEDERHERSTELLEN
    // ═══════════════════════════════════════════════════════════════
    function saveAnswers() {
        var data = {
            timestamp: Date.now(),
            seat: document.getElementById('seatSelect').value,
            seatConfirmed: seatConfirmed,
            niveau: selectedNiveau,
            submitted: testSubmitted,
            answers: {}
        };
        // Alle Selects
        var allSelects = document.querySelectorAll('select[id^="q"]');
        for (var i = 0; i < allSelects.length; i++) {
            data.answers[allSelects[i].id] = allSelects[i].value;
        }
        // Alle number Inputs
        var allInputs = document.querySelectorAll('input[type="number"]');
        for (var i = 0; i < allInputs.length; i++) {
            data.answers[allInputs[i].id] = allInputs[i].value;
        }
        // Alle Checkboxen
        var allChecks = document.querySelectorAll('input[type="checkbox"]');
        for (var i = 0; i < allChecks.length; i++) {
            data.answers[allChecks[i].name + '_' + allChecks[i].value] = allChecks[i].checked;
        }
        // Alle Radio-Buttons
        var allRadios = document.querySelectorAll('input[type="radio"]');
        for (var i = 0; i < allRadios.length; i++) {
            if (allRadios[i].checked) {
                data.answers['radio_' + allRadios[i].name] = allRadios[i].value;
            }
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function restoreAnswers() {
        var stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return;
        var data = JSON.parse(stored);

        // Prüfe Ablaufzeit
        var now = Date.now();
        var maxAge = STORAGE_HOURS * 60 * 60 * 1000;
        if (data.timestamp && (now - data.timestamp) > maxAge) {
            localStorage.removeItem(STORAGE_KEY);
            return;
        }

        // Platz wiederherstellen
        if (data.seat) {
            document.getElementById('seatSelect').value = data.seat;
            if (data.seatConfirmed) {
                seatConfirmed = true;
                document.getElementById('seatRow').style.display = 'none';
                document.getElementById('seatWarning').style.display = 'none';
                document.getElementById('seatConfirmed').textContent = 'Platz ' + data.seat;
                document.getElementById('seatConfirmed').style.display = 'block';
            }
        }
        // Niveau wiederherstellen
        if (data.niveau) {
            selectedNiveau = data.niveau;
            document.getElementById('niveauSelect').value = data.niveau;
            document.getElementById('niveauRow').style.display = 'none';
            document.getElementById('niveauWarning').style.display = 'none';
            var labels = { 1: '* Basis (25 BE)', 2: '** Standard (31 BE)', 3: '*** Erweitert (37 BE)' };
            document.getElementById('niveauConfirmed').textContent = labels[data.niveau];
            document.getElementById('niveauConfirmed').style.display = 'block';
            showQuestionsForNiveau(data.niveau);
        }
        // Antworten wiederherstellen
        if (data.answers) {
            for (var key in data.answers) {
                if (key.indexOf('_') > -1 && key.indexOf('radio_') === -1) {
                    // Checkbox
                    var parts = key.split('_');
                    var name = parts[0];
                    var val = parts[1];
                    var checks = document.querySelectorAll('input[name="' + name + '"][value="' + val + '"]');
                    for (var i = 0; i < checks.length; i++) {
                        checks[i].checked = data.answers[key];
                    }
                } else if (key.indexOf('radio_') === 0) {
                    // Radio
                    var radioName = key.replace('radio_', '');
                    var radioVal = data.answers[key];
                    var radio = document.querySelector('input[name="' + radioName + '"][value="' + radioVal + '"]');
                    if (radio) {
                        radio.checked = true;
                        radio.parentElement.classList.add('selected');
                    }
                } else {
                    var el = document.getElementById(key);
                    if (el) el.value = data.answers[key];
                }
            }
        }
        // Bereits abgegeben?
        if (data.submitted) {
            testSubmitted = true;
            submitTest(true);
        }
        updateProgress();
    }

    // ═══════════════════════════════════════════════════════════════
    // TEST ABGEBEN
    // ═══════════════════════════════════════════════════════════════
    function submitTest(isRestore) {
        if (!isRestore && !confirm('Test wirklich abgeben? Du kannst danach nichts mehr ändern.')) return;
        testSubmitted = true;
        saveAnswers();

        var totalPoints = 0;
        var earnedPoints = 0;

        // Q1: Lückentext (5 BE)
        var q1Fields = ['q1-a','q1-b','q1-c','q1-d','q1-e'];
        var q1Earned = 0;
        for (var i = 0; i < q1Fields.length; i++) {
            var el = document.getElementById(q1Fields[i]);
            if (el.value === answers[q1Fields[i]]) {
                q1Earned++;
                el.classList.add('correct');
            } else {
                el.classList.add('incorrect');
            }
            el.disabled = true;
        }
        totalPoints += 5;
        earnedPoints += q1Earned;
        showQuestionResult('q1', q1Earned, 5);

        // Q2: Zuordnungstabelle (6 BE = 1 BE pro Zeile mit 2 korrekten Ankreuzungen)
        var q2Result = evaluateTableRows('q2');
        totalPoints += 6;
        earnedPoints += q2Result;
        showQuestionResult('q2', q2Result, 6);

        // Q3: Geschwindigkeit (4 BE)
        var q3Earned = 0;
        q3Earned += evaluateNumeric('q3-s', 1);
        q3Earned += evaluateNumeric('q3-t', 1);
        q3Earned += evaluateNumeric('q3-v', 2);
        totalPoints += 4;
        earnedPoints += q3Earned;
        showQuestionResult('q3', q3Earned, 4);

        // Q4: Diagramm ablesen (5 BE)
        var q4Earned = 0;
        q4Earned += evaluateNumeric('q4-a', 1);
        q4Earned += evaluateSelect('q4-b', 1);
        q4Earned += evaluateSelect('q4-c', 1);
        q4Earned += evaluateNumeric('q4-d', 1);
        q4Earned += evaluateNumeric('q4-e', 1);
        totalPoints += 5;
        earnedPoints += q4Earned;
        showQuestionResult('q4', q4Earned, 5);

        // Q5: Verkehrssicherheit Begriffe (5 BE)
        var q5Fields = ['q5-a','q5-b','q5-c','q5-d','q5-e'];
        var q5Earned = 0;
        for (var i = 0; i < q5Fields.length; i++) {
            var el = document.getElementById(q5Fields[i]);
            if (el.value === answers[q5Fields[i]]) {
                q5Earned++;
                el.classList.add('correct');
            } else {
                el.classList.add('incorrect');
            }
            el.disabled = true;
        }
        totalPoints += 5;
        earnedPoints += q5Earned;
        showQuestionResult('q5', q5Earned, 5);

        // Q6: Formelumstellung (3 BE) - nur ** und ***
        if (selectedNiveau >= 2) {
            var q6Earned = 0;
            q6Earned += evaluateNumeric('q6-s', 1);
            q6Earned += evaluateNumeric('q6-v', 1);
            q6Earned += evaluateNumeric('q6-t', 1);
            totalPoints += 3;
            earnedPoints += q6Earned;
            showQuestionResult('q6', q6Earned, 3);

            // Q7: Geschwindigkeit aus Diagramm (3 BE)
            var q7Earned = 0;
            q7Earned += evaluateNumeric('q7-s', 1);
            q7Earned += evaluateNumeric('q7-t', 1);
            q7Earned += evaluateNumeric('q7-v', 1);
            totalPoints += 3;
            earnedPoints += q7Earned;
            showQuestionResult('q7', q7Earned, 3);
        }

        // Q8-Q9: nur ***
        if (selectedNiveau >= 3) {
            // Q8: Anhalteweg (3 BE)
            var q8Earned = 0;
            q8Earned += evaluateNumeric('q8-rw', 1);
            // Zwischenfelder nur visuell markieren (kein Scoring)
            evaluateNumeric('q8-rw2', 0);
            evaluateNumeric('q8-bw', 0);
            // Endergebnis Anhalteweg: 2 BE
            q8Earned += evaluateNumeric('q8-aw', 2);
            totalPoints += 3;
            earnedPoints += q8Earned;
            showQuestionResult('q8', q8Earned, 3);

            // Q9: Sicherheitsbeurteilung (3 BE)
            var q9Earned = 0;
            q9Earned += evaluateRadio('q9-a', 1);
            q9Earned += evaluateNumeric('q9-b', 1);
            q9Earned += evaluateNumeric('q9-c', 1);
            totalPoints += 3;
            earnedPoints += q9Earned;
            showQuestionResult('q9', q9Earned, 3);
        }

        // Alle Inputs deaktivieren
        var allInputs = document.querySelectorAll('input, select');
        for (var i = 0; i < allInputs.length; i++) {
            allInputs[i].disabled = true;
        }

        // Ergebnis anzeigen
        document.getElementById('submitSection').style.display = 'none';
        document.getElementById('resultsSection').classList.remove('hidden');
        document.getElementById('scoreDisplay').textContent = earnedPoints + ' / ' + totalPoints;
        document.getElementById('studentNameDisplay').textContent = 'Platz: ' + document.getElementById('seatSelect').value;
        var niveauLabels = { 1: '* Basis', 2: '** Standard', 3: '*** Erweitert' };
        document.getElementById('niveauDisplay').textContent = 'Niveau: ' + niveauLabels[selectedNiveau];

        var pct = (earnedPoints / totalPoints) * 100;
        var np = calculateNP(pct);
        document.getElementById('gradeDisplay').textContent = np + ' Notenpunkte';

        // BE-Tabelle füllen
        var thresholds = [100, 96, 90.67, 86, 80, 73.33, 66.67, 60, 53.33, 46.67, 40, 33.33, 26.67, 20];
        var marked = false;
        for (var i = 14; i >= 1; i--) {
            var beNeeded = Math.ceil(totalPoints * thresholds[14-i] / 100);
            document.getElementById('be' + i).textContent = beNeeded;
            if (!marked && earnedPoints >= beNeeded) {
                document.getElementById('be' + i).classList.add('current');
                marked = true;
            }
        }

        // Tab-Protokoll anzeigen
        var awaySeconds = Math.round(totalTimeAway / 1000);
        var protocol = 'Tab-Wechsel: ' + tabSwitches + ' | Zeit außerhalb: ' + awaySeconds + ' s';
        document.getElementById('tabProtocol').textContent = protocol;
    }

    function evaluateNumeric(fieldId, points) {
        var el = document.getElementById(fieldId);
        if (!el) return 0;
        var userVal = parseFloat(el.value);
        var correctVal = answers[fieldId];
        var tol = tolerances[fieldId] || 0;
        var isCorrect = !isNaN(userVal) && Math.abs(userVal - correctVal) <= tol;
        if (isCorrect) {
            el.classList.add('correct');
            el.disabled = true;
            return points;
        } else {
            el.classList.add('incorrect');
            el.disabled = true;
            return 0;
        }
    }

    function evaluateSelect(fieldId, points) {
        var el = document.getElementById(fieldId);
        if (!el) return 0;
        var isCorrect = el.value === answers[fieldId];
        if (isCorrect) {
            el.style.borderColor = '#2a7a4b';
            el.style.background = '#e8f5e9';
        } else {
            el.style.borderColor = '#c62828';
            el.style.background = '#ffebee';
        }
        el.disabled = true;
        return isCorrect ? points : 0;
    }

    function evaluateRadio(name, points) {
        var checked = document.querySelector('input[name="' + name + '"]:checked');
        var correctVal = answers[name];
        var allOptions = document.querySelectorAll('input[name="' + name + '"]');

        for (var i = 0; i < allOptions.length; i++) {
            var opt = allOptions[i];
            var parent = opt.parentElement;
            if (opt.value === correctVal) {
                parent.classList.add('correct-option');
            } else if (opt.checked) {
                parent.classList.add('incorrect-option');
            }
            opt.disabled = true;
        }

        return (checked && checked.value === correctVal) ? points : 0;
    }

    function evaluateTableRows(qId) {
        var tableEl = document.getElementById(qId);
        var rows = tableEl.querySelectorAll('tbody tr');
        var earned = 0;

        for (var r = 0; r < rows.length; r++) {
            var correctStr = rows[r].getAttribute('data-correct');
            var correctVals = correctStr.split(',');
            var checks = rows[r].querySelectorAll('input[type="checkbox"]');
            var rowCorrect = true;

            for (var c = 0; c < checks.length; c++) {
                var shouldBeChecked = correctVals.indexOf(checks[c].value) > -1;
                if (checks[c].checked && shouldBeChecked) {
                    checks[c].classList.add('correct-check');
                } else if (checks[c].checked && !shouldBeChecked) {
                    checks[c].classList.add('incorrect-check');
                    rowCorrect = false;
                } else if (!checks[c].checked && shouldBeChecked) {
                    checks[c].classList.add('missed-check');
                    rowCorrect = false;
                }
                checks[c].disabled = true;
            }

            if (rowCorrect) earned++;
        }
        return earned;
    }

    function showQuestionResult(qId, earned, total) {
        var header = document.querySelector('#' + qId + ' .question-header');
        var span = document.createElement('span');
        span.className = 'question-result';
        if (earned === total) {
            span.className += ' full';
            span.textContent = earned + '/' + total + ' BE';
            var fbCorrect = document.getElementById(qId + '-fb-correct');
            if (fbCorrect) fbCorrect.classList.add('show');
        } else if (earned > 0) {
            span.className += ' partial';
            span.textContent = earned + '/' + total + ' BE';
            var fbIncorrect = document.getElementById(qId + '-fb-incorrect');
            if (fbIncorrect) fbIncorrect.classList.add('show');
        } else {
            span.className += ' zero';
            span.textContent = '0/' + total + ' BE';
            var fbIncorrect = document.getElementById(qId + '-fb-incorrect');
            if (fbIncorrect) fbIncorrect.classList.add('show');
        }
        header.appendChild(span);
    }

    function calculateNP(pct) {
        var thresholds = [
            [100, 14], [96, 13], [90.67, 12], [86, 11], [80, 10],
            [73.33, 9], [66.67, 8], [60, 7], [53.33, 6], [46.67, 5],
            [40, 4], [33.33, 3], [26.67, 2], [20, 1]
        ];
        for (var i = 0; i < thresholds.length; i++) {
            if (pct >= thresholds[i][0]) return thresholds[i][1];
        }
        return 0;
    }

    // ═══════════════════════════════════════════════════════════════
    // TAB-WECHSEL-PROTOKOLL (Betrugsschutz)
    // ═══════════════════════════════════════════════════════════════
    var tabSwitches = 0;
    var tabSwitchStart = null;
    var totalTimeAway = 0;

    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            tabSwitches++;
            tabSwitchStart = Date.now();
        } else {
            if (tabSwitchStart) {
                totalTimeAway += (Date.now() - tabSwitchStart);
                tabSwitchStart = null;
            }
        }
    });

    // ═══════════════════════════════════════════════════════════════
    // LEHRER-RESET
    // ═══════════════════════════════════════════════════════════════
    function teacherReset() {
        var code = prompt('Lehrer-Code eingeben:');
        if (code === '2024') {
            localStorage.removeItem(STORAGE_KEY);
            alert('Platz wurde zurückgesetzt. Seite wird neu geladen.');
            location.reload();
        } else if (code !== null) {
            alert('Falscher Code!');
        }
    }
    </script>
</body>
</html>
