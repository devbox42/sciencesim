<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabellenkalkulation-Spielwiese | Informatik 7</title>
    <style>
        /* ========================================
           GRUNDLAYOUT
           ======================================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            color: #222;
            font-size: 16px;
            line-height: 1.5;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ========================================
           HEADER
           ======================================== */
        header {
            background: #b35c00;
            color: #fff;
            padding: 15px 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        header .subtitle {
            font-size: 0.85em;
            opacity: 0.9;
        }

        /* ========================================
           INFO-BOXEN
           ======================================== */
        .info-box {
            background: #fff3e0;
            border: 1px solid #b35c00;
            padding: 15px;
            margin: 15px 0;
        }

        .merke-box {
            background: #e8f5e9;
            border: 1px solid #2a7a4b;
            padding: 15px;
            margin: 15px 0;
        }

        /* ========================================
           EXCEL-SIMULATION (iPad + Desktop)
           ======================================== */
        .excel-container {
            border: 1px solid #999;
            background: #fff;
            margin: 20px 0;
            overflow: hidden;
        }

        .excel-titlebar {
            background: linear-gradient(180deg, #217346 0%, #1e6b40 100%);
            color: #fff;
            padding: 6px 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .excel-menubar {
            background: #f3f3f3;
            padding: 4px 10px;
            font-size: 0.75em;
            color: #444;
            border-bottom: 1px solid #ddd;
        }

        .excel-formula-bar {
            display: flex;
            align-items: center;
            background: #fff;
            border-bottom: 1px solid #ddd;
            padding: 4px;
            gap: 4px;
            position: relative;
        }

        .excel-name-box {
            width: 60px;
            padding: 4px 8px;
            background: #fff;
            border: 1px solid #ccc;
            font-size: 0.85em;
            text-align: center;
            font-family: "Segoe UI", sans-serif;
        }

        .excel-fx-label {
            padding: 0 8px;
            color: #666;
            font-style: italic;
            font-size: 0.9em;
        }

        .excel-formula-input {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #ccc;
            font-size: 0.9em;
            font-family: "Segoe UI", Consolas, monospace;
        }

        .excel-formula-input:focus {
            outline: none;
            border-color: #217346;
        }

        /* Autocomplete */
        .excel-autocomplete {
            display: none;
            position: absolute;
            top: 100%;
            left: 70px;
            right: 10px;
            background: #fff;
            border: 1px solid #217346;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        .excel-autocomplete.show {
            display: block;
        }

        .excel-autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .excel-autocomplete-item:hover {
            background: #e8f5e9;
        }

        .excel-autocomplete-item .fn-name {
            font-weight: 600;
            color: #217346;
        }

        .excel-autocomplete-item .fn-desc {
            font-size: 0.85em;
            color: #666;
            margin-left: 8px;
        }

        .excel-autocomplete-item .fn-syntax {
            font-size: 0.8em;
            color: #888;
            font-family: monospace;
            display: block;
            margin-top: 2px;
        }

        /* Grid */
        .excel-grid-wrapper {
            overflow: auto;
            max-height: 500px;
        }

        .excel-grid {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }

        .excel-grid th,
        .excel-grid td {
            border: 1px solid #ccc;
            padding: 0;
            text-align: center;
            font-size: 0.9em;
            height: 28px;
            min-width: 80px;
        }

        .excel-grid th.corner {
            background: #f0f0f0;
            width: 35px;
            min-width: 35px;
        }

        .excel-grid th.col-header,
        .excel-grid th.row-header {
            background: #f0f0f0;
            font-weight: 600;
            color: #333;
        }

        .excel-grid th.row-header {
            width: 35px;
            min-width: 35px;
        }

        .excel-grid td {
            background: #fff;
            cursor: cell;
            position: relative;
            padding: 2px 4px;
            text-align: right;
            font-family: "Segoe UI", Calibri, sans-serif;
        }

        .excel-grid td[data-editable="false"] {
            background: #f9f9f9;
            color: #666;
        }

        .excel-grid td.selected {
            outline: 2px solid #217346;
            outline-offset: -2px;
            background: #fff;
        }

        .excel-grid td.editing {
            padding: 0;
        }

        .excel-grid td.formula-ref {
            background: #e3f2fd;
        }

        .excel-grid td.fill-preview {
            background: #c8e6c9 !important;
            outline: 1px dashed #217346;
        }

        /* Fill-Handle (grüner Punkt) */
        .excel-fill-handle {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 10px;
            height: 10px;
            background: #217346;
            border: 1px solid #fff;
            cursor: crosshair;
            z-index: 10;
        }

        /* Cell-Input */
        .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 2px 4px;
            font-size: 0.9em;
            font-family: "Segoe UI", Calibri, sans-serif;
            text-align: right;
            background: #fff;
            outline: none;
        }

        /* Statusleiste */
        .excel-statusbar {
            background: #217346;
            color: #fff;
            padding: 4px 10px;
            font-size: 0.75em;
            display: flex;
            justify-content: space-between;
        }

        /* ========================================
           FUNKTIONS-REFERENZ
           ======================================== */
        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .function-card {
            background: #fff;
            border: 1px solid #ddd;
            padding: 12px;
        }

        .function-card code {
            display: block;
            font-size: 1em;
            font-weight: 600;
            color: #217346;
            margin-bottom: 5px;
        }

        .function-card p {
            font-size: 0.85em;
            color: #555;
            margin: 0;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            padding: 10px 20px;
            font-size: 0.95em;
            cursor: pointer;
            border: none;
            background: #ddd;
            color: #333;
        }

        .btn-primary {
            background: #b35c00;
            color: #fff;
        }

        .btn-reset {
            background: #fff;
            color: #666;
            border: 1px solid #ccc;
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .btn-reset:hover {
            background: #f5f5f5;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        /* ========================================
           BEISPIEL-DATEN BUTTONS
           ======================================== */
        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .preset-btn {
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #b35c00;
            color: #b35c00;
            cursor: pointer;
            font-size: 0.9em;
        }

        .preset-btn:hover {
            background: #fff3e0;
        }

        .preset-btn.active {
            background: #b35c00;
            color: #fff;
        }

        /* ========================================
           LINK ZURÜCK
           ======================================== */
        .back-link {
            display: inline-block;
            margin-bottom: 15px;
            color: #b35c00;
            text-decoration: none;
            font-size: 0.9em;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <h1>Tabellenkalkulation-Spielwiese</h1>
        <div class="subtitle">Frei experimentieren mit Formeln und Funktionen</div>
    </header>

    <div class="container">
        <a href="LP-02-praxis-formeln.html" class="back-link">Zurück zum Lernpfad</a>

        <div class="info-box">
            <strong>Willkommen in der Spielwiese!</strong>
            <p style="margin-top: 8px;">Hier kannst du frei experimentieren. Keine Aufgaben, keine Bewertung - nur du und die Tabellenkalkulation.</p>
        </div>

        <!-- FUNKTIONS-REFERENZ -->
        <h2 style="color: #b35c00; margin: 20px 0 10px;">Verfügbare Funktionen</h2>

        <div class="function-grid">
            <div class="function-card">
                <code>=SUMME(A1:A5)</code>
                <p>Addiert alle Zahlen im Bereich</p>
            </div>
            <div class="function-card">
                <code>=MITTELWERT(A1:A5)</code>
                <p>Berechnet den Durchschnitt</p>
            </div>
            <div class="function-card">
                <code>=MIN(A1:A5)</code>
                <p>Findet den kleinsten Wert</p>
            </div>
            <div class="function-card">
                <code>=MAX(A1:A5)</code>
                <p>Findet den größten Wert</p>
            </div>
            <div class="function-card">
                <code>=ANZAHL(A1:A5)</code>
                <p>Zählt die Zahlen im Bereich</p>
            </div>
            <div class="function-card">
                <code>=A1*B1</code>
                <p>Grundrechenarten: + - * /</p>
            </div>
        </div>

        <!-- BEISPIEL-DATEN -->
        <h2 style="color: #b35c00; margin: 20px 0 10px;">Beispiel-Daten laden</h2>

        <div class="preset-buttons">
            <button class="preset-btn" onclick="loadPreset('leer')">Leere Tabelle</button>
            <button class="preset-btn" onclick="loadPreset('noten')">Notenliste</button>
            <button class="preset-btn" onclick="loadPreset('budget')">Monatsbudget</button>
            <button class="preset-btn" onclick="loadPreset('sport')">Sportstatistik</button>
        </div>

        <!-- EXCEL -->
        <div style="display: flex; justify-content: flex-end; margin-bottom: 5px;">
            <button class="btn btn-reset" onclick="resetTabelle()">Zurücksetzen</button>
        </div>
        <div id="excel-playground"></div>

        <!-- TIPPS -->
        <div class="merke-box" style="margin-top: 20px;">
            <strong>Tipps:</strong>
            <ul style="margin: 10px 0 0 20px;">
                <li><strong>Formel eingeben:</strong> Beginne mit <code>=</code></li>
                <li><strong>Zellen anklicken:</strong> Während du eine Formel schreibst, klicke auf Zellen um ihre Adresse einzufügen</li>
                <li><strong>Aufziehen:</strong> Ziehe am grünen Punkt rechts unten, um Formeln zu kopieren</li>
                <li><strong>Autovervollständigung:</strong> Tippe <code>=SU</code> und wähle SUMME aus der Liste</li>
            </ul>
        </div>
    </div>

    <script>
        // ========================================
        // EXCEL SIMULATION ENGINE
        // ========================================

        var ExcelSim = function(containerId, config) {
            var self = this;
            this.containerId = containerId;
            this.config = config;
            this.data = {};
            this.formulas = {};
            this.selectedCell = null;
            this.isEditing = false;
            this.cursorInFormula = false;
            this.originalCellValue = '';

            // Fill-Handle State
            this.isDraggingFill = false;
            this.fillStartCell = null;
            this.fillPreviewCells = [];

            // Verfügbare Funktionen für Autocomplete
            this.functions = [
                { name: 'SUMME', desc: 'Addiert Zahlen', syntax: 'SUMME(Bereich)' },
                { name: 'MITTELWERT', desc: 'Berechnet Durchschnitt', syntax: 'MITTELWERT(Bereich)' },
                { name: 'MIN', desc: 'Kleinster Wert', syntax: 'MIN(Bereich)' },
                { name: 'MAX', desc: 'Größter Wert', syntax: 'MAX(Bereich)' },
                { name: 'ANZAHL', desc: 'Zählt Zahlen', syntax: 'ANZAHL(Bereich)' }
            ];

            this.init();
        };

        ExcelSim.prototype.init = function() {
            var self = this;
            var container = document.getElementById(this.containerId);

            // Daten initialisieren
            for (var r = 1; r <= this.config.rows; r++) {
                for (var c = 0; c < this.config.cols; c++) {
                    var col = String.fromCharCode(65 + c);
                    var cellId = col + r;
                    var cellData = this.config.data[cellId];
                    if (cellData !== undefined) {
                        if (typeof cellData === 'string' && cellData.charAt(0) === '=') {
                            this.formulas[cellId] = cellData;
                            this.data[cellId] = this.evaluateFormula(cellData);
                        } else {
                            this.data[cellId] = cellData;
                        }
                    } else {
                        this.data[cellId] = '';
                    }
                }
            }

            // HTML erstellen
            var html = '<div class="excel-container">';
            html += '<div class="excel-titlebar">Spielwiese</div>';
            html += '<div class="excel-menubar">Datei  Bearbeiten  Ansicht  Einfgen  Format</div>';

            // Formelzeile
            html += '<div class="excel-formula-bar">';
            html += '<div class="excel-name-box" id="' + this.containerId + '-namebox">A1</div>';
            html += '<div class="excel-fx-label">fx</div>';
            html += '<input type="text" class="excel-formula-input" id="' + this.containerId + '-formula" placeholder="">';
            html += '<div class="excel-autocomplete" id="' + this.containerId + '-autocomplete"></div>';
            html += '</div>';

            // Tabelle
            html += '<div class="excel-grid-wrapper">';
            html += '<table class="excel-grid" id="' + this.containerId + '-grid">';

            // Header-Zeile
            html += '<tr><th class="corner"></th>';
            for (var c = 0; c < this.config.cols; c++) {
                html += '<th class="col-header">' + String.fromCharCode(65 + c) + '</th>';
            }
            html += '</tr>';

            // Datenzeilen
            for (var r = 1; r <= this.config.rows; r++) {
                html += '<tr><th class="row-header">' + r + '</th>';
                for (var c = 0; c < this.config.cols; c++) {
                    var col = String.fromCharCode(65 + c);
                    var cellId = col + r;
                    var value = this.data[cellId];
                    var displayValue = this.formatValue(value);
                    html += '<td data-cell="' + cellId + '" data-editable="true">' + displayValue + '</td>';
                }
                html += '</tr>';
            }

            html += '</table></div>';

            // Statusleiste
            html += '<div class="excel-statusbar">';
            html += '<span id="' + this.containerId + '-status">Bereit</span>';
            html += '<span></span>';
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;
            this.attachEvents();
            this.selectCell('A1');
        };

        ExcelSim.prototype.formatValue = function(value) {
            if (value === '' || value === undefined || value === null) return '';
            if (typeof value === 'number') {
                if (Number.isInteger(value)) return String(value);
                return value.toFixed(2).replace('.', ',');
            }
            return String(value);
        };

        ExcelSim.prototype.attachEvents = function() {
            var self = this;
            var grid = document.getElementById(this.containerId + '-grid');
            var formulaInput = document.getElementById(this.containerId + '-formula');

            // Zellen-Klick
            grid.addEventListener('click', function(e) {
                var td = e.target.closest('td');
                if (td && td.dataset.cell) {
                    self.handleCellClick(td.dataset.cell);
                }
            });

            // Doppelklick zum Bearbeiten
            grid.addEventListener('dblclick', function(e) {
                var td = e.target.closest('td');
                if (td && td.dataset.cell) {
                    self.startEditing(td.dataset.cell, true);
                }
            });

            // Formelzeile
            formulaInput.addEventListener('focus', function() {
                self.editingInFormulaBar = true;
                if (self.selectedCell) {
                    self.startEditing(self.selectedCell, false);
                }
            });

            formulaInput.addEventListener('input', function(e) {
                self.handleFormulaInput(e);
            });

            formulaInput.addEventListener('keydown', function(e) {
                self.handleFormulaKeydown(e);
            });

            formulaInput.addEventListener('blur', function() {
                setTimeout(function() {
                    self.hideAutocomplete();
                }, 200);
            });

            // Autocomplete-Klicks
            var autocomplete = document.getElementById(this.containerId + '-autocomplete');
            autocomplete.addEventListener('click', function(e) {
                var item = e.target.closest('.excel-autocomplete-item');
                if (item) {
                    self.insertAutocomplete(item.dataset.fn);
                }
            });

            // Tastatur
            document.addEventListener('keydown', function(e) {
                var cellInput = document.getElementById(self.containerId + '-cellinput');
                var isInCellInput = cellInput && document.activeElement === cellInput;
                var isInFormulaInput = document.activeElement === formulaInput;

                if (self.isEditing && self.editingInCell && e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                    if (cellInput && document.activeElement !== cellInput) {
                        cellInput.focus();
                    }
                    return;
                }

                if (self.selectedCell && !isInCellInput && !isInFormulaInput) {
                    self.handleKeydown(e);
                }
            });
        };

        ExcelSim.prototype.handleCellClick = function(cellId) {
            var formulaInput = document.getElementById(this.containerId + '-formula');

            if (this.isEditing && this.cursorInFormula) {
                var currentValue = formulaInput.value;
                if (currentValue.charAt(0) === '=') {
                    var lastChar = currentValue.slice(-1);
                    var newValue;

                    if (/[\(\+\-\*\/\:\=]$/.test(currentValue) || currentValue === '=') {
                        newValue = currentValue + cellId;
                    } else if (/[A-Z0-9\)]$/i.test(lastChar)) {
                        newValue = currentValue + '+' + cellId;
                    } else {
                        newValue = currentValue + cellId;
                    }

                    formulaInput.value = newValue;
                    var cellInput = document.getElementById(this.containerId + '-cellinput');
                    if (cellInput) {
                        cellInput.value = newValue;
                        cellInput.focus();
                    } else {
                        formulaInput.focus();
                    }

                    this.highlightFormulaCell(cellId);
                    return;
                }
            }

            if (this.isEditing) {
                this.finishEditing();
            }
            this.selectCell(cellId);
        };

        ExcelSim.prototype.selectCell = function(cellId) {
            var self = this;
            var grid = document.getElementById(this.containerId + '-grid');

            var oldSelected = grid.querySelector('.selected');
            if (oldSelected) {
                oldSelected.classList.remove('selected');
            }
            var oldHandle = grid.querySelector('.excel-fill-handle');
            if (oldHandle) {
                oldHandle.parentNode.removeChild(oldHandle);
            }

            var cell = grid.querySelector('[data-cell="' + cellId + '"]');
            if (cell) {
                cell.classList.add('selected');
                this.selectedCell = cellId;

                var fillHandle = document.createElement('div');
                fillHandle.className = 'excel-fill-handle';
                fillHandle.id = this.containerId + '-fillhandle';
                cell.appendChild(fillHandle);

                fillHandle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    self.startFillDrag(cellId);
                });
                fillHandle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    self.startFillDrag(cellId);
                }, { passive: false });

                document.getElementById(this.containerId + '-namebox').textContent = cellId;

                var formulaInput = document.getElementById(this.containerId + '-formula');
                if (this.formulas[cellId]) {
                    formulaInput.value = this.formulas[cellId];
                } else {
                    formulaInput.value = this.data[cellId] !== undefined ? this.data[cellId] : '';
                }
            }
        };

        ExcelSim.prototype.startEditing = function(cellId, inCell) {
            var self = this;

            if (this.isEditing && this.selectedCell !== cellId) {
                this.finishEditing();
            }

            this.isEditing = true;
            this.editingInCell = inCell;

            var formulaInput = document.getElementById(this.containerId + '-formula');
            var grid = document.getElementById(this.containerId + '-grid');
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');

            var currentValue = this.formulas[cellId] || '';
            if (!currentValue && this.data[cellId] !== undefined && this.data[cellId] !== '') {
                currentValue = String(this.data[cellId]);
            }
            this.originalCellValue = currentValue;
            formulaInput.value = currentValue;

            this.cursorInFormula = (currentValue.charAt(0) === '=');

            var fillHandle = document.getElementById(this.containerId + '-fillhandle');
            if (fillHandle) {
                fillHandle.style.display = 'none';
            }

            if (inCell) {
                cell.classList.add('editing');

                var existingInput = document.getElementById(this.containerId + '-cellinput');
                if (existingInput) {
                    existingInput.parentNode.removeChild(existingInput);
                }

                var cellInput = document.createElement('input');
                cellInput.type = 'text';
                cellInput.className = 'cell-input';
                cellInput.id = this.containerId + '-cellinput';
                cellInput.value = currentValue;

                cell.textContent = '';
                cell.appendChild(cellInput);

                cellInput.addEventListener('input', function(e) {
                    formulaInput.value = cellInput.value;
                    self.handleFormulaInput(e);
                    self.cursorInFormula = (cellInput.value.charAt(0) === '=');
                });

                cellInput.addEventListener('keydown', function(e) {
                    self.handleCellInputKeydown(e);
                });

                cellInput.focus();
            } else {
                formulaInput.focus();
            }

            document.getElementById(this.containerId + '-status').textContent = 'Bearbeiten';
        };

        ExcelSim.prototype.startEditingWithChar = function(cellId, char) {
            var self = this;

            if (this.isEditing) {
                this.finishEditing();
            }

            this.isEditing = true;
            this.editingInCell = true;
            this.cursorInFormula = (char === '=');

            var formulaInput = document.getElementById(this.containerId + '-formula');
            var grid = document.getElementById(this.containerId + '-grid');
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');

            var fillHandle = document.getElementById(this.containerId + '-fillhandle');
            if (fillHandle) {
                fillHandle.style.display = 'none';
            }

            cell.classList.add('editing');

            var existingInput = document.getElementById(this.containerId + '-cellinput');
            if (existingInput) {
                existingInput.parentNode.removeChild(existingInput);
            }

            var cellInput = document.createElement('input');
            cellInput.type = 'text';
            cellInput.className = 'cell-input';
            cellInput.id = this.containerId + '-cellinput';
            cellInput.value = char;

            cell.textContent = '';
            cell.appendChild(cellInput);

            formulaInput.value = char;

            cellInput.addEventListener('input', function(e) {
                formulaInput.value = cellInput.value;
                self.handleFormulaInput(e);
                self.cursorInFormula = (cellInput.value.charAt(0) === '=');
            });

            cellInput.addEventListener('keydown', function(e) {
                self.handleCellInputKeydown(e);
            });

            cellInput.focus();
            cellInput.selectionStart = cellInput.selectionEnd = char.length;
        };

        ExcelSim.prototype.finishEditing = function() {
            if (!this.isEditing) return;

            var formulaInput = document.getElementById(this.containerId + '-formula');
            var grid = document.getElementById(this.containerId + '-grid');
            var cellId = this.selectedCell;
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');

            var value = formulaInput.value;

            this.clearFormulaHighlights();

            if (value.charAt(0) === '=') {
                this.formulas[cellId] = value;
                var result = this.evaluateFormula(value);
                this.data[cellId] = result;
                cell.textContent = this.formatValue(result);
            } else {
                delete this.formulas[cellId];
                var numValue = parseFloat(value.replace(',', '.'));
                if (!isNaN(numValue) && value.trim() !== '') {
                    this.data[cellId] = numValue;
                    cell.textContent = this.formatValue(numValue);
                } else {
                    this.data[cellId] = value;
                    cell.textContent = value;
                }
            }

            cell.classList.remove('editing');
            this.isEditing = false;
            this.editingInCell = false;
            this.editingInFormulaBar = false;

            var fillHandle = document.getElementById(this.containerId + '-fillhandle');
            if (fillHandle) {
                fillHandle.style.display = '';
            }

            this.recalculateAll();

            document.getElementById(this.containerId + '-status').textContent = 'Bereit';

            if (this.config.onChange) {
                this.config.onChange(cellId, this.data[cellId], this.formulas[cellId] || null);
            }
        };

        ExcelSim.prototype.cancelEditing = function() {
            if (!this.isEditing) return;

            var formulaInput = document.getElementById(this.containerId + '-formula');
            var grid = document.getElementById(this.containerId + '-grid');
            var cellId = this.selectedCell;
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');

            formulaInput.value = this.originalCellValue;
            cell.textContent = this.formatValue(this.data[cellId]);
            cell.classList.remove('editing');

            this.isEditing = false;
            this.editingInCell = false;

            var fillHandle = document.getElementById(this.containerId + '-fillhandle');
            if (fillHandle) {
                fillHandle.style.display = '';
            }

            this.clearFormulaHighlights();
            document.getElementById(this.containerId + '-status').textContent = 'Bereit';
        };

        ExcelSim.prototype.handleKeydown = function(e) {
            var cellId = this.selectedCell;
            if (!cellId) return;

            var col = cellId.charAt(0);
            var row = parseInt(cellId.slice(1));

            if (e.key === 'Enter') {
                if (this.isEditing) {
                    this.finishEditing();
                    this.moveToCell(col, row + 1);
                } else {
                    this.startEditing(cellId, true);
                }
                e.preventDefault();
            } else if (e.key === 'Tab') {
                if (this.isEditing) {
                    this.finishEditing();
                }
                var nextCol = String.fromCharCode(col.charCodeAt(0) + (e.shiftKey ? -1 : 1));
                this.moveToCell(nextCol, row);
                e.preventDefault();
            } else if (e.key === 'Escape') {
                this.cancelEditing();
                e.preventDefault();
            } else if (!this.isEditing) {
                if (e.key === 'ArrowUp') {
                    this.moveToCell(col, row - 1);
                    e.preventDefault();
                } else if (e.key === 'ArrowDown') {
                    this.moveToCell(col, row + 1);
                    e.preventDefault();
                } else if (e.key === 'ArrowLeft') {
                    var prevCol = String.fromCharCode(col.charCodeAt(0) - 1);
                    this.moveToCell(prevCol, row);
                    e.preventDefault();
                } else if (e.key === 'ArrowRight') {
                    var nextCol = String.fromCharCode(col.charCodeAt(0) + 1);
                    this.moveToCell(nextCol, row);
                    e.preventDefault();
                } else if (e.key === 'Delete' || e.key === 'Backspace') {
                    this.data[cellId] = '';
                    delete this.formulas[cellId];
                    var cell = document.querySelector('#' + this.containerId + '-grid [data-cell="' + cellId + '"]');
                    if (cell) cell.textContent = '';
                    this.recalculateAll();
                    e.preventDefault();
                } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                    this.startEditingWithChar(cellId, e.key);
                    e.preventDefault();
                }
            }
        };

        ExcelSim.prototype.handleCellInputKeydown = function(e) {
            if (e.key === 'Enter') {
                this.finishEditing();
                var col = this.selectedCell.charAt(0);
                var row = parseInt(this.selectedCell.slice(1));
                this.moveToCell(col, row + 1);
                e.preventDefault();
            } else if (e.key === 'Tab') {
                this.finishEditing();
                var col = this.selectedCell.charAt(0);
                var row = parseInt(this.selectedCell.slice(1));
                var nextCol = String.fromCharCode(col.charCodeAt(0) + (e.shiftKey ? -1 : 1));
                this.moveToCell(nextCol, row);
                e.preventDefault();
            } else if (e.key === 'Escape') {
                this.cancelEditing();
                e.preventDefault();
            }
        };

        ExcelSim.prototype.handleFormulaKeydown = function(e) {
            if (e.key === 'Enter') {
                this.finishEditing();
                e.preventDefault();
            } else if (e.key === 'Escape') {
                this.cancelEditing();
                e.preventDefault();
            } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                var autocomplete = document.getElementById(this.containerId + '-autocomplete');
                if (autocomplete.classList.contains('show')) {
                    e.preventDefault();
                }
            }
        };

        ExcelSim.prototype.handleFormulaInput = function(e) {
            var value = document.getElementById(this.containerId + '-formula').value;
            this.cursorInFormula = (value.charAt(0) === '=');

            if (value.charAt(0) === '=') {
                var match = value.match(/=([A-Z]+)$/i);
                if (match) {
                    this.showAutocomplete(match[1]);
                } else {
                    this.hideAutocomplete();
                }
            } else {
                this.hideAutocomplete();
            }
        };

        ExcelSim.prototype.showAutocomplete = function(partial) {
            var autocomplete = document.getElementById(this.containerId + '-autocomplete');
            var matches = [];

            for (var i = 0; i < this.functions.length; i++) {
                if (this.functions[i].name.toUpperCase().indexOf(partial.toUpperCase()) === 0) {
                    matches.push(this.functions[i]);
                }
            }

            if (matches.length === 0) {
                this.hideAutocomplete();
                return;
            }

            var html = '';
            for (var i = 0; i < matches.length; i++) {
                html += '<div class="excel-autocomplete-item" data-fn="' + matches[i].name + '">';
                html += '<span class="fn-name">' + matches[i].name + '</span>';
                html += '<span class="fn-desc">' + matches[i].desc + '</span>';
                html += '<span class="fn-syntax">' + matches[i].syntax + '</span>';
                html += '</div>';
            }

            autocomplete.innerHTML = html;
            autocomplete.classList.add('show');
        };

        ExcelSim.prototype.hideAutocomplete = function() {
            document.getElementById(this.containerId + '-autocomplete').classList.remove('show');
        };

        ExcelSim.prototype.insertAutocomplete = function(fnName) {
            var formulaInput = document.getElementById(this.containerId + '-formula');
            var cellInput = document.getElementById(this.containerId + '-cellinput');
            var value = formulaInput.value;

            var newValue = value.replace(/=([A-Z]+)$/i, '=' + fnName + '(');

            formulaInput.value = newValue;
            if (cellInput) {
                cellInput.value = newValue;
                cellInput.focus();
            }

            this.hideAutocomplete();
        };

        ExcelSim.prototype.moveToCell = function(col, row) {
            if (col < 'A' || col > String.fromCharCode(64 + this.config.cols)) return;
            if (row < 1 || row > this.config.rows) return;

            var newCellId = col + row;
            this.selectCell(newCellId);
        };

        ExcelSim.prototype.highlightFormulaCell = function(cellId) {
            var grid = document.getElementById(this.containerId + '-grid');
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');
            if (cell) {
                cell.classList.add('formula-ref');
            }
        };

        ExcelSim.prototype.clearFormulaHighlights = function() {
            var grid = document.getElementById(this.containerId + '-grid');
            var highlighted = grid.querySelectorAll('.formula-ref');
            for (var i = 0; i < highlighted.length; i++) {
                highlighted[i].classList.remove('formula-ref');
            }
        };

        // Fill-Handle (Aufziehen)
        ExcelSim.prototype.startFillDrag = function(startCell) {
            var self = this;
            this.isDraggingFill = true;
            this.fillStartCell = startCell;
            this.fillPreviewCells = [];

            var grid = document.getElementById(this.containerId + '-grid');

            var handleMove = function(e) {
                var touch = e.touches ? e.touches[0] : e;
                var element = document.elementFromPoint(touch.clientX, touch.clientY);

                if (element && element.dataset && element.dataset.cell) {
                    self.updateFillPreview(element.dataset.cell);
                }
            };

            var handleEnd = function(e) {
                document.removeEventListener('mousemove', handleMove);
                document.removeEventListener('mouseup', handleEnd);
                document.removeEventListener('touchmove', handleMove);
                document.removeEventListener('touchend', handleEnd);

                self.executeFill();
            };

            document.addEventListener('mousemove', handleMove);
            document.addEventListener('mouseup', handleEnd);
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('touchend', handleEnd);
        };

        ExcelSim.prototype.updateFillPreview = function(endCell) {
            var grid = document.getElementById(this.containerId + '-grid');

            for (var i = 0; i < this.fillPreviewCells.length; i++) {
                var cell = grid.querySelector('[data-cell="' + this.fillPreviewCells[i] + '"]');
                if (cell) cell.classList.remove('fill-preview');
            }

            this.fillPreviewCells = [];

            var startCol = this.fillStartCell.charAt(0);
            var startRow = parseInt(this.fillStartCell.slice(1));
            var endCol = endCell.charAt(0);
            var endRow = parseInt(endCell.slice(1));

            if (startCol === endCol && endRow > startRow) {
                for (var r = startRow + 1; r <= endRow; r++) {
                    this.fillPreviewCells.push(startCol + r);
                }
            }

            for (var i = 0; i < this.fillPreviewCells.length; i++) {
                var cell = grid.querySelector('[data-cell="' + this.fillPreviewCells[i] + '"]');
                if (cell) cell.classList.add('fill-preview');
            }
        };

        ExcelSim.prototype.executeFill = function() {
            var grid = document.getElementById(this.containerId + '-grid');

            for (var i = 0; i < this.fillPreviewCells.length; i++) {
                var cell = grid.querySelector('[data-cell="' + this.fillPreviewCells[i] + '"]');
                if (cell) cell.classList.remove('fill-preview');
            }

            if (this.fillPreviewCells.length === 0) {
                this.isDraggingFill = false;
                return;
            }

            var sourceCell = this.fillStartCell;
            var sourceFormula = this.formulas[sourceCell];

            if (sourceFormula) {
                var sourceRow = parseInt(sourceCell.slice(1));

                for (var i = 0; i < this.fillPreviewCells.length; i++) {
                    var targetCell = this.fillPreviewCells[i];
                    var targetRow = parseInt(targetCell.slice(1));
                    var rowDiff = targetRow - sourceRow;

                    var newFormula = this.adjustFormulaReferences(sourceFormula, 0, rowDiff);
                    this.formulas[targetCell] = newFormula;
                    this.data[targetCell] = this.evaluateFormula(newFormula);

                    var cell = grid.querySelector('[data-cell="' + targetCell + '"]');
                    if (cell) cell.textContent = this.formatValue(this.data[targetCell]);
                }
            } else {
                var sourceValue = this.data[sourceCell];
                for (var i = 0; i < this.fillPreviewCells.length; i++) {
                    var targetCell = this.fillPreviewCells[i];
                    this.data[targetCell] = sourceValue;

                    var cell = grid.querySelector('[data-cell="' + targetCell + '"]');
                    if (cell) cell.textContent = this.formatValue(sourceValue);
                }
            }

            this.recalculateAll();
            this.isDraggingFill = false;
            this.fillPreviewCells = [];

            if (this.config.onChange) {
                this.config.onChange(null, null, null);
            }
        };

        ExcelSim.prototype.adjustFormulaReferences = function(formula, colDiff, rowDiff) {
            return formula.replace(/([A-Z])(\d+)/g, function(match, col, row) {
                var newCol = String.fromCharCode(col.charCodeAt(0) + colDiff);
                var newRow = parseInt(row) + rowDiff;
                return newCol + newRow;
            });
        };

        ExcelSim.prototype.evaluateFormula = function(formula) {
            var self = this;

            try {
                var expr = formula.substring(1);

                // SUMME
                expr = expr.replace(/SUMME\(([A-Z])(\d+):([A-Z])(\d+)\)/gi, function(m, c1, r1, c2, r2) {
                    var sum = 0;
                    for (var r = parseInt(r1); r <= parseInt(r2); r++) {
                        for (var c = c1.charCodeAt(0); c <= c2.charCodeAt(0); c++) {
                            var cellId = String.fromCharCode(c) + r;
                            var val = self.data[cellId];
                            if (typeof val === 'number') sum += val;
                        }
                    }
                    return sum;
                });

                // MITTELWERT
                expr = expr.replace(/MITTELWERT\(([A-Z])(\d+):([A-Z])(\d+)\)/gi, function(m, c1, r1, c2, r2) {
                    var sum = 0, count = 0;
                    for (var r = parseInt(r1); r <= parseInt(r2); r++) {
                        for (var c = c1.charCodeAt(0); c <= c2.charCodeAt(0); c++) {
                            var cellId = String.fromCharCode(c) + r;
                            var val = self.data[cellId];
                            if (typeof val === 'number') { sum += val; count++; }
                        }
                    }
                    return count > 0 ? sum / count : 0;
                });

                // MIN
                expr = expr.replace(/MIN\(([A-Z])(\d+):([A-Z])(\d+)\)/gi, function(m, c1, r1, c2, r2) {
                    var min = Infinity;
                    for (var r = parseInt(r1); r <= parseInt(r2); r++) {
                        for (var c = c1.charCodeAt(0); c <= c2.charCodeAt(0); c++) {
                            var cellId = String.fromCharCode(c) + r;
                            var val = self.data[cellId];
                            if (typeof val === 'number' && val < min) min = val;
                        }
                    }
                    return min === Infinity ? 0 : min;
                });

                // MAX
                expr = expr.replace(/MAX\(([A-Z])(\d+):([A-Z])(\d+)\)/gi, function(m, c1, r1, c2, r2) {
                    var max = -Infinity;
                    for (var r = parseInt(r1); r <= parseInt(r2); r++) {
                        for (var c = c1.charCodeAt(0); c <= c2.charCodeAt(0); c++) {
                            var cellId = String.fromCharCode(c) + r;
                            var val = self.data[cellId];
                            if (typeof val === 'number' && val > max) max = val;
                        }
                    }
                    return max === -Infinity ? 0 : max;
                });

                // ANZAHL
                expr = expr.replace(/ANZAHL\(([A-Z])(\d+):([A-Z])(\d+)\)/gi, function(m, c1, r1, c2, r2) {
                    var count = 0;
                    for (var r = parseInt(r1); r <= parseInt(r2); r++) {
                        for (var c = c1.charCodeAt(0); c <= c2.charCodeAt(0); c++) {
                            var cellId = String.fromCharCode(c) + r;
                            var val = self.data[cellId];
                            if (typeof val === 'number') count++;
                        }
                    }
                    return count;
                });

                // Zellreferenzen
                expr = expr.replace(/([A-Z])(\d+)/g, function(match, col, row) {
                    var cellId = col.toUpperCase() + row;
                    var val = self.data[cellId];
                    if (typeof val === 'number') return val;
                    if (val === '' || val === undefined) return 0;
                    return '"' + val + '"';
                });

                var result = eval(expr);
                return typeof result === 'number' ? result : 0;

            } catch (e) {
                return '#FEHLER';
            }
        };

        ExcelSim.prototype.recalculateAll = function() {
            var self = this;
            var grid = document.getElementById(this.containerId + '-grid');

            for (var cellId in this.formulas) {
                var result = this.evaluateFormula(this.formulas[cellId]);
                this.data[cellId] = result;
                var cell = grid.querySelector('[data-cell="' + cellId + '"]');
                if (cell && !cell.classList.contains('editing')) {
                    cell.textContent = this.formatValue(result);
                }
            }
        };

        ExcelSim.prototype.loadData = function(newData) {
            this.data = {};
            this.formulas = {};

            for (var r = 1; r <= this.config.rows; r++) {
                for (var c = 0; c < this.config.cols; c++) {
                    var col = String.fromCharCode(65 + c);
                    var cellId = col + r;
                    var cellData = newData[cellId];
                    if (cellData !== undefined) {
                        if (typeof cellData === 'string' && cellData.charAt(0) === '=') {
                            this.formulas[cellId] = cellData;
                            this.data[cellId] = this.evaluateFormula(cellData);
                        } else {
                            this.data[cellId] = cellData;
                        }
                    } else {
                        this.data[cellId] = '';
                    }
                }
            }

            this.refreshDisplay();
        };

        ExcelSim.prototype.refreshDisplay = function() {
            var grid = document.getElementById(this.containerId + '-grid');

            for (var r = 1; r <= this.config.rows; r++) {
                for (var c = 0; c < this.config.cols; c++) {
                    var col = String.fromCharCode(65 + c);
                    var cellId = col + r;
                    var cell = grid.querySelector('[data-cell="' + cellId + '"]');
                    if (cell) {
                        cell.textContent = this.formatValue(this.data[cellId]);
                    }
                }
            }
        };

        // ========================================
        // PRESET-DATEN
        // ========================================

        var presets = {
            leer: {},

            noten: {
                'A1': 'Name', 'B1': 'Test 1', 'C1': 'Test 2', 'D1': 'Test 3', 'E1': 'Schnitt',
                'A2': 'Anna', 'B2': 2, 'C2': 1, 'D2': 2, 'E2': '=MITTELWERT(B2:D2)',
                'A3': 'Ben', 'B3': 3, 'C3': 2, 'D3': 3, 'E3': '=MITTELWERT(B3:D3)',
                'A4': 'Clara', 'B4': 1, 'C4': 1, 'D4': 2, 'E4': '=MITTELWERT(B4:D4)',
                'A5': 'David', 'B5': 4, 'C5': 3, 'D5': 3, 'E5': '=MITTELWERT(B5:D5)',
                'A6': 'Emma', 'B6': 2, 'C6': 2, 'D6': 1, 'E6': '=MITTELWERT(B6:D6)',
                'A8': 'Klassen-', 'B8': '=MITTELWERT(B2:B6)', 'C8': '=MITTELWERT(C2:C6)', 'D8': '=MITTELWERT(D2:D6)',
                'A9': 'Bester', 'B9': '=MIN(B2:B6)', 'C9': '=MIN(C2:C6)', 'D9': '=MIN(D2:D6)'
            },

            budget: {
                'A1': 'Kategorie', 'B1': 'Geplant', 'C1': 'Ausgegeben', 'D1': 'Differenz',
                'A2': 'Essen', 'B2': 200, 'C2': 185, 'D2': '=B2-C2',
                'A3': 'Transport', 'B3': 80, 'C3': 95, 'D3': '=B3-C3',
                'A4': 'Freizeit', 'B4': 100, 'C4': 120, 'D4': '=B4-C4',
                'A5': 'Kleidung', 'B5': 50, 'C5': 30, 'D5': '=B5-C5',
                'A6': 'Sonstiges', 'B6': 70, 'C6': 65, 'D6': '=B6-C6',
                'A8': 'SUMME', 'B8': '=SUMME(B2:B6)', 'C8': '=SUMME(C2:C6)', 'D8': '=SUMME(D2:D6)'
            },

            sport: {
                'A1': 'Spieler', 'B1': 'Tore', 'C1': 'Assists', 'D1': 'Punkte', 'E1': 'Spiele',
                'A2': 'Mller', 'B2': 12, 'C2': 8, 'D2': '=B2+C2', 'E2': 15,
                'A3': 'Schmidt', 'B3': 8, 'C3': 15, 'D3': '=B3+C3', 'E3': 14,
                'A4': 'Weber', 'B4': 15, 'C4': 5, 'D4': '=B4+C4', 'E4': 16,
                'A5': 'Fischer', 'B5': 6, 'C5': 12, 'D5': '=B5+C5', 'E5': 13,
                'A6': 'Meyer', 'B6': 10, 'C6': 10, 'D6': '=B6+C6', 'E6': 15,
                'A8': 'SUMME', 'B8': '=SUMME(B2:B6)', 'C8': '=SUMME(C2:C6)', 'D8': '=SUMME(D2:D6)',
                'A9': 'MAX', 'B9': '=MAX(B2:B6)', 'C9': '=MAX(C2:C6)', 'D9': '=MAX(D2:D6)',
                'A10': 'SCHNITT', 'B10': '=MITTELWERT(B2:B6)', 'C10': '=MITTELWERT(C2:C6)', 'D10': '=MITTELWERT(D2:D6)'
            }
        };

        // ========================================
        // INITIALISIERUNG
        // ========================================

        var excel;

        function initExcel(data) {
            excel = new ExcelSim('excel-playground', {
                rows: 15,
                cols: 6,
                data: data || {}
            });
        }

        function loadPreset(name) {
            // Button-Styling
            var buttons = document.querySelectorAll('.preset-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            event.target.classList.add('active');

            // Daten laden
            if (excel) {
                excel.loadData(presets[name] || {});
            }
        }

        function resetTabelle() {
            initExcel({});
        }

        // Starte mit leerer Tabelle
        initExcel({});
    </script>
</body>
</html>
