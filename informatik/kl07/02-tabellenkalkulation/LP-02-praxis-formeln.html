<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formeln praktisch anwenden | Informatik 7</title>
    <style>
        /* ========================================
           GRUNDLAYOUT
           ======================================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            color: #222;
            font-size: 16px;
            line-height: 1.5;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ========================================
           HEADER
           ======================================== */
        header {
            background: #b35c00;
            color: #fff;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        header .subtitle {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* ========================================
           FORTSCHRITTSANZEIGE
           ======================================== */
        .progress-bar {
            background: #ddd;
            height: 8px;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: #b35c00;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.85em;
            color: #555;
            margin-bottom: 10px;
        }

        /* Step-Indicators (Navigation) */
        .step-indicators {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .step-dot {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 600;
            border: 2px solid #ddd;
            background: #fff;
            color: #888;
            cursor: not-allowed;
            transition: all 0.15s;
        }

        .step-dot.unlocked {
            cursor: pointer;
            border-color: #b35c00;
            color: #b35c00;
        }

        .step-dot.unlocked:hover {
            background: #fff3e0;
        }

        .step-dot.completed {
            background: #2a7a4b;
            border-color: #2a7a4b;
            color: #fff;
            cursor: pointer;
        }

        .step-dot.completed:hover {
            background: #1e5a35;
        }

        .step-dot.current {
            border-color: #b35c00;
            border-width: 3px;
            background: #fff3e0;
            color: #b35c00;
            cursor: default;
        }

        /* ========================================
           ABSCHNITTE
           ======================================== */
        .section {
            background: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            font-size: 1.2em;
            font-weight: 600;
            color: #b35c00;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #b35c00;
        }

        .section p {
            margin-bottom: 15px;
        }

        /* ========================================
           INFO-BOXEN
           ======================================== */
        .info-box {
            background: #fff3e0;
            border: 1px solid #b35c00;
            padding: 15px;
            margin: 15px 0;
        }

        .info-box strong {
            color: #b35c00;
        }

        .merke-box {
            background: #e8f5e9;
            border: 1px solid #2a7a4b;
            padding: 15px;
            margin: 15px 0;
        }

        .merke-box::before {
            content: "Merke: ";
            font-weight: 600;
            color: #2a7a4b;
        }

        /* ========================================
           EXCEL-SIMULATION
           ======================================== */
        .excel-container {
            border: 1px solid #999;
            background: #fff;
            margin: 20px 0;
            overflow: hidden;
        }

        /* Titelleiste */
        .excel-titlebar {
            background: linear-gradient(180deg, #217346 0%, #1e6b40 100%);
            color: #fff;
            padding: 6px 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        /* Menüleiste (vereinfacht) */
        .excel-menubar {
            background: #f3f3f3;
            border-bottom: 1px solid #d4d4d4;
            padding: 4px 8px;
            font-size: 0.8em;
            color: #444;
        }

        /* Formelzeile */
        .excel-formula-bar {
            display: flex;
            border-bottom: 1px solid #d4d4d4;
            background: #fff;
        }

        .excel-name-box {
            width: 80px;
            padding: 4px 8px;
            border-right: 1px solid #d4d4d4;
            font-family: "Segoe UI", Arial, sans-serif;
            font-size: 0.9em;
            text-align: center;
            background: #f9f9f9;
            font-weight: 500;
        }

        .excel-fx-label {
            padding: 4px 8px;
            border-right: 1px solid #d4d4d4;
            font-style: italic;
            color: #666;
            font-size: 0.9em;
            background: #f9f9f9;
        }

        .excel-formula-input {
            flex: 1;
            border: none;
            padding: 4px 8px;
            font-family: "Segoe UI", Arial, sans-serif;
            font-size: 0.95em;
            outline: none;
        }

        .excel-formula-input:focus {
            background: #fff;
        }

        /* Autocomplete Dropdown */
        .excel-autocomplete {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .excel-autocomplete-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .excel-autocomplete-item:hover,
        .excel-autocomplete-item.selected {
            background: #e5f3ff;
        }

        .excel-autocomplete-item .fn-name {
            font-weight: 600;
            color: #217346;
        }

        .excel-autocomplete-item .fn-desc {
            color: #666;
            font-size: 0.85em;
        }

        /* Tabelle */
        .excel-grid-wrapper {
            overflow: auto;
            max-height: 350px;
        }

        .excel-grid {
            border-collapse: collapse;
            font-family: "Segoe UI", Arial, sans-serif;
            font-size: 0.9em;
            user-select: none;
        }

        .excel-grid th {
            background: #f0f0f0;
            border: 1px solid #c0c0c0;
            padding: 3px 8px;
            font-weight: 400;
            color: #333;
            text-align: center;
            min-width: 80px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .excel-grid th.col-header {
            min-width: 80px;
        }

        .excel-grid th.row-header {
            min-width: 40px;
            background: #f0f0f0;
            position: sticky;
            left: 0;
            z-index: 5;
        }

        .excel-grid th.corner {
            position: sticky;
            top: 0;
            left: 0;
            z-index: 15;
            background: #e8e8e8;
        }

        .excel-grid td {
            border: 1px solid #c0c0c0;
            padding: 3px 6px;
            min-width: 80px;
            height: 22px;
            background: #fff;
            cursor: cell;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .excel-grid td.selected {
            outline: 2px solid #217346;
            outline-offset: -1px;
            background: #fff;
        }

        .excel-grid td.editing {
            outline: 2px solid #217346;
            background: #fff;
            padding: 0;
        }

        .excel-grid td.in-formula {
            background: #e5f0ff;
        }

        .excel-grid td .cell-input {
            width: 100%;
            height: 100%;
            border: none;
            padding: 3px 6px;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            background: transparent;
        }

        /* Fill Handle - echtes Element für Touch-Support */
        .excel-fill-handle {
            position: absolute;
            right: -4px;
            bottom: -4px;
            width: 8px;
            height: 8px;
            background: #217346;
            cursor: crosshair;
            z-index: 20;
            touch-action: none;
        }

        /* Range-Highlight beim Aufziehen */
        .excel-grid td.fill-preview {
            background: #d4edda !important;
            outline: 1px dashed #217346;
        }

        /* Statusleiste */
        .excel-statusbar {
            background: #217346;
            color: #fff;
            padding: 4px 12px;
            font-size: 0.8em;
            display: flex;
            justify-content: space-between;
        }

        /* ========================================
           AUFGABEN-BOX
           ======================================== */
        .task-box {
            background: #fff3e0;
            border: 2px solid #b35c00;
            padding: 15px;
            margin: 15px 0;
        }

        .task-box h3 {
            color: #b35c00;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-list li {
            padding: 8px 0;
            padding-left: 28px;
            position: relative;
            border-bottom: 1px solid #ffe0b2;
        }

        .task-list li:last-child {
            border-bottom: none;
        }

        .task-list li::before {
            content: "☐";
            position: absolute;
            left: 0;
            color: #b35c00;
            font-size: 1.2em;
        }

        .task-list li.done::before {
            content: "☑";
            color: #2a7a4b;
        }

        .task-list li.done {
            color: #666;
            text-decoration: line-through;
        }

        /* ========================================
           FEEDBACK
           ======================================== */
        .feedback {
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #e8f5e9;
            border: 1px solid #2a7a4b;
            color: #1b5e20;
        }

        .feedback.incorrect {
            background: #ffebee;
            border: 1px solid #c62828;
            color: #b71c1c;
        }

        .feedback.hint {
            background: #e3f2fd;
            border: 1px solid #1565c0;
            color: #0d47a1;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            display: inline-block;
            padding: 10px 20px;
            font-size: 0.95em;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.85;
        }

        .btn-primary {
            background: #b35c00;
            color: #fff;
        }

        .btn-success {
            background: #2a7a4b;
            color: #fff;
        }

        .btn-secondary {
            background: #555;
            color: #fff;
        }

        .btn-reset {
            background: #888;
            color: #fff;
            font-size: 0.85em;
            padding: 6px 12px;
        }

        .btn-reset:hover {
            background: #666;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .excel-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .excel-header-row h3 {
            margin: 0;
            font-size: 1em;
            color: #555;
        }

        /* ========================================
           QUIZ
           ======================================== */
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .quiz-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
        }

        .quiz-option:hover {
            background: #fff3e0;
        }

        .quiz-option.selected {
            background: #ffe0b2;
            border-color: #b35c00;
        }

        .quiz-option.correct {
            background: #e8f5e9;
            border-color: #2a7a4b;
        }

        .quiz-option.wrong {
            background: #ffebee;
            border-color: #c62828;
        }

        /* ========================================
           ZUSAMMENFASSUNG
           ======================================== */
        .summary-list {
            list-style: none;
            padding: 0;
        }

        .summary-list li {
            padding: 10px 15px;
            margin-bottom: 10px;
            background: #fff;
            border-left: 4px solid #b35c00;
        }

        .summary-list li strong {
            color: #b35c00;
        }

        code {
            background: #f0f0f0;
            padding: 2px 6px;
            font-family: "Consolas", "Monaco", monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <header>
        <h1>Formeln praktisch anwenden</h1>
        <div class="subtitle">Informatik Klasse 7 | Tabellenkalkulation</div>
    </header>

    <div class="container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Schritt 1 von 6</div>
        <div class="step-indicators" id="stepIndicators"></div>

        <!-- ========================================
             SCHRITT 1: WILLKOMMEN
             ======================================== -->
        <div class="section active" id="section1">
            <h2>1. Willkommen</h2>

            <p>In der letzten Stunde hast du die <strong>Grundlagen der Tabellenkalkulation</strong> kennengelernt. Heute wendest du dein Wissen <strong>praktisch</strong> an!</p>

            <div class="info-box">
                <strong>Was du heute lernst:</strong>
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li>Formeln in einer Tabelle eingeben</li>
                    <li>Die SUMME-Funktion nutzen</li>
                    <li>Das <strong>Referenzprinzip</strong> verstehen</li>
                </ul>
            </div>

            <p>Du arbeitest mit einer <strong>Tabellenkalkulation-Simulation</strong>, die genauso funktioniert wie echte Programme!</p>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="nextSection()">Weiter</button>
            </div>
        </div>

        <!-- ========================================
             SCHRITT 2: WIEDERHOLUNG
             ======================================== -->
        <div class="section" id="section2">
            <h2>2. Kurze Wiederholung</h2>

            <p><strong>Frage:</strong> Welche Zelladresse hat die blau markierte Zelle?</p>

            <div class="excel-container" style="pointer-events: none;">
                <div class="excel-titlebar">Tabelle1 - Beispiel</div>
                <div class="excel-grid-wrapper">
                    <table class="excel-grid">
                        <tr>
                            <th class="corner"></th>
                            <th class="col-header">A</th>
                            <th class="col-header">B</th>
                            <th class="col-header">C</th>
                        </tr>
                        <tr>
                            <th class="row-header">1</th>
                            <td>Apfel</td>
                            <td>0,50</td>
                            <td>6</td>
                        </tr>
                        <tr>
                            <th class="row-header">2</th>
                            <td>Birne</td>
                            <td class="selected" style="background: #cce5ff;">0,80</td>
                            <td>4</td>
                        </tr>
                        <tr>
                            <th class="row-header">3</th>
                            <td>Orange</td>
                            <td>1,20</td>
                            <td>3</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="quiz-options" id="quiz1">
                <label class="quiz-option" onclick="selectQuizOption(this, 'quiz1')">
                    <input type="radio" name="quiz1" value="A2"> <span>A2</span>
                </label>
                <label class="quiz-option" onclick="selectQuizOption(this, 'quiz1')">
                    <input type="radio" name="quiz1" value="B2"> <span>B2</span>
                </label>
                <label class="quiz-option" onclick="selectQuizOption(this, 'quiz1')">
                    <input type="radio" name="quiz1" value="C2"> <span>C2</span>
                </label>
                <label class="quiz-option" onclick="selectQuizOption(this, 'quiz1')">
                    <input type="radio" name="quiz1" value="2B"> <span>2B</span>
                </label>
            </div>

            <div class="feedback" id="feedback1"></div>

            <div class="btn-group">
                <button class="btn btn-primary" id="check1" onclick="checkQuiz1()">Prüfen</button>
                <button class="btn btn-success" id="next2" onclick="nextSection()" style="display: none;">Weiter</button>
            </div>
        </div>

        <!-- ========================================
             SCHRITT 3: FORMELN EINGEBEN
             ======================================== -->
        <div class="section" id="section3">
            <h2>3. Formeln eingeben</h2>

            <div class="merke-box">
                Jede Formel beginnt mit dem <strong>Gleichheitszeichen =</strong>
            </div>

            <p>Probiere es aus! Klicke auf Zelle <strong>C1</strong> und gib die Formel <code>=A1+B1</code> ein.</p>

            <p style="font-size: 0.9em; color: #555;"><strong>Tipp:</strong> Du kannst auch auf Zellen klicken, um ihre Adresse einzufügen!</p>

            <div class="excel-header-row">
                <h3>Tabelle</h3>
                <button class="btn btn-reset" onclick="resetExcel1()">⟳ Zurücksetzen</button>
            </div>
            <div id="excel1"></div>

            <div class="task-box">
                <h3>Aufgabe</h3>
                <ul class="task-list" id="tasks1">
                    <li data-task="c1">Berechne in C1: A1 + B1</li>
                </ul>
            </div>

            <div class="feedback" id="feedback3"></div>

            <div class="btn-group">
                <button class="btn btn-success" id="next3" onclick="nextSection()" style="display: none;">Weiter</button>
            </div>
        </div>

        <!-- ========================================
             SCHRITT 4: SUMME-FUNKTION
             ======================================== -->
        <div class="section" id="section4">
            <h2>4. Die SUMME-Funktion</h2>

            <p>Wenn du viele Zellen addieren möchtest, nutze die <strong>SUMME-Funktion</strong>:</p>

            <div class="merke-box" style="font-family: monospace;">
                =SUMME(Startadresse:Endadresse)
            </div>

            <p><strong>Tipp:</strong> Tippe <code>=SU</code> und die Autovervollständigung hilft dir!</p>

            <div class="excel-header-row">
                <h3>Einkaufsliste</h3>
                <button class="btn btn-reset" onclick="resetExcel2()">⟳ Zurücksetzen</button>
            </div>
            <div id="excel2"></div>

            <div class="task-box">
                <h3>Aufgabe</h3>
                <ul class="task-list" id="tasks2">
                    <li data-task="b5">Berechne in B5 die Summe aller Preise (B2 bis B4)</li>
                </ul>
            </div>

            <div class="feedback" id="feedback4"></div>

            <div class="btn-group">
                <button class="btn btn-success" id="next4" onclick="nextSection()" style="display: none;">Weiter</button>
            </div>
        </div>

        <!-- ========================================
             SCHRITT 5: REFERENZPRINZIP
             ======================================== -->
        <div class="section" id="section5">
            <h2>5. Das Referenzprinzip</h2>

            <p>Jetzt kommt etwas Besonderes: Wenn du einen <strong>Wert änderst</strong>, berechnet die Tabelle die Formel <strong>automatisch neu</strong>!</p>

            <div class="info-box">
                <strong>Referenzprinzip:</strong> Formeln beziehen sich auf Zellen. Ändert sich der Inhalt einer Zelle, wird das Ergebnis automatisch aktualisiert.
            </div>

            <p><strong>Probiere es aus:</strong> Die Formel in C1 lautet <code>=A1+B1</code>. Ändere den Wert in A1 oder B1 und beobachte C1!</p>

            <div class="excel-header-row">
                <h3>Tabelle mit Formel</h3>
                <button class="btn btn-reset" onclick="resetExcel3()">⟳ Zurücksetzen</button>
            </div>
            <div id="excel3"></div>

            <div class="task-box">
                <h3>Aufgabe</h3>
                <ul class="task-list" id="tasks3">
                    <li data-task="change">Ändere A1 auf 20 und beobachte das Ergebnis in C1</li>
                </ul>
            </div>

            <div class="feedback" id="feedback5"></div>

            <div class="btn-group">
                <button class="btn btn-success" id="next5" onclick="nextSection()" style="display: none;">Weiter</button>
            </div>
        </div>

        <!-- ========================================
             SCHRITT 6: ZUSAMMENFASSUNG
             ======================================== -->
        <div class="section" id="section6">
            <h2>Zusammenfassung</h2>

            <p>Super! Du hast heute gelernt:</p>

            <ul class="summary-list">
                <li><strong>Formeln eingeben:</strong> Jede Formel beginnt mit <code>=</code></li>
                <li><strong>Zellen anklicken:</strong> Beim Eingeben einer Formel kannst du Zellen anklicken, um ihre Adresse einzufügen</li>
                <li><strong>Autovervollständigung:</strong> Tippe <code>=SU</code> und das Programm schlägt <code>SUMME</code> vor</li>
                <li><strong>SUMME-Funktion:</strong> <code>=SUMME(B2:B5)</code> addiert alle Werte im Bereich</li>
                <li><strong>Referenzprinzip:</strong> Ändert sich ein Wert, wird die Formel automatisch neu berechnet</li>
            </ul>

            <div class="merke-box">
                Formeln machen die Tabellenkalkulation so mächtig: Du gibst die Formel <strong>einmal</strong> ein, und die Tabelle rechnet <strong>automatisch</strong>!
            </div>

            <div style="text-align: center; margin-top: 30px; padding: 20px; background: #e8f5e9; border: 1px solid #2a7a4b;">
                <p style="font-size: 1.2em; color: #2a7a4b; font-weight: 600;">Geschafft!</p>
                <p>Du kannst diesen Lernpfad jederzeit wiederholen.</p>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="nextSection()">Weiter: Party-Budget</button>
            </div>
        </div>

        <!-- ========================================
             SCHRITT 7: PARTY-BUDGET (Aufziehen lernen)
             ======================================== -->
        <div class="section" id="section7">
            <h2>7. Party-Budget: Aufziehen lernen</h2>

            <p>Du planst eine <strong>Klassenparty</strong>! Dabei lernst du den <strong>Profi-Trick</strong>: Formeln automatisch kopieren.</p>

            <!-- AUFZIEHEN ERKLÄRT -->
            <div class="info-box" style="background: #e8f5e9; border-color: #2a7a4b;">
                <strong style="color: #2a7a4b; font-size: 1.1em;">Der Aufzieh-Trick (Fill-Handle)</strong>
                <p style="margin-top: 10px;">Statt jede Formel einzeln einzugeben, kannst du sie <strong>automatisch kopieren</strong>:</p>

                <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px; background: #fff; padding: 12px; border: 1px solid #2a7a4b;">
                        <p style="font-weight: 600; color: #2a7a4b; margin-bottom: 8px;">Schritt 1</p>
                        <p>Gib die Formel <code>=B2*C2</code> in Zelle <strong>D2</strong> ein und drücke Enter.</p>
                    </div>
                    <div style="flex: 1; min-width: 200px; background: #fff; padding: 12px; border: 1px solid #2a7a4b;">
                        <p style="font-weight: 600; color: #2a7a4b; margin-bottom: 8px;">Schritt 2</p>
                        <p>Klicke auf Zelle <strong>D2</strong>. Sieh den <span style="color: #217346; font-weight: 600;">grünen Punkt</span> rechts unten!</p>
                    </div>
                    <div style="flex: 1; min-width: 200px; background: #fff; padding: 12px; border: 1px solid #2a7a4b;">
                        <p style="font-weight: 600; color: #2a7a4b; margin-bottom: 8px;">Schritt 3</p>
                        <p>Ziehe den grünen Punkt <strong>nach unten</strong> bis D6. Die Formel wird automatisch angepasst!</p>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: #c8e6c9; text-align: center;">
                    <strong>Magie:</strong> Aus <code>=B2*C2</code> wird automatisch <code>=B3*C3</code>, dann <code>=B4*C4</code>, usw.
                </div>
            </div>

            <div class="excel-header-row">
                <h3>Party-Budget</h3>
                <button class="btn btn-reset" onclick="resetExcel4()">⟳ Zurücksetzen</button>
            </div>
            <div id="excel4"></div>

            <div class="task-box">
                <h3>Aufgaben</h3>
                <ul class="task-list" id="tasks4">
                    <li data-task="d2">D2: Gib <code>=B2*C2</code> ein (Chips: 1,50 € × 4)</li>
                    <li data-task="d3">D3: Limo-Gesamtpreis (aufziehen oder <code>=B3*C3</code>)</li>
                    <li data-task="d4">D4: Pizza-Gesamtpreis</li>
                    <li data-task="d5">D5: Deko-Gesamtpreis</li>
                    <li data-task="d6">D6: Becher-Gesamtpreis</li>
                    <li data-task="d7">D7: Gesamtsumme mit <code>=SUMME(D2:D6)</code></li>
                </ul>
            </div>

            <div class="feedback" id="feedback7"></div>

            <!-- INTERAKTIVE BONUS-FRAGEN -->
            <div class="info-box" style="margin-top: 20px;">
                <strong>Experimentiere:</strong>
                <div style="margin-top: 15px;">
                    <p style="margin-bottom: 8px;"><strong>Frage 1:</strong> Wenn du die Pizza-Menge (C4) auf <strong>5</strong> änderst, was zeigt D4?</p>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="bonus1-answer" style="width: 80px; padding: 5px; border: 1px solid #ccc;" placeholder="?">
                        <span>€</span>
                        <button class="btn" onclick="checkBonus1()" style="padding: 5px 15px;">Prüfen</button>
                        <span id="bonus1-feedback" style="font-weight: 600;"></span>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <p style="margin-bottom: 8px;"><strong>Frage 2:</strong> Wie hoch ist die Gesamtsumme (D7), wenn 30 Becher (C6) bestellt werden?</p>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="bonus2-answer" style="width: 80px; padding: 5px; border: 1px solid #ccc;" placeholder="?" step="0.01">
                        <span>€</span>
                        <button class="btn" onclick="checkBonus2()" style="padding: 5px 15px;">Prüfen</button>
                        <span id="bonus2-feedback" style="font-weight: 600;"></span>
                    </div>
                </div>
            </div>

            <div class="btn-group" id="next7" style="display: none;">
                <button class="btn btn-primary" onclick="nextSection()">Weiter zum Quiz</button>
            </div>
        </div>

        <!-- ========================================
             SCHRITT 8: QUIZ - WARUM IST DAS NÜTZLICH?
             ======================================== -->
        <div class="section" id="section8">
            <h2>Quiz: Warum Tabellenkalkulation?</h2>

            <p>Bevor du zur freien Spielwiese kommst, ein kurzes Quiz: <strong>Warum ist das eigentlich so nützlich?</strong></p>

            <div class="quiz-container" id="quiz2">
                <p style="font-weight: 600; margin-bottom: 15px;">Frage 1: Ein Supermarkt hat 50.000 Produkte. Der Chef will den Preis von ALLEM um 5% erhöhen. Wie lange dauert das?</p>

                <label class="quiz-option">
                    <input type="radio" name="q2" value="a">
                    <span>Wochen – jedes Preisschild einzeln ändern</span>
                </label>
                <label class="quiz-option">
                    <input type="radio" name="q2" value="b">
                    <span>Tage – mit einem Team von 10 Leuten</span>
                </label>
                <label class="quiz-option">
                    <input type="radio" name="q2" value="c">
                    <span>Sekunden – eine Formel, alle Preise ändern sich automatisch</span>
                </label>

                <div class="feedback" id="feedback-q2"></div>
            </div>

            <div class="quiz-container" id="quiz3" style="margin-top: 20px;">
                <p style="font-weight: 600; margin-bottom: 15px;">Frage 2: Eine Schule plant einen Wandertag. 847 Schüler, verschiedene Ziele, unterschiedliche Kosten. Was macht die Tabellenkalkulation möglich?</p>

                <label class="quiz-option">
                    <input type="radio" name="q3" value="a">
                    <span>Nur die Namen auflisten</span>
                </label>
                <label class="quiz-option">
                    <input type="radio" name="q3" value="b">
                    <span>Automatisch: Gesamtkosten, Kosten pro Klasse, günstigstes Ziel, Durchschnittspreis</span>
                </label>
                <label class="quiz-option">
                    <input type="radio" name="q3" value="c">
                    <span>Das Wetter vorhersagen</span>
                </label>

                <div class="feedback" id="feedback-q3"></div>
            </div>

            <div class="quiz-container" id="quiz4" style="margin-top: 20px;">
                <p style="font-weight: 600; margin-bottom: 15px;">Frage 3: Ein YouTuber trackt seine Views. Was kann die Tabellenkalkulation ihm zeigen?</p>

                <label class="quiz-option">
                    <input type="radio" name="q4" value="a">
                    <span>Nur Zahlen in einer Liste</span>
                </label>
                <label class="quiz-option">
                    <input type="radio" name="q4" value="b">
                    <span>Welches Video am besten läuft, Wachstum pro Monat, Diagramme, Prognosen</span>
                </label>
                <label class="quiz-option">
                    <input type="radio" name="q4" value="c">
                    <span>Mehr Abonnenten bekommen</span>
                </label>

                <div class="feedback" id="feedback-q4"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="checkAhaQuiz()">Antworten prüfen</button>
            </div>

            <div class="feedback" id="feedback8" style="margin-top: 20px;"></div>

            <!-- AHA-Box (erscheint nach Quiz) -->
            <div id="aha-box" style="display: none; margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border: 2px solid #b35c00;">
                <p style="font-size: 1.3em; font-weight: 600; color: #b35c00; text-align: center; margin-bottom: 15px;">Der AHA-Moment</p>

                <div style="display: grid; gap: 15px;">
                    <div style="background: #fff; padding: 15px; border-left: 4px solid #b35c00;">
                        <p style="font-weight: 600; color: #b35c00;">Automatisierung</p>
                        <p>Eine Formel → 50.000 Berechnungen. Das ist die Kraft der Tabellenkalkulation!</p>
                    </div>
                    <div style="background: #fff; padding: 15px; border-left: 4px solid #b35c00;">
                        <p style="font-weight: 600; color: #b35c00;">Echtzeit-Updates</p>
                        <p>Ändere einen Wert → alles wird sofort neu berechnet. Keine Fehler durch Vergessen!</p>
                    </div>
                    <div style="background: #fff; padding: 15px; border-left: 4px solid #b35c00;">
                        <p style="font-weight: 600; color: #b35c00;">Analyse</p>
                        <p>Aus Zahlen werden Erkenntnisse: Was läuft gut? Was muss sich ändern?</p>
                    </div>
                </div>

                <p style="text-align: center; margin-top: 20px; font-size: 1.1em;">
                    <strong>Profis nutzen Tabellenkalkulationen für:</strong> Finanzen, Wissenschaft, Logistik, Gaming-Stats, Sportanalysen, und vieles mehr!
                </p>
            </div>

            <div class="btn-group" id="next8" style="display: none;">
                <button class="btn btn-primary" onclick="nextSection()">Zur Spielwiese</button>
            </div>
        </div>

        <!-- ========================================
             SCHRITT 9: ABSCHLUSS + LINK ZUR SPIELWIESE
             ======================================== -->
        <div class="section" id="section9">
            <h2>Geschafft! Jetzt frei experimentieren</h2>

            <div style="text-align: center; padding: 30px; background: #e8f5e9; border: 2px solid #2a7a4b; margin-bottom: 20px;">
                <p style="font-size: 1.3em; color: #2a7a4b; font-weight: 600; margin-bottom: 10px;">Du bist jetzt Tabellen-Profi!</p>
                <p>Du kennst Formeln, SUMME, das Referenzprinzip und das Aufziehen.</p>
            </div>

            <p>Jetzt kannst du frei experimentieren! Die <strong>Spielwiese</strong> hat:</p>

            <ul style="margin: 15px 0 15px 25px;">
                <li>Mehr Zeilen und Spalten</li>
                <li>Neue Funktionen: <code>MITTELWERT</code>, <code>MIN</code>, <code>MAX</code>, <code>ANZAHL</code></li>
                <li>Freies Experimentieren ohne Aufgaben</li>
            </ul>

            <div style="text-align: center; margin: 30px 0;">
                <a href="SIM-02-excel-spielwiese.html" class="btn btn-primary" style="font-size: 1.1em; padding: 15px 30px; text-decoration: none; display: inline-block;">
                    Zur Spielwiese
                </a>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <p style="color: #555; font-size: 0.9em;">Oder scanne diesen QR-Code:</p>
                <div id="qr-spielwiese" style="margin: 15px auto; width: 150px; height: 150px; background: #f5f5f5; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; color: #888;">
                    [QR-Code]
                </div>
            </div>

            <div class="merke-box" style="margin-top: 30px;">
                Übung macht den Meister! Je mehr du mit Formeln experimentierst, desto natürlicher wird es.
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // DEBUG MODE - in Console: DEBUG_EXCEL = true
        // ========================================
        var DEBUG_EXCEL = false;

        function debugLog(source, message, data) {
            if (!DEBUG_EXCEL) return;
            var style = 'color: #217346; font-weight: bold;';
            if (data !== undefined) {
                console.log('%c[' + source + '] ' + message, style, data);
            } else {
                console.log('%c[' + source + '] ' + message, style);
            }
        }

        // ========================================
        // EXCEL SIMULATION ENGINE (iPad + Desktop)
        // ========================================

        var ExcelSim = function(containerId, config) {
            var self = this;
            this.containerId = containerId;
            this.config = config;
            this.data = {};
            this.formulas = {};
            this.selectedCell = null;
            this.isEditing = false;
            this.cursorInFormula = false;
            this.originalCellValue = '';

            // Fill-Handle State
            this.isDraggingFill = false;
            this.fillStartCell = null;
            this.fillPreviewCells = [];

            // Verfügbare Funktionen für Autocomplete
            this.functions = [
                { name: 'SUMME', desc: 'Addiert Zahlen', syntax: 'SUMME(Bereich)' },
                { name: 'MITTELWERT', desc: 'Berechnet Durchschnitt', syntax: 'MITTELWERT(Bereich)' },
                { name: 'MIN', desc: 'Kleinster Wert', syntax: 'MIN(Bereich)' },
                { name: 'MAX', desc: 'Größter Wert', syntax: 'MAX(Bereich)' },
                { name: 'ANZAHL', desc: 'Zählt Zahlen', syntax: 'ANZAHL(Bereich)' }
            ];

            // Globale Registry aller Instanzen (für Deaktivierung)
            if (!window.allExcelInstances) {
                window.allExcelInstances = [];
            }
            window.allExcelInstances.push(this);

            this.init();
        };

        ExcelSim.prototype.init = function() {
            var self = this;
            var container = document.getElementById(this.containerId);

            // Daten initialisieren
            for (var r = 1; r <= this.config.rows; r++) {
                for (var c = 0; c < this.config.cols; c++) {
                    var col = String.fromCharCode(65 + c);
                    var cellId = col + r;
                    var cellData = this.config.data[cellId];
                    if (cellData !== undefined) {
                        if (typeof cellData === 'string' && cellData.charAt(0) === '=') {
                            this.formulas[cellId] = cellData;
                            this.data[cellId] = this.evaluateFormula(cellData);
                        } else {
                            this.data[cellId] = cellData;
                        }
                    } else {
                        this.data[cellId] = '';
                    }
                }
            }

            // HTML erstellen
            var html = '<div class="excel-container">';
            html += '<div class="excel-titlebar">Tabelle1</div>';
            html += '<div class="excel-menubar">Datei  Bearbeiten  Ansicht  Einfügen  Format</div>';

            // Formelzeile
            html += '<div class="excel-formula-bar">';
            html += '<div class="excel-name-box" id="' + this.containerId + '-namebox">A1</div>';
            html += '<div class="excel-fx-label">fx</div>';
            html += '<input type="text" class="excel-formula-input" id="' + this.containerId + '-formula" placeholder="">';
            html += '<div class="excel-autocomplete" id="' + this.containerId + '-autocomplete"></div>';
            html += '</div>';

            // Tabelle
            html += '<div class="excel-grid-wrapper">';
            html += '<table class="excel-grid" id="' + this.containerId + '-grid">';

            // Header-Zeile
            html += '<tr><th class="corner"></th>';
            for (var c = 0; c < this.config.cols; c++) {
                html += '<th class="col-header">' + String.fromCharCode(65 + c) + '</th>';
            }
            html += '</tr>';

            // Datenzeilen
            for (var r = 1; r <= this.config.rows; r++) {
                html += '<tr><th class="row-header">' + r + '</th>';
                for (var c = 0; c < this.config.cols; c++) {
                    var col = String.fromCharCode(65 + c);
                    var cellId = col + r;
                    var value = this.data[cellId];
                    var displayValue = this.formatValue(value);
                    var editable = !this.config.locked || !this.config.locked[cellId];
                    html += '<td data-cell="' + cellId + '" data-editable="' + editable + '">' + displayValue + '</td>';
                }
                html += '</tr>';
            }

            html += '</table></div>';

            // Statusleiste
            html += '<div class="excel-statusbar">';
            html += '<span id="' + this.containerId + '-status">Bereit</span>';
            html += '<span></span>';
            html += '</div>';

            html += '</div>';

            container.innerHTML = html;

            // Event-Listener
            this.attachEvents();

            // Erste Zelle auswählen
            var firstCell = this.config.initialSelect || 'A1';
            this.selectCell(firstCell);
        };

        ExcelSim.prototype.attachEvents = function() {
            var self = this;
            var grid = document.getElementById(this.containerId + '-grid');
            var formulaInput = document.getElementById(this.containerId + '-formula');

            // Zellen-Klick
            grid.addEventListener('click', function(e) {
                var td = e.target.closest('td');
                if (td && td.dataset.cell) {
                    self.handleCellClick(td.dataset.cell);
                }
            });

            // Doppelklick zum Bearbeiten
            grid.addEventListener('dblclick', function(e) {
                var td = e.target.closest('td');
                if (td && td.dataset.cell) {
                    self.startEditing(td.dataset.cell, true);
                }
            });

            // Formelzeile
            formulaInput.addEventListener('focus', function() {
                self.editingInFormulaBar = true;
                if (self.selectedCell) {
                    self.startEditing(self.selectedCell, false);
                }
            });

            formulaInput.addEventListener('input', function(e) {
                self.handleFormulaInput(e);
            });

            formulaInput.addEventListener('keydown', function(e) {
                self.handleFormulaKeydown(e);
            });

            formulaInput.addEventListener('blur', function() {
                setTimeout(function() {
                    self.hideAutocomplete();
                }, 200);
            });

            // Autocomplete-Klicks
            var autocomplete = document.getElementById(this.containerId + '-autocomplete');
            autocomplete.addEventListener('click', function(e) {
                var item = e.target.closest('.excel-autocomplete-item');
                if (item) {
                    self.insertAutocomplete(item.dataset.fn);
                }
            });

            // Tastatur - Grid muss fokussiert sein oder zuletzt angeklickt
            var container = document.getElementById(this.containerId);
            this.isActive = false;

            // Aktiviere diese Instanz wenn Container angeklickt wird
            container.addEventListener('mousedown', function() {
                // Deaktiviere alle anderen ExcelSim-Instanzen
                document.querySelectorAll('.excel-container').forEach(function(el) {
                    el.excelSimActive = false;
                });
                container.querySelector('.excel-container').excelSimActive = true;
                self.isActive = true;
            });
            container.addEventListener('touchstart', function() {
                document.querySelectorAll('.excel-container').forEach(function(el) {
                    el.excelSimActive = false;
                });
                container.querySelector('.excel-container').excelSimActive = true;
                self.isActive = true;
            }, { passive: true });

            // Tastatur-Handler
            document.addEventListener('keydown', function(e) {
                var cellInput = document.getElementById(self.containerId + '-cellinput');
                var isInCellInput = cellInput && document.activeElement === cellInput;
                var isInFormulaInput = document.activeElement === formulaInput;

                debugLog(self.containerId, 'DOC-KEYDOWN: "' + e.key + '"', {
                    isActive: self.isActive,
                    selectedCell: self.selectedCell,
                    isEditing: self.isEditing,
                    cellInputExists: !!cellInput,
                    cellInputId: cellInput ? cellInput.id : 'null',
                    isInCellInput: isInCellInput,
                    isInFormulaInput: isInFormulaInput,
                    activeElementTag: document.activeElement.tagName,
                    activeElementId: document.activeElement.id || '(keine ID)'
                });

                // Nur reagieren wenn diese Instanz aktiv ist
                if (!self.isActive) {
                    debugLog(self.containerId, '→ SKIP: nicht aktiv');
                    return;
                }

                // ROBUSTE PRÜFUNG: Wenn wir in Zell-Editing sind und ein normales Zeichen getippt wird,
                // überlassen wir das dem Browser (das Zeichen geht ins Input)
                if (self.isEditing && self.editingInCell && e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                    // Sicherheitsprüfung: cellInput existiert und hat Focus?
                    if (cellInput) {
                        if (document.activeElement !== cellInput) {
                            debugLog(self.containerId, '→ Refokussiere cellInput (Focus war verloren)');
                            cellInput.focus();
                        }
                        debugLog(self.containerId, '→ SKIP: Zell-Editing aktiv, Zeichen geht ins Input');
                        return;
                    } else {
                        // cellInput existiert nicht mehr - beende Editing-Modus
                        debugLog(self.containerId, '→ WARNUNG: cellInput fehlt, setze Editing zurück');
                        self.isEditing = false;
                        self.editingInCell = false;
                    }
                }

                // Nur handleKeydown aufrufen, wenn wir NICHT in einem Input sind
                if (self.selectedCell && !isInCellInput && !isInFormulaInput) {
                    debugLog(self.containerId, '→ handleKeydown aufrufen');
                    self.handleKeydown(e);
                } else {
                    debugLog(self.containerId, '→ SKIP: bereits in Input oder keine Zelle');
                }
            });
        };

        ExcelSim.prototype.handleCellClick = function(cellId) {
            var formulaInput = document.getElementById(this.containerId + '-formula');
            var cellInput = document.getElementById(this.containerId + '-cellinput');

            // Wenn wir in Formelbearbeitung sind und die Formel mit = beginnt
            if (this.isEditing && this.cursorInFormula) {
                var currentValue = formulaInput.value;
                if (currentValue.charAt(0) === '=') {
                    // Zellreferenz einfügen
                    var lastChar = currentValue.slice(-1);
                    var newValue;

                    // Nach (, +, -, *, /, :, = oder am Anfang: Direkt einfügen
                    // Nach Buchstabe, Zahl oder ): Operator einfügen
                    if (/[\(\+\-\*\/\:\=]$/.test(currentValue) || currentValue === '=') {
                        newValue = currentValue + cellId;
                    } else if (/[A-Z0-9\)]$/i.test(lastChar)) {
                        // Nach Zellreferenz oder Zahl: Operator hinzufügen
                        newValue = currentValue + '+' + cellId;
                    } else {
                        newValue = currentValue + cellId;
                    }

                    // Beide Inputs synchronisieren
                    formulaInput.value = newValue;
                    if (cellInput) {
                        cellInput.value = newValue;
                        cellInput.focus();
                        cellInput.selectionStart = cellInput.selectionEnd = newValue.length;
                    } else {
                        formulaInput.focus();
                    }

                    // Zelle als "in Formel verwendet" markieren
                    this.highlightFormulaCell(cellId);
                    return;
                }
            }

            // Normale Auswahl
            if (this.isEditing) {
                this.finishEditing();
            }
            this.selectCell(cellId);
        };

        ExcelSim.prototype.selectCell = function(cellId) {
            var self = this;
            var grid = document.getElementById(this.containerId + '-grid');

            // ALLE anderen Instanzen deaktivieren, NUR diese aktivieren
            if (window.allExcelInstances) {
                debugLog(this.containerId, 'selectCell: Deaktiviere ' + window.allExcelInstances.length + ' Instanzen');
                for (var i = 0; i < window.allExcelInstances.length; i++) {
                    window.allExcelInstances[i].isActive = false;
                }
            }
            this.isActive = true;
            debugLog(this.containerId, 'selectCell: ' + cellId + ' (jetzt aktiv)');

            // Alte Auswahl und Fill-Handle entfernen
            var oldSelected = grid.querySelector('.selected');
            if (oldSelected) {
                oldSelected.classList.remove('selected');
            }
            var oldHandle = grid.querySelector('.excel-fill-handle');
            if (oldHandle) {
                oldHandle.parentNode.removeChild(oldHandle);
            }

            // Neue Auswahl
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');
            if (cell) {
                cell.classList.add('selected');
                this.selectedCell = cellId;

                // Fill-Handle erstellen (echtes Element für Touch-Support)
                var fillHandle = document.createElement('div');
                fillHandle.className = 'excel-fill-handle';
                fillHandle.id = this.containerId + '-fillhandle';
                cell.appendChild(fillHandle);

                // Fill-Handle Events (Mouse + Touch)
                fillHandle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    self.startFillDrag(cellId);
                });
                fillHandle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    self.startFillDrag(cellId);
                }, { passive: false });

                // Name-Box aktualisieren
                document.getElementById(this.containerId + '-namebox').textContent = cellId;

                // Formelzeile aktualisieren
                var formulaInput = document.getElementById(this.containerId + '-formula');
                if (this.formulas[cellId]) {
                    formulaInput.value = this.formulas[cellId];
                } else {
                    formulaInput.value = this.data[cellId] !== undefined ? this.data[cellId] : '';
                }
            }
        };

        ExcelSim.prototype.startEditing = function(cellId, inCell) {
            var self = this;

            // Falls bereits in einer anderen Zelle editiert wird, erst abschließen
            if (this.isEditing && this.selectedCell !== cellId) {
                this.finishEditing();
            }

            this.isEditing = true;
            this.editingInCell = inCell;

            var formulaInput = document.getElementById(this.containerId + '-formula');
            var grid = document.getElementById(this.containerId + '-grid');
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');

            // Original-Wert speichern für Cancel
            var currentValue = this.formulas[cellId] || '';
            if (!currentValue && this.data[cellId] !== undefined && this.data[cellId] !== '') {
                currentValue = String(this.data[cellId]);
            }
            this.originalCellValue = currentValue;
            formulaInput.value = currentValue;

            // Prüfe ob Formel
            this.cursorInFormula = (currentValue.charAt(0) === '=');

            // Fill-Handle während Editing verstecken
            var fillHandle = document.getElementById(this.containerId + '-fillhandle');
            if (fillHandle) {
                fillHandle.style.display = 'none';
            }

            if (inCell) {
                // In-Cell-Editing: Input-Feld in Zelle einfügen
                cell.classList.add('editing');

                // Vorhandenes Input entfernen falls vorhanden
                var existingInput = document.getElementById(this.containerId + '-cellinput');
                if (existingInput) {
                    existingInput.parentNode.removeChild(existingInput);
                }

                var cellInput = document.createElement('input');
                cellInput.type = 'text';
                cellInput.className = 'cell-input';
                cellInput.id = this.containerId + '-cellinput';
                cellInput.value = currentValue;

                // Zellentext durch Input ersetzen
                cell.textContent = '';
                cell.appendChild(cellInput);

                // Synchronisation Cell-Input <-> Formula-Input
                cellInput.addEventListener('input', function(e) {
                    formulaInput.value = cellInput.value;
                    self.handleFormulaInput(e);
                    // Update cursorInFormula
                    self.cursorInFormula = (cellInput.value.charAt(0) === '=');
                });

                cellInput.addEventListener('keydown', function(e) {
                    self.handleCellInputKeydown(e);
                });

                // Focus SOFORT setzen (kein setTimeout!)
                cellInput.focus();
            } else {
                // Formelzeilen-Editing
                formulaInput.focus();
                formulaInput.selectionStart = formulaInput.selectionEnd = formulaInput.value.length;
            }

            document.getElementById(this.containerId + '-status').textContent = 'Bearbeiten';
        };

        // Spezielle Methode: Editing starten UND erstes Zeichen einfügen
        ExcelSim.prototype.startEditingWithChar = function(cellId, char) {
            var self = this;
            debugLog(this.containerId, 'startEditingWithChar: "' + char + '" in ' + cellId);

            // Falls bereits editiert wird, erst abschließen
            if (this.isEditing) {
                debugLog(this.containerId, '→ War bereits im Edit-Modus, beende erst');
                this.finishEditing();
            }

            this.isEditing = true;
            this.editingInCell = true;
            this.cursorInFormula = (char === '=');

            var formulaInput = document.getElementById(this.containerId + '-formula');
            var grid = document.getElementById(this.containerId + '-grid');
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');

            // Fill-Handle verstecken
            var fillHandle = document.getElementById(this.containerId + '-fillhandle');
            if (fillHandle) {
                fillHandle.style.display = 'none';
            }

            // Cell-Input erstellen
            cell.classList.add('editing');

            var existingInput = document.getElementById(this.containerId + '-cellinput');
            if (existingInput) {
                existingInput.parentNode.removeChild(existingInput);
            }

            var cellInput = document.createElement('input');
            cellInput.type = 'text';
            cellInput.className = 'cell-input';
            cellInput.id = this.containerId + '-cellinput';
            cellInput.value = char; // Erstes Zeichen direkt setzen

            cell.textContent = '';
            cell.appendChild(cellInput);

            // Formelzeile synchronisieren
            formulaInput.value = char;

            // Event-Listener
            cellInput.addEventListener('input', function(e) {
                debugLog(self.containerId, 'cellInput INPUT event', {
                    cellInputValue: cellInput.value,
                    isEditing: self.isEditing
                });
                formulaInput.value = cellInput.value;
                self.handleFormulaInput(e);
                self.cursorInFormula = (cellInput.value.charAt(0) === '=');
            });

            cellInput.addEventListener('keydown', function(e) {
                self.handleCellInputKeydown(e);
            });

            // Focus und Cursor ans Ende
            cellInput.focus();
            cellInput.selectionStart = cellInput.selectionEnd = char.length;

            // Prüfe ob Focus gesetzt wurde
            var focusWorked = (document.activeElement === cellInput);
            debugLog(this.containerId, 'startEditingWithChar DONE', {
                cellInputValue: cellInput.value,
                activeElement: document.activeElement.id,
                focusWorked: focusWorked,
                isEditing: this.isEditing
            });

            if (!focusWorked) {
                console.warn('[' + this.containerId + '] WARNUNG: Focus konnte nicht gesetzt werden!');
            }

            document.getElementById(this.containerId + '-status').textContent = 'Bearbeiten';
        };

        ExcelSim.prototype.handleCellInputKeydown = function(e) {
            debugLog(this.containerId, 'handleCellInputKeydown: "' + e.key + '"', {
                cellInputValue: e.target.value,
                activeElement: document.activeElement.id
            });

            var autocomplete = document.getElementById(this.containerId + '-autocomplete');
            var cellInput = document.getElementById(this.containerId + '-cellinput');
            var formulaInput = document.getElementById(this.containerId + '-formula');

            if (e.key === 'Enter') {
                e.preventDefault();
                if (autocomplete.style.display === 'block') {
                    var selected = autocomplete.querySelector('.selected');
                    if (selected) {
                        this.insertAutocompleteToCellInput(selected.dataset.fn);
                        return;
                    }
                }
                this.finishEditing();
                this.moveSelection(0, 1);
            } else if (e.key === 'Tab') {
                e.preventDefault();
                if (autocomplete.style.display === 'block') {
                    var selected = autocomplete.querySelector('.selected');
                    if (selected) {
                        this.insertAutocompleteToCellInput(selected.dataset.fn);
                        return;
                    }
                }
                this.finishEditing();
                this.moveSelection(1, 0);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                this.cancelEditing();
            } else if (e.key === 'ArrowDown' && autocomplete.style.display === 'block') {
                e.preventDefault();
                this.navigateAutocomplete(1);
            } else if (e.key === 'ArrowUp' && autocomplete.style.display === 'block') {
                e.preventDefault();
                this.navigateAutocomplete(-1);
            }
        };

        ExcelSim.prototype.insertAutocompleteToCellInput = function(fnName) {
            var cellInput = document.getElementById(this.containerId + '-cellinput');
            var formulaInput = document.getElementById(this.containerId + '-formula');

            if (cellInput) {
                var value = cellInput.value;
                var newValue = value.replace(/=[A-Z]+$/i, '=' + fnName + '(');
                cellInput.value = newValue;
                formulaInput.value = newValue;
                cellInput.focus();
            }

            this.hideAutocomplete();
        };

        ExcelSim.prototype.finishEditing = function() {
            if (!this.isEditing) return;

            var formulaInput = document.getElementById(this.containerId + '-formula');
            var value = formulaInput.value;
            var cellId = this.selectedCell;

            // Formel-Highlights entfernen
            var grid = document.getElementById(this.containerId + '-grid');
            var highlighted = grid.querySelectorAll('.in-formula');
            for (var i = 0; i < highlighted.length; i++) {
                highlighted[i].classList.remove('in-formula');
            }

            // Cell-Input-Element entfernen falls vorhanden
            var cellInput = document.getElementById(this.containerId + '-cellinput');
            if (cellInput) {
                cellInput.parentNode.removeChild(cellInput);
            }

            // Editing-Status entfernen
            var editingCell = grid.querySelector('.editing');
            if (editingCell) {
                editingCell.classList.remove('editing');
            }

            // Wert speichern
            if (value.charAt(0) === '=') {
                this.formulas[cellId] = value.toUpperCase();
                this.data[cellId] = this.evaluateFormula(value);
            } else {
                delete this.formulas[cellId];
                // Versuche Zahl zu parsen
                var num = parseFloat(value.replace(',', '.'));
                this.data[cellId] = isNaN(num) ? value : num;
            }

            // Zelle aktualisieren
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');
            if (cell) {
                cell.textContent = this.formatValue(this.data[cellId]);
            }

            // Abhängige Zellen neu berechnen
            this.recalculateAll();

            this.isEditing = false;
            this.editingInCell = false;
            this.cursorInFormula = false;
            document.getElementById(this.containerId + '-status').textContent = 'Bereit';

            this.hideAutocomplete();

            // Fill-Handle wieder anzeigen
            var fillHandle = document.getElementById(this.containerId + '-fillhandle');
            if (fillHandle) {
                fillHandle.style.display = 'block';
            }

            // Callback aufrufen
            if (this.config.onChange) {
                this.config.onChange(cellId, this.data[cellId], this.formulas[cellId]);
            }
        };

        ExcelSim.prototype.highlightFormulaCell = function(cellId) {
            var grid = document.getElementById(this.containerId + '-grid');
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');
            if (cell) {
                cell.classList.add('in-formula');
            }
        };

        ExcelSim.prototype.handleFormulaInput = function(e) {
            var value = e.target.value;

            // Synchronisiere mit Cell-Input falls vorhanden
            var cellInput = document.getElementById(this.containerId + '-cellinput');
            if (cellInput && e.target !== cellInput) {
                cellInput.value = value;
            }

            if (value.charAt(0) === '=') {
                this.cursorInFormula = true;

                // Autocomplete prüfen
                var match = value.match(/=([A-Z]+)$/i);
                if (match && match[1].length >= 2) {
                    this.showAutocomplete(match[1]);
                } else {
                    this.hideAutocomplete();
                }
            } else {
                this.hideAutocomplete();
            }
        };

        ExcelSim.prototype.handleFormulaKeydown = function(e) {
            var autocomplete = document.getElementById(this.containerId + '-autocomplete');

            if (e.key === 'Enter') {
                e.preventDefault();
                if (autocomplete.style.display === 'block') {
                    var selected = autocomplete.querySelector('.selected');
                    if (selected) {
                        this.insertAutocomplete(selected.dataset.fn);
                        return;
                    }
                }
                this.finishEditing();
                // Zur nächsten Zeile
                this.moveSelection(0, 1);
            } else if (e.key === 'Tab') {
                e.preventDefault();
                if (autocomplete.style.display === 'block') {
                    var selected = autocomplete.querySelector('.selected');
                    if (selected) {
                        this.insertAutocomplete(selected.dataset.fn);
                        return;
                    }
                }
                this.finishEditing();
                this.moveSelection(1, 0);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                this.cancelEditing();
            } else if (e.key === 'ArrowDown' && autocomplete.style.display === 'block') {
                e.preventDefault();
                this.navigateAutocomplete(1);
            } else if (e.key === 'ArrowUp' && autocomplete.style.display === 'block') {
                e.preventDefault();
                this.navigateAutocomplete(-1);
            }
        };

        ExcelSim.prototype.handleKeydown = function(e) {
            if (e.key === 'Enter') {
                this.startEditing(this.selectedCell, true);
            } else if (e.key === 'Delete' || e.key === 'Backspace') {
                this.clearCell(this.selectedCell);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                this.moveSelection(0, -1);
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                this.moveSelection(0, 1);
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                this.moveSelection(-1, 0);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                this.moveSelection(1, 0);
            } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                // Direktes Tippen startet In-Cell-Editing (wie bei Excel)
                // WICHTIG: KEIN preventDefault() - das Zeichen soll natürlich ins Input gehen!
                this.startEditingWithChar(this.selectedCell, e.key);
                e.preventDefault(); // Jetzt verhindern, da wir das Zeichen manuell eingefügt haben
            }
        };

        ExcelSim.prototype.cancelEditing = function() {
            if (!this.isEditing) return;

            var cellId = this.selectedCell;
            var grid = document.getElementById(this.containerId + '-grid');

            // Cell-Input-Element entfernen falls vorhanden
            var cellInput = document.getElementById(this.containerId + '-cellinput');
            if (cellInput) {
                cellInput.parentNode.removeChild(cellInput);
            }

            // Formelzeile zurücksetzen
            var formulaInput = document.getElementById(this.containerId + '-formula');
            if (this.formulas[cellId]) {
                formulaInput.value = this.formulas[cellId];
            } else {
                formulaInput.value = this.data[cellId] !== undefined ? this.data[cellId] : '';
            }

            // Highlights entfernen
            var highlighted = grid.querySelectorAll('.in-formula, .editing');
            for (var i = 0; i < highlighted.length; i++) {
                highlighted[i].classList.remove('in-formula', 'editing');
            }

            // Zelltext der editierten Zelle wiederherstellen
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');
            if (cell) {
                cell.textContent = this.formatValue(this.data[cellId]);
            }

            this.isEditing = false;
            this.editingInCell = false;
            this.cursorInFormula = false;

            this.hideAutocomplete();
            document.getElementById(this.containerId + '-status').textContent = 'Bereit';

            // Fill-Handle wieder anzeigen
            var fillHandle = document.getElementById(this.containerId + '-fillhandle');
            if (fillHandle) {
                fillHandle.style.display = 'block';
            }
        };

        ExcelSim.prototype.clearCell = function(cellId) {
            delete this.formulas[cellId];
            this.data[cellId] = '';

            var grid = document.getElementById(this.containerId + '-grid');
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');
            cell.textContent = '';

            var formulaInput = document.getElementById(this.containerId + '-formula');
            formulaInput.value = '';

            this.recalculateAll();
        };

        ExcelSim.prototype.moveSelection = function(dx, dy) {
            if (!this.selectedCell) return;

            var col = this.selectedCell.charCodeAt(0) - 65;
            var row = parseInt(this.selectedCell.substring(1));

            var newCol = Math.max(0, Math.min(this.config.cols - 1, col + dx));
            var newRow = Math.max(1, Math.min(this.config.rows, row + dy));

            var newCellId = String.fromCharCode(65 + newCol) + newRow;
            this.selectCell(newCellId);
        };

        ExcelSim.prototype.showAutocomplete = function(partial) {
            var autocomplete = document.getElementById(this.containerId + '-autocomplete');
            var matches = [];

            partial = partial.toUpperCase();
            for (var i = 0; i < this.functions.length; i++) {
                if (this.functions[i].name.indexOf(partial) === 0) {
                    matches.push(this.functions[i]);
                }
            }

            if (matches.length === 0) {
                this.hideAutocomplete();
                return;
            }

            var html = '';
            for (var i = 0; i < matches.length; i++) {
                var cls = i === 0 ? 'excel-autocomplete-item selected' : 'excel-autocomplete-item';
                html += '<div class="' + cls + '" data-fn="' + matches[i].name + '">';
                html += '<span class="fn-name">' + matches[i].name + '</span>';
                html += '<span class="fn-desc">' + matches[i].desc + '</span>';
                html += '</div>';
            }

            autocomplete.innerHTML = html;

            // Position
            var formulaInput = document.getElementById(this.containerId + '-formula');
            var rect = formulaInput.getBoundingClientRect();
            autocomplete.style.left = rect.left + 'px';
            autocomplete.style.top = (rect.bottom + 2) + 'px';
            autocomplete.style.width = rect.width + 'px';
            autocomplete.style.display = 'block';
        };

        ExcelSim.prototype.hideAutocomplete = function() {
            document.getElementById(this.containerId + '-autocomplete').style.display = 'none';
        };

        ExcelSim.prototype.navigateAutocomplete = function(dir) {
            var autocomplete = document.getElementById(this.containerId + '-autocomplete');
            var items = autocomplete.querySelectorAll('.excel-autocomplete-item');
            var currentIdx = -1;

            for (var i = 0; i < items.length; i++) {
                if (items[i].classList.contains('selected')) {
                    currentIdx = i;
                    items[i].classList.remove('selected');
                    break;
                }
            }

            var newIdx = currentIdx + dir;
            if (newIdx < 0) newIdx = items.length - 1;
            if (newIdx >= items.length) newIdx = 0;

            items[newIdx].classList.add('selected');
        };

        ExcelSim.prototype.insertAutocomplete = function(fnName) {
            var formulaInput = document.getElementById(this.containerId + '-formula');
            var cellInput = document.getElementById(this.containerId + '-cellinput');
            var value = formulaInput.value;

            // Ersetze das getippte Partial mit der vollständigen Funktion
            var newValue = value.replace(/=[A-Z]+$/i, '=' + fnName + '(');
            formulaInput.value = newValue;

            // Synchronisiere mit Cell-Input falls vorhanden
            if (cellInput) {
                cellInput.value = newValue;
                cellInput.focus();
                cellInput.selectionStart = cellInput.selectionEnd = newValue.length;
            } else {
                formulaInput.focus();
            }

            this.hideAutocomplete();
        };

        ExcelSim.prototype.evaluateFormula = function(formula) {
            if (!formula || formula.charAt(0) !== '=') return formula;

            var self = this;
            formula = formula.substring(1).toUpperCase();

            // SUMME-Funktion
            var summeMatch = formula.match(/SUMME\(([A-Z])(\d+):([A-Z])(\d+)\)/);
            if (summeMatch) {
                var startCol = summeMatch[1].charCodeAt(0) - 65;
                var startRow = parseInt(summeMatch[2]);
                var endCol = summeMatch[3].charCodeAt(0) - 65;
                var endRow = parseInt(summeMatch[4]);

                var sum = 0;
                for (var c = startCol; c <= endCol; c++) {
                    for (var r = startRow; r <= endRow; r++) {
                        var cellId = String.fromCharCode(65 + c) + r;
                        var val = parseFloat(this.data[cellId]);
                        if (!isNaN(val)) sum += val;
                    }
                }
                return sum;
            }

            // Einfache Formel - Zellreferenzen ersetzen
            var evalFormula = formula.replace(/([A-Z])(\d+)/g, function(match, col, row) {
                var cellId = col + row;
                var val = self.data[cellId];
                if (typeof val === 'number') return val;
                var num = parseFloat(String(val).replace(',', '.'));
                return isNaN(num) ? 0 : num;
            });

            try {
                if (/^[\d\.\+\-\*\/\(\)\s]+$/.test(evalFormula)) {
                    return eval(evalFormula);
                }
            } catch (e) {
                return '#FEHLER!';
            }

            return '#FEHLER!';
        };

        ExcelSim.prototype.recalculateAll = function() {
            var grid = document.getElementById(this.containerId + '-grid');

            for (var cellId in this.formulas) {
                if (this.formulas.hasOwnProperty(cellId)) {
                    this.data[cellId] = this.evaluateFormula(this.formulas[cellId]);
                    var cell = grid.querySelector('[data-cell="' + cellId + '"]');
                    if (cell) {
                        cell.textContent = this.formatValue(this.data[cellId]);
                    }
                }
            }
        };

        ExcelSim.prototype.formatValue = function(value) {
            if (value === '' || value === undefined || value === null) return '';
            if (typeof value === 'number') {
                // Deutsche Formatierung
                return value.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            }
            return value;
        };

        ExcelSim.prototype.getValue = function(cellId) {
            return this.data[cellId];
        };

        ExcelSim.prototype.setValue = function(cellId, value) {
            if (typeof value === 'string' && value.charAt(0) === '=') {
                this.formulas[cellId] = value.toUpperCase();
                this.data[cellId] = this.evaluateFormula(value);
            } else {
                delete this.formulas[cellId];
                this.data[cellId] = value;
            }

            var grid = document.getElementById(this.containerId + '-grid');
            var cell = grid.querySelector('[data-cell="' + cellId + '"]');
            if (cell) {
                cell.textContent = this.formatValue(this.data[cellId]);
            }

            this.recalculateAll();
        };

        // ========================================
        // FILL-HANDLE (Aufziehen) - Mouse + Touch
        // ========================================

        ExcelSim.prototype.startFillDrag = function(cellId) {
            var self = this;
            this.isDraggingFill = true;
            this.fillStartCell = cellId;
            this.fillPreviewCells = [];

            var grid = document.getElementById(this.containerId + '-grid');

            // Mouse Events
            var onMouseMove = function(e) {
                self.handleFillMove(e.clientX, e.clientY);
            };
            var onMouseUp = function(e) {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                self.finishFillDrag();
            };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);

            // Touch Events
            var onTouchMove = function(e) {
                if (e.touches.length > 0) {
                    self.handleFillMove(e.touches[0].clientX, e.touches[0].clientY);
                }
            };
            var onTouchEnd = function(e) {
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onTouchEnd);
                self.finishFillDrag();
            };
            document.addEventListener('touchmove', onTouchMove, { passive: false });
            document.addEventListener('touchend', onTouchEnd);

            document.getElementById(this.containerId + '-status').textContent = 'Aufziehen...';
        };

        ExcelSim.prototype.handleFillMove = function(clientX, clientY) {
            var grid = document.getElementById(this.containerId + '-grid');
            var cells = grid.querySelectorAll('td[data-cell]');

            // Alte Previews entfernen
            for (var i = 0; i < this.fillPreviewCells.length; i++) {
                var prevCell = grid.querySelector('[data-cell="' + this.fillPreviewCells[i] + '"]');
                if (prevCell) prevCell.classList.remove('fill-preview');
            }
            this.fillPreviewCells = [];

            // Finde Zelle unter Cursor
            var targetCell = null;
            for (var i = 0; i < cells.length; i++) {
                var rect = cells[i].getBoundingClientRect();
                if (clientX >= rect.left && clientX <= rect.right &&
                    clientY >= rect.top && clientY <= rect.bottom) {
                    targetCell = cells[i].dataset.cell;
                    break;
                }
            }

            if (!targetCell || targetCell === this.fillStartCell) return;

            // Berechne Bereich (nur vertikal oder horizontal)
            var startCol = this.fillStartCell.charCodeAt(0) - 65;
            var startRow = parseInt(this.fillStartCell.substring(1));
            var endCol = targetCell.charCodeAt(0) - 65;
            var endRow = parseInt(targetCell.substring(1));

            // Bestimme Richtung (vertikal bevorzugt, wenn diagonal)
            var deltaCol = Math.abs(endCol - startCol);
            var deltaRow = Math.abs(endRow - startRow);

            if (deltaRow >= deltaCol) {
                // Vertikal
                endCol = startCol;
                var rowDir = endRow > startRow ? 1 : -1;
                for (var r = startRow + rowDir; rowDir > 0 ? r <= endRow : r >= endRow; r += rowDir) {
                    var cId = String.fromCharCode(65 + startCol) + r;
                    this.fillPreviewCells.push(cId);
                    var c = grid.querySelector('[data-cell="' + cId + '"]');
                    if (c) c.classList.add('fill-preview');
                }
            } else {
                // Horizontal
                endRow = startRow;
                var colDir = endCol > startCol ? 1 : -1;
                for (var c = startCol + colDir; colDir > 0 ? c <= endCol : c >= endCol; c += colDir) {
                    var cId = String.fromCharCode(65 + c) + startRow;
                    this.fillPreviewCells.push(cId);
                    var cell = grid.querySelector('[data-cell="' + cId + '"]');
                    if (cell) cell.classList.add('fill-preview');
                }
            }
        };

        ExcelSim.prototype.finishFillDrag = function() {
            if (!this.isDraggingFill) return;

            var grid = document.getElementById(this.containerId + '-grid');

            // Wert/Formel aus Startzelle holen
            var sourceFormula = this.formulas[this.fillStartCell];
            var sourceValue = this.data[this.fillStartCell];

            // In alle Preview-Zellen kopieren (mit Formel-Anpassung)
            for (var i = 0; i < this.fillPreviewCells.length; i++) {
                var targetId = this.fillPreviewCells[i];
                var targetCell = grid.querySelector('[data-cell="' + targetId + '"]');
                if (targetCell) {
                    targetCell.classList.remove('fill-preview');
                }

                if (sourceFormula) {
                    // Formel anpassen (relative Referenzen)
                    var adjustedFormula = this.adjustFormula(sourceFormula, this.fillStartCell, targetId);
                    this.formulas[targetId] = adjustedFormula;
                    this.data[targetId] = this.evaluateFormula(adjustedFormula);
                } else {
                    // Einfacher Wert kopieren
                    delete this.formulas[targetId];
                    this.data[targetId] = sourceValue;
                }

                if (targetCell) {
                    targetCell.textContent = this.formatValue(this.data[targetId]);
                }
            }

            this.recalculateAll();

            // Callback für jede geänderte Zelle
            if (this.config.onChange) {
                for (var i = 0; i < this.fillPreviewCells.length; i++) {
                    var cId = this.fillPreviewCells[i];
                    this.config.onChange(cId, this.data[cId], this.formulas[cId]);
                }
            }

            this.isDraggingFill = false;
            this.fillStartCell = null;
            this.fillPreviewCells = [];
            document.getElementById(this.containerId + '-status').textContent = 'Bereit';
        };

        ExcelSim.prototype.adjustFormula = function(formula, fromCell, toCell) {
            // Berechne Offset
            var fromCol = fromCell.charCodeAt(0) - 65;
            var fromRow = parseInt(fromCell.substring(1));
            var toCol = toCell.charCodeAt(0) - 65;
            var toRow = parseInt(toCell.substring(1));

            var colOffset = toCol - fromCol;
            var rowOffset = toRow - fromRow;

            // Ersetze Zellreferenzen in der Formel
            return formula.replace(/([A-Z])(\d+)/g, function(match, col, row) {
                var newCol = col.charCodeAt(0) - 65 + colOffset;
                var newRow = parseInt(row) + rowOffset;

                // Grenzen prüfen
                if (newCol < 0 || newCol > 25 || newRow < 1) {
                    return match; // Ungültig - Original behalten
                }

                return String.fromCharCode(65 + newCol) + newRow;
            });
        };


        // ========================================
        // LERNPFAD LOGIK MIT PERSISTENZ
        // ========================================

        var STORAGE_KEY = 'lp-info-7-formeln';
        var currentSection = 1;
        var totalSections = 9;
        var completedSections = []; // Array der abgeschlossenen Schritte
        var excel1, excel2, excel3, excel4;

        // Initial-Daten für Reset
        var excel1InitialData = { 'A1': 10, 'B1': 5, 'C1': '', 'D1': '' };
        var excel2InitialData = { 'A1': 'Produkt', 'B1': 'Preis', 'A2': 'Apfel', 'B2': 0.50, 'A3': 'Birne', 'B3': 0.80, 'A4': 'Orange', 'B4': 1.20, 'A5': 'Summe', 'B5': '' };
        var excel3InitialData = { 'A1': 10, 'B1': 5, 'C1': '=A1+B1' };
        var excel4InitialData = {
            'A1': 'Artikel', 'B1': 'Preis (€)', 'C1': 'Menge', 'D1': 'Gesamt',
            'A2': 'Chips', 'B2': 1.50, 'C2': 4, 'D2': '',
            'A3': 'Limo', 'B3': 0.80, 'C3': 10, 'D3': '',
            'A4': 'Pizza', 'B4': 8.00, 'C4': 3, 'D4': '',
            'A5': 'Deko', 'B5': 5.00, 'C5': 2, 'D5': '',
            'A6': 'Becher', 'B6': 0.10, 'C6': 25, 'D6': '',
            'A7': 'SUMME', 'B7': '', 'C7': '', 'D7': ''
        };

        // ========================================
        // PERSISTENZ (localStorage)
        // ========================================

        function saveProgress() {
            try {
                localStorage.setItem(STORAGE_KEY + '-section', currentSection);
                localStorage.setItem(STORAGE_KEY + '-completed', JSON.stringify(completedSections));

                // Speichere Quiz-Antwort
                var quiz1Answer = document.querySelector('#quiz1 input:checked');
                if (quiz1Answer) {
                    localStorage.setItem(STORAGE_KEY + '-quiz1', quiz1Answer.value);
                }

                // Speichere Excel-Daten
                if (excel1) {
                    localStorage.setItem(STORAGE_KEY + '-excel1', JSON.stringify(excel1.data));
                    localStorage.setItem(STORAGE_KEY + '-excel1-formulas', JSON.stringify(excel1.formulas));
                }
                if (excel2) {
                    localStorage.setItem(STORAGE_KEY + '-excel2', JSON.stringify(excel2.data));
                    localStorage.setItem(STORAGE_KEY + '-excel2-formulas', JSON.stringify(excel2.formulas));
                }
                if (excel3) {
                    localStorage.setItem(STORAGE_KEY + '-excel3', JSON.stringify(excel3.data));
                    localStorage.setItem(STORAGE_KEY + '-excel3-formulas', JSON.stringify(excel3.formulas));
                }
            } catch (e) {
                console.warn('localStorage nicht verfügbar');
            }
        }

        function loadProgress() {
            try {
                var savedSection = localStorage.getItem(STORAGE_KEY + '-section');
                if (savedSection) {
                    currentSection = parseInt(savedSection);
                }

                var savedCompleted = localStorage.getItem(STORAGE_KEY + '-completed');
                if (savedCompleted) {
                    completedSections = JSON.parse(savedCompleted);
                }

                // Quiz wiederherstellen
                var savedQuiz1 = localStorage.getItem(STORAGE_KEY + '-quiz1');
                if (savedQuiz1) {
                    var radio = document.querySelector('#quiz1 input[value="' + savedQuiz1 + '"]');
                    if (radio) {
                        radio.checked = true;
                        radio.closest('.quiz-option').classList.add('selected');
                    }
                }
            } catch (e) {
                console.warn('localStorage nicht verfügbar');
            }
        }

        // ========================================
        // STEP-INDICATORS
        // ========================================

        function generateStepIndicators() {
            var container = document.getElementById('stepIndicators');
            container.innerHTML = '';

            for (var i = 1; i <= totalSections; i++) {
                var dot = document.createElement('div');
                dot.className = 'step-dot';
                dot.textContent = i;
                dot.setAttribute('data-step', i);

                // Klassen setzen
                if (i === currentSection) {
                    dot.classList.add('current');
                } else if (completedSections.indexOf(i) !== -1) {
                    dot.classList.add('completed');
                } else if (i === 1 || completedSections.indexOf(i - 1) !== -1) {
                    dot.classList.add('unlocked');
                }

                // Klick-Handler (nur für completed oder unlocked)
                dot.onclick = function() {
                    var stepNum = parseInt(this.getAttribute('data-step'));
                    if (this.classList.contains('completed') || this.classList.contains('unlocked') || stepNum === currentSection) {
                        goToSection(stepNum);
                    }
                };

                container.appendChild(dot);
            }
        }

        function updateStepIndicators() {
            var dots = document.querySelectorAll('.step-dot');
            for (var i = 0; i < dots.length; i++) {
                var stepNum = parseInt(dots[i].getAttribute('data-step'));
                dots[i].classList.remove('current', 'completed', 'unlocked');

                if (stepNum === currentSection) {
                    dots[i].classList.add('current');
                } else if (completedSections.indexOf(stepNum) !== -1) {
                    dots[i].classList.add('completed');
                } else if (stepNum === 1 || completedSections.indexOf(stepNum - 1) !== -1) {
                    dots[i].classList.add('unlocked');
                }
            }
        }

        // ========================================
        // NAVIGATION
        // ========================================

        function updateProgress() {
            var percent = ((currentSection - 1) / (totalSections - 1)) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = 'Schritt ' + currentSection + ' von ' + totalSections;
            updateStepIndicators();
        }

        function goToSection(n) {
            if (n < 1 || n > totalSections) return;

            // Kann nur zu bereits freigeschalteten Schritten navigieren
            if (n > 1 && completedSections.indexOf(n - 1) === -1 && n !== currentSection) {
                return;
            }

            document.getElementById('section' + currentSection).classList.remove('active');
            currentSection = n;
            document.getElementById('section' + currentSection).classList.add('active');
            updateProgress();
            saveProgress();
            window.scrollTo(0, 0);

            // Excel-Simulationen initialisieren
            initExcelForSection(n);
        }

        function nextSection() {
            // Aktuellen Schritt als abgeschlossen markieren
            if (completedSections.indexOf(currentSection) === -1) {
                completedSections.push(currentSection);
            }

            if (currentSection < totalSections) {
                goToSection(currentSection + 1);
            }
        }

        function markSectionCompleted(sectionNum) {
            if (completedSections.indexOf(sectionNum) === -1) {
                completedSections.push(sectionNum);
                updateStepIndicators();
                saveProgress();
            }
        }

        function initExcelForSection(n) {
            if (n === 3 && !excel1) {
                initExcel1();
            } else if (n === 4 && !excel2) {
                initExcel2();
            } else if (n === 5 && !excel3) {
                initExcel3();
            } else if (n === 7 && !excel4) {
                initExcel4();
            }
        }

        // ========================================
        // QUIZ
        // ========================================

        function selectQuizOption(element, quizId) {
            var options = document.querySelectorAll('#' + quizId + ' .quiz-option');
            for (var i = 0; i < options.length; i++) {
                options[i].classList.remove('selected');
            }
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function checkQuiz1() {
            var selected = document.querySelector('#quiz1 input:checked');
            var feedback = document.getElementById('feedback1');

            if (!selected) {
                feedback.className = 'feedback show hint';
                feedback.textContent = 'Bitte wähle eine Antwort aus!';
                return;
            }

            var options = document.querySelectorAll('#quiz1 .quiz-option');
            for (var i = 0; i < options.length; i++) {
                var input = options[i].querySelector('input');
                if (input.value === 'B2') {
                    options[i].classList.add('correct');
                } else if (input.checked) {
                    options[i].classList.add('wrong');
                }
            }

            if (selected.value === 'B2') {
                feedback.className = 'feedback show correct';
                feedback.innerHTML = '<strong>Richtig!</strong> Die Zelle ist in Spalte B und Zeile 2, also B2.';
            } else {
                feedback.className = 'feedback show incorrect';
                feedback.innerHTML = '<strong>Nicht ganz.</strong> Erst der Spaltenbuchstabe (B), dann die Zeilennummer (2). Die richtige Antwort ist <strong>B2</strong>.';
            }

            document.getElementById('check1').style.display = 'none';
            document.getElementById('next2').style.display = 'inline-block';
        }

        // ========================================
        // EXCEL 1: Einfache Formeln
        // ========================================

        function initExcel1() {
            excel1 = new ExcelSim('excel1', {
                rows: 3,
                cols: 4,
                data: {
                    'A1': 10,
                    'B1': 5,
                    'C1': '',
                    'D1': ''
                },
                initialSelect: 'C1',
                onChange: function(cellId, value, formula) {
                    saveProgress(); // Speichere bei jeder Änderung

                    if (cellId === 'C1' && value === 15) {
                        // Aufgabe erledigt
                        var task = document.querySelector('#tasks1 [data-task="c1"]');
                        task.classList.add('done');

                        var feedback = document.getElementById('feedback3');
                        feedback.className = 'feedback show correct';
                        feedback.innerHTML = '<strong>Perfekt!</strong> Die Formel <code>=A1+B1</code> addiert 10 + 5 = 15.';

                        document.getElementById('next3').style.display = 'inline-block';
                    }
                }
            });
        }

        // ========================================
        // EXCEL 2: SUMME-Funktion
        // ========================================

        function initExcel2() {
            excel2 = new ExcelSim('excel2', {
                rows: 5,
                cols: 2,
                data: {
                    'A1': 'Produkt',
                    'B1': 'Preis',
                    'A2': 'Apfel',
                    'B2': 0.50,
                    'A3': 'Birne',
                    'B3': 0.80,
                    'A4': 'Orange',
                    'B4': 1.20,
                    'A5': 'Summe',
                    'B5': ''
                },
                initialSelect: 'B5',
                onChange: function(cellId, value, formula) {
                    saveProgress(); // Speichere bei jeder Änderung

                    if (cellId === 'B5' && Math.abs(value - 2.5) < 0.01) {
                        var task = document.querySelector('#tasks2 [data-task="b5"]');
                        task.classList.add('done');

                        var feedback = document.getElementById('feedback4');
                        feedback.className = 'feedback show correct';
                        feedback.innerHTML = '<strong>Ausgezeichnet!</strong> <code>=SUMME(B2:B4)</code> ergibt 0,50 + 0,80 + 1,20 = 2,50';

                        document.getElementById('next4').style.display = 'inline-block';
                    }
                }
            });
        }

        // ========================================
        // EXCEL 3: Referenzprinzip
        // ========================================

        function initExcel3() {
            excel3 = new ExcelSim('excel3', {
                rows: 3,
                cols: 3,
                data: {
                    'A1': 10,
                    'B1': 5,
                    'C1': '=A1+B1'
                },
                initialSelect: 'A1',
                onChange: function(cellId, value, formula) {
                    saveProgress(); // Speichere bei jeder Änderung

                    // Prüfe ob A1 auf 20 geändert wurde
                    if (cellId === 'A1' && value === 20) {
                        var c1Value = excel3.getValue('C1');
                        if (c1Value === 25) {
                            var task = document.querySelector('#tasks3 [data-task="change"]');
                            task.classList.add('done');

                            var feedback = document.getElementById('feedback5');
                            feedback.className = 'feedback show correct';
                            feedback.innerHTML = '<strong>Siehst du?</strong> Du hast A1 auf 20 geändert, und C1 zeigt jetzt automatisch 25 (= 20 + 5). Das ist das Referenzprinzip!';

                            document.getElementById('next5').style.display = 'inline-block';
                        }
                    }
                }
            });
        }

        // ========================================
        // EXCEL 4: Party-Budget (Bonus)
        // ========================================

        function initExcel4() {
            var completedTasks = { d2: false, d3: false, d4: false, d5: false, d6: false, d7: false };
            var expectedValues = { D2: 6, D3: 8, D4: 24, D5: 10, D6: 2.5 };

            excel4 = new ExcelSim('excel4', {
                rows: 7,
                cols: 4,
                data: excel4InitialData,
                initialSelect: 'D2',
                onChange: function(cellId, value, formula) {
                    saveProgress();

                    // Prüfe einzelne Zellen D2-D7
                    var taskMap = { 'D2': 'd2', 'D3': 'd3', 'D4': 'd4', 'D5': 'd5', 'D6': 'd6', 'D7': 'd7' };

                    if (taskMap[cellId]) {
                        var taskId = taskMap[cellId];
                        var isCorrect = false;

                        if (cellId === 'D7') {
                            // Summe prüfen: Wert muss ungefähr der Summe von D2:D6 entsprechen
                            var sumD = 0;
                            for (var i = 2; i <= 6; i++) {
                                var val = excel4.data['D' + i];
                                if (typeof val === 'number') sumD += val;
                            }
                            // Akzeptiere wenn der Wert stimmt (egal ob Formel oder manuell)
                            isCorrect = typeof value === 'number' && Math.abs(value - sumD) < 0.1 && sumD > 0;
                        } else if (expectedValues[cellId] !== undefined) {
                            // Einzelpreis prüfen - akzeptiere auch leicht abweichende Werte
                            isCorrect = typeof value === 'number' && Math.abs(value - expectedValues[cellId]) < 0.1;
                        }

                        if (isCorrect) {
                            var task = document.querySelector('#tasks4 [data-task="' + taskId + '"]');
                            if (task) task.classList.add('done');
                            completedTasks[taskId] = true;
                        }
                    }

                    // Prüfe ob alle 6 Aufgaben erledigt (D2-D7)
                    var allDone = completedTasks.d2 && completedTasks.d3 && completedTasks.d4 &&
                                  completedTasks.d5 && completedTasks.d6 && completedTasks.d7;

                    if (allDone) {
                        var feedback = document.getElementById('feedback7');
                        feedback.className = 'feedback show correct';

                        // Berechne aktuelle Summe
                        var currentSum = 0;
                        for (var i = 2; i <= 6; i++) {
                            var val = excel4.data['D' + i];
                            if (typeof val === 'number') currentSum += val;
                        }

                        feedback.innerHTML = '<strong>Sehr gut!</strong> Party-Budget: ' + currentSum.toFixed(2).replace('.', ',') + ' € - Jetzt die Experimentier-Fragen!';

                        // Weiter-Button anzeigen
                        document.getElementById('next7').style.display = 'block';
                        markSectionCompleted(7);
                    }
                }
            });
        }

        // ========================================
        // BONUS-FRAGEN (Experimentieren)
        // ========================================

        function checkBonus1() {
            var input = document.getElementById('bonus1-answer');
            var feedback = document.getElementById('bonus1-feedback');
            var answer = parseFloat(input.value);

            // Pizza: 8€ * 5 = 40€
            if (Math.abs(answer - 40) < 0.1) {
                feedback.textContent = 'Richtig! 8 € × 5 = 40 €';
                feedback.style.color = '#2a7a4b';
                input.style.borderColor = '#2a7a4b';
            } else {
                feedback.textContent = 'Rechne: Pizzapreis × neue Menge';
                feedback.style.color = '#c62828';
                input.style.borderColor = '#c62828';
            }
        }

        function checkBonus2() {
            var input = document.getElementById('bonus2-answer');
            var feedback = document.getElementById('bonus2-feedback');
            var answer = parseFloat(input.value.replace(',', '.'));

            // Originalsumme: 6 + 8 + 24 + 10 + 2.5 = 50.5
            // Mit 30 Bechern: 6 + 8 + 24 + 10 + 3 = 51
            // Becher: 0.10 * 30 = 3 (statt 0.10 * 25 = 2.5)
            // Differenz: +0.5€
            if (Math.abs(answer - 51) < 0.1) {
                feedback.textContent = 'Richtig! 0,10 € × 30 = 3 € (statt 2,50 €)';
                feedback.style.color = '#2a7a4b';
                input.style.borderColor = '#2a7a4b';
            } else {
                feedback.textContent = 'Tipp: Berechne zuerst den neuen Becherpreis';
                feedback.style.color = '#c62828';
                input.style.borderColor = '#c62828';
            }
        }

        // ========================================
        // RESET-FUNKTIONEN
        // ========================================

        function resetExcel1() {
            if (!excel1) return;

            // Task zurücksetzen
            var task = document.querySelector('#tasks1 [data-task="c1"]');
            if (task) task.classList.remove('done');

            // Feedback verstecken
            var feedback = document.getElementById('feedback3');
            feedback.className = 'feedback';
            feedback.textContent = '';

            // Weiter-Button verstecken
            document.getElementById('next3').style.display = 'none';

            // Excel neu initialisieren
            excel1 = null;
            document.getElementById('excel1').innerHTML = '';
            initExcel1();
        }

        function resetExcel2() {
            if (!excel2) return;

            // Task zurücksetzen
            var task = document.querySelector('#tasks2 [data-task="b5"]');
            if (task) task.classList.remove('done');

            // Feedback verstecken
            var feedback = document.getElementById('feedback4');
            feedback.className = 'feedback';
            feedback.textContent = '';

            // Weiter-Button verstecken
            document.getElementById('next4').style.display = 'none';

            // Excel neu initialisieren
            excel2 = null;
            document.getElementById('excel2').innerHTML = '';
            initExcel2();
        }

        function resetExcel3() {
            if (!excel3) return;

            // Task zurücksetzen
            var task = document.querySelector('#tasks3 [data-task="change"]');
            if (task) task.classList.remove('done');

            // Feedback verstecken
            var feedback = document.getElementById('feedback5');
            feedback.className = 'feedback';
            feedback.textContent = '';

            // Weiter-Button verstecken
            document.getElementById('next5').style.display = 'none';

            // Excel neu initialisieren
            excel3 = null;
            document.getElementById('excel3').innerHTML = '';
            initExcel3();
        }

        function resetExcel4() {
            if (!excel4) return;

            // Alle Tasks zurücksetzen
            var tasks = document.querySelectorAll('#tasks4 li');
            for (var i = 0; i < tasks.length; i++) {
                tasks[i].classList.remove('done');
            }

            // Feedback verstecken
            var feedback = document.getElementById('feedback7');
            feedback.className = 'feedback';
            feedback.textContent = '';

            // Weiter-Button verstecken
            document.getElementById('next7').style.display = 'none';

            // Excel neu initialisieren
            excel4 = null;
            document.getElementById('excel4').innerHTML = '';
            initExcel4();
        }

        // ========================================
        // QUIZ: AHA-EFFEKTE
        // ========================================

        function checkAhaQuiz() {
            var q2 = document.querySelector('input[name="q2"]:checked');
            var q3 = document.querySelector('input[name="q3"]:checked');
            var q4 = document.querySelector('input[name="q4"]:checked');

            var correct = 0;
            var total = 3;

            // Frage 2: Supermarkt - Antwort c
            if (q2) {
                var fb2 = document.getElementById('feedback-q2');
                if (q2.value === 'c') {
                    q2.parentElement.classList.add('correct');
                    fb2.className = 'feedback show correct';
                    fb2.textContent = 'Richtig! Eine Formel kann 50.000 Preise in Sekunden ändern.';
                    correct++;
                } else {
                    q2.parentElement.classList.add('incorrect');
                    fb2.className = 'feedback show incorrect';
                    fb2.textContent = 'Nicht ganz. Mit einer Formel geht das in Sekunden!';
                }
            }

            // Frage 3: Schule - Antwort b
            if (q3) {
                var fb3 = document.getElementById('feedback-q3');
                if (q3.value === 'b') {
                    q3.parentElement.classList.add('correct');
                    fb3.className = 'feedback show correct';
                    fb3.textContent = 'Richtig! Die Tabellenkalkulation kann alles automatisch berechnen und vergleichen.';
                    correct++;
                } else {
                    q3.parentElement.classList.add('incorrect');
                    fb3.className = 'feedback show incorrect';
                    fb3.textContent = 'Die Tabellenkalkulation kann viel mehr als nur Listen erstellen!';
                }
            }

            // Frage 4: YouTuber - Antwort b
            if (q4) {
                var fb4 = document.getElementById('feedback-q4');
                if (q4.value === 'b') {
                    q4.parentElement.classList.add('correct');
                    fb4.className = 'feedback show correct';
                    fb4.textContent = 'Richtig! Analyse, Trends und Prognosen – das ist die Power der Tabellenkalkulation!';
                    correct++;
                } else {
                    q4.parentElement.classList.add('incorrect');
                    fb4.className = 'feedback show incorrect';
                    fb4.textContent = 'Die Tabellenkalkulation zeigt Trends und Analysen – mehr als nur Zahlen!';
                }
            }

            // Gesamtfeedback
            var fb8 = document.getElementById('feedback8');
            if (correct === total) {
                fb8.className = 'feedback show correct';
                fb8.innerHTML = '<strong>Perfekt!</strong> Alle ' + total + ' Fragen richtig!';
            } else if (correct >= 2) {
                fb8.className = 'feedback show correct';
                fb8.innerHTML = '<strong>Gut!</strong> ' + correct + ' von ' + total + ' richtig.';
            } else {
                fb8.className = 'feedback show incorrect';
                fb8.innerHTML = correct + ' von ' + total + ' richtig. Schau dir die Erklärungen an!';
            }

            // AHA-Box und Weiter-Button anzeigen
            document.getElementById('aha-box').style.display = 'block';
            document.getElementById('next8').style.display = 'block';
            markSectionCompleted(8);
            saveProgress();
        }

        // ========================================
        // INITIALISIERUNG
        // ========================================

        // Fortschritt laden
        loadProgress();

        // Step-Indicators generieren
        generateStepIndicators();

        // Zur gespeicherten Section navigieren (ohne completed zu ändern)
        if (currentSection > 1) {
            for (var i = 1; i <= totalSections; i++) {
                var section = document.getElementById('section' + i);
                if (section) section.classList.remove('active');
            }
            var targetSection = document.getElementById('section' + currentSection);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Excel für diese Section initialisieren
            initExcelForSection(currentSection);
        }

        // Fortschritt aktualisieren
        updateProgress();

        // Quiz-Zustand wiederherstellen (falls Quiz bereits beantwortet)
        if (completedSections.indexOf(2) !== -1) {
            // Quiz wurde bereits korrekt beantwortet
            var selectedOption = document.querySelector('#quiz1 .quiz-option.selected');
            if (selectedOption) {
                // Prüfen ob B2 gewählt war
                var input = selectedOption.querySelector('input');
                if (input && input.value === 'B2') {
                    selectedOption.classList.add('correct');
                    document.getElementById('check1').style.display = 'none';
                    document.getElementById('next2').style.display = 'inline-block';
                    var feedback = document.getElementById('feedback1');
                    feedback.className = 'feedback show correct';
                    feedback.innerHTML = '<strong>Richtig!</strong> Die Zelle ist in Spalte B und Zeile 2, also B2.';
                }
            }
        }

        // Auto-Save bei Änderungen
        document.addEventListener('change', saveProgress);
    </script>
</body>
</html>
